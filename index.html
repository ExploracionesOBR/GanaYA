<!doctype html><html lang="es" data-theme="original"> <head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üé¥ GANA YA! - Loter√≠a Interactiva (v12.0)</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%23ff6bcb'/%3E%3Ctext x='50%25' y='55%25' font-size='18' font-family='Arial' fill='white' text-anchor='middle' font-weight='700'%3EG%3C/text%3E%3C/svg%3E">
<style>
/* --- INICIO DE ESTILO (v12.0) --- */

/* -------------------------------------------
  DEFINICI√ìN DE TEMAS (SKINS)
  -------------------------------------------
*/

/* TEMA 1: Original (Defecto) */
:root { 
    --rojo:#e63946; 
    --verde:#2a9d8f; 
    --azul:#457b9d; 
    --naranja:#f4a261; 
    --crema:#f1faee; 
    --sombra:0 10px 28px rgba(0,0,0,0.15); 
    --accent1:#e9c46a; 
    --accent2:#d62828;
    --texto-principal: #1d3557;
    --texto-secundario: #666;
    --borde-cabecera: #e63946;
    --gradiente-barra: linear-gradient(90deg, var(--verde) 0%, var(--crema) 50%, var(--rojo) 100%);
    --fondo-calculadora: #f9f9f9;
}

/* TEMA 2: Mexicano 1 (Fiesta) */
[data-theme="mexicano1"] {
    --rojo: #d00000;
    --verde: #008000;
    --azul: #0077b6;
    --naranja: #f77f00;
    --crema: #fff8ec;
    --accent1: #ffd60a;
    --accent2: #e63946;
    --texto-principal: #222;
    --texto-secundario: #555;
    --borde-cabecera: #d00000;
    --gradiente-barra: linear-gradient(90deg, var(--verde) 0%, var(--accent1) 50%, var(--rojo) 100%);
    --fondo-calculadora: #fffbe6;
}
/* Efecto Banderas (Mexicano 1) */
[data-theme="mexicano1"] .mex-frame::before, 
[data-theme="mexicano1"] .mex-frame-small::before {
    content: 'üá≤üáΩ';
    position: absolute;
    top: -5px; left: 10px;
    font-size: 20px;
    transform: rotate(-15deg);
    z-index: 1;
    background: none; /* Sobrescribe la barra de gradiente */
    height: auto;
}
[data-theme="mexicano1"] .mex-frame::after,
[data-theme="mexicano1"] .mex-frame-small::after {
    content: 'üéâ';
    position: absolute;
    top: 0; right: 10px;
    font-size: 20px;
    transform: rotate(15deg);
    z-index: 1;
}

/* TEMA 3: Mexicano 2 (Ne√≥n y Fuegos Artificiales) */
[data-theme="mexicano2"] {
    --rojo: #d00000;
    --verde: #008000;
    --azul: #0077b6;
    --naranja: #f77f00;
    --crema: #fff8ec;
    --accent1: #ffd60a;
    --accent2: #e63946;
    --texto-principal: #222;
    --texto-secundario: #555;
    --borde-cabecera: #d00000;
    --gradiente-barra: linear-gradient(90deg, var(--verde) 0%, var(--accent1) 50%, var(--rojo) 100%);
    --fondo-calculadora: #fffbe6;
}
/* Efecto Ne√≥n (Mexicano 2) */
@keyframes neonGlow {
    0%, 100% { box-shadow: 0 0 5px var(--verde), 0 0 10px var(--verde), 0 0 15px #fff, 0 0 20px #fff, 0 0 25px var(--rojo), 0 0 30px var(--rojo); }
    50% { box-shadow: 0 0 10px var(--verde), 0 0 15px var(--verde), 0 0 20px #fff, 0 0 30px #fff, 0 0 40px var(--rojo), 0 0 50px var(--rojo); transform: scale(1.1); }
}
[data-theme="mexicano2"] .winner-card {
    animation: neonGlow 1.5s infinite ease-in-out;
}


/* TEMA 4: Halloween */
[data-theme="halloween"] {
    --rojo: #FF4500;
    --verde: #5e0873; /* Morado */
    --azul: #9400D3; 
    --naranja: #FF8C00;
    --crema: #fdfbf5; /* Crema 'hueso' */
    --accent1: #adff02; /* Verde Lima */
    --accent2: #FF4500;
    --texto-principal: #1a1a1a;
    --texto-secundario: #444;
    --borde-cabecera: #FF4500;
    --gradiente-barra: linear-gradient(90deg, var(--accent1) 0%, var(--azul) 50%, var(--rojo) 100%);
    --fondo-calculadora: #f9f2e8;
}
[data-theme="halloween"] body {
    background-image: radial-gradient(var(--naranja) 0.5px, transparent 0.5px), radial-gradient(var(--azul) 0.5px, transparent 0.5px);
}
/* Efecto Telara√±a en botones y cartas */
[data-theme="halloween"] .btn::after,
[data-theme="halloween"] .player-card::after {
    content: 'üï∏Ô∏è';
    position: absolute;
    top: -5px; right: -5px;
    font-size: 20px;
    opacity: 0.15;
    z-index: 1;
    pointer-events: none;
}
/* Efecto Mancha de Sangre */
[data-theme="halloween"] body::after {
    content: 'ü©∏';
    position: fixed;
    bottom: -20px;
    right: -20px;
    font-size: 150px;
    opacity: 0.2;
    transform: rotate(-15deg);
    z-index: -1;
}


/* TEMA 5: Navidad */
[data-theme="navidad"] {
    --rojo: #c1121f;
    --verde: #005f08;
    --azul: #0077b6;
    --naranja: #f77f00;
    --crema: #fdfdfd;
    --accent1: #ffd700;
    --accent2: #c1121f;
    --texto-principal: #000;
    --texto-secundario: #444;
    --borde-cabecera: #005f08;
    --gradiente-barra: linear-gradient(90deg, var(--verde) 0%, var(--accent1) 50%, var(--rojo) 100%);
    --fondo-calculadora: #f0f8ff;
}
[data-theme="navidad"] body {
    background-image: radial-gradient(var(--rojo) 0.5px, transparent 0.5px), radial-gradient(var(--verde) 0.5px, transparent 0.5px);
}

/* TEMA 6: Pascua */
[data-theme="pascua"] {
    --rojo: #ffb3c1;
    --verde: #a9def9;
    --azul: #e6c0e9;
    --naranja: #f9c74f;
    --crema: #f8f9fa;
    --accent1: #d4e09b;
    --accent2: #ffb3c1;
    --texto-principal: #222;
    --texto-secundario: #555;
    --borde-cabecera: var(--rojo);
    --gradiente-barra: linear-gradient(90deg, var(--verde) 0%, var(--accent1) 50%, var(--rojo) 100%);
    --fondo-calculadora: #fff;
}
[data-theme="pascua"] body {
     background-image: radial-gradient(var(--rojo) 1px, transparent 1px), radial-gradient(var(--azul) 1px, transparent 1px);
}

/* TEMA 7: Santos Reyes */
[data-theme="reyes"] {
    --rojo: #D4AF37;
    --verde: #5a189a;
    --azul: #003049;
    --naranja: #D4AF37;
    --crema: #f1faee;
    --accent1: #D4AF37;
    --accent2: #5a189a;
    --texto-principal: #000;
    --texto-secundario: #444;
    --borde-cabecera: var(--verde);
    --gradiente-barra: linear-gradient(90deg, var(--verde) 0%, var(--rojo) 50%, var(--azul) 100%);
    --fondo-calculadora: #fdfcdc;
}
[data-theme="reyes"] body {
     background-image: radial-gradient(var(--rojo) 1px, transparent 1px), radial-gradient(var(--verde) 1px, transparent 1px);
}


/* -------------------------------------------
  FIN DE TEMAS
  ------------------------------------------- */

/* -------------------------------------------
  EFECTOS DE TEMA
  ------------------------------------------- */

/* Efecto Telara√±as (Halloween) */
.webs-overlay { display: none; }
[data-theme="halloween"] .webs-overlay {
    display: block;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    pointer-events: none;
    z-index: 9990;
}
.webs-overlay::before, .webs-overlay::after {
    content: 'üï∏Ô∏è';
    font-size: 150px;
    position: absolute;
    opacity: 0.15;
}
.webs-overlay::before { top: -20px; left: -20px; }
.webs-overlay::after { top: -20px; right: -20px; transform: scaleX(-1); }
#webs-overlay .web-bottom-left, #webs-overlay .web-bottom-right {
    content: 'üï∏Ô∏è';
    font-size: 100px;
    position: absolute;
    opacity: 0.15;
    bottom: -20px;
}
.web-bottom-left { left: -20px; transform: scaleY(-1); }
.web-bottom-right { right: -20px; transform: scale(-1, -1); }


/* Efecto Nieve/Regalos (Navidad) */
.snow-overlay { display: none; }
[data-theme="navidad"] .snow-overlay {
    display: block;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    pointer-events: none;
    z-index: 9990;
}
.snow-overlay .snow {
    position: absolute;
    top: -20px;
    color: var(--azul);
    font-size: 20px;
    animation: falling 10s linear infinite;
}
.snow-overlay .snow:nth-child(2) { left: 20%; animation-duration: 12s; animation-delay: 1s; font-size: 15px;}
.snow-overlay .snow:nth-child(3) { left: 40%; animation-duration: 8s; animation-delay: 2s; font-size: 10px;}
.snow-overlay .snow:nth-child(4) { left: 60%; animation-duration: 11s; animation-delay: 3s; font-size: 24px;}
.snow-overlay .snow:nth-child(5) { left: 80%; animation-duration: 9s; animation-delay: 4s; font-size: 12px;}
.snow-overlay .snow:nth-child(6) { left: 90%; animation-duration: 10s; animation-delay: 2s; font-size: 20px;}
@keyframes falling {
    0% { transform: translateY(0) rotate(0); opacity: 1; }
    100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
}

/* Efecto Luces (Navidad) */
.lights-overlay { display: none; }
[data-theme="navidad"] .lights-overlay {
    display: flex;
    justify-content: space-around;
    position: absolute;
    top: 0px; left: 0; right: 0;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
}
.lights-overlay .light {
    display: inline-block;
    width: 10px; height: 16px;
    background: #555;
    border-radius: 50%;
    margin: 0 5px;
    animation: twinkleLights 2s infinite;
}
.lights-overlay .light:nth-child(1) { --light-color: #ff0000; animation-delay: 0s; }
.lights-overlay .light:nth-child(2) { --light-color: #00ff00; animation-delay: 0.2s; }
.lights-overlay .light:nth-child(3) { --light-color: #ffd700; animation-delay: 0.4s; }
.lights-overlay .light:nth-child(4) { --light-color: #0000ff; animation-delay: 0.6s; }
.lights-overlay .light:nth-child(5) { --light-color: #ff00ff; animation-delay: 0.8s; }
.lights-overlay .light:nth-child(6) { --light-color: #00ffff; animation-delay: 1s; }
.lights-overlay .light:nth-child(7) { --light-color: #ff0000; animation-delay: 1.2s; }
.lights-overlay .light:nth-child(8) { --light-color: #00ff00; animation-delay: 1.4s; }
.lights-overlay .light:nth-child(9) { --light-color: #ffd700; animation-delay: 1.6s; }
.lights-overlay .light:nth-child(10){ --light-color: #0000ff; animation-delay: 1.8s; }
@keyframes twinkleLights {
    0%, 100% { background: var(--light-color); box-shadow: 0 0 5px 2px var(--light-color); }
    50% { background: #555; box-shadow: none; }
}

/* Efecto Estrellas/Regalos (Reyes) */
.stars-overlay { display: none; }
[data-theme="reyes"] .stars-overlay {
    display: block;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    pointer-events: none;
    z-index: 9990;
}
.stars-overlay .star {
    position: absolute;
    top: -20px;
    color: var(--rojo);
    font-size: 20px;
    animation: falling 10s linear infinite;
}
.stars-overlay .star.lucero {
    font-size: 40px;
    left: 10%;
    animation: falling 15s linear infinite, pulseTitle 2s infinite;
}
.stars-overlay .star:nth-child(2) { left: 20%; animation-duration: 12s; animation-delay: 1s; font-size: 15px;}
.stars-overlay .star:nth-child(3) { left: 40%; animation-duration: 8s; animation-delay: 2s; font-size: 10px;}
.stars-overlay .star:nth-child(4) { left: 60%; animation-duration: 11s; animation-delay: 3s; font-size: 24px;}
.stars-overlay .star:nth-child(5) { left: 80%; animation-duration: 9s; animation-delay: 4s; font-size: 12px;}
.stars-overlay .star:nth-child(6) { left: 90%; animation-duration: 10s; animation-delay: 2s; font-size: 20px;}

/* Efecto Pascua */
.pascua-overlay { display: none; }
[data-theme="pascua"] .pascua-overlay {
    display: block;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    pointer-events: none;
    z-index: 9990;
}
.pascua-overlay .item {
    position: absolute;
    top: -20px;
    font-size: 20px;
    animation: bounceFall 8s linear infinite;
}
.pascua-overlay .item:nth-child(2) { left: 20%; animation-duration: 12s; animation-delay: 1s; font-size: 15px;}
.pascua-overlay .item:nth-child(3) { left: 40%; animation-duration: 8s; animation-delay: 2s; font-size: 10px;}
.pascua-overlay .item:nth-child(4) { left: 60%; animation-duration: 11s; animation-delay: 3s; font-size: 24px;}
.pascua-overlay .item:nth-child(5) { left: 80%; animation-duration: 9s; animation-delay: 4s; font-size: 12px;}
.pascua-overlay .item:nth-child(6) { left: 90%; animation-duration: 10s; animation-delay: 2s; font-size: 20px;}
@keyframes bounceFall {
  0% { transform: translateY(0) rotate(0); opacity: 1; }
  25% { transform: translateY(25vh) rotate(90deg); }
  50% { transform: translateY(50vh) rotate(180deg); }
  75% { transform: translateY(75vh) rotate(270deg); }
  100% { transform: translateY(110vh) rotate(360deg); opacity: 0; }
}

/* Efecto Fuegos Artificiales (Mexicano 2) */
#fireworks-overlay { display: none; }
[data-theme="mexicano2"] #fireworks-overlay.active {
    display: block;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    pointer-events: none;
    z-index: 9998;
}
.firework {
    position: absolute;
    opacity: 0;
    animation: firework-pop 2.5s ease-out forwards;
}
.firework .particle {
    position: absolute;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    animation: firework-particle 1s ease-out forwards;
}
@keyframes firework-pop { 0% { opacity: 1; transform: scale(0.1); } 30% { opacity: 1; transform: scale(1); } 100% { opacity: 0; } }
@keyframes firework-particle { 0% { transform: translate(0, 0); opacity: 1; } 100% { transform: translate(var(--x-end), var(--y-end)); opacity: 0; } }


/* -------------------------------------------
  FIN EFECTOS DE TEMA
  ------------------------------------------- */


/* GENERALES */
*{box-sizing:border-box} 
html{ margin:0; padding:0; }
body{ 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
  background:var(--crema); 
  color:var(--texto-principal);
  background-image: radial-gradient(var(--accent1) 1px, transparent 1px), radial-gradient(var(--rojo) 1px, transparent 1px);
  background-position: 0 0, 25px 25px; 
  background-size: 50px 50px;
  overflow-x: hidden; 
  margin:0; 
  padding:0;
  transition: background 0.3s, color 0.3s;
}

/* CONTENEDOR PRINCIPAL CENTRADO */
.container{ 
  max-width: 1600px; 
  width: 100%; 
  margin: 0 auto;
  padding: 10px; 
  display: flex;
  flex-direction: column;
  min-height: 98vh; 
}

/* ENCABEZADO */
.main-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 0;
    margin-bottom: 10px;
    background: rgba(255,255,255,0.85);
    backdrop-filter: blur(5px);
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    border-bottom: 3px solid var(--borde-cabecera);
    transition: background 0.3s, border-bottom 0.3s;
    position: relative; 
    overflow: hidden;
}

.logo-box-wrapper{
  flex-shrink: 0;
  width: 90px; 
  height: 90px;
  margin-left: 15px;
}

.logo-box img{ 
  width:100%; 
  height:100%;
  object-fit:contain; 
  filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));
}

.title-container {
    flex-grow: 1;
    text-align: center;
    padding: 0 15px;
}

.title { 
  font-size: clamp(32px, 5vw, 48px);
  font-weight: 900; 
  color: var(--rojo); 
  margin:0; 
  line-height: 1.1;
  text-transform: uppercase;
  letter-spacing: -1px;
  text-shadow: 2px 2px #fff, 4px 4px var(--accent1);
  animation: pulseTitle 2.5s infinite;
  transition: color 0.3s, text-shadow 0.3s;
}

.subtitle { 
  color: var(--verde); 
  font-size: 15px;
  margin-top: 4px; 
  font-weight: 600;
  text-shadow: 1px 1px rgba(255,255,255,0.5);
  transition: color 0.3s, text-shadow 0.3s;
}

@keyframes pulseTitle {
  0%, 100% { color: var(--rojo); text-shadow: 2px 2px #fff, 4px 4px var(--accent1); }
  50% { color: var(--verde); text-shadow: 2px 2px #fff, 4px 4px var(--rojo); }
}


/* MAIN GRID */
.main-grid{ 
  display:grid;
  grid-template-columns: 260px 1fr 340px; 
  gap:12px; 
  align-items:start;
  flex-grow: 1;
}
@media(max-width:1100px){ .main-grid{ grid-template-columns: 240px 1fr; } .controls-panel{ grid-column: 1 / -1; grid-row: 1; } #winners-panel { grid-row: 2; } #players-section { grid-row: 2; }}
@media(max-width:850px){ .main-grid{ grid-template-columns: 1fr; } .controls-panel, #winners-panel, #players-section { grid-column: auto; grid-row: auto; } }

.mex-frame, .mex-frame-small{ 
  background:#fff; 
  border-radius:12px; 
  padding:12px; 
  box-shadow:var(--sombra); 
  border: none;
  position: relative;
  overflow: hidden;
  transition: background 0.3s;
}
.mex-frame::before, .mex-frame-small::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px;
    background: var(--gradiente-barra);
    transition: background 0.3s;
}

/* CONTROLES HEADER */
.header-controls-wrapper {
  margin-right: 15px;
  display: flex;
  gap: 10px;
  align-items: center;
}

.bolsa-compact{ 
  display:flex; 
  flex-direction: column; 
  align-items: center; 
  justify-content: center; 
  padding: 8px 16px; 
  background: var(--crema); 
  border-radius: 8px; 
  border: 2px solid var(--accent1); 
  transition: background 0.3s;
}
.bolsa-compact .label{ 
  font-size:14px; 
  font-weight:800; 
  color:var(--verde); 
  text-transform: uppercase; 
}
.bolsa-compact .amount{ 
  font-weight:900; 
  color:var(--rojo); 
  font-size:24px; 
  line-height: 1.1; 
}

.toggle-btn{ 
  padding:8px 12px; border-radius:8px; border:none; font-weight:700; cursor:pointer; 
  transition: all .2s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.toggle-btn:hover{ transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
.toggle-play{ background:var(--azul); color:white; }
.toggle-admin{ background:#e0e0e0; color:#333; }

/* JUGADORES */
.players-grid{ 
  display:grid; 
  grid-template-columns: repeat(5, 1fr); 
  gap:6px; 
}

.player-card{ 
  background:#fff; border-radius:8px; padding:5px; text-align:center;
  box-shadow: 0 2px 5px rgba(0,0,0,0.08); cursor:pointer; transition:all .2s ease;
  border: 1px solid #ddd; 
  min-height: 110px; 
  display: flex; 
  flex-direction: column; 
  justify-content: flex-start; 
  transition: background 0.3s, border-color 0.3s;
  position: relative;
  overflow: hidden; /* Para las telara√±as */
}
.player-card:hover{ transform:translateY(-2px); box-shadow: 0 5px 12px rgba(0,0,0,0.12); border-color: var(--accent1); }
.player-name{ 
    font-weight:800; font-size:12px; 
    color: var(--azul); margin-bottom: 2px; 
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
}
.player-info { display: none; }

.card-thumb{ 
  width:48px; height:70px; border-radius:5px; background-size:cover; background-position:center; 
  position:relative; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.player-cards .card-thumb { 
    width: 100%; height: auto; aspect-ratio: 3/4.5; 
    min-width: 25px; 
} 

#players-area .card-thumb.drawn { filter:grayscale(1) opacity(0.6); }
#players-area .card-thumb.drawn .sticker { filter: grayscale(0) opacity(1); }


.sticker{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; }
.sticker img{ width:70%; height:70%; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }

.card-thumb.shine::before{
    content:'';
    position:absolute;
    top:0;left:-80%;
    width:60%;height:100%;
    background:linear-gradient(120deg, rgba(255,200,80,0.95), rgba(255,200,80,0.0));
    transform:skewX(-20deg);
    z-index:3;
    animation:shineMove .9s linear 0s 2
}
@keyframes shineMove{100%{left:140%}}


/* CONTROLES JUEGO */
#control-partida h3 { color: var(--rojo); text-align: center; margin-top: 0; }
.controls { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top:10px; }
.btn{ 
  padding:10px 16px; border-radius:8px; font-weight:800; border:none; cursor:pointer; color:white;
  transition: transform .1s active, box-shadow .2s ease, background-color 0.3s; 
  text-transform: uppercase; letter-spacing: 0.5px; font-size: 14px;
  position: relative;
  overflow: hidden;
}
.btn:active { transform: scale(0.98); }
.btn:disabled { background: #999; cursor: not-allowed; opacity: 0.7; }

.btn-blue{ background:var(--azul); } .btn-red{ background:var(--rojo); } .btn-green{ background:var(--verde); } .btn-muted{ background:#aaa; }

.current-card{ 
  height:240px; border-radius:12px; display:flex; align-items:center; justify-content:center; 
  background: #fff; 
  border: 2px dashed #ddd; margin-top: 10px; overflow: hidden;
  transition: background 0.3s;
}
.current-card-img { width: 100%; height: 100%; background-size: contain; background-position: center; background-repeat: no-repeat; }

/* ADMIN */
.admin-row{ display:flex; gap:10px; flex-wrap: wrap; }
.admin-col{ flex:1; min-width: 300px; }
.input{ width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; margin-bottom: 8px; font-family: inherit; transition: background 0.3s, color 0.3s, border-color 0.3s; }
.input:focus { outline: 2px solid var(--azul); border-color: transparent; }

.admin-col.mex-frame-small .input { text-align: center; }
.admin-col.mex-frame-small label { display: block; text-align: center; }

#calc-info { 
    font-size: 16px; 
    color: var(--azul); 
    margin-top:10px; 
    min-height:20px; 
    text-align: center; 
    font-weight: bold; 
    border-top: 2px dashed var(--accent1);
    padding-top: 10px;
}
#budget-helper {
    font-size: 13px; 
    color: var(--texto-secundario); 
    margin-top: 10px; 
    min-height: 20px; 
    text-align: center;
}
.input-hint { 
    font-size: 12px; 
    font-weight: 600; 
    text-align: left; 
    margin-top: -4px; 
    margin-bottom: 8px; 
    min-height: 16px;
    padding-left: 5px;
}
.input-hint.valid { color: var(--verde); }
.input-hint.invalid { color: var(--rojo); }


.table-wrap{ overflow-x:auto; background: #fff; border-radius: 8px; border: 1px solid #eee; }
table { width: 100%; border-collapse: collapse; font-size: 13px; }
th { background: var(--azul); color: white; text-align: left; padding: 8px; position: sticky; top: 0; transition: background 0.3s; }
td { border-bottom: 1px solid #eee; padding: 8px; }
tr:hover { background: #f9f9f9; }

/* MODALES */
.modal-back{ position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter: blur(3px); display:flex; align-items:center; justify-content:center; z-index:9999; opacity: 1; pointer-events: all; transition: opacity 0.3s ease; }
.modal{ background:#fff; border-radius:15px; padding:20px; width:90%; max-width:500px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); position: relative; transform: translateY(0); transition: transform 0.3s ease; max-height: 90vh; overflow-y: auto; }

.modal-back.hidden { opacity: 0; pointer-events: none; }
.modal-back.hidden .modal { transform: translateY(20px); }

.close-modal-x { position: absolute; top: 10px; right: 15px; font-size: 24px; background: none; border: none; cursor: pointer; color: #999; }
.close-modal-x:hover { color: var(--rojo); }

.modal-alert .modal-body, .modal-confirm .modal-body {
    font-size: 18px;
    text-align: center;
    padding: 20px 10px;
    line-height: 1.5;
}
.modal-alert .modal-footer, .modal-confirm .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}
.modal-confirm .modal-footer { justify-content: space-between; }


/* WINNER ANIMATIONS */
@keyframes mexicanGlow {
    0% { box-shadow: 0 0 5px var(--verde), 0 0 10px var(--crema), 0 0 15px var(--rojo); }
    50% { box-shadow: 0 0 20px var(--verde), 0 0 30px var(--accent1), 0 0 40px var(--rojo); transform: scale(1.18); }
    100% { box-shadow: 0 0 5px var(--verde), 0 0 10px var(--crema), 0 0 15px var(--rojo); }
}
.winner-card {
    animation: mexicanGlow 1.5s infinite ease-in-out;
    z-index: 10;
}

/* --- SHUFFLE OVERLAY --- */
#shuffle-overlay{
  position:fixed; 
  inset:0; 
  display:none; 
  align-items:center; 
  justify-content:center; 
  background:rgba(0,0,0,0.45); 
  z-index:9998;
  backdrop-filter: blur(3px);
}
.shuffle-center{
  position:relative;
  width:880px;
  height:520px;
  max-width: 95vw;
  max-height: 90vh;
  transform: scale(0.8); 
}
.shuffle-card{
  position:absolute;
  width:120px; 
  height:180px; 
  border-radius:10px; 
  background-size:cover; 
  background-position:center; 
  box-shadow:0 12px 28px rgba(0,0,0,0.28); 
  transform-origin:center center;
}
.shuffle-card.flip{
  transform:rotateY(180deg) scale(.98); 
  transition:transform .6s;
}
.shuffle-card.wave-move{
  transition:transform .9s,opacity .9s;
}
/* --- FIN SHUFFLE OVERLAY --- */

#confetti-canvas { position: fixed; inset: 0; pointer-events: none; z-index: 9998; display: none; }
.hidden { display: none !important; }

/* UTILS */
.text-center { text-align: center; }
.mb-2 { margin-bottom: 0.5rem; }
.mt-2 { margin-top: 0.5rem; }
.w-full { width: 100%; }
.font-bold { font-weight: 700; }
.badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; color: white; }

.badge-jugando { background-color: var(--verde); } 
.badge-porpagar { background-color: var(--accent1); color: #333; animation: pulse 1s infinite; } 
.badge-pagado { background-color: var(--azul); } 
.badge-finalizado { background-color: #999; } 

@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

.winner-item.new {
    animation: fadeInDown 0.6s ease-out;
}
@keyframes fadeInDown {
    0% { opacity: 0; transform: translateY(-10px); }
    100% { opacity: 1; transform: translateY(0); }
}

</style>
</head>
<body>

<audio id="snd-win" src="APLAUSOS_GANADOR.mp3" preload="auto"></audio>
<audio id="snd-flip" src="flip.mp3" preload="auto"></audio>

<div id="webs-overlay" class="webs-overlay hidden">
    <div class="web-bottom-left"></div>
    <div class="web-bottom-right"></div>
</div>
<div id="snow-overlay" class="snow-overlay hidden">
    <div class="snow">‚ùÑÔ∏è</div><div class="snow">üéÑ</div><div class="snow">üéÅ</div><div class="snow">‚ùÑÔ∏è</div><div class="snow">üéÅ</div><div class="snow">üéÑ</div>
</div>
<div id="stars-overlay" class="stars-overlay hidden">
    <div class="star lucero">üåü</div><div class="star">‚ú®</div><div class="star">üéÅ</div><div class="star">‚ú®</div><div class="star">üéÅ</div><div class="star">‚ú®</div>
</div>
<div id="pascua-overlay" class="pascua-overlay hidden">
    <div class="item">üêá</div><div class="item">ü•ö</div><div class="item">üç¨</div><div class="item">üç≠</div><div class="item">üêá</div><div class="item">ü•ö</div>
</div>
<div id="fireworks-overlay" class="fireworks-overlay hidden"></div>

<div class="container">

  <header class="main-header">
      <div id="lights-overlay" class="lights-overlay hidden">
          <div class="light"></div><div class="light"></div><div class="light"></div><div class="light"></div><div class="light"></div>
          <div class="light"></div><div class="light"></div><div class="light"></div><div class="light"></div><div class="light"></div>
      </div>

      <div class="logo-box-wrapper">
          <div class="logo-box"><img id="logo-img" src="logo_1_entrada.png" alt="logo"></div>
      </div>

      <div class="title-container">
          <div class="title">üéâ GANA YA!</div>
          <div class="subtitle">Loter√≠a Interactiva Mexicana</div>
      </div>
      
      <div class="header-controls-wrapper">
          <div class="bolsa-compact">
              <span class="label" id="bolsa-label">üí∞ Bolsa</span>
              <span class="amount" id="bolsa-amount">$0.00</span>
          </div>
          <button id="btn-view-play" class="toggle-btn toggle-play">EN JUEGO</button>
          <button id="btn-view-admin" class="toggle-btn toggle-admin">‚öôÔ∏è</button>
      </div>
  </header>
  
  <div class="main-grid" id="main-grid">

    <aside class="mex-frame-small winners" id="winners-panel" aria-label="√öltimos Ganadores">
      <h3 class="text-center" style="color: var(--verde); margin-top:0;">üèÜ Ganadores Recientes</h3>
      <div class="winners-list" id="winners-list" style="margin-top:4px"><div class="small-muted" style="text-align:center">A√∫n no hay ganadores.</div></div>
    </aside>

    <section class="mex-frame" id="players-section">
      <h2 class="text-center" style="color: var(--azul); margin-top:0;">JUGADORES ACTIVOS</h2>
   
      <div class="players-grid" id="players-area" style="margin-top:8px">
        <div class="small-muted" style="padding:18px; text-align:center">A√∫n no hay jugadores.</div>
      </div>
    </section>

    <aside class="controls-panel mex-frame-small" id="controls-panel">
      
      <div id="control-partida">
 
        <h3>üéÆ CONTROL DE JUEGO</h3>

        <div style="margin-bottom: 15px;">
            <label for="select-modality" style="display:block; text-align:center; font-size:12px; color:var(--texto-secundario); margin-bottom:5px;">Modalidad Actual:</label>
            <select id="select-modality" class="input" style="text-align:center; font-weight:bold; font-size:16px;">
                <option value="4">4 cartas</option>
                <option value="6">6 cartas</option>
            </select>
        </div>

        <div id="game-controls" class="controls">
            <button id="btn-shuffle" class="btn btn-blue w-full">üîÄ BARAJEAR</button>
            <div style="display:flex; gap:8px; width:100%;">
                <button id="btn-draw" class="btn btn-red" style="flex:1;">üÉè TIRAR</button>
                <button id="btn-auto" class="btn btn-green" style="flex:1;">ü§ñ AUTO</button>
            </div>
        </div>

        <button id="btn-reset-win" class="btn btn-red w-full hidden" style="background: var(--verde); padding: 15px; font-size: 18px; animation: pulse 2s infinite;">üîÑ REINICIAR PARTIDA</button>

        <div class="text-center mt-2" style="color:var(--texto-secundario); font-size:13px; display: none;">
            Cartas restantes: <strong id="deck-count" style="color:var(--rojo)">54</strong>
        </div>
      </div>

      <div style="margin-top:20px">
        <h3 class="text-center" style="margin-bottom:10px; color:var(--azul)">CARTA EN JUEGO</h3>
        <div id="current-card" class="current-card">
            <div class="small-muted" style="color:var(--texto-secundario);">Esperando barajeo...</div>
        </div>
      </div>

      <div style="margin-top:20px">
        <h4 class="text-center" style="margin:0 0 10px 0; color:var(--texto-secundario); font-size:14px;">ANTERIORES</h4>
        <div id="last-cards" style="display:flex; gap:5px; justify-content:center; min-height:60px;"></div>
      </div>

    </aside>

  </div> 
  
  <section id="view-admin" class="mex-frame hidden" style="margin-top:10px;">
    <h2 style="color:var(--azul); margin-top:0; border-bottom:2px solid #eee; padding-bottom:10px;">‚öôÔ∏è Administraci√≥n de Caja</h2>
    
    <div class="admin-row">
      <div class="admin-col mex-frame-small">
        <h3 style="margin:0 0 8px 0">Modalidades - Precio & Ganancia</h3>
        <div class="price-grid" style="margin-top:4px; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <div class="price-box" style="padding:10px; border:1px solid #eee; border-radius:8px;">
            <div style="font-size:16px">4 Cartas</div>
            <div style="display:flex; gap:6px; margin-top:6px;">
              <input id="price4" class="input" type="number" value="10" min="1" title="Precio">
              <input id="profit4" class="input" type="number" value="2" min="0" title="Ganancia">
            </div>
            <div class="small-muted" style="margin-top:4px">Precio ‚Ä¢ Ganancia</div>
          </div>
          <div class="price-box" style="padding:10px; border:1px solid #eee; border-radius:8px;">
            <div style="font-size:16px">6 Cartas</div>
            <div style="display:flex; gap:6px; margin-top:6px;">
              <input id="price6" class="input" type="number" value="12" min="1" title="Precio">
              <input id="profit6" class="input" type="number" value="3" min="0" title="Ganancia">
            </div>
            <div class="small-muted" style="margin-top:4px">Precio ‚Ä¢ Ganancia</div>
          </div>
        </div>
        <div style="display:flex; gap:8px; margin-top:10px;">
          <button id="save-prices" class="btn btn-green">Guardar</button>
          <button id="reset-prices" class="btn btn-muted">Reset</button>
        </div>
        
        <div style="border-top: 2px solid #eee; margin-top: 15px; padding-top: 10px;">
            <label for="theme-switcher" style="display:block; text-align:center; font-weight:bold; color:var(--azul); margin-bottom:5px;">üé® Apariencia (Skin)</label>
            <select id="theme-switcher" class="input" style="text-align:center;">
                <option value="original">Original (Defecto)</option>
                <option value="mexicano1">Mexicano 1 (Fiesta)</option>
                <option value="mexicano2">Mexicano 2 (Ne√≥n)</option>
                <option value="halloween">Halloween</option>
                <option value="navidad">Navidad</option>
                <option value="pascua">Pascua</option>
                <option value="reyes">Santos Reyes</option>
            </select>
        </div>
      </div>

      <div class="admin-col mex-frame-small">
        <h3 style="margin-top:0; color:var(--rojo)">üìù Registrar Jugador</h3>
        <input id="input-name" placeholder="Nombre Completo" class="input">
        
        <div style="display:flex; gap:10px;">
            <div style="flex:1;">
                <input id="input-cell" placeholder="Celular (10 d√≠gitos)" class="input" style="flex:1" type="tel" maxlength="10">
                <div id="cell-hint" class="input-hint"></div>
            </div>
            <div style="flex:1;">
                <input id="input-clabe" placeholder="CLABE / Cuenta Destino" class="input" style="flex:1" type="tel" maxlength="18">
                <div id="clabe-hint" class="input-hint"></div>
            </div>
        </div>
        
        <div style="background:var(--fondo-calculadora); padding:10px; border-radius:8px; margin-top:10px;">
            <label style="font-size:13px; font-weight:bold; color:var(--azul)">üî¢ Calculadora R√°pida:</label>
            <input id="input-budget" placeholder="Ingresa Presupuesto MXN" class="input" type="number" min="0">
        </div>

        <div style="display:flex; gap:10px; align-items: flex-end; margin-top: 10px;">
            <div style="flex:1">
                <label style="font-size:12px;">Cant. 4 Cartas</label>
                <input id="qty4" type="number" min="0" value="0" class="input text-center">
            </div>
            <div style="flex:1">
                <label style="font-size:12px;">Cant. 6 Cartas</label>
                <input id="qty6" type="number" min="0" value="0" class="input text-center">
            </div>
            <button id="btn-register" class="btn btn-green" style="flex:1.5; height: 42px;">‚úÖ REGISTRAR</button>
        </div>
        
        <div id="budget-helper" style="font-size:13px; color:var(--texto-secundario); margin-top:10px; min-height:20px; text-align: center;">
            Ingresa un presupuesto para ver opciones.
        </div>
        <div id="calc-info" style="font-size:14px; color:var(--texto-principal); margin-top:12px; min-height:20px; text-align: center; font-weight: bold;">
            Costo Total: $0.00
        </div>
      </div>
    </div>

    <div class="mex-frame-small" style="margin-top:15px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-wrap:wrap; gap:10px;">
            <div style="display:flex; gap:5px; align-items:center;">
                <strong>Filtrar:</strong>
                <button class="toggle-btn" id="filter-all" style="background:#eee">Todos</button>
                <button class="toggle-btn" id="filter-4" style="background:#eee">4 Cartas</button>
                <button class="toggle-btn" id="filter-6" style="background:#eee">6 Cartas</button>
            </div>
            <div style="flex-grow: 1; max-width: 300px;">
                <input id="admin-search" placeholder="üîç Buscar por Folio o Nombre..." class="input" style="margin-bottom: 0; text-align:left;">
            </div>
            <div style="display:flex; gap:10px;">
                 <button id="btn-export" class="btn btn-blue">üìÑ Reporte PDF</button>
                 <button id="btn-reset-day" class="btn btn-red">üóëÔ∏è BORRAR D√çA</button>
            </div>
        </div>
        <div class="table-wrap">
            <table id="players-table-el" style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr><th>Folio</th><th>Jugador</th><th>Mod.</th><th>En Juego</th><th>Casa</th><th>Estado</th><th>Acci√≥n</th></tr>
                </thead>
                <tbody id="players-table">
                    </tbody>
            </table>
        </div>
    </div>
  </section>
  
  <footer style="text-align:center; margin-top:12px; padding: 10px; font-size: 13px; color: #777;" class="small-muted">
      Coloca <strong>logo_1_entrada.png</strong>, <strong>APLAUSOS_GANADOR.mp3</strong> y <strong>flip.mp3</strong> en la ra√≠z.<br>
      Coloca la carpeta <strong>Cartas_baraja_loteria/</strong> con las 54 im√°genes.
  </footer>
</div> <div class="modal-back hidden" id="modal-player">
    <div class="modal">
        <button class="close-modal-x" id="modal-close-x">√ó</button>
        <h3 id="modal-player-name" style="color:var(--azul); margin-top:0;">Detalle de Jugador</h3>
        <div id="modal-body" class="text-center"></div>
        <div id="modal-player-actions" class="mt-2" style="display:flex; flex-direction:column; gap:8px;">
        </div>
        <button id="modal-close" class="btn btn-muted mt-2 w-full">Cerrar</button>
    </div>
</div>

<div class="modal-back hidden" id="modal-winner">
    <div class="modal text-center" style="border: 5px solid var(--accent1);">
        <button class="close-modal-x" id="winner-close">√ó</button>
        <h1 id="winner-title" style="color:var(--rojo); font-size: 40px; margin:10px 0;">üéâ ¬°LOTER√çA! üéâ</h1>
        <div id="winner-body" style="font-size:22px; margin-bottom:10px;"></div>
        <div id="winner-sub" style="font-size:18px; margin-bottom:20px; color: var(--verde); font-weight: bold;"></div>
        <button id="winner-ok" class="btn btn-green" style="font-size:20px; padding:15px 30px;">¬°VER GANADOR!</button>
    </div>
</div>

<div class="modal-back hidden" id="modal-winner-detail">
    <div class="modal text-center">
        <button class="close-modal-x" id="winner-detail-close-x">√ó</button>
        <h2 style="color:var(--verde); margin-top:0; font-size: 28px;">üëë ¬°TENEMOS GANADOR!</h2>
        <h3 id="winner-detail-player-name" style="color:var(--azul); font-size: 22px;"></h3>
        <div id="winner-detail-card-name" style="font-weight:700; color:var(--rojo); margin-bottom: 15px; font-size: 20px;"></div>
        <div id="winner-detail-player-cards" style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin:20px 0;">
        </div>
        <button id="winner-detail-ok" class="btn btn-blue">Cerrar y Continuar</button>
    </div>
</div>

<div class="modal-back hidden" id="modal-alert">
    <div class="modal modal-alert">
        <div id="modal-alert-body" class="modal-body"></div>
        <div class="modal-footer">
            <button id="modal-alert-ok" class="btn btn-blue w-full">Aceptar</button>
        </div>
    </div>
</div>

<div class="modal-back hidden" id="modal-confirm">
    <div class="modal modal-confirm">
        <div id="modal-confirm-body" class="modal-body"></div>
        <div class="modal-footer">
            <button id="modal-confirm-cancel" class="btn btn-muted">Cancelar</button>
            <button id="modal-confirm-ok" class="btn btn-red">Confirmar</button>
        </div>
    </div>
</div>


<div id="shuffle-overlay" aria-hidden="true">
</div>
<canvas id="confetti-canvas"></canvas>


<script>
/* index_v12.0_pulido - code block */
const CARD_IMAGE_BASE_PATH='Cartas_baraja_loteria/';
const CARD_NAME_MAP = {1:"1 el gallo-min.jpg",2:"2 el diablito-min.jpg",3:"3 la dama-min.jpg",4:"4 el catrin-min.jpg",5:"5 el paraguas-min.jpg",6:"6 la sirena-min.jpg",7:"7 la escalera-min.jpg",8:"8 la botella-min.jpg",9:"9 el barril-min.jpg",10:"10 arbol-min.jpg",11:"11 melon-min.jpg",12:"12 el valiente-min.jpg",13:"13 el gorrito-min.jpg",14:"14 la muerte-min.jpg",15:"15 la pera-min.jpg",16:"16 la bandera-min.jpg",17:"17 el bandolon-min.jpg",18:"18 el violoncello-min.jpg",19:"19 la garza-min.jpg",20:"20 el pajaro-min.jpg",21:"21 la mano-min.jpg",22:"22 la bota-min.jpg",23:"23 la luna-min.jpg",24:"24 el cotorro-min.jpg",25:"25 el borracho-min.jpg",26:"26 el negrito-min.jpg",27:"27 el corazon-min.jpg",28:"28 la sandia-min.jpg",29:"29 el tambor-min.jpg",30:"30 el camaron-min.jpg",31:"31 las jaras-min.jpg",32:"32 el musico-min.jpg",33:"33 la ara√±a-min.jpg",34:"34 el soldado-min.jpg",35:"35 la estrella-min.jpg",36:"36 el cazo-min.jpg",37:"37 el mundo-min.jpg",38:"38 el apache-min.jpg",39:"39 el nopal-min.jpg",40:"40 el alacran-min.jpg",41:"41 la rosa-min.jpg",42:"42 la calavera-min.jpg",43:"43 la campana-min.jpg",44:"44 el cantarito-min.jpg",45:"45 el venado-min.jpg",46:"46 el sol-min.jpg",47:"47 la corona-min.jpg",48:"48 la chalupa-min.jpg",50:"50 el pescado-min.jpg",51:"51 la palma-min.jpg",52:"52 la maceta-min.jpg",53:"53 el arpa-min.jpg",54:"54 la rana-min.jpg",49:"49 el pino-min.jpg"};
const cardImageUrl = id => CARD_IMAGE_BASE_PATH + (CARD_NAME_MAP[id] ? CARD_NAME_MAP[id] : `${id}.jpg`);

const Kp='ganya_v90_prices', Kg='ganya_v90_game', Kpu='ganya_v90_purchases', Ktx='ganya_v90_tx', Kw='ganya_v90_winners', Kdig='ganya_v90_dig', Kmod='ganya_v90_mod', Kthm = 'ganya_v90_theme';
const Kid='ganya_v90_id_counter'; 
const defaultsPrices=()=>({price4:10,profit4:2,price6:12,profit6:3});
const defaultsGame=()=>({deck:Array.from({length:54},(_,i)=>i+1),drawn:[],current:0,pending:[], winnerPending: false});

let prices = load(Kp) || defaultsPrices();
let game = load(Kg) || defaultsGame();
let purchases = load(Kpu) || [];
let tx = load(Ktx) || [];
let winners = load(Kw) || [];
let drawnInGame = load(Kdig) || [];
let currentMode = Number(localStorage.getItem(Kmod) || 4);
if(currentMode===8) currentMode=4; 
let currentIdCounter = Number(localStorage.getItem(Kid) || 233); 
let adminSearch = '';
let currentTheme = localStorage.getItem(Kthm) || 'original';

let isAuto=false, autoInterval=null, animShuffling=false;
let audioCtx=null;
try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch(e){ audioCtx=null; }

// --- Helpers --- 
function $q(sel){return document.querySelector(sel)}
function $qa(sel){return Array.from(document.querySelectorAll(sel))}
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function load(k){ try{ const v=localStorage.getItem(k); return v? JSON.parse(v): null;}catch(e){return null;} }
function saveAll(){ save(Kp,prices); save(Kg,game); save(Kpu,purchases); save(Ktx,tx); save(Kw,winners); save(Kdig,drawnInGame); localStorage.setItem(Kmod,String(currentMode)); localStorage.setItem(Kid,String(currentIdCounter)); }

function getNextPurchaseId() {
    currentIdCounter += 1;
    localStorage.setItem(Kid, String(currentIdCounter));
    return `GanaYA!-` + String(currentIdCounter).padStart(4, '0');
}

function uuid(){ return 'id-'+Math.random().toString(36).slice(2,10); } 
function shuffle(a){ const arr=a.slice();
for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }
function formatMoney(n){ return '$'+Number(n||0).toFixed(2); }
function cardName(id){ 
    let baseName = CARD_NAME_MAP[id] ? CARD_NAME_MAP[id].replace(/^\d+\s*/,'').replace(/-min\.jpg$/,'').replace(/\.min\.jpg$/,'') : ('Carta '+id);
    return baseName.replace(/_/g, ' ').replace(/\.jpg/i, '').trim(); 
}

// --- Sonidos ---
function playSound(id) {
    const el = $q('#' + id);
    if(el) {
        el.currentTime = 0;
        el.play().catch(e => console.log("Audio play failed:", e));
    }
}

function playWinSound(){
    playSound('snd-win');
}

function playShuffleSound(){ 
    if(!audioCtx) return; 
    const now=audioCtx.currentTime; 
    const buf=audioCtx.createBuffer(1,audioCtx.sampleRate*0.22,audioCtx.sampleRate); 
    const d=buf.getChannelData(0); 
    for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*(1-i/d.length); 
    const s=audioCtx.createBufferSource(); 
    s.buffer=buf;
    const g=audioCtx.createGain();
    g.gain.setValueAtTime(0.04,now);
    s.connect(g);
    g.connect(audioCtx.destination);
    s.start(0); 
}

// --- Modales Personalizados ---
function showAlert(message) {
    return new Promise((resolve) => {
        $q('#modal-alert-body').innerHTML = message;
        $q('#modal-alert').classList.remove('hidden');
        $q('#modal-alert-ok').onclick = () => {
            $q('#modal-alert').classList.add('hidden');
            resolve(true);
        };
    });
}

function showConfirm(message, confirmText = "Confirmar") {
    $q('#modal-confirm-body').innerHTML = message;
    $q('#modal-confirm-ok').textContent = confirmText;
    const modal = $q('#modal-confirm');
    modal.classList.remove('hidden');

    return new Promise((resolve) => {
        $q('#modal-confirm-ok').onclick = () => {
            modal.classList.add('hidden');
            resolve(true);
        };
        $q('#modal-confirm-cancel').onclick = () => {
            modal.classList.add('hidden');
            resolve(false);
        };
    });
}
// --- Fin Modales Personalizados ---


// --- Confetti / Serpentinas --- 
let confettiInstance = null;
function startConfettiFullScreen(){
    // L√≥gica condicional de efectos
    if (currentTheme === 'mexicano2') {
        startFireworksAnimation();
        return;
    }
    
    const canvas=$q('#confetti-canvas');
    if(!canvas) return;
    canvas.style.display='block';
    if(confettiInstance){ confettiInstance.clear(); }
    
    // Confetti normal
    confettiInstance=confetti.create(canvas,{ resize:true, useWorker:true });
    const defaults = { origin: { y: 0.7 }, zIndex: 9998 };
    confettiInstance({ ...defaults, particleCount: 50, spread: 150, startVelocity: 40, scalar: 0.8 });
    confettiInstance({ ...defaults, particleCount: 40, spread: 90, startVelocity: 60, scalar: 1.0 });

    // Confetti de temporada
    if (currentTheme === 'halloween') {
        confettiInstance({ ...defaults, particleCount: 50, spread: 100, origin: { y: 0.6 }, colors: ['#FF4500', '#9400D3', '#adff02', '#000000'], shapes: ['square'], scalar: 0.7,
            ticks: 200, gravity: 0.8, decay: 0.92, startVelocity: 40,
            particleCount: 30,
        });
    }
}
function stopConfettiFullScreen(){
    const canvas=$q('#confetti-canvas');
    if(canvas) canvas.style.display='none';
    if(confettiInstance){ confettiInstance.clear(); confettiInstance=null; }
    
    $q('#fireworks-overlay').classList.remove('active');
    $q('#fireworks-overlay').innerHTML = '';
}

function startFireworksAnimation() {
    const overlay = $q('#fireworks-overlay');
    overlay.innerHTML = '';
    overlay.classList.add('active');
    
    const colors = ['var(--verde)', 'var(--accent1)', 'var(--rojo)', '#fff'];
    
    for(let i = 0; i < 5; i++) {
        const firework = document.createElement('div');
        firework.className = 'firework';
        firework.style.left = (Math.random() * 80 + 10) + '%';
        firework.style.top = (Math.random() * 40 + 30) + '%';
        firework.style.animationDelay = (Math.random() * 2) + 's';
        
        for(let j = 0; j < 12; j++) {
            const particle = document.createElement('span');
            particle.className = 'particle';
            const angle = (j / 12) * 360;
            const distance = Math.random() * 80 + 60;
            particle.style.background = colors[j % colors.length];
            particle.style.setProperty('--x-end', Math.cos(angle * Math.PI / 180) * distance + 'px');
            particle.style.setProperty('--y-end', Math.sin(angle * Math.PI / 180) * distance + 'px');
            firework.appendChild(particle);
        }
        overlay.appendChild(firework);
    }
}

// --- Control de Juego --- 
function stopAuto(){
    if(autoInterval){ clearInterval(autoInterval); autoInterval=null; }
    isAuto=false;
    const btn=$q('#btn-auto');
    if(btn){ btn.textContent='ü§ñ AUTO'; btn.classList.remove('btn-muted'); btn.classList.add('btn-green'); }
    renderAll();
}
function startAuto(){
    if(animShuffling || game.winnerPending) return;
    isAuto=true;
    const btn=$q('#btn-auto');
    if(btn){ btn.textContent='‚èπ DETENER'; btn.classList.remove('btn-green'); btn.classList.add('btn-muted'); }
    
    autoInterval=setInterval(drawOne, 1500); 
    renderAll();
}

function disableControls(disable){
    $q('#btn-shuffle').disabled = disable;
    $q('#btn-draw').disabled = disable;
    if (!isAuto) {
        $q('#btn-auto').disabled = disable;
    }
}

// --- Renderizado --- 
function renderPlayerCard(p){
    let html=`<div class="player-card" tabindex="0" data-player-id="${p.id}">`;
    html+=`<div class="player-name" title="${escapeHtml(p.playerName)}">${escapeHtml(p.playerName)}</div>`;
    html+=`<div class="player-cards" style="display:grid;grid-template-columns:repeat(${p.modality===4?2:3},1fr);gap:3px;justify-items:center;">`;
    (p.card||[]).forEach(cid=>{ 
        const isMarked = (p.markedCards||[]).includes(cid);
        const isDrawn = drawnInGame.includes(cid);
        const sticker = isMarked? `<div class="sticker"><img src="logo_1_entrada.png" alt="lg"/></div>` : '';
        const drawnClass = isDrawn ? 'drawn' : ''; 
        html+=`<div class="card-thumb ${drawnClass}" style="background-image:url('${cardImageUrl(cid)}')">${sticker}</div>`;
    });
    html+='</div></div>';
    return html;
}

function renderAll(){
    const isAdminView = !$q('#view-admin').classList.contains('hidden');
    const mainGridEl = $q('#main-grid');
    
    if (isAdminView) {
        if (mainGridEl) mainGridEl.style.display = 'none';
        $q('#btn-view-admin').classList.add('toggle-play');
        $q('#btn-view-admin').classList.remove('toggle-admin');
        $q('#btn-view-play').classList.remove('toggle-play');
        $q('#btn-view-play').classList.add('toggle-admin');
    } else {
        if (mainGridEl) mainGridEl.style.display = 'grid';
        $q('#btn-view-play').classList.add('toggle-play');
        $q('#btn-view-play').classList.remove('toggle-admin');
        $q('#btn-view-admin').classList.remove('toggle-play');
        $q('#btn-view-admin').classList.add('toggle-admin');
    }

    let potAmount = 0;
    let potLabelText = 'üí∞ Bolsa';
    purchases.forEach(p => initializePurchaseData(p));
    
    if (isAdminView) {
        const totalHouseProfit = purchases.reduce((s, p) => s + (p.casa || 0), 0);
        potAmount = totalHouseProfit;
        potLabelText = 'üè¶ CASA TOTAL';
    } else {
        // CORRECCI√ìN 2: El pozo solo incluye jugadores JUGANDO
        const activeForPot = purchases.filter(p=> p.state==='JUGANDO' && p.modality === currentMode );
        const totalEnJuego = activeForPot.reduce((s,p)=> s + (p.enJuego||0),0);
        potAmount = totalEnJuego;
        potLabelText = `üí∞ BOLSA (${currentMode} CARTAS)`;
    }

    animateBolsa(potAmount);
    const bolsaLabelEl = $q('#bolsa-label');
    if(bolsaLabelEl) bolsaLabelEl.textContent = potLabelText;
    
    const deckCount=$q('#deck-count');
    if(deckCount) deckCount.textContent=game.deck.length;
    
    const area=$q('#players-area');
    // CORRECCI√ìN 2: El grid solo muestra jugadores JUGANDO
    const active = purchases.filter(p=> p.state==='JUGANDO' && p.modality===currentMode);
    const hasActivePlayers = active.length > 0;
    
    let finalHtml = active.map(p=> renderPlayerCard(p)).join('');
    
    if (!hasActivePlayers) {
        area.innerHTML = '<div class="text-center small-muted" style="grid-column:1/-1; padding:30px; opacity:0.5;">No hay jugadores activos para '+currentMode+' cartas.</div>';
    } else {
        area.innerHTML = finalHtml;
    }
    
    const cur=$q('#current-card');
    if(game.current && cur) {
        cur.innerHTML=`<div class="current-card-img" style="background-image:url('${cardImageUrl(game.current)}')"></div>`; 
    } else if(cur) {
        cur.innerHTML='<div style="opacity:0.4; font-weight:bold; color:var(--texto-secundario);">LISTO PARA JUGAR</div>';
    }
    
    const last=(game.drawn||[]).slice(-4, -1).reverse();
    const lastEl=$q('#last-cards'); 
    if(lastEl) lastEl.innerHTML = last.length? 
        last.map(id=> `<div class="card-thumb" style="width:40px;height:55px;background-image:url('${cardImageUrl(id)}')"></div>`).join('') : '<div class="small-muted" style="color:var(--texto-secundario);">...</div>';

    const winnerPending = game.winnerPending || false;
    $q('#game-controls').classList.toggle('hidden', !!winnerPending);
    $q('#btn-reset-win').classList.toggle('hidden', !winnerPending);
    
    const gameInProgress = (game.drawn && game.drawn.length > 0);
    
    $q('#select-modality').disabled = (isAuto || winnerPending || gameInProgress);
    
    $q('#btn-draw').disabled = !hasActivePlayers || isAuto || animShuffling || winnerPending;
    $q('#btn-shuffle').disabled = !hasActivePlayers || isAuto || animShuffling || winnerPending;
    $q('#btn-auto').disabled = !hasActivePlayers || animShuffling || winnerPending;
    
    if (isAuto) {
        $q('#btn-draw').disabled = true;
        $q('#btn-shuffle').disabled = true;
        $q('#btn-auto').disabled = false; 
    }


    const currentFilter = $q('.toggle-btn[id^="filter-"][style*="background: var(--azul)"]');
    let filterValue = null;
    if (currentFilter) {
        if (currentFilter.id === 'filter-4') filterValue = 4;
        if (currentFilter.id === 'filter-6') filterValue = 6;
    }
    renderPlayersTable(filterValue);
    renderWinnersList();
    updateCalculatorInfo(false);
}

function renderWinnersList(){
    const listEl=$q('#winners-list');
    const sortedWinners = winners.slice().sort((a,b)=> b.ts-a.ts).slice(0,5);
    
    $qa('.winner-item.new').forEach(el => el.classList.remove('new'));

    if(!listEl) return;
    if(!sortedWinners.length){ listEl.innerHTML='<div class="text-center small-muted" style="padding: 20px; opacity: 0.6;">Sin ganadores hoy.</div>'; return; }

    const html = sortedWinners.map((w, index)=>{ 
        const player=purchases.find(p=>p.id===w.purchaseId);
        if(!player) return ''; 
        const paidText = w.paid ? 'PAGADO' : 'PENDIENTE';
        const paidColor = w.paid ? 'var(--verde)' : 'var(--rojo)';
        const isNew = index === 0 ? 'new' : '';
        
        const cardNameText = cardName(w.cardId).toUpperCase();
        const modalityText = `Modalidad: ${w.modality} cartas`;

        return `<div class="winner-item ${isNew}" style="padding:8px; border-bottom:1px solid #eee; font-size:13px; cursor:pointer;" onclick="showWinnerDetailModal('${w.purchaseId}','${w.cardId}')">
            <div style="font-weight:bold; color:var(--azul); display:flex; justify-content:space-between; align-items: center;">
                <span>${escapeHtml(player.playerName)}</span>
                <span style="color:${paidColor}; font-size: 11px; font-weight: 700;">${paidText}</span>
            </div>
            <div style="display:flex; justify-content:space-between; color:var(--texto-secundario); margin-top: 4px; align-items: center;">
                <span>${formatMoney(w.prize)}</span>
                <span style="font-size: 11px; color: #555;">${modalityText}</span>
            </div>
             <div style="text-align: right; font-size: 11px; color: var(--rojo); font-weight: 600; margin-top: 2px;">
                Gan√≥ con: ${cardNameText}
             </div>
        </div>`;
    }).join('');

    setTimeout(() => { listEl.innerHTML = html; }, 0);
}

function renderPlayersTable(filter){
    const tbody=$q('#players-table');
    let list = purchases.slice();
    
    if (adminSearch) {
        list = list.filter(p => 
            p.playerName.toLowerCase().includes(adminSearch) || 
            p.id.toLowerCase().includes(adminSearch)
        );
    }
    if (filter) {
        list = list.filter(p => p.modality === filter);
    }
    
    list.forEach(p => initializePurchaseData(p));
    
    const stateOrder = { 'POR PAGAR': 1, 'JUGANDO': 2, 'PAGADO': 3, 'FINALIZADO': 4 };
    list.sort((a, b) => {
        const stateA = stateOrder[a.state] || 5;
        const stateB = stateOrder[b.state] || 5;
        if (stateA !== stateB) {
            return stateA - stateB;
        }
        return b.createdAt - a.createdAt; 
    });

    if(!tbody) return;
    if(!list.length){ 
        tbody.innerHTML=`<tr><td colspan="7" style="text-align:center;padding:18px;color:#888">${adminSearch ? 'No hay resultados para "' + escapeHtml(adminSearch) + '"' : 'No hay operaciones.'}</td></tr>`; 
        return; 
    }
    
    tbody.innerHTML = list.map(p=>{
        let stateClass = 'badge-finalizado';
        if (p.state === 'JUGANDO') stateClass = 'badge-jugando';
        if (p.state === 'POR PAGAR') stateClass = 'badge-porpagar';
        if (p.state === 'PAGADO') stateClass = 'badge-pagado';

        return `<tr>
            <td style="padding:8px">${p.id}</td>
            <td style="padding:8px"><strong>${escapeHtml(p.playerName)}</strong><br><small>${escapeHtml(p.cell||'‚Äî')}</small></td>
            <td style="padding:8px;text-align:center">${p.modality}</td>
            <td style="padding:8px;text-align:center">${formatMoney(p.enJuego||0)}</td>
            <td style="padding:8px;text-align:center">${formatMoney(p.casa||0)}</td>
            <td style="padding:8px;text-align:center"><span class="badge ${stateClass}">${p.state||'JUGANDO'}</span></td>
            <td style="padding:8px;text-align:center"><button class="btn btn-blue" style="padding:4px 8px; font-size:11px;" onclick="openPurchaseDetail('${p.id}')">VER</button></td>
        </tr>`
    }).join('');
}

// --- Modales --- 
function openPurchaseDetail(id){
    const p=purchases.find(x=>x.id===id);
    if(!p) return showAlert('No se encontr√≥ al jugador.');
    initializePurchaseData(p);
    const modal=$q('#modal-player');
    $q('#modal-player-name').textContent=`${p.playerName}`;
    
    const isPending = p.state === 'POR PAGAR';
    const isPlaying = p.state === 'JUGANDO';
    
    const cards=(p.card||[]).map(cid=>{ 
        const isMarked = (p.markedCards||[]).includes(cid); 
        const sticker = isMarked? `<div class="sticker"><img src="logo_1_entrada.png" alt="lg"/></div>` : ''; 
        return `<div class="card-thumb" style="width:60px; height:90px; background-image:url('${cardImageUrl(cid)}');">${sticker}</div>`; 
    }).join('');
    
    let bodyHtml = `<div class="text-center">
        <p>Folio: <strong>${p.id}</strong> | Cel: ${p.cell || 'N/A'}</p>
        <p>CLABE/Cta: <strong>${p.clabe || 'No registrada'}</strong></p>
        <p>Modalidad: ${p.modality} Cartas</p>
        <hr>
        <div style="display:flex; justify-content:center; gap:8px; flex-wrap:wrap; margin:15px 0;">
             ${cards}
        </div>
    </div>`;
    $q('#modal-body').innerHTML = bodyHtml;

    const actionsDiv = $q('#modal-player-actions');
    actionsDiv.innerHTML = '';

    if(p.clabe && isPending) {
        actionsDiv.innerHTML += `<button class="btn btn-blue" onclick="copyClabe('${p.id}')">üìã Copiar CLABE/Cuenta</button>`;
    }
    if(isPending) {
        const pendingWin = winners.find(w => w.purchaseId === id && !w.paid);
        if (pendingWin) {
            actionsDiv.innerHTML += `<button class="btn btn-green" onclick="markPaidById('${p.id}', ${pendingWin.ts})">üí∏ Marcar como PAGADO y Notificar</button>`;
        }
    }
    if(isPlaying || isPending) {
        actionsDiv.innerHTML += `<button class="btn btn-muted" onclick="resendRegistrationWhatsapp('${p.id}')">üì± Reenviar Cartas (WhatsApp)</button>`;
    }

    modal.classList.remove('hidden');
    $q('#modal-close').onclick=closeGroupModal;
    $q('#modal-close-x').onclick=closeGroupModal;
}

function copyClabe(id){
    const p=purchases.find(x=>x.id===id);
    if(!p) return; 
    const text = p.clabe||'';
    if(!text) return showAlert('No hay CLABE registrada');
    navigator.clipboard.writeText(text).then(()=>showAlert('CLABE copiada al portapapeles.'));
}

window.resendRegistrationWhatsapp = function(id){
    const p=purchases.find(x=>x.id===id);
    if(!p) return; 

    const messageParts = [];
    const cardNames = (p.card||[]).map(cardName).join(', ');
    messageParts.push(`üéüÔ∏è *FOLIO ${p.id}* (${p.modality} Cartas):\n${cardNames}`);
    
    const finalMsg = `üéâ ¬°HOLA ${p.playerName.toUpperCase()}! BIENVENIDO A GANA YA! üéâ\n\n‚úÖ Tu registro fue exitoso. Aqu√≠ est√°n tus tableros para hoy:\n\n${messageParts.join('\n\n')}\n\nüçÄ ¬°MUCHA SUERTE Y A GANAR! üçÄ`;
    window.open(`https://wa.me/52${p.cell}?text=${encodeURIComponent(finalMsg)}`, '_blank');
};

function printPurchase(id){
    const p=purchases.find(x=>x.id===id);
    if(!p) return showAlert('No encontrado');
    const html = `<html><head><title>Ticket ${p.id}</title><style>
                body{ font-family:sans-serif; padding:12px; }
                .card-thumb{ width:74px; height:106px; border-radius:8px; background-size:cover; background-position:center; position:relative; display:inline-block; margin:4px;}
                .sticker{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; }
                .sticker img{ width:42px; height:42px; filter:none; }
            </style></head><body>
            <div style="text-align:center;">
                <img src="logo_1_entrada.png" style="width:80px;height:80px;object-fit:contain"/>
                <h2>¬°GANA YA!</h2><p><strong>Loter√≠a Interactiva Mexicana</strong></p>
            </div><hr>
            <h3>Detalle de Compra #${p.id}</h3>
            <p><strong>Jugador:</strong> ${escapeHtml(p.playerName)} (${escapeHtml(p.cell||'‚Äî')})</p>
            <p><strong>Modalidad:</strong> ${p.modality} cartas</p>
            <p><strong>Total Pagado:</strong> ${formatMoney(p.totalPaid)}</p>
            <p><strong>En Juego:</strong> ${formatMoney(p.enJuego || 0)}</p>
            <p><strong>Ganancia Casa:</strong> ${formatMoney(p.casa || 0)}</p>
            <hr><h4>Cartas Asignadas (${p.card.length})</h4>
            <div style="text-align:center;">
            ${(p.card||[]).map(cid=>{ 
                const isMarked = (p.markedCards||[]).includes(cid);
                const sticker = isMarked? `<div class="sticker"><img src="logo_1_entrada.png" alt="lg"/></div>` : ''; 
                return `<div class="card-thumb" style="background-image:url('${cardImageUrl(cid)}')">${sticker}</div>`;
            }).join('')}
            </div><hr>
            <p style="text-align:center; font-size:10px;">ID de registro: ${p.id}<br>Fecha: ${new Date(p.createdAt).toLocaleString()}</p>
        </body></html>`;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.print();
}

function initializePurchaseData(p){
    p.price = p.price || (p.modality === 4 ? prices.price4 : prices.price6);
    p.profit = p.profit || (p.modality === 4 ? prices.profit4 : prices.profit6);
    p.enJuego = p.price - p.profit;
    p.casa = p.profit;
    p.state = p.state || 'JUGANDO'; 
    p.markedCards = p.markedCards || [];
    p.gamesLeft = p.gamesLeft === undefined ? 1 : p.gamesLeft; 
    p.totalPaid = p.totalPaid || p.price;
}

function animateBolsa(targetAmount){
    const el=$q('#bolsa-amount');
    if(!el) return;
    let currentAmount=parseFloat(el.textContent.replace('$', '') || 0);
    const duration=800;
    let start=null;
    function step(timestamp){
        if(!start) start=timestamp;
        const progress=timestamp-start;
        const percentage=Math.min(progress/duration, 1);
        const nextAmount=currentAmount+(targetAmount-currentAmount)*percentage;
        el.textContent=formatMoney(nextAmount);
        if(percentage<1){ window.requestAnimationFrame(step); }
    }
    window.requestAnimationFrame(step);
}

// --- FUNCI√ìN DE ANIMACI√ìN DE BARAJEO ---
function animateShuffle(){
  if(window.animShuffling) return; 
  window.animShuffling=true;
  stopAuto();
  disableControls(true);
  
  const overlay = $q('#shuffle-overlay'); 
  overlay.style.display='flex'; 
  overlay.innerHTML='<div class="shuffle-center"></div>';
  const center = overlay.querySelector('.shuffle-center');
  
  const pending = shuffle(game.deck.slice()); 
  const sample = pending.slice(0, 20); 
  
  const cards = sample.map((cid,i)=>{
    const el=document.createElement('div'); 
    el.className='shuffle-card shuffle-wave'; 
    el.style.backgroundImage='url("' + cardImageUrl(cid) + '")'; 
    el.style.left='50%'; 
    el.style.top='50%'; 
    el.style.transform='translate(-50%,-50%)'; 
    el.style.zIndex=100+i; 
    center.appendChild(el); 
    return {el,cid};
  });
  
  // Wave 1
  cards.forEach((c,idx)=> setTimeout(()=>{ 
    const tx=(idx-cards.length/2)*18+(Math.random()*40-20); 
    const ty=-160+Math.random()*100; 
    const rot=(Math.random()*40-20);
    c.el.style.transition='transform 1.2s cubic-bezier(.22,.9,.32,1),opacity 1.2s'; 
    c.el.style.transform=`translate(${tx}px, ${ty}px) rotate(${rot}deg) scale(1)`;
    if(Math.random()>0.6) c.el.classList.add('flip');
    if(idx % 5 === 0) playShuffleSound(); 
  }, idx*60));
  
  // Wave 2
  setTimeout(()=>{ 
      cards.forEach((c,idx)=> setTimeout(()=>{ 
          const tx=(Math.random()*700-350); 
          const ty=(Math.random()*260-130); 
          const rot=(Math.random()*720-360); 
          c.el.classList.remove('flip'); 
          c.el.classList.add('wave-move'); 
          c.el.style.transform=`translate(${tx}px, ${ty}px) rotate(${rot}deg) scale(.94)`; 
          if(idx % 5 === 0) playShuffleSound(); 
      }, idx*50)); 
  }, 1600);
  
  // Wave 3 final gather
  setTimeout(()=>{ 
      playShuffleSound();
      cards.forEach((c,idx)=>{ 
          c.el.style.transition='transform .6s ease, opacity .6s ease'; 
          c.el.style.transform=`translate(${(idx-cards.length/2)*10}px, -30px) rotate(${Math.random()*18-9}deg) scale(.96)`; 
          c.el.innerHTML='<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;"><img src="logo_1_entrada.png" style="width:80px;height:80px;opacity:.95"></div>'; 
          c.el.style.backgroundImage='linear-gradient(#ddd,#bbb)'; 
      }); 
  }, 3200);
  
  // finalize
  setTimeout(()=>{
    $qa('#players-grid .card-thumb').forEach(c=>{ c.classList.add('shine'); setTimeout(()=>c.classList.remove('shine'),2600); });
    overlay.style.display='none'; 
    overlay.innerHTML=''; 
    window.animShuffling=false; 
    
    shufflePending(); 
    
    disableControls(false); 
    renderAll();
  }, 5200); 
}

function shufflePending(){
    game.deck = shuffle(game.deck);
    tx.push({id:uuid(),type:'shuffle_remaining',ts:Date.now()});
    saveAll();
}
// --- FIN ANIMACI√ìN BARAJEO ---

async function drawOne(){
    if(animShuffling || game.winnerPending) return;

    if(game.deck.length === 0){
        await showAlert('El mazo est√° vac√≠o. ¬°Reinicia la partida para barajear de nuevo!');
        stopAuto();
        return;
    }
    
    playSound('snd-flip');
    const card = game.deck.shift(); 
    game.drawn.push(card);
    game.current=card;
    drawnInGame.push(card); 
    
    tx.push({id:uuid(),type:'draw',card:card,ts:Date.now()});
    saveAll();
    processCard(card);
    renderAll();
}

function processCard(cardId){
    const winnersFound=[];
    purchases.forEach((p,i)=>{
        if(p.state !== 'JUGANDO' || p.modality !== currentMode) return;
        
        if(p.card && p.card.includes(cardId) && !(p.markedCards||[]).includes(cardId)){
            p.markedCards = [...(p.markedCards||[]), cardId];
        }

        if((p.markedCards||[]).length === p.modality){
            winnersFound.push({idx:i,purchaseId:p.id});
        }
    });

    if(winnersFound.length > 0){
        stopAuto();
        game.winnerPending = true;
        
        const firstWinner = winnersFound[0];
        const winningModality = purchases[firstWinner.idx].modality;
        
        const activeForPot = purchases.filter(p=> (p.state==='JUGANDO' || p.state === 'POR PAGAR') && p.modality === winningModality );
        activeForPot.forEach(p => initializePurchaseData(p));
        const totalEnJuego = activeForPot.reduce((s,p)=> s + (p.enJuego||0),0);
        
        const recs=[];
        
        const p = purchases[firstWinner.idx];
        p.wins=(p.wins||0)+1;
        p.state='POR PAGAR'; 
        p.prize=totalEnJuego;
        p.gamesLeft = 0; // CORRECCI√ìN 2: Consumir la partida al ganar
        
        const rec = {
            id: uuid(),
            purchaseId: p.id,
            playerName: p.playerName,
            modality: p.modality,
            cardId: cardId, 
            prize: totalEnJuego,
            paid: false,
            ts: Date.now()
        };
        winners.push(rec);
        recs.push(rec);
        tx.push({id:uuid(),type:'win',player:p.playerName,modality:p.modality,amount:totalEnJuego,card:cardId,purchaseId:p.id,ts:Date.now()});

        saveAll();
        window._tempWinnerRecs = recs; 

        const modal = $q('#modal-winner');
        $q('#winner-title').textContent = `üéâ ¬°LOTER√çA! üéâ`;
        const winnerName = purchases[firstWinner.idx].playerName;
        $q('#winner-body').innerHTML = `¬°Ganador con la carta <strong>${cardName(cardId).toUpperCase()}</strong>!:<br><br><div style="color:var(--azul); font-weight:900; font-size:24px;">${escapeHtml(winnerName)}</div>`;
        $q('#winner-sub').innerHTML = `Premio: <strong style="color:var(--verde);">${formatMoney(totalEnJuego)}</strong>`;
        modal.classList.remove('hidden');
        
        playWinSound(); 
        startConfettiFullScreen(); // Esto ahora es condicional (confetti o fuegos artificiales)

        renderAll();
    }
}

function showWinnerDetailModal(purchaseId, cardId){
    if(!purchaseId){
        if(!window._tempWinnerRecs || window._tempWinnerRecs.length === 0) return;
        purchaseId = window._tempWinnerRecs[0].purchaseId;
        cardId = window._tempWinnerRecs[0].cardId;
    }
    
    if(!cardId) {
        const winnerRec = winners.find(w => w.purchaseId === purchaseId && !w.paid);
        if(!winnerRec) {
             const anyWinnerRec = winners.find(w => w.purchaseId === purchaseId);
             if(anyWinnerRec) cardId = anyWinnerRec.cardId;
             else return;
        } else {
             cardId = winnerRec.cardId;
        }
    }

    const player = purchases.find(p=>p.id===purchaseId);
    if(!player) return;

    $q('#modal-winner').classList.add('hidden');
    
    const detailPlayerName = $q('#winner-detail-player-name');
    const detailCardName = $q('#winner-detail-card-name');
    const detailCardsContainer = $q('#winner-detail-player-cards');

    detailPlayerName.textContent = escapeHtml(player.playerName);
    detailCardName.textContent = 'Carta Ganadora: ' + cardName(cardId).toUpperCase();

    const cardListHtml = (player.card || []).map(cid => {
        const isMarked = (player.markedCards || []).includes(cid);
        const isWinner = (cid == cardId);
        const sticker = isMarked ? `<div class="sticker"><img src="logo_1_entrada.png" alt="lg"/></div>` : '';
        return `<div class="card-thumb ${isWinner ? 'winner-card' : ''}" style="width:80px; height:120px; background-image:url('${cardImageUrl(cid)}')">${sticker}</div>`;
    }).join('');
    detailCardsContainer.innerHTML = cardListHtml;

    const modalDetail = $q('#modal-winner-detail');
    modalDetail.classList.remove('hidden');
}

function closeWinnerDetailModal(){
    const modalDetail = $q('#modal-winner-detail');
    modalDetail.classList.add('hidden');
    delete window._tempWinnerRecs;
    stopConfettiFullScreen(); 
    renderAll(); 
}

function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[m])); }

async function markPaidById(id, ts){
    const p=purchases.find(x=>x.id===id);
    if(!p) return showAlert('No encontrado');

    let winnerRec;
    if (ts) {
        winnerRec = winners.find(w => w.purchaseId === id && w.ts === ts && !w.paid);
    } else {
        winnerRec = winners.find(w => w.purchaseId === id && !w.paid); 
    }
    
    if(!winnerRec) return showAlert('No se encontr√≥ registro de premio pendiente de pago para esta compra.');

    let winIndex = winners.findIndex(w => w.id === winnerRec.id);
    if (winIndex !== -1) {
        winners[winIndex].paid = true;
    }

    const hasOtherPendingWins = winners.some(w => w.purchaseId === id && !w.paid);

    if (!hasOtherPendingWins) {
        p.state = 'PAGADO';
        p.paidAt=Date.now();
    }
    
    tx.push({id:uuid(),type:'mark_paid',purchaseId:id, winnerId: winnerRec.id, ts:Date.now()});
    saveAll();
    renderAll();
    closeGroupModal();

    const prizeAmount = formatMoney(winnerRec.prize);
    const datePaid = new Date().toLocaleDateString('es-MX', { day: '2-digit', month: 'long', year: 'numeric' });
    const winningCardName = cardName(winnerRec.cardId);
    
    const message = `ü§ë ¬°FELICIDADES ${p.playerName.toUpperCase()}! ü§ë\n\nüí∏ TU PAGO HA SIDO ENVIADO üí∏\n\nüí∞ Monto: *${prizeAmount}*\nüè¶ Destino: Enviado ${p.clabe ? 'a la cuenta con terminaci√≥n *' + p.clabe.slice(-4) + '*' : 'a tu cuenta registrada'}\n‚è∞ Hora: ${new Date().toLocaleTimeString('es-MX')}\n\nüÉè Carta Ganadora: *${winningCardName.toUpperCase()}*\n\nü•≥ ¬°Que siga la racha!`;

    window.open(`https://wa.me/52${p.cell}?text=${encodeURIComponent(message)}`, '_blank');

    await showAlert('Marcado como PAGADO y mensaje de confirmaci√≥n de pago enviado por WhatsApp.');
};

function closeGroupModal(){
    const modal=$q('#modal-player');
    modal.classList.add('hidden');
}

function setActiveFilter(f){
    $qa('#filter-all, #filter-4, #filter-6').forEach(b=>{
        b.style.background = '#eee';
        b.style.color = '#333';
    });
    let activeBtnId = 'filter-all';
    if(f===4) activeBtnId = 'filter-4';
    if(f===6) activeBtnId = 'filter-6';
    
    const activeBtn = $q('#' + activeBtnId);
    activeBtn.style.background = 'var(--azul)';
    activeBtn.style.color = 'white';
}

function generateCardForPurchase(modality){
    let cards = Array.from({length:54},(_,i)=>i+1);
    const usedCards = purchases.filter(p => p.modality === modality && p.card).flatMap(p => p.card);
    const availableCards = cards.filter(c => !usedCards.includes(c));
    
    if (availableCards.length < modality) {
        cards = shuffle(cards);
    } else {
        cards = shuffle(availableCards);
    }
    return cards.slice(0, modality);
}

function updateCalculatorInfo(autoFill = false){
    const p4=prices.price4, p6=prices.price6;
    const budgetRaw=$q('#input-budget').value;
    const budget = budgetRaw===''?0:parseFloat(budgetRaw||0);

    let q4=parseInt($q('#qty4').value||0);
    let q6=parseInt($q('#qty6').value||0);
    
    const calcInfoEl = $q('#calc-info');
    const budgetInfoEl = $q('#budget-helper');
    
    if(autoFill && budget > 0) {
        const max4 = Math.floor(budget / p4);
        const max6 = Math.floor(budget / p6);
        budgetInfoEl.innerHTML = (budget > 0) 
            ? `Opciones: <strong style="color:var(--azul)">${max4}</strong> de 4 Cartas √≥ <strong style="color:var(--azul)">${max6}</strong> de 6 Cartas.`
            : 'Ingresa un presupuesto para ver opciones.';
    } else if (autoFill) {
         budgetInfoEl.innerHTML = 'Ingresa un presupuesto para ver opciones.';
    }
    
    const cost4 = q4*p4, cost6 = q6*p6, totalCost = cost4 + cost6;
    let msg = `Costo Total: <strong>${formatMoney(totalCost)}</strong>`;
    if(totalCost > budget && budget > 0){ msg += ` <span style="color:var(--rojo);font-weight:700;">(Faltan: ${formatMoney(totalCost - budget)})</span>`; }
    else if (budget > totalCost && totalCost > 0){ msg += ` <span style="color:var(--verde);font-weight:700;">(Sobrante: ${formatMoney(budget - totalCost)})</span>`; }
    
    calcInfoEl.innerHTML = msg;
}

async function registerPlayer(){
    const name=($q('#input-name').value||'').trim();
    const cell=($q('#input-cell').value||'').trim().replace(/\D/g,'');
    const clabe=($q('#input-clabe').value||'').trim().replace(/\D/g,'');
    const budgetRaw=$q('#input-budget').value;
    const budget = budgetRaw===''?0:parseFloat(budgetRaw||0);
    const q4=parseInt($q('#qty4').value||0), q6=parseInt($q('#qty6').value||0);

    if(!name) return showAlert('Captura el nombre');
    if(!cell || cell.length !== 10) return showAlert('Captura un n√∫mero de celular de 10 d√≠gitos.');
    if(q4+q6<=0) return showAlert('Selecciona al menos una partida (cantidad)');
    
    const needed = q4*prices.price4 + q6*prices.price6;
    
    if(budget > 0 && budget < needed){
        return showAlert(`El presupuesto de ${formatMoney(budget)} no es suficiente. Se requiere ${formatMoney(needed)}.`);
    }

    const parts=[];
    if(q4>0) parts.push({modality:4,qty:q4,price:prices.price4,profit:prices.profit4});
    if(q6>0) parts.push({modality:6,qty:q6,price:prices.price6,profit:prices.profit6});

    const messageParts = []; 
    
    parts.forEach(pt=>{
        const ptPrice = pt.price, ptProfit = pt.profit, ptEnJuego = ptPrice - ptProfit;
        for(let i=0;i<pt.qty;i++){
            const id = getNextPurchaseId(); 
            const p={
                id:id,playerName:name,cell:cell,clabe:clabe,
                modality:pt.modality, 
                initialGames:1, gamesLeft:1, 
                totalPaid:ptPrice, wins:0,state:'JUGANDO',card:[],markedCards:[],
                createdAt:Date.now(), price: ptPrice, profit: ptProfit, 
                enJuego: ptEnJuego, casa: ptProfit
            };
            p.card=generateCardForPurchase(pt.modality);
            purchases.push(p);
            const cardNames = p.card.map(cardName).join(', ');
            messageParts.push(`üéüÔ∏è *FOLIO ${p.id}* (${p.modality} Cartas):\n${cardNames}`);
            tx.push({id:uuid(),type:'purchase',player:name,modality:pt.modality,amount:ptPrice,purchaseId:p.id,ts:Date.now()});
        }
    });

    saveAll();
    
    $q('#input-name').value=''; $q('#input-cell').value=''; $q('#input-clabe').value='';
    $q('#input-budget').value=''; $q('#qty4').value='0'; $q('#qty6').value='0';
    $q('#budget-helper').textContent = 'Ingresa un presupuesto para ver opciones.';
    $q('#calc-info').textContent = 'Costo Total: $0.00';
    $q('#clabe-hint').textContent = '';
    $q('#cell-hint').textContent = '';

    const finalMsg = `üéâ ¬°HOLA ${name.toUpperCase()}! BIENVENIDO A GANA YA! üéâ\n\n‚úÖ Tu registro fue exitoso. Aqu√≠ est√°n tus tableros para hoy:\n\n${messageParts.join('\n\n')}\n\nüçÄ ¬°MUCHA SUERTE Y A GANAR! üçÄ`;
    window.open(`https://wa.me/52${cell}?text=${encodeURIComponent(finalMsg)}`, '_blank');
    await showAlert(`¬°${name} registrado con √©xito! (${q4+q6} partidas totales). Se abri√≥ WhatsApp para enviar el registro.`);
    renderAll();
}

async function resetGame(){
    const confirm = await showConfirm('¬øINICIAR NUEVA PARTIDA?<br><br>Esto finalizar√° la partida actual. Los ganadores quedar√°n "POR PAGAR" y los dem√°s jugadores de esta modalidad pasar√°n a "FINALIZADO".<br>Se reiniciar√° el mazo completo.', 'Reiniciar Partida');
    if(!confirm) return;
    
    game.winnerPending = false; 
    stopAuto();
    
    purchases.forEach(p=>{
        if (p.modality === currentMode) {
            if(p.state === 'JUGANDO'){
                p.state = 'FINALIZADO';
                p.gamesLeft = 0; 
            }
        }
        p.markedCards=[]; 
    });

    game.deck = shuffle(Array.from({length:54},(_,i)=>i+1));
    game.drawn=[]; game.current=0; drawnInGame=[];
    
    $q('#shuffle-overlay').classList.remove('visible');
    $q('#shuffle-overlay').style.display='none';
    tx.push({id:uuid(),type:'reset_full_deck',ts:Date.now()});
    saveAll();
    renderAll(); 
    showAlert('Partida anterior finalizada. Mazo reiniciado. ¬°Listo para una nueva partida!');
}

function exportPdf(){
    const date=new Date(), header=`Reporte de partidas ‚Äî GANA YA!`, logo='logo_1_entrada.png';
    let html=`<html><head><title>${header}</title><style>
        body{font-family:Arial;padding:12px;font-size:12px;}
        table{width:100%; border-collapse: collapse; margin-top: 10px;}
        th, td{padding:4px 6px; border: 1px solid #ccc; text-align:left;}
        th{background:#f0f0f0; text-align:center;}
        .text-center{text-align:center;}
        .text-right{text-align:right;}
        .summary-table td{font-size: 14px; font-weight: bold; padding: 8px;}
        .summary-table tr:last-child td { border-top: 2px solid #333; }
    </style></head><body>`;
    
    html+=`<div style="display:flex;gap:12px;align-items:center">
        <img src="${logo}" style="width:80px;height:80px;object-fit:contain"/>
        <div><h2>${header}</h2><p style="font-size:12px">Generado el ${date.toLocaleString()}</p></div>
    </div><hr>`;

    let totalRecaudado=0, totalPremios=0, totalCasa=0, totalPagado=0, totalPartidas=0;
    purchases.forEach(p=>{ 
        initializePurchaseData(p);
        totalRecaudado += (p.totalPaid||0); 
        totalCasa += (p.casa||0);
        totalPartidas++;
    });
    winners.forEach(w => {
        totalPremios += (w.prize || 0);
        if(w.paid) { totalPagado += (w.prize || 0); }
    });
    const gananciaNeta = totalRecaudado - totalPagado;

    html += `<div style="margin-top:20px;">
        <h3>Resumen Ejecutivo</h3>
        <table class="summary-table">
            <tr><td>Total Recaudado:</td><td class="text-right">${formatMoney(totalRecaudado)}</td></tr>
            <tr><td>Total Pagado a Ganadores:</td><td class="text-right" style="color:red;">(${formatMoney(totalPagado)})</td></tr>
            <tr><td style="font-weight:bold; color:green;">Ganancia Neta (en Caja):</td><td class="text-right" style="color:green;">${formatMoney(gananciaNeta)}</td></tr>
            <tr><td style="font-size:12px; font-weight:normal;">Total Apartado por la Casa (Bruto):</td><td class="text-right" style="font-size:12px; font-weight:normal;">${formatMoney(totalCasa)}</td></tr>
            <tr><td style="font-size:12px; font-weight:normal;">Total de Premios Pendientes:</td><td class="text-right" style="font-size:12px; font-weight:normal;">${formatMoney(totalPremios - totalPagado)}</td></tr>
            <tr><td style="font-size:12px; font-weight:normal;">Total de Partidas Vendidas:</td><td class="text-right" style="font-size:12px; font-weight:normal;">${totalPartidas}</td></tr>
        </table>
    </div>`;

    const pricesHtml = `<div style="margin-top:20px;">
        <h3>Configuraci√≥n de Precios</h3>
        <table>
            <tr><th>Modalidad</th><th>Precio</th><th>Ganancia Casa</th><th>Monto en Juego</th></tr>
            <tr><td class="text-center">4 Cartas</td><td class="text-center">${formatMoney(prices.price4)}</td><td class="text-center">${formatMoney(prices.profit4)}</td><td class="text-center">${formatMoney(prices.price4 - prices.profit4)}</td></tr>
            <tr><td class="text-center">6 Cartas</td><td class="text-center">${formatMoney(prices.price6)}</td><td class="text-center">${formatMoney(prices.profit6)}</td><td class="text-center">${formatMoney(prices.price6 - prices.profit6)}</td></tr>
        </table>
    </div>`;

    const playersHtml = `<div style="margin-top:20px;">
        <h3>Detalle de Jugadores y Compras</h3>
        <table>
            <thead><tr><th>ID</th><th>Jugador</th><th>Mod</th><th>En Juego</th><th>Casa</th><th>Estado</th></tr></thead>
            <tbody>
                ${purchases.map(p=>{ 
                    return `<tr>
                        <td style="padding:4px">${p.id}</td>
                        <td style="padding:4px">${escapeHtml(p.playerName)}<br><span style="color:#777">${escapeHtml(p.cell||'‚Äî')}</span></td>
                        <td class="text-center">${p.modality}</td>
                        <td class="text-center">${formatMoney(p.enJuego||0)}</td>
                        <td class="text-center">${formatMoney(p.casa||0)}</td>
                        <td class="text-center">${p.state||'JUGANDO'}</td>
                    </tr>`;
                }).join('')}
            </tbody>
        </table>
    </div>`;

    const winnersHtml = `<div style="margin-top:20px;">
        <h3>Detalle de Ganadores</h3>
        <table>
            <thead><tr><th>Fecha</th><th>Jugador</th><th>Carta Ganadora</th><th>Premio</th><th>Estado</th></tr></thead>
            <tbody>
                ${winners.slice().sort((a,b)=>b.ts-a.ts).map(w=>{ 
                    return `<tr>
                        <td style="padding:4px">${new Date(w.ts).toLocaleString()}</td>
                        <td style="padding:4px">${escapeHtml(w.playerName)}</td>
                        <td class="text-center">${cardName(w.cardId)}</td>
                        <td class="text-center">${formatMoney(w.prize)}</td>
                        <td class="text-center">${w.paid?'PAGADO':'POR PAGAR'}</td>
                    </tr>`;
                }).join('')}
            </tbody>
        </table>
    </div>`;
    
    html+=pricesHtml+playersHtml+winnersHtml;
    html+='<hr><p style="text-align:center; font-size:10px;">Fin del Reporte</p></body></html>';

    const printWindow = window.open('', '_blank');
    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.print();
}

function applyTheme(themeName) {
    document.documentElement.dataset.theme = themeName;
    localStorage.setItem(Kthm, themeName);
    currentTheme = themeName;
    $q('#theme-switcher').value = themeName;

    // Activar/Desactivar Overlays de efectos
    $q('#webs-overlay').classList.toggle('hidden', themeName !== 'halloween');
    $q('#snow-overlay').classList.toggle('hidden', themeName !== 'navidad');
    $q('#lights-overlay').classList.toggle('hidden', themeName !== 'navidad');
    $q('#stars-overlay').classList.toggle('hidden', themeName !== 'reyes');
    $q('#pascua-overlay').classList.toggle('hidden', themeName !== 'pascua');
}

// --- INICIALIZACI√ìN Y EVENT LISTENERS --- 
document.addEventListener('DOMContentLoaded', ()=>{
    
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js';
    document.head.appendChild(script);

    $q('#price4').value = prices.price4;
    $q('#profit4').value = prices.profit4;
    $q('#price6').value = prices.price6;
    $q('#profit6').value = prices.profit6;
    $q('#select-modality').value = currentMode;
    
    applyTheme(currentTheme); 
    renderAll();
    
    $q('#btn-shuffle').addEventListener('click', animateShuffle);
    $q('#btn-draw').addEventListener('click', drawOne);
    $q('#btn-auto').addEventListener('click', ()=>{ isAuto? stopAuto() : startAuto(); });
    $q('#btn-reset-win').addEventListener('click', async () => { await resetGame(); });
    
    $q('#save-prices').addEventListener('click', async ()=>{
        prices.price4=parseFloat($q('#price4').value||0);
        prices.profit4=parseFloat($q('#profit4').value||0);
        prices.price6=parseFloat($q('#price6').value||0);
        prices.profit6=parseFloat($q('#profit6').value||0);
        saveAll();
        renderAll();
        showAlert('Precios guardados.');
    });
    $q('#reset-prices').addEventListener('click', async ()=>{
        prices=defaultsPrices();
        $q('#price4').value=prices.price4;
        $q('#profit4').value=prices.profit4;
        $q('#price6').value=prices.price6;
        $q('#profit6').value=prices.profit6;
        saveAll();
        renderAll();
        showAlert('Precios reseteados a los valores por defecto.');
    });
    
    $q('#theme-switcher').addEventListener('change', (e) => {
        applyTheme(e.target.value);
    });

    $q('#btn-register').addEventListener('click', async () => { await registerPlayer(); });
    
    $q('#input-budget').addEventListener('input', (e) => updateCalculatorInfo(true)); 
    $q('#qty4').addEventListener('input', (e) => updateCalculatorInfo(false));
    $q('#qty6').addEventListener('input', (e) => updateCalculatorInfo(false));
    
    $q('#input-cell').addEventListener('input', (e) => {
        const val = e.target.value.replace(/\D/g,'');
        e.target.value = val; 
        const hintEl = $q('#cell-hint'); 
        if (val.length === 10) {
            hintEl.textContent = '‚úÖ V√°lido';
            hintEl.className = 'input-hint valid';
        } else if (val.length > 0) {
            hintEl.textContent = `‚ùå Incompleto (${val.length}/10)`;
            hintEl.className = 'input-hint invalid';
        } else {
            hintEl.textContent = '';
        }
    });

    $q('#input-clabe').addEventListener('input', (e) => {
        const val = e.target.value.replace(/\D/g,'');
        e.target.value = val; 
        const hintEl = $q('#clabe-hint');
        if (val.length === 16) {
             hintEl.textContent = '‚úÖ N√∫mero de Tarjeta';
             hintEl.className = 'input-hint valid';
        } else if (val.length === 18) {
            hintEl.textContent = '‚úÖ Cuenta CLABE';
            hintEl.className = 'input-hint valid';
        } else if (val.length > 0 && (val.length < 16 || val.length === 17)) {
            hintEl.textContent = '‚ùå Longitud no v√°lida';
            hintEl.className = 'input-hint invalid';
        } else if (val.length > 18) {
            hintEl.textContent = '‚ùå Demasiado largo';
            hintEl.className = 'input-hint invalid';
        } else {
            hintEl.textContent = '';
        }
    });
    
    $q('#btn-view-play').addEventListener('click', ()=>{ 
        $q('#view-admin').classList.add('hidden'); 
        renderAll(); 
    });
    $q('#btn-view-admin').addEventListener('click', ()=>{ 
        $q('#view-admin').classList.remove('hidden'); 
        renderAll(); 
    });
    
    $q('#select-modality').addEventListener('change', (e)=>{ 
        currentMode = Number(e.target.value); 
        localStorage.setItem(Kmod,String(currentMode)); 
        renderAll(); 
    });

    $q('#btn-export').addEventListener('click', exportPdf);
    $q('#btn-reset-day').addEventListener('click', async ()=>{ 
        const confirm = await showConfirm('¬øBORRAR TODAS LAS COMPRAS Y GANADORES DEL D√çA?<br><br>Esta acci√≥n no se puede deshacer.', 'Borrar D√≠a');
        if(!confirm) return;
        
        purchases=[];
        tx.push({id:uuid(),type:'clear',ts:Date.now()});
        game=defaultsGame();
        winners=[];
        drawnInGame=[];
        saveAll();
        renderAll();
        showAlert('D√≠a reiniciado. Todos los datos de compras y ganancias se borraron.');
    });

    $q('#admin-search').addEventListener('input', (e) => {
        adminSearch = e.target.value.toLowerCase().trim();
        const currentFilter = $q('.toggle-btn[id^="filter-"][style*="background: var(--azul)"]');
        let filterValue = null;
        if (currentFilter) {
            if (currentFilter.id === 'filter-4') filterValue = 4;
            if (currentFilter.id === 'filter-6') filterValue = 6;
        }
        renderPlayersTable(filterValue);
    });

    $q('#filter-all').addEventListener('click', ()=>{ setActiveFilter('all'); renderPlayersTable(); });
    $q('#filter-4').addEventListener('click', ()=>{ setActiveFilter(4); renderPlayersTable(4); });
    $q('#filter-6').addEventListener('click', ()=>{ setActiveFilter(6); renderPlayersTable(6); });

    // --- Cierres de Modales ---
    $qa('.modal-back').forEach(modalBack => {
        modalBack.addEventListener('click', (e) => {
            if (e.target === modalBack) {
                modalBack.classList.add('hidden');
                if (modalBack.id === 'modal-winner' || modalBack.id === 'modal-winner-detail') {
                    stopConfettiFullScreen();
                }
            }
        });
    });
    
    $q('#modal-close').addEventListener('click', closeGroupModal);
    $q('#modal-close-x').addEventListener('click', closeGroupModal);
    $q('#winner-ok').addEventListener('click', () => showWinnerDetailModal()); 
    $q('#winner-close').addEventListener('click', ()=>{ $q('#modal-winner').classList.add('hidden'); stopConfettiFullScreen(); });
    $q('#winner-detail-ok').addEventListener('click', closeWinnerDetailModal);
    $q('#winner-detail-close-x').addEventListener('click', closeWinnerDetailModal);
    
    $q('#modal-alert-ok').addEventListener('click', () => $q('#modal-alert').classList.add('hidden'));

    // CORRECCI√ìN 1: Flujo de 'ESC'
    document.addEventListener('keydown', (e)=>{
        if(e.key !== 'Escape') return;

        const winnerModal = $q('#modal-winner');
        const detailModal = $q('#modal-winner-detail');
        const playerModal = $q('#modal-player');
        const alertModal = $q('#modal-alert');
        const confirmModal = $q('#modal-confirm');

        if (!confirmModal.classList.contains('hidden')) {
            $q('#modal-confirm-cancel').click();
        } else if (!alertModal.classList.contains('hidden')) {
            $q('#modal-alert-ok').click();
        } else if (!playerModal.classList.contains('hidden')) {
            closeGroupModal();
        } else if (!detailModal.classList.contains('hidden')) {
            closeWinnerDetailModal();
        } else if (!winnerModal.classList.contains('hidden')) {
            // ESC en "FELICIDADES" abre el detalle
            showWinnerDetailModal(); 
        }
    });

    const playersAreaEl = $q('#players-area');
    if (playersAreaEl) {
        playersAreaEl.addEventListener('click', (e) => {
            let target = e.target.closest('.player-card');
            if (target && !target.classList.contains('simulated')) {
                const playerId = target.getAttribute('data-player-id');
                if (playerId) {
                    openPurchaseDetail(playerId);
                }
            } 
        });
    }

});

</script>
</body>
</html>
