<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loter√≠a Mexicana GANA YA! Interactiva</title>
    <!-- Carga de Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la fuente Inter --><style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Estilos base de la tarjeta - Solo para la carta GRANDE en juego */
        .card-loteria-lg {
            width: 100%;
            height: 100%;
            padding-top: 140%; 
            background-size: cover;
            background-position: center;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            border: 3px solid #2563EB; 
            overflow: hidden;
        }

        /* MINIATURA DE CARTONES DE JUGADOR (EL GRAN CAMBIO) */
        .player-card-compact {
            aspect-ratio: 1 / 1.1; /* Ligera verticalidad */
            width: 100%; 
            padding: 4px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            cursor: pointer;
        }
        .player-card-compact:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        }
        .player-grid-compact {
            display: grid;
            gap: 2px;
        }
        .board-grid-4-compact { grid-template-columns: repeat(2, 1fr); }
        .board-grid-6-compact { grid-template-columns: repeat(2, 1fr); }
        .board-grid-9-compact { grid-template-columns: repeat(3, 1fr); }

        .marked-cell {
            background-color: #EF4444; /* Rojo: Marcado */
            border-radius: 2px;
        }
        .unmarked-cell {
            background-color: #D1D5DB; /* Gris: Sin Marcar */
            border-radius: 2px;
        }

        @keyframes fanfare {
            0% { transform: scale(1) rotate(0deg); opacity: 0; }
            50% { transform: scale(1.5) rotate(-5deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 0; }
        }

        /* Animaci√≥n para el overlay del ganador */
        @keyframes winner-bounce {
            0%, 100% { transform: translateY(0); }
            20%, 80% { transform: translateY(-5px); }
            40%, 60% { transform: translateY(-10px); }
        }
        .winner-overlay-content {
            animation: winner-bounce 0.8s ease-in-out infinite alternate;
        }

        /* Animaci√≥n para el efecto "¬°Felicidades!" alrededor del nombre */
        @keyframes glitter {
            0% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0; transform: scale(0.5); }
        }
        .winner-name-effect {
            position: relative;
            display: inline-block;
            overflow: visible; /* Permitir que los elementos salgan del contenedor */
        }
        .winner-name-effect::before,
        .winner-name-effect::after {
            content: '‚ú®'; /* Emoji o car√°cter para el efecto */
            position: absolute;
            font-size: 2rem;
            opacity: 0;
            animation: glitter 1.5s ease-out infinite;
        }
        .winner-name-effect::before {
            top: -20px;
            left: -20px;
            animation-delay: 0s;
        }
        .winner-name-effect::after {
            bottom: -20px;
            right: -20px;
            animation-delay: 0.75s;
        }


        .confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        /* Estructura del Layout Principal de la Vista de Juego */
        .game-layout {
            display: grid;
            /* 3 columnas: 1 columna peque√±a, 2 columnas grandes (para jugadores) */
            grid-template-columns: 1fr 3fr 1fr;
            /* 3 filas: Logo/Titulo, Contenido Principal, Ganadores */
            grid-template-rows: auto 1fr auto; 
            gap: 16px;
            height: 90vh; 
        }
        
        /* Definici√≥n de √Åreas */
        .logo-area { grid-area: 1 / 1 / 2 / 2; }
        .title-area { grid-area: 1 / 2 / 2 / 3; }
        .pot-area { grid-area: 1 / 3 / 2 / 4; }
        .players-area { grid-area: 2 / 1 / 3 / 3; } /* Ocupa 2 columnas */
        .current-card-area { 
            grid-area: 2 / 3 / 4 / 4; /* Ahora ocupa 2 filas (2 y 3) */
            align-items: flex-start; /* Alineaci√≥n arriba para dejar espacio al bot√≥n */
        } 
        .winners-area { grid-area: 3 / 1 / 4 / 3; } /* Ahora solo ocupa 2 columnas */
        
        /* Media Query para m√≥vil (apilar contenido) */
        @media (max-width: 1024px) {
            .game-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr auto; /* M√°s filas para apilar */
                height: auto;
            }
             .logo-area, .title-area, .pot-area, .players-area, .current-card-area, .winners-area {
                grid-area: unset !important; /* Deshabilitar grid-area */
                grid-column: 1 / -1; /* Ocupar todo el ancho */
            }
             .current-card-area { order: -1; } /* Mover la carta actual al inicio en m√≥vil */
             .players-area { min-height: 400px; }
        }

    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Configuraci√≥n e Inicializaci√≥n de Firebase --><script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, setDoc, updateDoc, getDocs, addDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer nivel de log para depuraci√≥n de Firestore
        setLogLevel('Debug');

        // Variables Globales de Canvas (MANDATORIO)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { /* mock config */ };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Instancias de Firebase
        let app, db, auth;
        let userId = 'loading'; // ID del usuario actual

        // Estados Reactivos GLOBALES (Para que sean accesibles desde el HTML)
        window.gameState = {
            currentTab: 'game', // 'game' o 'admin'
            isAuthReady: false,
            // Estado del juego desde Firestore (loteria_state/game_status)
            gameStatus: {
                drawnCards: [],
                deck: [], // Baraja completa
                currentCard: null,
                drawSpeed: 1, // 1, 2, o 3
                gameId: null,
                gameRunning: false,
                winner: null, // Nuevo: almacena la info del ganador
            },
            // Datos del jugador desde Firestore (players/{userId})
            players: {},
            // Datos de ganadores desde Firestore (winners/{winnerId})
            winners: [],
            // Cartas de la loter√≠a Mexicana (54 cartas)
            allCards: [
                { id: 1, name: "El Gallo", emoji: "üêì" }, { id: 2, name: "El Diablito", emoji: "üòà" },
                { id: 3, name: "La Dama", emoji: "üë©" }, { id: 4, name: "El Catr√≠n", emoji: "ü§µ" },
                { id: 5, name: "El Paraguas", emoji: "‚òÇÔ∏è" }, { id: 6, name: "La Sirena", emoji: "üßú‚Äç‚ôÄÔ∏è" },
                { id: 7, name: "La Escalera", emoji: "ü™ú" }, { id: 8, name: "La Botella", emoji: "üçæ" },
                { id: 9, name: "El Barril", emoji: "üõ¢Ô∏è" }, { id: 10, name: "El √Årbol", emoji: "üå≥" },
                { id: 11, name: "El Mel√≥n", emoji: "üçà" }, { id: 12, name: "El Valiente", emoji: "ü¶∏‚Äç‚ôÇÔ∏è" },
                { id: 13, name: "El Gorrito", emoji: "ü§†" }, { id: 14, name: "La Muerte", emoji: "üíÄ" },
                { id: 15, name: "La Pera", emoji: "üçê" }, { id: 16, name: "La Bandera", emoji: "üá≤üáΩ" },
                { id: 17, name: "El Bandol√≥n", emoji: "üéª" }, { id: 18, name: "El Violoncello", emoji: "üé∏" },
                { id: 19, name: "La Garza", emoji: "ü¶¢" }, { id: 20, name: "El P√°jaro", emoji: "üê¶" },
                { id: 21, name: "La Mano", emoji: "‚úã" }, { id: 22, name: "La Bota", emoji: "üë¢" },
                { id: 23, name: "La Luna", emoji: "üåï" }, { id: 24, name: "El Cotorro", emoji: "ü¶ú" },
                { id: 25, name: "El Borracho", emoji: "üçª" }, { id: 26, name: "El Negrito", emoji: "üë®" },
                { id: 27, name: "El Coraz√≥n", emoji: "‚ù§Ô∏è" }, { id: 28, name: "La Sand√≠a", emoji: "üçâ" },
                { id: 29, name: "El Tambor", emoji: "ü•Å" }, { id: 30, name: "El Camar√≥n", emoji: "ü¶ê" },
                { id: 31, name: "Las Jaras", emoji: "üèπ" }, { id: 32, name: "El M√∫sico", emoji: "üé∂" },
                { id: 33, name: "La Ara√±a", emoji: "üï∑Ô∏è" }, { id: 34, name: "El Soldado", emoji: "üíÇ" },
                { id: 35, name: "La Estrella", emoji: "‚≠ê" }, { id: 36, name: "El Cazo", emoji: "üç≤" },
                { id: 37, name: "El Mundo", emoji: "üåé" }, { id: 38, name: "El Apache", emoji: "üèπ" },
                { id: 39, name: "El Nopal", emoji: "üåµ" }, { id: 40, name: "El Alacr√°n", emoji: "ü¶Ç" },
                { id: 41, name: "La Rosa", emoji: "üåπ" }, { id: 42, name: "La Calavera", emoji: "üíÄ" },
                { id: 43, name: "La Campana", emoji: "üîî" }, { id: 44, name: "El Cantarito", emoji: "üè∫" },
                { id: 45, name: "El Venado", emoji: "ü¶å" }, { id: 46, name: "El Sol", emoji: "‚òÄÔ∏è" },
                { id: 47, name: "La Corona", emoji: "üëë" }, { id: 48, name: "La Chalupa", emoji: "üõ∂" },
                { id: 49, name: "El Pino", emoji: "üå≤" }, { id: 50, name: "El Pescado", emoji: "üêü" },
                { id: 51, name: "La Palma", emoji: "üå¥" }, { id: 52, name: "La Maceta", emoji: "ü™¥" },
                { id: 53, name: "El Arpa", emoji: "üéº" }, { id: 54, name: "La Rana", emoji: "üê∏" }
            ]
        };

        // --- FUNCIONES DE UTILIDAD FIREBASE ---

        // Rutas de Firestore
        const getGameStatusRef = () => doc(db, 'artifacts', appId, 'public', 'data', 'loteria_state', 'game_status');
        const getPlayersCollection = () => collection(db, 'artifacts', appId, 'public', 'data', 'players');
        const getWinnersCollection = () => collection(db, 'artifacts', appId, 'public', 'data', 'winners');
        
        // Obtener el nombre del grid CSS basado en el tama√±o del cart√≥n
        const getGridClassCompact = (size) => {
            switch (size) {
                case 4: return 'board-grid-4-compact'; 
                case 6: return 'board-grid-6-compact'; 
                case 9: return 'board-grid-9-compact'; 
                default: return 'board-grid-4-compact';
            }
        };

        // Inicializaci√≥n de la aplicaci√≥n y autenticaci√≥n
        const initializeFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    // Autenticaci√≥n con token o an√≥nima
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Autenticaci√≥n exitosa con token personalizado.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Autenticaci√≥n an√≥nima exitosa.");
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("UserID:", userId);
                        } else {
                            userId = crypto.randomUUID();
                            console.warn("No se pudo obtener el UID. Usando ID temporal:", userId);
                        }
                        window.gameState.isAuthReady = true;
                        startListeners(); // Iniciar la escucha de datos
                        window.renderApp(); // Renderizar la interfaz
                    });
                } else {
                    console.error("Configuraci√≥n de Firebase no disponible. Ejecutando en modo demo.");
                    window.gameState.isAuthReady = true;
                    userId = 'demo-user';
                    window.renderApp();
                }
            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                window.gameState.isAuthReady = true;
                userId = 'error-user';
                window.renderApp();
            }
        };
        
        // Inicializa el documento de estado del juego si no existe
        const initializeGameStatus = async () => {
            if (!db) return;
            const gameStatusRef = getGameStatusRef();
            try {
                const docSnap = await getDoc(gameStatusRef);
                if (!docSnap.exists()) {
                    console.log("Inicializando estado del juego por primera vez.");
                    await setDoc(gameStatusRef, {
                        drawnCards: [],
                        deck: [],
                        currentCard: null,
                        drawSpeed: 1,
                        gameId: null,
                        gameRunning: false,
                        winner: null,
                    });
                }
            } catch (e) {
                console.error("Error al inicializar el estado del juego:", e);
            }
        };

        // Escuchadores de Firestore (onSnapshot)
        const startListeners = () => {
            if (!db || !window.gameState.isAuthReady) return;

            initializeGameStatus(); 

            // 1. Escuchar Estado del Juego
            onSnapshot(getGameStatusRef(), (doc) => {
                const status = doc.data();
                if (status) {
                    // Si el juego ha terminado y hay un ganador, detenemos el intervalo
                    if (!status.gameRunning && status.winner) {
                        window.stopDrawingInterval();
                    } else if (status.gameRunning && drawingInterval === null) {
                        // Si el juego se reactiva desde otro lado, reiniciamos el intervalo
                        window.startDrawingInterval();
                    }

                    window.gameState.gameStatus = {
                        ...window.gameState.gameStatus,
                        ...status,
                        drawnCards: Array.isArray(status.drawnCards) ? status.drawnCards : [],
                        deck: Array.isArray(status.deck) ? status.deck : [],
                        currentCard: status.currentCard || null,
                        drawSpeed: status.drawSpeed || 1,
                        gameRunning: status.gameRunning || false,
                        winner: status.winner || null,
                    };
                    // Solo revisamos las marcas si el juego est√° corriendo
                    if(window.gameState.gameStatus.gameRunning) {
                        checkAndMarkBoards(); 
                    }
                }
                window.renderApp();
            }, (error) => console.error("Error listening to game status:", error));

            // 2. Escuchar Jugadores
            onSnapshot(getPlayersCollection(), (snapshot) => {
                window.gameState.players = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (Array.isArray(data.boards)) {
                        data.boards = data.boards.map(board => ({
                            ...board,
                            cards: board.cards || [],
                            matched_cards: board.matched_cards || [],
                            boardId: board.boardId || crypto.randomUUID(), 
                        }));
                    } else {
                         data.boards = [];
                    }
                    window.gameState.players[doc.id] = { id: doc.id, ...data };
                });
                window.renderApp();
            }, (error) => console.error("Error listening to players:", error));

            // 3. Escuchar Ganadores
            onSnapshot(query(getWinnersCollection()), (snapshot) => {
                window.gameState.winners = [];
                snapshot.forEach(doc => {
                    window.gameState.winners.push({ id: doc.id, ...doc.data() });
                });
                window.gameState.winners.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                window.renderApp();
            }, (error) => console.error("Error listening to winners:", error));
        };

        // --- L√ìGICA DEL JUEGO ---

        // Marcar cartas en los tableros de los jugadores y revisar si hay ganador
        const checkAndMarkBoards = () => {
            const { gameStatus, players } = window.gameState;
            if (!gameStatus.gameRunning || gameStatus.winner) return;

            const drawnIds = gameStatus.drawnCards.map(card => card.id);
            let playerUpdates = [];
            let winnerDetected = false;

            Object.values(players).forEach(player => {
                if (player.partidas_pagadas <= 0) return; // Ignorar jugadores sin partidas activas
                
                let playerUpdated = false;

                const updatedBoards = player.boards.map(board => {
                    if (board.status === 'won' || winnerDetected) return board; 

                    let currentMatches = board.matched_cards.length;
                    const newMatchedCards = board.cards
                        .filter((card) => drawnIds.includes(card.id))
                        .map(card => card.id);

                    board.matched_cards = newMatchedCards;
                    
                    // Detecci√≥n de Victoria (Llenar todas las cartas del cart√≥n)
                    if (board.matched_cards.length === board.cards.length && board.cards.length > 0) {
                        winnerDetected = true; // Establecer bandera
                        // Llamar a handleWin (que tambi√©n se detiene el juego y se encarga de todo)
                        handleWin(player.id, player.name, board);
                        // Marcar el board como 'won' localmente
                        return { ...board, status: 'won' }; 
                    }
                    // Si hubo cambios en las marcas
                    else if (currentMatches !== board.matched_cards.length) {
                        playerUpdated = true;
                    }
                    return board;
                });

                if (playerUpdated && !winnerDetected) {
                    playerUpdates.push({
                        id: player.id,
                        name: player.name,
                        boards: updatedBoards,
                        partidas_pagadas: player.partidas_pagadas
                    });
                }
            });

            // Aplicar actualizaciones a Firestore si no hay ganador (si hay, handleWin se encarga)
            if (!winnerDetected) {
                playerUpdates.forEach(p => {
                     updatePlayerInFirestore(p.id, p.name, p.boards, p.partidas_pagadas);
                });
            }
        };

        // Funci√≥n que gestiona una victoria
        const handleWin = async (playerId, playerName, winningBoard) => {
            // Previene m√∫ltiples detecciones
            if (window.gameState.gameStatus.winner) return;

            try {
                // 1. **DETENER EL JUEGO INMEDIATAMENTE** y registrar ganador en el estado del juego
                await setDoc(getGameStatusRef(), { 
                    gameRunning: false,
                    winner: { id: playerId, name: playerName, boardId: winningBoard.boardId, time: new Date() }
                }, { merge: true });
                window.stopDrawingInterval();


                // 2. Calcular el Bote y Registrar Ganador
                // Se recalcula el total de partidas activas justo antes de la victoria
                const totalPartidas = Object.values(window.gameState.players).reduce((acc, p) => acc + (p.partidas_pagadas || 0), 0);
                const prize = totalPartidas * 20; // $20 MXN por cart√≥n activo en juego
                const winTime = new Date();

                await addDoc(getWinnersCollection(), {
                    timestamp: winTime,
                    playerName: playerName,
                    playerId: playerId,
                    prizeAmount: prize,
                    message: `Gan√≥ con un cart√≥n de ${winningBoard.cards.length} cartas`,
                    status: 'PAGADO' 
                });

                // 3. Reducir partidas pagadas del jugador
                const playerRef = doc(getPlayersCollection(), playerId);
                const playerDoc = await getDoc(playerRef);
                if (!playerDoc.exists()) return; 

                const currentData = playerDoc.data();
                
                let newPartidasPagadas = (currentData.partidas_pagadas || 0) - 1;
                if (newPartidasPagadas < 0) newPartidasPagadas = 0;
                
                // Marcar el board como ganado y remover la partida de la cuenta del jugador (partidas_pagadas -1)
                const newBoards = currentData.boards.map(board => 
                    board.boardId === winningBoard.boardId ? { ...board, status: 'won' } : board
                );
                
                // Si ya no quedan partidas, el jugador se queda con sus boards ganados, pero ya no paga
                await updateDoc(playerRef, {
                    partidas_pagadas: newPartidasPagadas,
                    boards: newBoards,
                });

                window.showConfetti(); // Mostrar confeti

            } catch (e) {
                console.error("Error gestionando la victoria:", e);
            }
        };


        // Barajar y Reiniciar el juego (ADMIN) - GLOBALIZADA
        window.startGame = async () => {
            if (!db) return console.error("Firebase no disponible.");

            // Reiniciar el estado del juego
            const newDeck = [...window.gameState.allCards].sort(() => 0.5 - Math.random());
            
            try {
                await setDoc(getGameStatusRef(), {
                    drawnCards: [],
                    currentCard: null,
                    deck: newDeck,
                    gameId: Date.now(),
                    drawSpeed: window.gameState.gameStatus.drawSpeed || 1,
                    gameRunning: true,
                    winner: null, // Limpiar ganador
                });
                
                // Limpiar el estado 'won' de todos los boards y las cartas marcadas
                const playersSnapshot = await getDocs(getPlayersCollection());
                playersSnapshot.forEach(async (playerDoc) => {
                    const playerData = playerDoc.data();
                    const cleanBoards = playerData.boards.map(board => {
                        return { ...board, matched_cards: [], status: 'active' }; // Restablecer a 'active'
                    });
                    // Usamos updateDoc para solo actualizar los boards
                    await updateDoc(doc(getPlayersCollection(), playerDoc.id), { boards: cleanBoards });
                });

                // Limpiar la lista de ganadores (opcional, pero ayuda a la simulaci√≥n de una nueva ronda)
                const winnersSnapshot = await getDocs(getWinnersCollection());
                winnersSnapshot.forEach(async (winnerDoc) => {
                    await deleteDoc(doc(getWinnersCollection(), winnerDoc.id));
                });

                window.startDrawingInterval();
            } catch (e) {
                console.error("Error al iniciar juego:", e);
            }
        };

        // Detener el juego (ADMIN) - GLOBALIZADA
        window.stopGame = async () => {
            if (!db) return;
            try {
                // Detener sin declarar ganador (pausa)
                await setDoc(getGameStatusRef(), { gameRunning: false }, { merge: true }); 
                window.stopDrawingInterval();
            } catch (e) {
                console.error("Error al detener juego:", e);
            }
        };

        // Cambiar la velocidad de extracci√≥n (ADMIN) - GLOBALIZADA
        window.changeDrawSpeed = async (speed) => {
            if (!db) return;
            try {
                await setDoc(getGameStatusRef(), { drawSpeed: speed }, { merge: true }); 
            } catch (e) {
                console.error("Error al cambiar velocidad:", e);
            }
        };

        // Extraer la siguiente carta (ADMIN) - GLOBALIZADA
        window.drawNextCard = async (numCards = 1) => {
            const { gameStatus } = window.gameState;
            if (!db || !gameStatus.gameRunning || gameStatus.winner) return;

            let newDeck = [...gameStatus.deck];
            let newDrawnCards = [...gameStatus.drawnCards];
            let lastDrawn = null;

            for (let i = 0; i < numCards; i++) {
                if (newDeck.length > 0) {
                    lastDrawn = newDeck.shift();
                    newDrawnCards.push(lastDrawn);
                }
            }

            if (lastDrawn) {
                 try {
                    await updateDoc(getGameStatusRef(), {
                        deck: newDeck,
                        drawnCards: newDrawnCards,
                        currentCard: lastDrawn,
                    });
                } catch (e) {
                    console.error("Error al extraer carta:", e);
                }
            } else {
                 console.log("¬°Baraja vac√≠a! Juego terminado.");
                 window.stopGame();
            }
        };
        
        // Control de tiempo para el avance autom√°tico (ADMIN) - GLOBALIZADA
        let drawingInterval = null;
        window.startDrawingInterval = () => {
            window.stopDrawingInterval();
            if (!window.gameState.gameStatus.gameRunning) return;

            // La velocidad se ajusta en base a drawSpeed (1, 2, o 3 cartas por lanzamiento)
            const speedMultiplier = window.gameState.gameStatus.drawSpeed;
            // Un lanzamiento cada 5 segundos (m√°s lento)
            const intervalTime = 5000; 
            drawingInterval = setInterval(() => {
                if (!window.gameState.gameStatus.gameRunning || window.gameState.gameStatus.winner) {
                    window.stopDrawingInterval();
                    return;
                }
                window.drawNextCard(speedMultiplier);
            }, intervalTime); 
        };

        window.stopDrawingInterval = () => {
            if (drawingInterval) {
                clearInterval(drawingInterval);
                drawingInterval = null;
            }
        };

        // Event listener para la barra espaciadora
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && window.gameState.gameStatus.gameRunning) {
                e.preventDefault(); // Previene el scroll de la p√°gina
                window.drawNextCard(window.gameState.gameStatus.drawSpeed);
            }
        });
        
        // --- FUNCIONES DE ADMINISTRACI√ìN ---

        // Funci√≥n para actualizar la informaci√≥n del jugador en Firestore
        const updatePlayerInFirestore = async (playerId, playerName, boards, partidasPagadas) => {
            if (!db) return;
            const playerRef = doc(getPlayersCollection(), playerId);
            try {
                await setDoc(playerRef, {
                    name: playerName,
                    partidas_pagadas: partidasPagadas,
                    boards: boards,
                }, { merge: true });
            } catch (e) {
                console.error("Error al guardar jugador:", e);
            }
        };

        // Generar un nuevo tablero aleatorio
        const generateBoard = (numCards) => {
            const shuffled = [...window.gameState.allCards].sort(() => 0.5 - Math.random());
            const boardCards = shuffled.slice(0, numCards); 
            return {
                cards: boardCards,
                matched_cards: [],
                boardId: crypto.randomUUID(), 
                status: 'active'
            };
        };

        // A√±adir/Actualizar un jugador (ADMIN) - GLOBALIZADA
        window.handlePlayerSubmit = (event) => {
            event.preventDefault();
            const form = event.target;
            const playerName = form.playerName.value.trim();
            const partidas = parseInt(form.partidas.value, 10);
            const numCards = parseInt(form.numCards.value, 10); // 4, 6 o 9
            const playerId = form.playerId.value || Date.now().toString(); 

            if (!playerName || isNaN(partidas) || partidas < 1 || isNaN(numCards) || ![4, 6, 9].includes(numCards)) {
                window.showAlert('Datos de jugador inv√°lidos. Aseg√∫rate de que las partidas sean al menos 1 y el cart√≥n sea de 4, 6 o 9 cartas.', 'error');
                return;
            }
            
            let boards = [];
            const existingPlayer = window.gameState.players[playerId];

            if (existingPlayer) {
                boards = existingPlayer.boards;
            } else {
                 // Generar UN cart√≥n por esta acci√≥n, el contador de partidas controla la cantidad que est√° pagando
                boards.push(generateBoard(numCards));
            }
            
            const finalPlayerId = existingPlayer ? existingPlayer.id : 'player-' + playerId;

            updatePlayerInFirestore(finalPlayerId, playerName, boards, partidas);
            
            form.reset();
        };

        // Eliminar jugador (ADMIN) - GLOBALIZADA
        window.deletePlayer = (id) => {
            if (!db) return;
            const player = window.gameState.players[id];
            window.showConfirmation(`¬øEst√°s seguro de que quieres eliminar al jugador **${player.name}**?`, async () => {
                try {
                    await deleteDoc(doc(getPlayersCollection(), id));
                    window.hideModal();
                } catch (e) {
                    console.error("Error al eliminar jugador:", e);
                    window.hideModal();
                }
            });
        };
        
        // --- UTILIDADES UI ---
        
        // Mostrar mensaje de alerta/confirmaci√≥n
        window.showConfirmation = (message, onConfirm) => {
            const modalEl = document.getElementById('confirmationModal');
            document.getElementById('modalTitle').textContent = 'Confirmar Acci√≥n';
            document.getElementById('modalMessage').innerHTML = message;
            
            const confirmBtn = document.getElementById('confirmActionBtn');
            confirmBtn.onclick = onConfirm;
            confirmBtn.classList.remove('hidden');
            document.getElementById('cancelActionBtn').classList.remove('hidden');

            modalEl.classList.remove('hidden');
        };
        
        window.showAlert = (message, type = 'info') => {
            const modalEl = document.getElementById('confirmationModal');
            document.getElementById('modalTitle').textContent = type === 'error' ? '¬°Error!' : 'Informaci√≥n';
            document.getElementById('modalMessage').innerHTML = message;
            
            const confirmBtn = document.getElementById('confirmActionBtn');
            confirmBtn.classList.add('hidden');
            document.getElementById('cancelActionBtn').classList.add('hidden');
            
            modalEl.classList.remove('hidden');
        }

        window.hideModal = () => {
            document.getElementById('confirmationModal').classList.add('hidden');
        };

        // Generar Confeti para la victoria
        window.showConfetti = () => {
            const confettiContainer = document.getElementById('confetti-container');
            confettiContainer.innerHTML = ''; // Limpiar confeti anterior
            const colors = ['#f44336', '#ffeb3b', '#2196f3', '#4caf50', '#ff9800'];

            for (let i = 0; i < 50; i++) {
                const piece = document.createElement('div');
                piece.style.cssText = `
                    position: absolute;
                    width: 10px;
                    height: 10px;
                    background-color: ${colors[Math.floor(Math.random() * colors.length)]};
                    top: ${Math.random() * 100}vh;
                    left: ${Math.random() * 100}vw;
                    opacity: ${Math.random()};
                    transform: rotate(${Math.random() * 360}deg);
                    animation: fall ${2 + Math.random() * 3}s ease-in forwards;
                `;
                confettiContainer.appendChild(piece);
            }

            // CSS Keyframes para la animaci√≥n de ca√≠da del confeti
            const style = document.createElement('style');
            style.innerHTML = `
                @keyframes fall {
                    0% { transform: translate(0, 0) rotate(0deg); opacity: 1; }
                    100% { transform: translate(${Math.random() * 400 - 200}px, 100vh) rotate(${720 + Math.random() * 360}deg); opacity: 0; }
                }
            `;
            document.head.appendChild(style);

            setTimeout(() => {
                confettiContainer.innerHTML = ''; // Limpiar confeti
            }, 5000);
        };

        // --- FUNCIONES DE RENDERIZADO (UI) ---

        // Funci√≥n para renderizar una carta GRANDE individual (solo para la carta actual)
        const renderSingleCardLG = (card) => {
            if (!card) return '';
            // Usamos un placeholder con el nombre y el ID
            const cardBg = `https://placehold.co/100x140/FFFFFF/2563EB/png?text=${encodeURIComponent(card.name)}\n(${card.id})`;
            
            return `
                <div 
                    class="card-loteria-lg bg-white shadow-2xl transition-transform duration-200" 
                    style="background-image: url(${cardBg}); border-color: #EF4444;"
                    title="${card.name}"
                >
                     <div class="absolute inset-0 flex items-center justify-center text-8xl">${card.emoji}</div>
                </div>
            `;
        };

        // Funci√≥n para renderizar la tarjeta compacta de un jugador
        const renderPlayerCardCompact = (player) => {
            // Solo renderizamos la primera tabla activa
            const activeBoard = player.boards.find(b => b.status !== 'won'); 
            if (!activeBoard) return '';

            const cardCount = activeBoard.cards.length;
            const isMatched = (cardId) => activeBoard.matched_cards.includes(cardId);
            const gridClass = getGridClassCompact(cardCount);
            const isWinning = activeBoard.status === 'won';
            const progress = cardCount > 0 ? (activeBoard.matched_cards.length / cardCount) : 0;
            const progressColor = isWinning ? 'bg-green-600' : (progress > 0.6 ? 'bg-yellow-500' : 'bg-red-500');

            return `
                <div class="player-card-compact ${isWinning ? 'border-4 border-green-500 shadow-lg' : 'border border-gray-300'}"
                     title="${player.name} - ${activeBoard.matched_cards.length}/${cardCount} Cartas"
                >
                    <!-- Encabezado compacto --><div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-bold truncate max-w-[60%]">${player.name}</span>
                        <span class="text-[0.6rem] font-medium text-gray-500">${activeBoard.matched_cards.length}/${cardCount}</span>
                    </div>

                    <!-- Miniatura del Cart√≥n (Grid) --><div class="${gridClass} player-grid-compact w-full h-full">
                        ${activeBoard.cards.map(card => `
                            <div class="w-full h-full ${isMatched(card.id) ? 'marked-cell' : 'unmarked-cell'} flex items-center justify-center text-[0.6rem] text-white" 
                                 style="aspect-ratio: 1;"
                                 title="${card.name}"
                            >
                                ${card.emoji}
                            </div>
                        `).join('')}
                    </div>

                    <!-- Barra de Progreso --><div class="h-1 mt-1 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-1 rounded-full ${progressColor}" style="width: ${progress * 100}%;"></div>
                    </div>
                </div>
            `;
        };


        // Funci√≥n principal de renderizado - GLOBALIZADA
        window.renderApp = () => {
            const container = document.getElementById('app-container');
            if (!container) return;

            const isGameTab = window.gameState.currentTab === 'game';
            
            container.innerHTML = `
                <div class="max-w-7xl mx-auto p-4">
                    <!-- Tabs de Navegaci√≥n --><div class="flex border-b border-gray-300 mb-6">
                        <button 
                            onclick="window.gameState.currentTab = 'game'; window.renderApp();" 
                            class="py-2 px-6 text-sm font-medium ${isGameTab ? 'border-b-4 border-red-600 text-red-600' : 'text-gray-500 hover:text-red-500'}"
                        >
                            Juego (Live)
                        </button>
                        <button 
                            onclick="window.gameState.currentTab = 'admin'; window.renderApp();" 
                            class="py-2 px-6 text-sm font-medium ${!isGameTab ? 'border-b-4 border-red-600 text-red-600' : 'text-gray-500 hover:text-red-500'}"
                        >
                            Administrador
                        </button>
                    </div>

                    ${isGameTab ? renderGameView() : renderAdminView()}
                </div>
                ${renderModal()}
                <div id="confetti-container" class="confetti"></div>
            `;
        };
        
        // Renderizar la Vista del Juego (Live)
        const renderGameView = () => {
            const { gameStatus, players, winners } = window.gameState;
            // Jugadores que tienen al menos 1 partida activa
            const activePlayers = Object.values(players).filter(p => p.partidas_pagadas > 0 && p.boards.length > 0);
            // C√°lculo del bote: $20 MXN por CADA partida activa
            const totalPot = activePlayers.reduce((acc, p) => acc + (p.partidas_pagadas || 0), 0) * 20;
            const cardsRemaining = gameStatus.deck.length;

            return `
                
                <!-- Overlay de Ganador -->${gameStatus.winner ? `
                    <div class="fixed inset-0 bg-black/80 z-40 flex flex-col items-center justify-center p-4">
                        <div class="bg-yellow-400 p-10 rounded-3xl border-8 border-red-600 text-center shadow-2xl winner-overlay-content">
                            <h2 class="text-8xl font-black text-red-800 mb-4 tracking-wider">¬°GANA YA!</h2>
                            <p class="text-4xl font-extrabold text-gray-900">¬°Ganador: <span class="text-red-600 winner-name-effect">${gameStatus.winner.name.toUpperCase()}</span>!</p>
                            <p class="text-xl text-gray-700 mt-2">Ha ganado el Bote de **$${totalPot.toLocaleString('es-MX')} MXN**</p>
                             <!-- El bot√≥n 'Terminar Partida y Cerrar' se ha eliminado como solicitaste --><!-- Ahora el juego permanece en la pantalla de ganador hasta que el administrador lo reinicie manualmente --></div>
                    </div>
                ` : ''}

                <div class="game-layout">
                    <!-- LOGO AREA (1/1) --><div class="logo-area flex items-center justify-center">
                         <div class="w-12 h-12 rounded-full bg-red-600 text-white flex items-center justify-center font-black text-lg shadow-md">L</div>
                    </div>
                    
                    <!-- TITULO AREA (1/2) --><div class="title-area flex items-center justify-center border-2 border-gray-300 rounded-lg p-2 bg-white shadow-md">
                        <h1 class="text-2xl font-extrabold text-red-600 tracking-tighter">LOTER√çA MEXICANA ¬°GANA YA!</h1>
                    </div>
                    
                    <!-- $ EN JUEGO AREA (1/3) --><div class="pot-area flex flex-col items-center justify-center border-2 border-green-500 bg-green-50 rounded-lg p-2 shadow-md">
                        <span class="text-xs font-semibold text-green-700">BOTE ACUMULADO</span>
                        <p class="text-xl font-black text-green-800">$${totalPot.toLocaleString('es-MX')} MXN</p>
                    </div>

                    <!-- CARTAS EN JUEGO AREA (2/3 & 3/3) - Columna Lateral Derecha --><div class="current-card-area flex flex-col items-center bg-white p-4 rounded-xl shadow-2xl border-4 border-yellow-500">
                        <h3 class="text-lg font-bold mb-3 text-yellow-700 border-b pb-2 w-full text-center">CARTA EN JUEGO</h3>
                        <!-- Carta Actual --><div class="flex flex-col items-center w-full max-w-[200px] mb-4">
                            ${gameStatus.currentCard ? `
                                <div class="transition-all duration-500 transform scale-100 shadow-2xl rounded-xl w-full" style="aspect-ratio: 100/140;">
                                    ${renderSingleCardLG(gameStatus.currentCard)}
                                </div>
                                <h2 class="text-xl font-black mt-3 text-red-800">${gameStatus.currentCard.name.toUpperCase()}</h2>
                                <p class="text-xs text-gray-600 mt-1">¬°Corre y se va corriendo!</p>
                            ` : `
                                <div class="text-center p-4 bg-gray-100/70 rounded-xl shadow-inner w-full" style="aspect-ratio: 100/140;">
                                    <span class="text-4xl text-red-400">üÉè</span>
                                    <p class="text-sm text-gray-600 font-semibold mt-2">Esperando carta...</p>
                                </div>
                            `}
                        </div>
                        
                        <!-- Controles de Lanzamiento Manual/Velocidad --><div class="w-full mt-2 space-y-3">
                            <button 
                                onclick="window.drawNextCard(window.gameState.gameStatus.drawSpeed)" 
                                ${!gameStatus.gameRunning || gameStatus.winner ? 'disabled' : ''}
                                class="w-full py-3 bg-red-600 text-white font-bold rounded-lg shadow-xl hover:bg-red-700 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed text-sm"
                            >
                                TIRAR CARTA (ESPACIO)
                            </button>
                             <button 
                                onclick="window.startGame()" 
                                class="w-full py-2 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition duration-200 text-sm"
                            >
                                üîÑ BARAJEAR Y REINICIAR
                            </button>
                        </div>
                        
                        <!-- Estado del Mazo y Velocidad --><div class="w-full mt-4 p-3 bg-gray-100 rounded-lg shadow-inner">
                            <p class="text-xs font-semibold mb-2 text-gray-700 text-center">MAZO: ${gameStatus.drawnCards.length} / ${window.gameState.allCards.length} | Restantes: ${cardsRemaining}</p>
                            <p class="text-xs font-semibold mb-1 text-gray-700">Velocidad:</p>
                            <div class="flex justify-between space-x-1">
                                <button onclick="window.changeDrawSpeed(1)" class="flex-1 py-1 text-xs rounded-full transition-all ${gameStatus.drawSpeed === 1 ? 'bg-red-600 text-white' : 'bg-gray-300 text-gray-700 hover:bg-red-200'}">üê¢ 1</button>
                                <button onclick="window.changeDrawSpeed(2)" class="flex-1 py-1 text-xs rounded-full transition-all ${gameStatus.drawSpeed === 2 ? 'bg-red-600 text-white' : 'bg-gray-300 text-gray-700 hover:bg-red-200'}">üêá 2</button>
                                <button onclick="window.changeDrawSpeed(3)" class="flex-1 py-1 text-xs rounded-full transition-all ${gameStatus.drawSpeed === 3 ? 'bg-red-600 text-white' : 'bg-gray-300 text-gray-700 hover:bg-red-200'}">üöÄ 3</button>
                            </div>
                        </div>
                         <!-- ULTIMAS CARTAS (Miniaturas) --><div class="w-full mt-4 p-3 bg-red-50 rounded-lg border border-red-200 shadow-inner">
                            <h3 class="text-xs font-bold mb-2 text-red-600 w-full text-center">HISTORIAL</h3>
                            <div class="flex justify-center space-x-2">
                                ${gameStatus.drawnCards.slice(-5).reverse().map(card => `
                                    <div class="text-xl w-6 h-6 flex items-center justify-center rounded-full bg-red-200 shadow-inner" title="${card.name}">
                                        ${card.emoji}
                                    </div>
                                `).join('')}
                                ${gameStatus.drawnCards.length === 0 ? '<p class="text-gray-500 text-xs">Empieza la partida...</p>' : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- CARTAS DE JUGADORES ACTIVOS AREA (2/1-2) - Mayor Espacio --><div class="players-area bg-white p-4 rounded-xl shadow-2xl border-4 border-red-600 overflow-y-auto">
                        <h3 class="text-xl font-bold mb-3 text-red-600 border-b pb-2">JUGADORES ACTIVOS (${activePlayers.length})</h3>
                        <!-- Usamos un grid denso para los cartones compactos --><div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 xl:grid-cols-7 2xl:grid-cols-8 gap-3">
                            ${activePlayers.length > 0 ? activePlayers.map(renderPlayerCardCompact).join('') : '<p class="text-gray-500">No hay jugadores activos.</p>'}
                        </div>
                    </div>

                    <!-- ULTIMOS GANADORES AREA (3/1-3) - Pie de p√°gina (Ahora solo 2 columnas) --><div class="winners-area bg-white p-4 rounded-xl shadow-2xl border-t-4 border-blue-500">
                        <h3 class="text-xl font-bold mb-3 text-blue-600 border-b pb-2">√öLTIMOS GANADORES</h3>
                        <div class="flex overflow-x-auto space-x-4 pb-2">
                            ${winners.length > 0 ? winners.slice(0, 5).map(winner => `
                                <div class="flex-shrink-0 w-64 p-3 bg-blue-50 rounded-lg border-l-4 border-blue-600 shadow-sm hover:shadow-md transition">
                                    <p class="font-bold text-blue-800 truncate">${winner.playerName.toUpperCase()}</p>
                                    <p class="text-sm text-gray-700">Gan√≥ <span class="font-bold">$${winner.prizeAmount.toLocaleString('es-MX')} MXN</span></p>
                                    <p class="text-xs text-gray-500">${new Date(winner.timestamp?.seconds * 1000).toLocaleString('es-MX')}</p>
                                </div>
                            `).join('') : '<p class="text-gray-500">A√∫n no hay ganadores en esta partida.</p>'}
                        </div>
                    </div>
                </div>
            `;
        };

        // Renderizar la Vista del Administrador (sin cambios en la l√≥gica, solo para mantener la coherencia)
        const renderAdminView = () => {
             const { gameStatus, players } = window.gameState;
             const activePlayersArray = Object.values(players);
             
             return `
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                     <!-- PANEL DE CONTROL DEL JUEGO --><div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-2xl border-t-4 border-red-600">
                         <h2 class="text-2xl font-bold mb-4 text-red-600">Control de la Partida</h2>
                         
                         <!-- Estado y Controles --><div class="mb-4">
                            <p class="font-semibold text-lg mb-2">Estado: 
                                <span class="${gameStatus.gameRunning ? 'text-green-600' : gameStatus.winner ? 'text-yellow-600' : 'text-gray-500'} font-bold">
                                    ${gameStatus.gameRunning ? 'CORRIENDO' : gameStatus.winner ? '¬°TERMINADO (GANADOR)!': 'DETENIDO'}
                                </span>
                            </p>
                            ${gameStatus.currentCard ? `<p class="text-sm text-gray-600">√öltima carta: ${gameStatus.currentCard.name} (${gameStatus.currentCard.id})</p>` : ''}
                            <p class="text-sm text-gray-600">Cartas restantes: ${gameStatus.deck.length}</p>
                         </div>
                         
                         <!-- Botones de Acci√≥n --><div class="flex flex-col space-y-3">
                            ${gameStatus.gameRunning ? `
                                <button onclick="window.drawNextCard(window.gameState.gameStatus.drawSpeed)" class="w-full py-3 bg-yellow-500 text-white font-bold rounded-lg shadow-md hover:bg-yellow-600 transition duration-200">
                                    LANZAR SIGUIENTE (${gameStatus.drawSpeed})
                                </button>
                                <button onclick="window.stopGame()" class="w-full py-3 bg-red-600 text-white font-bold rounded-lg shadow-md hover:bg-red-700 transition duration-200">
                                    PAUSAR JUEGO
                                </button>
                            ` : `
                                <button onclick="window.startGame()" class="w-full py-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition duration-200">
                                    INICIAR/REINICIAR JUEGO
                                </button>
                            `}
                            <p class="text-xs text-gray-500 pt-2">El bot√≥n Iniciar/Reiniciar limpia la baraja, ganadores y el estado de los cartones.</p>
                         </div>
                     </div>
                     
                     <!-- FORMULARIO DE JUGADOR --><div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-2xl border-t-4 border-yellow-500">
                         <h2 class="text-2xl font-bold mb-4 text-yellow-600">Gesti√≥n de Jugadores</h2>
                         <form onsubmit="window.handlePlayerSubmit(event)" class="grid grid-cols-3 gap-4">
                             <div class="col-span-3">
                                 <label for="playerName" class="block text-sm font-medium text-gray-700">Nombre del Jugador</label>
                                 <input type="text" id="playerName" name="playerName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                             </div>
                             <div>
                                 <label for="partidas" class="block text-sm font-medium text-gray-700">Partidas a Pagar (Activas)</label>
                                 <input type="number" id="partidas" name="partidas" required min="1" value="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                  <p class="text-xs text-gray-500 mt-1">Cada partida es de $20 MXN.</p>
                             </div>
                             <div>
                                 <label for="numCards" class="block text-sm font-medium text-gray-700">Tama√±o del Cart√≥n</label>
                                 <select id="numCards" name="numCards" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                    <option value="4">4 Cartas (2x2)</option>
                                    <option value="6">6 Cartas (2x3)</option>
                                    <option value="9">9 Cartas (3x3)</option>
                                 </select>
                                 <p class="text-xs text-gray-500 mt-1">Define el tama√±o del cart√≥n generado.</p>
                             </div>
                             <div class="col-span-3">
                                 <input type="hidden" id="playerId" name="playerId">
                                 <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition duration-200">
                                     Generar Cart√≥n y Actualizar Partidas
                                 </button>
                             </div>
                         </form>
                     </div>
                     
                     <!-- TABLA DE JUGADORES ACTIVOS --><div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-2xl">
                         <h2 class="text-2xl font-bold mb-4 text-gray-700">Jugadores Registrados (${activePlayersArray.length})</h2>
                         <div class="overflow-x-auto">
                             <table class="min-w-full divide-y divide-gray-200">
                                 <thead class="bg-gray-50">
                                     <tr>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">JUGADOR</th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CARTONES</th>
                                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PARTIDAS ACTIVAS ($)</th>
                                         <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ACCIONES</th>
                                     </tr>
                                 </thead>
                                 <tbody class="bg-white divide-y divide-gray-200">
                                     ${activePlayersArray.length > 0 ? activePlayersArray.map(player => `
                                         <tr>
                                             <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 truncate max-w-xs" title="${player.name}">${player.name} (${player.id.substring(0, 4)}...)</td>
                                             <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${player.boards.length} (Ganados: ${player.boards.filter(b => b.status === 'won').length})</td>
                                             <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-semibold">$${(player.partidas_pagadas * 20).toLocaleString('es-MX')} (${player.partidas_pagadas})</td>
                                             <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                                 <button onclick="window.deletePlayer('${player.id}')" class="text-red-600 hover:text-red-900 transition-colors">Eliminar</button>
                                             </td>
                                         </tr>
                                     `).join('') : `
                                         <tr>
                                             <td colspan="4" class="px-6 py-4 text-center text-gray-500">No hay jugadores registrados.</td>
                                         </tr>
                                     `}
                                 </tbody>
                             </table>
                         </div>
                     </div>
                 </div>
             `;
        };

        // Renderizado de la Modal de Confirmaci√≥n
        const renderModal = () => `
            <div id="confirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden z-50 transition-opacity flex items-center justify-center">
                <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6">
                    <h3 class="text-xl font-bold text-red-600 mb-4" id="modalTitle">Confirmar Acci√≥n</h3>
                    <p id="modalMessage" class="text-gray-700 mb-6"></p>
                    <div class="flex justify-end space-x-4">
                        <button id="cancelActionBtn" onclick="window.hideModal()" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                            Cancelar
                        </button>
                        <button id="confirmActionBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            Confirmar
                        </button>
                    </div>
                </div>
            </div>
        `;

        // Iniciar la aplicaci√≥n al cargar la ventana
        window.onload = initializeFirebase;
    </script>

    <!-- Contenedor Principal de la Aplicaci√≥n --><div id="app-container">
        <div class="text-center p-10">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-t-red-500 border-red-200 rounded-full"></div>
            <p class="text-gray-600 mt-2">Cargando Loter√≠a Mexicana y autenticando...</p>
        </div>
    </div>

</body>
</html>
