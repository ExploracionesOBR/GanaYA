<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loter√≠a Mexicana GANA YA! Interactiva</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Estilos base de la tarjeta GRANDE en juego */
        .card-loteria-lg {
            width: 100%;
            height: 100%;
            /* Ajuste para usar aspect-ratio en lugar del padding-top hack */
            aspect-ratio: 1 / 1.4; 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            border: 3px solid #2563EB; 
            overflow: hidden;
            /* Texto de respaldo */
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        /* MINIATURA DE CARTONES DE JUGADOR */
        .player-card-compact {
            aspect-ratio: 1 / 1.1;
            width: 100%; 
            padding: 4px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            cursor: pointer;
        }
        .player-card-compact:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        }
        .player-grid-compact {
            display: grid;
            gap: 2px;
        }
        .board-grid-4-compact { grid-template-columns: repeat(2, 1fr); }
        .board-grid-6-compact { grid-template-columns: repeat(2, 1fr); }
        .board-grid-9-compact { grid-template-columns: repeat(3, 1fr); }

        /* Estilo para cada celda de la miniatura (ahora con imagen de fondo) */
        .board-cell {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative; /* Para el overlay de la marca */
        }
        
        /* Efecto de marcado: Overlay rojo semitransparente con una 'X' */
        .marked-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(239, 68, 68, 0.7); /* Rojo semi-transparente */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: black;
            color: white;
            text-shadow: 1px 1px 2px black;
        }

        @keyframes fanfare {
            0% { transform: scale(1) rotate(0deg); opacity: 0; }
            50% { transform: scale(1.5) rotate(-5deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 0; }
        }

        /* Animaci√≥n para el overlay del ganador */
        @keyframes winner-bounce {
            0%, 100% { transform: translateY(0); }
            20%, 80% { transform: translateY(-5px); }
            40%, 60% { transform: translateY(-10px); }
        }
        .winner-overlay-content {
            animation: winner-bounce 0.8s ease-in-out infinite alternate;
        }

        /* Animaci√≥n para el efecto "¬°Felicidades!" alrededor del nombre */
        @keyframes glitter {
            0% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1.2); }
            100% { opacity: 0; transform: scale(0.5); }
        }
        .winner-name-effect {
            position: relative;
            display: inline-block;
            overflow: visible;
        }
        .winner-name-effect::before,
        .winner-name-effect::after {
            content: '‚ú®';
            position: absolute;
            font-size: 2rem;
            opacity: 0;
            animation: glitter 1.5s ease-out infinite;
        }
        .winner-name-effect::before {
            top: -20px;
            left: -20px;
            animation-delay: 0s;
        }
        .winner-name-effect::after {
            bottom: -20px;
            right: -20px;
            animation-delay: 0.75s;
        }


        .confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        /* Estructura del Layout Principal de la Vista de Juego */
        .game-layout {
            display: grid;
            grid-template-columns: 1fr 3fr 1fr;
            grid-template-rows: auto 1fr auto;
            gap: 16px;
            height: 90vh; 
        }
        
        /* Definici√≥n de √Åreas */
        .logo-area { grid-area: 1 / 1 / 2 / 2; }
        .title-area { grid-area: 1 / 2 / 2 / 3; }
        .pot-area { grid-area: 1 / 3 / 2 / 4; }
        .players-area { grid-area: 2 / 1 / 3 / 3; }
        .current-card-area { 
            grid-area: 2 / 3 / 4 / 4;
            align-items: flex-start;
        } 
        .winners-area { grid-area: 3 / 1 / 4 / 3; }
        
        /* Media Query para m√≥vil (apilar contenido) */
        @media (max-width: 1024px) {
            .game-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr auto;
                height: auto;
            }
             .logo-area, .title-area, .pot-area, .players-area, .current-card-area, .winners-area {
                grid-area: unset !important;
                grid-column: 1 / -1;
            }
             .current-card-area { order: -1; }
             .players-area { min-height: 400px; }
        }

    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, setDoc, updateDoc, getDocs, addDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer nivel de log para depuraci√≥n de Firestore
        setLogLevel('Debug');
        
        // --- CONSTANTES ---
        // üö® RUTA CRUCIAL: AJUSTADA a todo en MIN√öSCULAS para coincidir con GitHub Pages
        const CARD_IMAGE_PATH = './cartas_baraja_loteria/'; 

        // Variables Globales de Canvas (MANDATORIO)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { /* mock config */ };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Instancias de Firebase
        let app, db, auth;
        let userId = 'loading'; // ID del usuario actual

        // Estados Reactivos GLOBALES
        window.gameState = {
            currentTab: 'game', // 'game' o 'admin'
            isAuthReady: false,
            // Estado del juego desde Firestore (loteria_state/game_status)
            gameStatus: {
                drawnCards: [],
                deck: [], // Baraja completa
                currentCard: null,
                drawSpeed: 1, // 1, 2, o 3
                gameId: null,
                gameRunning: false,
                winner: null, // Nuevo: almacena la info del ganador
            },
            // Datos del jugador desde Firestore (players/{userId})
            players: {},
            // Datos de ganadores desde Firestore (winners/{winnerId})
            winners: [],
            // üö® CARTAS AJUSTADAS: con ESPACIOS, en MIN√öSCULAS y el sufijo -min
            allCards: [
                { id: 1, name: "El Gallo", fileName: "01 el gallo-min.jpg" }, { id: 2, name: "El Diablito", fileName: "02 el diablito-min.jpg" },
                { id: 3, name: "La Dama", fileName: "03 la dama-min.jpg" }, { id: 4, name: "El Catr√≠n", fileName: "04 el catr√≠n-min.jpg" },
                { id: 5, name: "El Paraguas", fileName: "05 el paraguas-min.jpg" }, { id: 6, name: "La Sirena", fileName: "06 la sirena-min.jpg" },
                { id: 7, name: "La Escalera", fileName: "07 la escalera-min.jpg" }, { id: 8, name: "La Botella", fileName: "08 la botella-min.jpg" },
                { id: 9, name: "El Barril", fileName: "09 el barril-min.jpg" }, { id: 10, name: "El √Årbol", fileName: "10 el √°rbol-min.jpg" },
                { id: 11, name: "El Mel√≥n", fileName: "11 el mel√≥n-min.jpg" }, { id: 12, name: "El Valiente", fileName: "12 el valiente-min.jpg" },
                { id: 13, name: "El Gorrito", fileName: "13 el gorrito-min.jpg" }, { id: 14, name: "La Muerte", fileName: "14 la muerte-min.jpg" },
                { id: 15, name: "La Pera", fileName: "15 la pera-min.jpg" }, { id: 16, name: "La Bandera", fileName: "16 la bandera-min.jpg" },
                { id: 17, name: "El Bandol√≥n", fileName: "17 el bandol√≥n-min.jpg" }, { id: 18, name: "El Violoncello", fileName: "18 el violoncello-min.jpg" },
                { id: 19, name: "La Garza", fileName: "19 la garza-min.jpg" }, { id: 20, name: "El P√°jaro", fileName: "20 el p√°jaro-min.jpg" },
                { id: 21, name: "La Mano", fileName: "21 la mano-min.jpg" }, { id: 22, name: "La Bota", fileName: "22 la bota-min.jpg" },
                { id: 23, name: "La Luna", fileName: "23 la luna-min.jpg" }, { id: 24, name: "El Cotorro", fileName: "24 el cotorro-min.jpg" },
                { id: 25, name: "El Borracho", fileName: "25 el borracho-min.jpg" }, { id: 26, name: "El Negrito", fileName: "26 el negrito-min.jpg" },
                { id: 27, name: "El Coraz√≥n", fileName: "27 el coraz√≥n-min.jpg" }, { id: 28, name: "La Sand√≠a", fileName: "28 la sand√≠a-min.jpg" },
                { id: 29, name: "El Tambor", fileName: "29 el tambor-min.jpg" }, { id: 30, name: "El Camar√≥n", fileName: "30 el camar√≥n-min.jpg" },
                { id: 31, name: "Las Jaras", fileName: "31 las jaras-min.jpg" }, { id: 32, name: "El M√∫sico", fileName: "32 el m√∫sico-min.jpg" },
                { id: 33, name: "La Ara√±a", fileName: "33 la ara√±a-min.jpg" }, { id: 34, name: "El Soldado", fileName: "34 el soldado-min.jpg" },
                { id: 35, name: "La Estrella", fileName: "35 la estrella-min.jpg" }, { id: 36, name: "El Cazo", fileName: "36 el cazo-min.jpg" },
                { id: 37, name: "El Mundo", fileName: "37 el mundo-min.jpg" }, { id: 38, name: "El Apache", fileName: "38 el apache-min.jpg" },
                { id: 39, name: "El Nopal", fileName: "39 el nopal-min.jpg" }, { id: 40, name: "El Alacr√°n", fileName: "40 el alacr√°n-min.jpg" },
                { id: 41, name: "La Rosa", fileName: "41 la rosa-min.jpg" }, { id: 42, name: "La Calavera", fileName: "42 la calavera-min.jpg" },
                { id: 43, name: "La Campana", fileName: "43 la campana-min.jpg" }, { id: 44, name: "El Cantarito", fileName: "44 el cantarito-min.jpg" },
                { id: 45, name: "El Venado", fileName: "45 el venado-min.jpg" }, { id: 46, name: "El Sol", fileName: "46 el sol-min.jpg" },
                { id: 47, name: "La Corona", fileName: "47 la corona-min.jpg" }, { id: 48, name: "La Chalupa", fileName: "48 la chalupa-min.jpg" },
                { id: 49, name: "El Pino", fileName: "49 el pino-min.jpg" }, { id: 50, name: "El Pescado", fileName: "50 el pescado-min.jpg" },
                { id: 51, name: "La Palma", fileName: "51 la palma-min.jpg" }, { id: 52, name: "La Maceta", fileName: "52 la maceta-min.jpg" },
                { id: 53, name: "El Arpa", fileName: "53 el arpa-min.jpg" }, { id: 54, name: "La Rana", fileName: "54 la rana-min.jpg" }
            ]
        };

        // --- FUNCIONES DE UTILIDAD FIREBASE ---

        // Rutas de Firestore
        const getGameStatusRef = () => doc(db, 'artifacts', appId, 'public', 'data', 'loteria_state', 'game_status');
        const getPlayersCollection = () => collection(db, 'artifacts', appId, 'public', 'data', 'players');
        const getWinnersCollection = () => collection(db, 'artifacts', appId, 'public', 'data', 'winners');

        // Obtener el nombre del grid CSS basado en el tama√±o del cart√≥n
        const getGridClassCompact = (size) => {
            switch (size) {
                case 4: return 'board-grid-4-compact';
                case 6: return 'board-grid-6-compact'; 
                case 9: return 'board-grid-9-compact'; 
                default: return 'board-grid-4-compact';
            }
        };

        // Inicializaci√≥n de la aplicaci√≥n y autenticaci√≥n
        const initializeFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    // Autenticaci√≥n con token o an√≥nima
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Autenticaci√≥n exitosa con token personalizado.");
                    } else {
                        await signInAnonymously(auth);
                        console.log("Autenticaci√≥n an√≥nima exitosa.");
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("UserID:", userId);
                        } else {
                            userId = crypto.randomUUID();
                            console.warn("No se pudo obtener el UID. Usando ID temporal:", userId);
                        }
                        window.gameState.isAuthReady = true;
                        startListeners(); // Iniciar la escucha de datos
                        window.renderApp(); // Renderizar la interfaz
                    });
                } else {
                    console.error("Configuraci√≥n de Firebase no disponible. Ejecutando en modo demo.");
                    window.gameState.isAuthReady = true;
                    userId = 'demo-user';
                    window.renderApp();
                }
            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                window.gameState.isAuthReady = true;
                userId = 'error-user';
                window.renderApp();
            }
        };

        // Inicializa el documento de estado del juego si no existe
        const initializeGameStatus = async () => {
            if (!db) return;
            const gameStatusRef = getGameStatusRef();
            try {
                const docSnap = await getDoc(gameStatusRef);
                if (!docSnap.exists()) {
                    console.log("Inicializando estado del juego por primera vez.");
                    await setDoc(gameStatusRef, {
                        drawnCards: [],
                        deck: [],
                        currentCard: null,
                        drawSpeed: 1,
                        gameId: null,
                        gameRunning: false,
                        winner: null,
                    });
                }
            } catch (e) {
                console.error("Error al inicializar el estado del juego:", e);
            }
        };

        // Escuchadores de Firestore (onSnapshot)
        const startListeners = () => {
            if (!db || !window.gameState.isAuthReady) return;
            initializeGameStatus(); 

            // 1. Escuchar Estado del Juego
            onSnapshot(getGameStatusRef(), (doc) => {
                const status = doc.data();
                if (status) {
                    // Si el juego ha terminado y hay un ganador, detenemos el intervalo
                    if (!status.gameRunning && status.winner) {
                        window.stopDrawingInterval();
                    } else if (status.gameRunning && drawingInterval === null) {
                        // Si el juego se reactiva desde otro lado, reiniciamos el intervalo
                        window.startDrawingInterval();
                    }

                    window.gameState.gameStatus = {
                        ...window.gameState.gameStatus,
                        ...status,
                        drawnCards: Array.isArray(status.drawnCards) ? status.drawnCards : [],
                        deck: Array.isArray(status.deck) ? status.deck : [],
                        currentCard: status.currentCard || null,
                        drawSpeed: status.drawSpeed || 1,
                        gameRunning: status.gameRunning || false,
                        winner: status.winner || null,
                    };
                    // Solo revisamos las marcas si el juego est√° corriendo
                    if(window.gameState.gameStatus.gameRunning) {
                        checkAndMarkBoards();
                    }
                }
                window.renderApp();
            }, (error) => console.error("Error listening to game status:", error));

            // 2. Escuchar Jugadores
            onSnapshot(getPlayersCollection(), (snapshot) => {
                window.gameState.players = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (Array.isArray(data.boards)) {
                        data.boards = data.boards.map(board => ({
                            ...board,
                            cards: board.cards || [],
                            matched_cards: board.matched_cards || [],
                            boardId: board.boardId || crypto.randomUUID(), 
                        }));
                    } else {
                         data.boards = [];
                    }
                    window.gameState.players[doc.id] = { id: doc.id, ...data };
                });
                window.renderApp();
            }, (error) => console.error("Error listening to players:", error));

            // 3. Escuchar Ganadores
            onSnapshot(query(getWinnersCollection()), (snapshot) => {
                window.gameState.winners = [];
                snapshot.forEach(doc => {
                    window.gameState.winners.push({ id: doc.id, ...doc.data() });
                });
                window.gameState.winners.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                window.renderApp();
            }, (error) => console.error("Error listening to winners:", error));
        };

        // --- L√ìGICA DEL JUEGO ---

        // Marcar cartas en los tableros de los jugadores y revisar si hay ganador
        const checkAndMarkBoards = () => {
            const { gameStatus, players } = window.gameState;
            if (!gameStatus.gameRunning || gameStatus.winner) return;

            const drawnIds = gameStatus.drawnCards.map(card => card.id);
            let playerUpdates = [];
            let winnerDetected = false;

            Object.values(players).forEach(player => {
                if (player.partidas_pagadas <= 0) return; // Ignorar jugadores sin partidas activas
                
                let playerUpdated = false;

                const updatedBoards = player.boards.map(board => {
                    if (board.status === 'won' || winnerDetected) return board; 

                    let currentMatches = board.matched_cards.length;
                    const newMatchedCards = board.cards
                        .filter((card) => drawnIds.includes(card.id))
                        .map(card => card.id);

                    board.matched_cards = newMatchedCards;
                    
                    // Detecci√≥n de Victoria (Llenar todas las cartas del cart√≥n)
                    if (board.matched_cards.length === board.cards.length && board.cards.length > 0) {
                        winnerDetected = true; // Establecer bandera
                        // Llamar a handleWin (que tambi√©n se detiene el juego y se encarga de todo)
                        handleWin(player.id, player.name, board);
                        // Marcar el board como 'won' localmente
                        return { ...board, status: 'won' };
                    }
                    // Si hubo cambios en las marcas
                    else if (currentMatches !== board.matched_cards.length) {
                        playerUpdated = true;
                    }
                    return board;
                });

                if (playerUpdated && !winnerDetected) {
                    playerUpdates.push({
                        id: player.id,
                        name: player.name,
                        boards: updatedBoards,
                        partidas_pagadas: player.partidas_pagadas
                    });
                }
            });

            // Aplicar actualizaciones a Firestore si no hay ganador (si hay, handleWin se encarga)
            if (!winnerDetected) {
                playerUpdates.forEach(p => {
                     updatePlayerInFirestore(p.id, p.name, p.boards, p.partidas_pagadas);
                });
            }
        };

        // Funci√≥n que gestiona una victoria
        const handleWin = async (playerId, playerName, winningBoard) => {
            // Previene m√∫ltiples detecciones
            if (window.gameState.gameStatus.winner) return;
            try {
                // 1. **DETENER EL JUEGO INMEDIATAMENTE** y registrar ganador en el estado del juego
                await setDoc(getGameStatusRef(), { 
                    gameRunning: false,
                    winner: { id: playerId, name: playerName, boardId: winningBoard.boardId, time: new Date() }
                }, { merge: true });
                window.stopDrawingInterval();


                // 2. Calcular el Bote y Registrar Ganador
                // Se recalcula el total de partidas activas justo antes de la victoria
                const totalPartidas = Object.values(window.gameState.players).reduce((acc, p) => acc + (p.partidas_pagadas || 0), 0);
                const prize = totalPartidas * 20; // $20 MXN por cart√≥n activo en juego
                const winTime = new Date();

                await addDoc(getWinnersCollection(), {
                    timestamp: winTime,
                    playerName: playerName,
                    playerId: playerId,
                    prizeAmount: prize,
                    message: `Gan√≥ con un cart√≥n de ${winningBoard.cards.length} cartas`,
                    status: 'PAGADO' 
                });

                // 3. Reducir partidas pagadas del jugador
                const playerRef = doc(getPlayersCollection(), playerId);
                const playerDoc = await getDoc(playerRef);
                if (!playerDoc.exists()) return; 

                const currentData = playerDoc.data();
                
                let newPartidasPagadas = (currentData.partidas_pagadas || 0) - 1;
                if (newPartidasPagadas < 0) newPartidasPagadas = 0;
                
                // Marcar el board como ganado y remover la partida de la cuenta del jugador (partidas_pagadas -1)
                const newBoards = currentData.boards.map(board => 
                    board.boardId === winningBoard.boardId ? { ...board, status: 'won' } : board
                );
                // Si ya no quedan partidas, el jugador se queda con sus boards ganados, pero ya no paga
                await updateDoc(playerRef, {
                    partidas_pagadas: newPartidasPagadas,
                    boards: newBoards,
                });
                window.showConfetti(); // Mostrar confeti

            } catch (e) {
                console.error("Error gestionando la victoria:", e);
            }
        };


        // Barajar y Reiniciar el juego (ADMIN) - GLOBALIZADA
        window.startGame = async () => {
            if (!db) return console.error("Firebase no disponible.");
            // Reiniciar el estado del juego
            const newDeck = [...window.gameState.allCards].sort(() => 0.5 - Math.random());
            try {
                await setDoc(getGameStatusRef(), {
                    drawnCards: [],
                    currentCard: null,
                    deck: newDeck,
                    gameId: Date.now(),
                    drawSpeed: window.gameState.gameStatus.drawSpeed || 1,
                    gameRunning: true,
                    winner: null, // Limpiar ganador
                });

                // Limpiar el estado 'won' de todos los boards y las cartas marcadas
                const playersSnapshot = await getDocs(getPlayersCollection());
                playersSnapshot.forEach(async (playerDoc) => {
                    const playerData = playerDoc.data();
                    const cleanBoards = playerData.boards.map(board => {
                        return { ...board, matched_cards: [], status: 'active' }; // Restablecer a 'active'
                    });
                    // Usamos updateDoc para solo actualizar los boards
                    await updateDoc(doc(getPlayersCollection(), playerDoc.id), { boards: cleanBoards });
                });

                // Limpiar la lista de ganadores (opcional, pero ayuda a la simulaci√≥n de una nueva ronda)
                const winnersSnapshot = await getDocs(getWinnersCollection());
                winnersSnapshot.forEach(async (winnerDoc) => {
                    await deleteDoc(doc(getWinnersCollection(), winnerDoc.id));
                });

                window.startDrawingInterval();
            } catch (e) {
                console.error("Error al iniciar juego:", e);
            }
        };

        // Detener el juego (ADMIN) - GLOBALIZADA
        window.stopGame = async () => {
            if (!db) return;
            try {
                // Detener sin declarar ganador (pausa)
                await setDoc(getGameStatusRef(), { gameRunning: false }, { merge: true });
                window.stopDrawingInterval();
            } catch (e) {
                console.error("Error al detener juego:", e);
            }
        };

        // Cambiar la velocidad de extracci√≥n (ADMIN) - GLOBALIZADA
        window.changeDrawSpeed = async (speed) => {
            if (!db) return;
            try {
                await setDoc(getGameStatusRef(), { drawSpeed: speed }, { merge: true });
            } catch (e) {
                console.error("Error al cambiar velocidad:", e);
            }
        };

        // Extraer la siguiente carta (ADMIN) - GLOBALIZADA
        window.drawNextCard = async (numCards = 1) => {
            const { gameStatus } = window.gameState;
            if (!db || !gameStatus.gameRunning || gameStatus.winner) return;

            let newDeck = [...gameStatus.deck];
            let newDrawnCards = [...gameStatus.drawnCards];
            let lastDrawn = null;

            for (let i = 0; i < numCards; i++) {
                if (newDeck.length > 0) {
                    lastDrawn = newDeck.shift();
                    newDrawnCards.push(lastDrawn);
                }
            }

            if (lastDrawn) {
                 try {
                    await updateDoc(getGameStatusRef(), {
                        deck: newDeck,
                        drawnCards: newDrawnCards,
                        currentCard: lastDrawn,
                    });
                } catch (e) {
                    console.error("Error al extraer carta:", e);
                }
            } else {
                 console.log("¬°Baraja vac√≠a! Juego terminado.");
                window.stopGame();
            }
        };

        // Control de tiempo para el avance autom√°tico (ADMIN) - GLOBALIZADA
        let drawingInterval = null;
        window.startDrawingInterval = () => {
            window.stopDrawingInterval();
            if (!window.gameState.gameStatus.gameRunning) return;

            // La velocidad se ajusta en base a drawSpeed (1, 2, o 3 cartas por lanzamiento)
            const speedMultiplier = window.gameState.gameStatus.drawSpeed;
            // Un lanzamiento cada 5 segundos (m√°s lento)
            const intervalTime = 5000;

            drawingInterval = setInterval(() => {
                if (!window.gameState.gameStatus.gameRunning || window.gameState.gameStatus.winner) {
                    window.stopDrawingInterval();
                    return;
                }
                window.drawNextCard(speedMultiplier);
            }, intervalTime); 
        };

        window.stopDrawingInterval = () => {
            if (drawingInterval) {
                clearInterval(drawingInterval);
                drawingInterval = null;
            }
        };

        // Event listener para la barra espaciadora
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && window.gameState.currentTab === 'game' && window.gameState.gameStatus.gameRunning) {
                e.preventDefault(); // Previene el scroll de la p√°gina
                window.drawNextCard(window.gameState.gameStatus.drawSpeed);
            }
        });

        // --- FUNCIONES DE ADMINISTRACI√ìN ---

        // Funci√≥n para actualizar la informaci√≥n del jugador en Firestore
        const updatePlayerInFirestore = async (playerId, playerName, boards, partidasPagadas) => {
            if (!db) return;
            const playerRef = doc(getPlayersCollection(), playerId);
            try {
                await setDoc(playerRef, {
                    name: playerName,
                    partidas_pagadas: partidasPagadas,
                    boards: boards,
                }, { merge: true });
            } catch (e) {
                console.error("Error al guardar jugador:", e);
            }
        };

        // Generar un nuevo tablero aleatorio
        const generateBoard = (numCards) => {
            const shuffled = [...window.gameState.allCards].sort(() => 0.5 - Math.random());
            const boardCards = shuffled.slice(0, numCards); 
            return {
                cards: boardCards,
                matched_cards: [],
                boardId: crypto.randomUUID(), 
                status: 'active'
            };
        };

        // A√±adir/Actualizar un jugador (ADMIN) - GLOBALIZADA
        window.handlePlayerSubmit = (event) => {
            event.preventDefault();
            const form = event.target;
            const playerName = form.playerName.value.trim();
            const partidas = parseInt(form.partidas.value, 10);
            const numCards = parseInt(form.numCards.value, 10); // 4, 6 o 9
            const playerId = form.playerId.value || Date.now().toString(); 

            if (!playerName || isNaN(partidas) || partidas < 1 || isNaN(numCards) || ![4, 6, 9].includes(numCards)) {
                window.showAlert('Datos de jugador inv√°lidos. Aseg√∫rate de que las partidas sean al menos 1 y el cart√≥n sea de 4, 6 o 9 cartas.', 'error');
                return;
            }
            
            let boards = [];
            const existingPlayer = window.gameState.players[playerId];

            if (existingPlayer) {
                boards = existingPlayer.boards;
            } else {
                 // Generar UN cart√≥n por esta acci√≥n, el contador de partidas controla la cantidad que est√° pagando
                boards.push(generateBoard(numCards));
            }
            
            const finalPlayerId = existingPlayer ? existingPlayer.id : 'player-' + playerId;

            updatePlayerInFirestore(finalPlayerId, playerName, boards, partidas);
            
            form.reset();
        };

        // Eliminar jugador (ADMIN) - GLOBALIZADA
        window.deletePlayer = (id) => {
            if (!db) return;
            const player = window.gameState.players[id];
            window.showConfirmation(`¬øEst√°s seguro de que quieres eliminar al jugador **${player.name}**?`, async () => {
                try {
                    await deleteDoc(doc(getPlayersCollection(), id));
                    window.hideModal();
                } catch (e) {
                    console.error("Error al eliminar jugador:", e);
                    window.hideModal();
                }
            });
        };
        
        // --- UTILIDADES UI ---
        
        // Mostrar mensaje de alerta/confirmaci√≥n
        window.showConfirmation = (message, onConfirm) => {
            const modalEl = document.getElementById('confirmationModal');
            document.getElementById('modalTitle').textContent = 'Confirmar Acci√≥n';
            document.getElementById('modalMessage').innerHTML = message;
            
            const confirmBtn = document.getElementById('confirmActionBtn');
            confirmBtn.onclick = onConfirm;
            confirmBtn.classList.remove('hidden');
            document.getElementById('cancelActionBtn').classList.remove('hidden');

            modalEl.classList.remove('hidden');
        };

        window.showAlert = (message, type = 'info') => {
            const modalEl = document.getElementById('confirmationModal');
            document.getElementById('modalTitle').textContent = type === 'error' ? '¬°Error!' : 'Informaci√≥n';
            document.getElementById('modalMessage').innerHTML = message;
            
            const confirmBtn = document.getElementById('confirmActionBtn');
            confirmBtn.classList.add('hidden');
            document.getElementById('cancelActionBtn').classList.add('hidden');
            
            modalEl.classList.remove('hidden');
        }

        window.hideModal = () => {
            document.getElementById('confirmationModal').classList.add('hidden');
        };

        // Generar Confeti para la victoria
        window.showConfetti = () => {
            const confettiContainer = document.getElementById('confetti-container');
            confettiContainer.innerHTML = ''; // Limpiar confeti anterior
            const colors = ['#f44336', '#ffeb3b', '#2196f3', '#4caf50', '#ff9800'];
            const pieces = 50;

            let style = document.createElement('style');
            style.type = 'text/css';
            document.head.appendChild(style);

            for (let i = 0; i < pieces; i++) {
                const color = colors[Math.floor(Math.random() * colors.length)];
                const size = Math.random() * 10 + 5;
                const left = Math.random() * 100;
                const delay = Math.random() * 2;
                const duration = Math.random() * 3 + 2;

                const piece = document.createElement('div');
                piece.style.cssText = `
                    position: absolute;
                    width: ${size}px;
                    height: ${size}px;
                    background-color: ${color};
                    top: -${size}px;
                    left: ${left}%;
                    opacity: 0;
                    transform-origin: 50% 50%;
                    animation: confetti-fall-${i} ${duration}s ease-in ${delay}s forwards;
                    border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
                `;
                confettiContainer.appendChild(piece);
                
                // Generar keyframes din√°micos
                style.sheet.insertRule(`
                    @keyframes confetti-fall-${i} {
                        0% { transform: translate(0, 0) rotate(0deg); opacity: 1; }
                        100% { transform: translate(${Math.random() * 400 - 200}px, 100vh) rotate(${720 + Math.random() * 360}deg); opacity: 0; }
                    }
                `);
            }
            // Limpiar confeti despu√©s de 5 segundos
            setTimeout(() => { confettiContainer.innerHTML = ''; }, 5000); 
        };

        // --- FUNCIONES DE RENDERIZADO (UI) ---

        // Funci√≥n para renderizar una carta GRANDE individual
        const renderSingleCardLG = (card) => {
            if (!card) return '';
            // üö® MODIFICADO: Usar el fileName de la carta para la imagen de fondo
            const imageUrl = CARD_IMAGE_PATH + card.fileName;

            return `
                <div class="card-loteria-lg bg-white shadow-2xl transition-transform duration-200"
                    style="background-image: url('${imageUrl}'); border-color: #EF4444;"
                    title="${card.name}"
                >
                    <div class="absolute inset-x-0 bottom-0 bg-black/60 p-1 text-center">
                        <span class="text-sm font-bold text-white">${card.name}</span>
                        <span class="text-xs text-yellow-300">#${card.id}</span>
                    </div>
                </div>
            `;
        };

        // Funci√≥n para renderizar la tarjeta compacta de un jugador
        const renderPlayerCardCompact = (player) => {
            // Solo renderizamos la primera tabla activa
            const activeBoard = player.boards.find(b => b.status !== 'won');
            if (!activeBoard) return '';

            const cardCount = activeBoard.cards.length;
            const isMatched = (cardId) => activeBoard.matched_cards.includes(cardId);
            const gridClass = getGridClassCompact(cardCount);
            const isWinning = activeBoard.status === 'won';
            const progress = cardCount > 0 ? (activeBoard.matched_cards.length / cardCount) : 0;
            const progressColor = isWinning ? 'bg-green-600' : (progress > 0.6 ? 'bg-yellow-500' : 'bg-red-500');

            return `
                <div class="player-card-compact ${isWinning ? 'border-4 border-green-500 shadow-lg' : 'border border-gray-300'}"
                    title="${player.name} - ${activeBoard.matched_cards.length}/${cardCount} Cartas"
                >
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-bold truncate max-w-[60%]">${player.name}</span>
                        <span class="text-[0.6rem] font-medium text-gray-500">${activeBoard.matched_cards.length}/${cardCount}</span>
                    </div>
                    <div class="${gridClass} player-grid-compact w-full h-full">
                        ${activeBoard.cards.map(card => `
                            <div class="board-cell w-full h-full" 
                                style="aspect-ratio: 1; background-image: url('${CARD_IMAGE_PATH}${card.fileName}');"
                                title="${card.name}"
                            >
                                ${isMatched(card.id) ? 
                                    `<div class="marked-overlay">X</div>` : 
                                    ''
                                }
                            </div>
                        `).join('')}
                    </div>
                    <div class="h-1 mt-1 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full ${progressColor}" style="width: ${progress * 100}%;"></div>
                    </div>
                    <div class="text-[0.6rem] text-center font-semibold text-gray-700 mt-1">
                        Partidas: ${player.partidas_pagadas}
                    </div>
                </div>
            `;
        };

        // Renderizar la Vista del Juego (Live)
        const renderGameView = () => {
            const { gameStatus, players, winners } = window.gameState;
            // Jugadores que tienen al menos 1 partida activa
            const activePlayers = Object.values(players).filter(p => p.partidas_pagadas > 0 && p.boards.length > 0);
            // C√°lculo del bote: $20 MXN por CADA partida activa
            const totalPot = activePlayers.reduce((acc, p) => acc + (p.partidas_pagadas || 0), 0) * 20;
            const cardsRemaining = gameStatus.deck.length;

            return `
                ${gameStatus.winner ?
                `
                <div class="fixed inset-0 bg-black/80 z-40 flex flex-col items-center justify-center p-4">
                    <div class="bg-yellow-400 p-10 rounded-3xl border-8 border-red-600 text-center shadow-2xl winner-overlay-content">
                        <h2 class="text-8xl font-black text-red-800 mb-4 tracking-wider">¬°GANA YA!</h2>
                        <p class="text-4xl font-extrabold text-gray-900">¬°Ganador: <span class="text-red-600 winner-name-effect">${gameStatus.winner.name.toUpperCase()}</span>!</p>
                        <p class="text-xl text-gray-700 mt-2">Ha ganado el Bote de **$${totalPot.toLocaleString('es-MX')} MXN**</p>
                    </div>
                </div>
                ` : ''}

                <div class="game-layout">
                    <div class="logo-area flex items-center justify-center">
                        <div class="w-12 h-12 rounded-full bg-red-600 text-white flex items-center justify-center font-black text-lg shadow-md">L</div>
                    </div>

                    <div class="title-area flex items-center justify-center border-2 border-gray-300 rounded-lg p-2 bg-white shadow-md">
                        <h1 class="text-2xl font-extrabold text-red-600 tracking-tighter">LOTER√çA MEXICANA ¬°FELICIDADES!</h1>
                    </div>

                    <div class="pot-area flex flex-col items-center justify-center border-2 border-green-500 bg-green-50 rounded-lg p-2 shadow-md">
                        <span class="text-xs font-semibold text-green-700">BOTE ACUMULADO</span>
                        <p class="text-xl font-black text-green-800">$${totalPot.toLocaleString('es-MX')} MXN</p>
                    </div>

                    <div class="current-card-area flex flex-col items-center bg-white p-4 rounded-xl shadow-2xl border-4 border-yellow-500">
                        <h3 class="text-lg font-bold mb-3 text-yellow-700 border-b pb-2 w-full text-center">CARTA EN JUEGO</h3>
                        
                        <div class="flex flex-col items-center w-full max-w-[200px] aspect-[1/1.4] mb-4">
                            ${renderSingleCardLG(gameStatus.currentCard)}
                        </div>

                        <div class="flex flex-col space-y-2 w-full">
                            <button onclick="window.drawNextCard(window.gameState.gameStatus.drawSpeed)" 
                                ${!gameStatus.gameRunning || gameStatus.winner ? 'disabled' : ''}
                                class="w-full py-3 bg-red-600 text-white font-bold rounded-lg shadow-xl hover:bg-red-700 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed text-sm"
                            > 
                                TIRAR CARTA (ESPACIO)
                            </button>
                            <button onclick="window.startGame()" class="w-full py-2 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition duration-200 text-sm"
                            > 
                                üîÑ BARAJEAR Y REINICIAR
                            </button>
                        </div>

                        <div class="w-full mt-4 p-3 bg-gray-100 rounded-lg shadow-inner">
                            <p class="text-xs font-semibold mb-2 text-gray-700 text-center">MAZO: ${gameStatus.drawnCards.length} / ${window.gameState.allCards.length} | Restantes: ${cardsRemaining}</p>
                            <p class="text-xs font-semibold mb-1 text-gray-700">Velocidad:</p>
                            <div class="flex justify-between space-x-1">
                                <button onclick="window.changeDrawSpeed(1)" class="flex-1 py-1 text-xs rounded-full transition-all ${gameStatus.drawSpeed === 1 ? 'bg-red-600 text-white' : 'bg-gray-300 text-gray-700 hover:bg-red-200'}">üê¢ 1</button>
                                <button onclick="window.changeDrawSpeed(2)" class="flex-1 py-1 text-xs rounded-full transition-all ${gameStatus.drawSpeed === 2 ? 'bg-red-600 text-white' : 'bg-gray-300 text-gray-700 hover:bg-red-200'}">üêá 2</button>
                                <button onclick="window.changeDrawSpeed(3)" class="flex-1 py-1 text-xs rounded-full transition-all ${gameStatus.drawSpeed === 3 ? 'bg-red-600 text-white' : 'bg-gray-300 text-gray-700 hover:bg-red-200'}">üöÄ 3</button>
                            </div>
                        </div>

                        <div class="w-full mt-4 p-3 bg-red-50 rounded-lg border border-red-200 shadow-inner">
                            <h3 class="text-xs font-bold mb-2 text-red-600 w-full text-center">HISTORIAL</h3>
                            <div class="flex justify-center space-x-2">
                                ${gameStatus.drawnCards.slice(-5).reverse().map(card => `
                                    <div class="w-8 h-11 bg-cover bg-center rounded shadow-md border border-gray-300" 
                                        style="background-image: url('${CARD_IMAGE_PATH}${card.fileName}');"
                                        title="${card.name}">
                                    </div>
                                `).join('')}
                                ${gameStatus.drawnCards.length === 0 ? '<p class="text-gray-500 text-xs">Empieza la partida...</p>' : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="players-area bg-white p-4 rounded-xl shadow-2xl border-4 border-red-600 overflow-y-auto">
                        <h3 class="text-xl font-bold mb-3 text-red-600 border-b pb-2">JUGADORES ACTIVOS (${activePlayers.length})</h3>
                        <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 xl:grid-cols-7 2xl:grid-cols-8 gap-3">
                            ${activePlayers.length > 0 ? activePlayers.map(renderPlayerCardCompact).join('') : '<p class="text-gray-500">No hay jugadores activos con partidas pagadas.</p>'}
                        </div>
                    </div>

                    <div class="winners-area bg-white p-4 rounded-xl shadow-2xl border-4 border-blue-600 overflow-y-auto">
                        <h3 class="text-xl font-bold mb-3 text-blue-600 border-b pb-2">GANADORES RECIENTES (${winners.length})</h3>
                        <div class="flex flex-wrap gap-4">
                            ${winners.slice(0, 10).map(w => `
                                <div class="bg-blue-50 p-3 rounded-lg border border-blue-200 text-sm shadow-sm">
                                    <p class="font-bold text-blue-800">${w.playerName}</p>
                                    <p class="text-xs text-gray-600">${w.message}</p>
                                    <p class="text-sm font-black text-green-700">$${w.prizeAmount.toLocaleString('es-MX')} MXN</p>
                                </div>
                            `).join('')}
                            ${winners.length === 0 ? '<p class="text-gray-500">A√∫n no hay ganadores en esta ronda.</p></div>' : ''}
                        </div>
                    </div>

                </div>
            `;
        };

        // Renderizar la Vista de Administraci√≥n
        const renderAdminView = () => {
            const { gameStatus, players } = window.gameState;
            const activePlayersArray = Object.values(players);

            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-2xl border-t-4 border-red-600">
                        <h2 class="text-2xl font-bold mb-4 text-red-600">Control de la Partida</h2>

                        <div class="mb-4">
                            <p class="font-semibold text-lg mb-2">Estado: 
                                <span class="${gameStatus.gameRunning ? 'text-green-600' : gameStatus.winner ? 'text-yellow-600' : 'text-gray-500'} font-bold">
                                    ${gameStatus.gameRunning ? 'CORRIENDO' : gameStatus.winner ? '¬°TERMINADO (GANADOR)!': 'DETENIDO'}
                                </span>
                            </p>
                            ${gameStatus.currentCard ? `<p class="text-sm text-gray-600">√öltima carta: ${gameStatus.currentCard.name} (${gameStatus.currentCard.id})</p>` : ''}
                            <p class="text-sm text-gray-600">Cartas restantes: ${gameStatus.deck.length}</p>
                        </div>

                        <div class="flex flex-col space-y-3">
                            ${gameStatus.gameRunning ? `
                                <button onclick="window.drawNextCard(window.gameState.gameStatus.drawSpeed)" class="w-full py-3 bg-yellow-500 text-white font-bold rounded-lg shadow-md hover:bg-yellow-600 transition duration-200">
                                    LANZAR SIGUIENTE (${gameStatus.drawSpeed})
                                </button>
                                <button onclick="window.stopGame()" class="w-full py-3 bg-red-600 text-white font-bold rounded-lg shadow-md hover:bg-red-700 transition duration-200">
                                    PAUSAR JUEGO
                                </button>
                            ` : `
                                <button onclick="window.startGame()" class="w-full py-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition duration-200">
                                    INICIAR/REINICIAR JUEGO
                                </button>
                            `}
                            <p class="text-xs text-gray-500 pt-2">El bot√≥n Iniciar/Reiniciar limpia la baraja, ganadores y el estado de los cartones.</p>
                        </div>
                    </div>

                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-2xl border-t-4 border-yellow-500">
                        <h2 class="text-2xl font-bold mb-4 text-yellow-600">Gesti√≥n de Jugadores</h2>
                        <form onsubmit="window.handlePlayerSubmit(event)" class="grid grid-cols-3 gap-4">
                            <div class="col-span-3">
                                <label for="playerName" class="block text-sm font-medium text-gray-700">Nombre del Jugador</label>
                                <input type="text" id="playerName" name="playerName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            </div>

                            <div>
                                <label for="partidas" class="block text-sm font-medium text-gray-700">Partidas Pagadas (x$20)</label>
                                <input type="number" id="partidas" name="partidas" min="1" value="1" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            </div>

                            <div>
                                <label for="numCards" class="block text-sm font-medium text-gray-700">Tama√±o del Cart√≥n</label>
                                <select id="numCards" name="numCards" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                    <option value="4">4 Cartas</option>
                                    <option value="6">6 Cartas</option>
                                    <option value="9">9 Cartas</option>
                                </select>
                            </div>
                            
                            <input type="hidden" id="playerId" name="playerId" value="">

                            <div class="col-span-3">
                                <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    A√±adir / Actualizar Jugador
                                </button>
                            </div>
                            <p class="col-span-3 text-xs text-gray-500">Si el jugador ya existe, se actualizan sus datos y el contador de partidas pagadas.</p>
                        </form>
                    </div>

                    <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-2xl border-t-4 border-blue-600">
                        <h2 class="text-2xl font-bold mb-4 text-blue-600">Lista de Jugadores Registrados (${activePlayersArray.length})</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NOMBRE</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CARTONES</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PARTIDAS ACTIVAS ($)</th>
                                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ACCIONES</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${activePlayersArray.length > 0 ? activePlayersArray.map(player => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 truncate max-w-xs" title="${player.name}">${player.name} (${player.id.substring(0, 4)}...)</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${player.boards.length} (Ganados: ${player.boards.filter(b => b.status === 'won').length})</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-semibold">$${(player.partidas_pagadas * 20).toLocaleString('es-MX')}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                <button onclick="window.deletePlayer('${player.id}')" class="text-red-600 hover:text-red-900 ml-3">Eliminar</button>
                                            </td>
                                        </tr>
                                    `).join('') : `
                                        <tr>
                                            <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">No hay jugadores registrados.</td>
                                        </tr>
                                    `}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        };
        
        // Renderizado de la aplicaci√≥n
        window.renderApp = () => {
            const appContainer = document.getElementById('app-container');
            const isGameTab = window.gameState.currentTab === 'game';
            
            // Si Firebase no est√° listo, solo muestra el spinner (o modo demo)
            if (!window.gameState.isAuthReady && Object.keys(firebaseConfig).length > 0) {
                 appContainer.innerHTML = `
                    <div class="text-center p-10">
                        <div class="animate-spin inline-block w-8 h-8 border-4 border-t-red-500 border-red-200 rounded-full"></div>
                        <p class="mt-4 text-red-600">Conectando a Firebase...</p>
                    </div>
                 `;
                 return;
            }

            // Renderizado completo de la interfaz
            appContainer.innerHTML = `
                <div class="p-4 lg:p-6">
                    <div class="flex border-b border-gray-300 mb-6 space-x-4">
                        <button onclick="window.gameState.currentTab = 'game'; window.renderApp();" 
                                class="py-2 px-4 font-semibold transition-colors duration-200 
                                       ${isGameTab ? 'border-b-4 border-red-600 text-red-600' : 'text-gray-500 hover:text-red-400'}">
                            Vista de Juego (Live)
                        </button>
                        <button onclick="window.gameState.currentTab = 'admin'; window.renderApp();" 
                                class="py-2 px-4 font-semibold transition-colors duration-200 
                                       ${!isGameTab ? 'border-b-4 border-red-600 text-red-600' : 'text-gray-500 hover:text-red-400'}">
                            Administrador
                        </button>
                    </div>
                    ${isGameTab ? renderGameView() : renderAdminView()}
                </div>
                ${renderModal()}
                <div id="confetti-container" class="confetti"></div>
            `;
        };

        // Renderizado del Modal de Confirmaci√≥n
        const renderModal = () => `
            <div id="confirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden z-50 transition-opacity flex items-center justify-center">
                <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-6">
                    <h3 class="text-xl font-bold text-red-600 mb-4" id="modalTitle">Confirmar Acci√≥n</h3>
                    <p id="modalMessage" class="text-gray-700 mb-6"></p>
                    <div class="flex justify-end space-x-4">
                        <button id="cancelActionBtn" onclick="window.hideModal()" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                            Cancelar
                        </button>
                        <button id="confirmActionBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            Confirmar
                        </button>
                    </div>
                </div>
            </div>
        `;

        // Iniciar la aplicaci√≥n al cargar la ventana
        window.onload = initializeFirebase;
    </script>

    <div id="app-container">
        <div class="text-center p-10">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-t-red-500 border-red-200 rounded-full"></div>
            <p class="mt-4 text-red-600">Cargando aplicaci√≥n...</p>
        </div>
    </div>
</body>
</html>
