<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üé¥ GANA YA! - Loter√≠a Interactiva Mexicana (v9.14)</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%23ff6bcb'/%3E%3Ctext x='50%25' y='55%25' font-size='18' font-family='Arial' fill='white' text-anchor='middle' font-weight='700'%3EG%3C/text%3E%3C/svg%3E">
<style>
/* VARIABLES DE COLOR */
:root{ 
    --rojo:#e63946; 
    --verde:#2a9d8f; 
    --azul:#457b9d; 
    --naranja:#f4a261; 
    --crema:#f1faee; 
    --sombra:0 10px 28px rgba(0,0,0,0.15); 
    --accent1:#e9c46a; 
    --accent2:#d62828; 
}

/* GENERALES */
*{box-sizing:border-box} 
html,body{height:100%; margin:0; padding:0;}
body{ 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
  background:var(--crema); 
  color:#1d3557;
  background-image: radial-gradient(var(--accent1) 1px, transparent 1px), radial-gradient(var(--rojo) 1px, transparent 1px);
  background-position: 0 0, 25px 25px; 
  background-size: 50px 50px;
  overflow-x: hidden; 
}

/* CONTENEDOR PRINCIPAL CENTRADO */
.container{ 
  max-width:1200px; 
  margin: 0 auto;
  padding: 10px; 
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* ENCABEZADO */
.main-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 0;
    margin-bottom: 10px;
    background: rgba(255,255,255,0.85);
    backdrop-filter: blur(5px);
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    border-bottom: 3px solid var(--rojo);
}

.logo-box-wrapper{
  flex-shrink: 0;
  width: 90px; 
  height: 90px;
  margin-left: 15px;
}

.logo-box img{ 
  width:100%; 
  height:100%;
  object-fit:contain; 
  filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));
}

.title-container {
    flex-grow: 1;
    text-align: center;
    padding: 0 15px;
}

.title { 
  font-size: clamp(32px, 5vw, 48px); /* T√≠tulo responsivo */
  font-weight:900; 
  color:var(--rojo); 
  margin:0; 
  animation: fiesta 4s linear infinite; 
  line-height: 1.1;
  text-transform: uppercase;
  letter-spacing: -1px;
}

.subtitle { 
  color: var(--verde); 
  font-size: 15px;
  margin-top: 4px; 
  font-weight: 600;
}

@keyframes fiesta { 
  0%{ color:#e63946 } 25%{ color:#2a9d8f } 50%{ color:#e9c46a } 75%{ color:#f4a261 } 100%{ color:#e63946 } 
}

/* MAIN GRID */
.main-grid{ 
  display:grid;
  grid-template-columns: 260px 1fr 340px; 
  gap:12px; 
  align-items:start;
  flex-grow: 1;
}
@media(max-width:1100px){ .main-grid{ grid-template-columns: 240px 1fr; } .controls-panel{ grid-column: 1 / -1; grid-row: 1; } #winners-panel { grid-row: 2; } #players-section { grid-row: 2; }}
@media(max-width:850px){ .main-grid{ grid-template-columns: 1fr; } .controls-panel, #winners-panel, #players-section { grid-column: auto; grid-row: auto; } }

.mex-frame, .mex-frame-small{ 
  background:#fff; 
  border-radius:12px; 
  padding:12px; 
  box-shadow:var(--sombra); 
  border: none;
  position: relative;
  overflow: hidden;
}
.mex-frame::before, .mex-frame-small::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px;
    background: linear-gradient(90deg, var(--verde) 0%, var(--crema) 50%, var(--rojo) 100%);
}

/* CONTROLES HEADER */
.header-controls-wrapper {
  margin-right: 15px;
  display: flex;
  gap: 10px;
  align-items: center;
}

.bolsa-compact{ 
  display:flex; flex-direction: column; align-items:flex-end;
  padding: 5px 10px; background: var(--crema); border-radius: 8px; border: 1px solid var(--accent1);
}
.bolsa-compact .label{ font-size:11px; font-weight:700; color:var(--verde); text-transform: uppercase; }
.bolsa-compact .amount{ font-weight:900; color:var(--rojo); font-size:18px; line-height: 1; }

.toggle-btn{ 
  padding:8px 12px; border-radius:8px; border:none; font-weight:700; cursor:pointer; 
  transition: all .2s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.toggle-btn:hover{ transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
.toggle-play{ background:var(--azul); color:white; }
.toggle-admin{ background:#e0e0e0; color:#333; }

/* JUGADORES - MODIFICADO PARA 5 COLUMNAS FIJAS Y M√ÅS COMPACTO */
.players-grid{ 
  display:grid; 
  grid-template-columns: repeat(5, 1fr); /* 5 Columnas FIJAS */
  gap:6px; /* Gap m√°s peque√±o */
}
/* En m√≥viles muy peque√±os, quiz√°s quieras bajar a 3 o 4 para que no se rompa, 
   pero pediste fijo a 5. Si se ve muy mal en cel, descomenta la linea de abajo */
/* @media(max-width:600px){ .players-grid{ grid-template-columns: repeat(3, 1fr) !important; } } */

.player-card{ 
  background:#fff; border-radius:8px; padding:5px; text-align:center;
  box-shadow: 0 2px 5px rgba(0,0,0,0.08); cursor:pointer; transition:all .2s ease;
  border: 1px solid #eee;
  min-height: 110px; /* Altura m√≠nima reducida */
}
.player-card:hover{ transform:translateY(-2px); box-shadow: 0 5px 12px rgba(0,0,0,0.12); border-color: var(--accent1); }
.player-name{ 
    font-weight:800; font-size:12px; /* Fuente m√°s peque√±a */
    color: var(--azul); margin-bottom: 2px; 
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
}
.player-info { font-size: 10px; color:#777; margin-bottom:4px; }

.card-thumb{ 
  width:48px; height:70px; border-radius:5px; background-size:cover; background-position:center; 
  position:relative; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
/* Thumbs m√°s peque√±os DENTRO de la tarjeta de jugador para que quepan bien */
.player-cards .card-thumb { 
    width: 100%; height: auto; aspect-ratio: 3/4.5; 
    min-width: 25px; /* Evita que desaparezcan en pantallas muy peque√±as */
} 

.card-thumb.passed{ filter:grayscale(1) opacity(0.5); }
.sticker{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; }
.sticker img{ width:70%; height:70%; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }

/* CONTROLES JUEGO */
#control-partida h3 { color: var(--rojo); text-align: center; margin-top: 0; }
.controls { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top:10px; }
.btn{ 
  padding:10px 16px; border-radius:8px; font-weight:800; border:none; cursor:pointer; color:white;
  transition: transform .1s active, box-shadow .2s ease; text-transform: uppercase; letter-spacing: 0.5px; font-size: 14px;
}
.btn:active { transform: scale(0.98); }
.btn-blue{ background:var(--azul); } .btn-red{ background:var(--rojo); } .btn-green{ background:var(--verde); } .btn-muted{ background:#999; }

.current-card{ 
  height:240px; border-radius:12px; display:flex; align-items:center; justify-content:center; 
  background: #fff url('logo_1_entrada.png') no-repeat center center; background-size: 80px;
  border: 2px dashed #ddd; margin-top: 10px; overflow: hidden;
}
.current-card-img { width: 100%; height: 100%; background-size: contain; background-position: center; background-repeat: no-repeat; }

/* ADMIN */
.admin-row{ display:flex; gap:10px; flex-wrap: wrap; }
.admin-col{ flex:1; min-width: 300px; }
.input{ width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; margin-bottom: 8px; font-family: inherit; }
.input:focus { outline: 2px solid var(--azul); border-color: transparent; }

.table-wrap{ overflow-x:auto; background: #fff; border-radius: 8px; border: 1px solid #eee; }
table { width: 100%; border-collapse: collapse; font-size: 13px; }
th { background: var(--azul); color: white; text-align: left; padding: 8px; position: sticky; top: 0; }
td { border-bottom: 1px solid #eee; padding: 8px; }
tr:hover { background: #f9f9f9; }

/* MODALES */
.modal-back{ position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter: blur(3px); display:flex; align-items:center; justify-content:center; z-index:9999; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
.modal-back.active { opacity: 1; pointer-events: all; }
.modal{ background:#fff; border-radius:15px; padding:20px; width:90%; max-width:500px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); position: relative; transform: translateY(20px); transition: transform 0.3s ease; max-height: 90vh; overflow-y: auto; }
.modal-back.active .modal { transform: translateY(0); }

.close-modal-x { position: absolute; top: 10px; right: 15px; font-size: 24px; background: none; border: none; cursor: pointer; color: #999; }
.close-modal-x:hover { color: var(--rojo); }

/* WINNER ANIMATIONS */
@keyframes mexicanGlow {
    0% { box-shadow: 0 0 5px var(--verde), 0 0 10px var(--blanco), 0 0 15px var(--rojo); }
    50% { box-shadow: 0 0 20px var(--verde), 0 0 30px var(--accent1), 0 0 40px var(--rojo); transform: scale(1.18); }
    100% { box-shadow: 0 0 5px var(--verde), 0 0 10px var(--blanco), 0 0 15px var(--rojo); }
}
.winner-card {
    animation: mexicanGlow 1.5s infinite ease-in-out;
    z-index: 10;
}

/* SHUFFLE OVERLAY */
.shuffle-overlay{ position:fixed; inset:0; z-index:2000; background:rgba(255,248,240,0.95); display:none; align-items:center; justify-content:center; flex-direction: column; }
.shuffle-overlay.visible{ display:flex; }

#confetti-canvas { position: fixed; inset: 0; pointer-events: none; z-index: 9998; }
.hidden { display: none !important; }

/* UTILS */
.text-center { text-align: center; }
.mb-2 { margin-bottom: 0.5rem; }
.mt-2 { margin-top: 0.5rem; }
.w-full { width: 100%; }
.font-bold { font-weight: 700; }
.badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; color: white; }
.badge-play { background-color: var(--verde); }
.badge-win { background-color: var(--accent1); color: #333; animation: pulse 1s infinite; }
.badge-paid { background-color: var(--azul); }
.badge-end { background-color: #999; }

@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

</style>
</head>
<body>

<!-- SONIDOS (Requieren archivos locales) -->
<audio id="snd-flip" src="flip.mp3" preload="auto"></audio>
<audio id="snd-win" src="APLAUSOS_GANADOR.mp3" preload="auto"></audio>

<div class="container">

  <header class="main-header">
      <div class="logo-box-wrapper">
          <div class="logo-box"><img id="logo-img" src="logo_1_entrada.png" alt="Logo Loter√≠a"></div>
      </div>
      <div class="title-container">
          <div class="title">üéâ GANA YA!</div>
          <div class="subtitle">Loter√≠a Interactiva Mexicana</div>
      </div>
      <div class="header-controls-wrapper">
          <div class="bolsa-compact">
              <span class="label" id="bolsa-label">üí∞ Bolsa</span>
              <span class="amount" id="bolsa-amount">$0.00</span>
          </div>
          <button id="btn-view-play" class="toggle-btn toggle-play" title="Vista de Juego">Jugar</button>
          <button id="btn-view-admin" class="toggle-btn toggle-admin" title="Vista de Administraci√≥n">‚öôÔ∏è</button>
      </div>
  </header>
  
  <!-- VISTA DE JUEGO -->
  <div class="main-grid" id="main-grid">

    <!-- PANEL IZQUIERDO: GANADORES -->
    <aside class="mex-frame-small winners" id="winners-panel">
      <h3 class="text-center" style="color: var(--verde); margin-top:0;">üèÜ Ganadores Recientes</h3>
      <div id="winners-list" style="min-height: 100px;">
          <div class="text-center small-muted" style="padding: 20px; opacity: 0.6;">Esperando ganadores...</div>
      </div>
    </aside>

    <!-- PANEL CENTRAL: JUGADORES -->
    <section class="mex-frame" id="players-section">
      <h2 class="text-center" style="color: var(--azul); margin-top:0;">JUGADORES ACTIVOS</h2>
      <div class="players-grid" id="players-area">
          <!-- Se llena con JS -->
      </div>
    </section>

    <!-- PANEL DERECHO: CONTROLES -->
    <aside class="controls-panel mex-frame-small" id="controls-panel">
        <div id="control-partida"> 
            <h3>üéÆ CONTROL DE JUEGO</h3>
            
            <div style="margin-bottom: 15px;">
                <label for="select-modality" style="display:block; text-align:center; font-size:12px; color:#666; margin-bottom:5px;">Modalidad Actual:</label>
                <select id="select-modality" class="input" style="text-align:center; font-weight:bold; font-size:16px;">
                    <option value="4">4 Cartas</option>
                    <option value="6">6 Cartas</option>
                </select>
            </div>

            <!-- CONTROLES NORMALES -->
            <div id="game-controls-group" class="controls">
                <button id="btn-shuffle" class="btn btn-blue w-full">üîÄ BARAJEAR</button>
                <div style="display:flex; gap:8px; width:100%;">
                    <button id="btn-draw" class="btn btn-red" style="flex:1;">üÉè TIRAR</button>
                    <button id="btn-auto" class="btn btn-green" style="flex:1;">ü§ñ AUTO</button>
                </div>
            </div>

            <!-- BOT√ìN DE REINICIO (SOLO AL GANAR) -->
            <button id="btn-reset-win" class="btn btn-verde w-full hidden" style="background: var(--verde); padding: 15px; font-size: 18px; animation: pulse 2s infinite;">üîÑ REINICIAR PARTIDA</button>

            <div class="text-center mt-2" style="color:#666; font-size:13px;">
                Cartas restantes: <strong id="deck-count" style="color:var(--rojo)">54</strong>
            </div>
        </div>

        <div style="margin-top:20px">
            <h3 class="text-center" style="margin-bottom:10px; color:var(--azul)">CARTA EN JUEGO</h3>
            <div id="current-card" class="current-card">
                <!-- Carta actual -->
            </div>
        </div>

        <div style="margin-top:20px">
            <h4 class="text-center" style="margin:0 0 10px 0; color:#999; font-size:14px;">ANTERIORES</h4>
            <div id="last-cards" style="display:flex; gap:5px; justify-content:center; min-height:60px;"></div>
        </div>
    </aside>

  </div> 
  
  <!-- VISTA DE ADMINISTRACI√ìN -->
  <section id="view-admin" class="mex-frame hidden" style="margin-top:10px;">
    <h2 style="color:var(--azul); margin-top:0; border-bottom:2px solid #eee; padding-bottom:10px;">‚öôÔ∏è Administraci√≥n de Caja</h2>
    
    <div class="admin-row">
      <!-- CONFIG PRECIOS -->
      <div class="admin-col mex-frame-small">
        <h3 style="margin-top:0; color:var(--verde)">üí≤ Configuraci√≥n de Precios</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div>
                <label class="font-bold">4 Cartas:</label>
                <div style="display:flex; gap:5px; align-items:center">
                    <input id="price4" class="input" type="number" placeholder="Precio" title="Precio al p√∫blico">
                    <input id="profit4" class="input" type="number" placeholder="Ganancia" title="Ganancia de la casa">
                </div>
            </div>
            <div>
                <label class="font-bold">6 Cartas:</label>
                <div style="display:flex; gap:5px; align-items:center">
                    <input id="price6" class="input" type="number" placeholder="Precio">
                    <input id="profit6" class="input" type="number" placeholder="Ganancia">
                </div>
            </div>
        </div>
        <button id="save-prices" class="btn btn-blue w-full mt-2">Guardar Precios</button>
      </div>

      <!-- REGISTRO JUGADOR -->
      <div class="admin-col mex-frame-small">
        <h3 style="margin-top:0; color:var(--rojo)">üìù Registrar Jugador</h3>
        <input id="input-name" placeholder="Nombre Completo" class="input">
        <div style="display:flex; gap:10px;">
            <input id="input-cell" placeholder="Celular (WhatsApp)" class="input" style="flex:1">
            <input id="input-clabe" placeholder="CLABE / Cuenta Destino" class="input" style="flex:1">
        </div>
        
        <div style="background:#f9f9f9; padding:10px; border-radius:8px; margin:10px 0;">
            <label style="font-size:13px; font-weight:bold; color:var(--azul)">üî¢ Calculadora R√°pida:</label>
            <input id="input-budget" placeholder="Ingresa Presupuesto MXN" class="input" type="number" min="0">
            <div id="calc-info" style="font-size:13px; color:#555; margin-bottom:8px; min-height:20px;">Ingresa un presupuesto para ver opciones.</div>
        </div>

        <div style="display:flex; gap:10px; align-items: flex-end;">
            <div style="flex:1">
                <label style="font-size:12px;">Cant. 4 Cartas</label>
                <input id="qty4" type="number" min="0" value="0" class="input text-center">
            </div>
            <div style="flex:1">
                <label style="font-size:12px;">Cant. 6 Cartas</label>
                <input id="qty6" type="number" min="0" value="0" class="input text-center">
            </div>
            <button id="btn-register" class="btn btn-green" style="flex:1.5; height: 42px;">‚úÖ REGISTRAR</button>
        </div>
      </div>
    </div>

    <!-- TABLA DE JUGADORES -->
    <div class="mex-frame-small" style="margin-top:15px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-wrap:wrap; gap:10px;">
            <div style="display:flex; gap:5px; align-items:center;">
                <strong>Filtrar:</strong>
                <button class="toggle-btn" id="filter-all" style="background:#eee">Todos</button>
                <button class="toggle-btn" id="filter-4" style="background:#eee">4 Cartas</button>
                <button class="toggle-btn" id="filter-6" style="background:#eee">6 Cartas</button>
            </div>
            <div style="display:flex; gap:10px;">
                 <button id="btn-export" class="btn btn-blue">üìÑ Reporte PDF</button>
                 <button id="btn-reset-day" class="btn btn-red">üóëÔ∏è BORRAR D√çA</button>
            </div>
        </div>
        <div class="table-wrap">
            <table id="players-table-el">
                <thead>
                    <tr><th>Folio</th><th>Jugador</th><th>Mod.</th><th>Restantes</th><th>En Juego</th><th>Casa</th><th>Estado</th><th>Acci√≥n</th></tr>
                </thead>
                <tbody id="players-table-body">
                    <!-- Llenado con JS -->
                </tbody>
            </table>
        </div>
    </div>
  </section>
  
</div> <!-- Fin Container -->

<!-- MODALES -->
<div class="modal-back" id="modal-player">
    <div class="modal">
        <button class="close-modal-x" id="close-player-modal">√ó</button>
        <h3 id="modal-player-title" style="color:var(--azul); margin-top:0;">Detalle de Jugador</h3>
        <div id="modal-player-body"></div>
        <div id="modal-player-actions" class="mt-2" style="display:flex; flex-direction:column; gap:8px;">
            <!-- Acciones din√°micas (copiar clabe, marcar pagado, etc) -->
        </div>
    </div>
</div>

<div class="modal-back" id="modal-winner">
    <div class="modal text-center" style="border: 5px solid var(--accent1);">
        <h1 style="color:var(--rojo); font-size: 36px; margin:10px 0;">üéâ ¬°LOTER√çA! üéâ</h1>
        <div id="winner-body" style="font-size:20px; margin-bottom:20px;"></div>
        <button id="btn-winner-ok" class="btn btn-green" style="font-size:20px; padding:15px 30px;">¬°VER GANADORES!</button>
    </div>
</div>

<div class="modal-back" id="modal-winner-detail">
    <div class="modal text-center">
        <button class="close-modal-x" id="close-winner-detail">√ó</button>
        <h2 style="color:var(--verde); margin-top:0;">üëë ¬°TENEMOS GANADOR!</h2>
        <h3 id="wd-player-name" style="color:var(--azul)"></h3>
        <div id="wd-cards" style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin:20px 0;"></div>
        <button id="btn-wd-close" class="btn btn-blue">Cerrar y Continuar</button>
    </div>
</div>

<!-- OVERLAYS -->
<div id="shuffle-overlay" class="shuffle-overlay">
    <div style="font-size: 40px; color:var(--rojo); font-weight:900; margin-bottom:20px;">¬°BARAJEANDO!</div>
    <!-- Aqu√≠ se inyectan cartas animadas -->
</div>
<canvas id="confetti-canvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
/*** GANA YA! v9.14 Core Logic ***/

// CONFIG & CONSTANTS
const CARD_PATH = 'Cartas_baraja_loteria/'; 
const CARD_MAP = {1:"1 el gallo",2:"2 el diablito",3:"3 la dama",4:"4 el catrin",5:"5 el paraguas",6:"6 la sirena",7:"7 la escalera",8:"8 la botella",9:"9 el barril",10:"10 arbol",11:"11 melon",12:"12 el valiente",13:"13 el gorrito",14:"14 la muerte",15:"15 la pera",16:"16 la bandera",17:"17 el bandolon",18:"18 el violoncello",19:"19 la garza",20:"20 el pajaro",21:"21 la mano",22:"22 la bota",23:"23 la luna",24:"24 el cotorro",25:"25 el borracho",26:"26 el negrito",27:"27 el corazon",28:"28 la sandia",29:"29 el tambor",30:"30 el camaron",31:"31 las jaras",32:"32 el musico",33:"33 la ara√±a",34:"34 el soldado",35:"35 la estrella",36:"36 el cazo",37:"37 el mundo",38:"38 el apache",39:"39 el nopal",40:"40 el alacran",41:"41 la rosa",42:"42 la calavera",43:"43 la campana",44:"44 el cantarito",45:"45 el venado",46:"46 el sol",47:"47 la corona",48:"48 la chalupa",49:"49 el pino",50:"50 el pescado",51:"51 la palma",52:"52 la maceta",53:"53 el arpa",54:"54 la rana"};
const getCardUrl = id => `${CARD_PATH}${CARD_MAP[id] || id}.jpg`;
const getCardName = id => (CARD_MAP[id] || `Carta ${id}`).replace(/^\d+\s*/, '').toUpperCase();

// STATE MANAGEMENT
const LS_KEYS = { PRICES:'gy_prices', GAME:'gy_game', PURCHASES:'gy_purchases', WINNERS:'gy_winners', ID:'gy_id_ctr', MODE:'gy_mode' };
let APP = {
    prices: load(LS_KEYS.PRICES) || {p4:10, g4:2, p6:12, g6:3},
    game: load(LS_KEYS.GAME) || {deck:createDeck(), drawn:[], current:null, state:'READY'}, 
    purchases: load(LS_KEYS.PURCHASES) || [],
    winners: load(LS_KEYS.WINNERS) || [],
    mode: parseInt(localStorage.getItem(LS_KEYS.MODE) || 4),
    idCounter: parseInt(localStorage.getItem(LS_KEYS.ID) || 100),
    autoInterval: null
};

// UTILS
function load(k){ try{return JSON.parse(localStorage.getItem(k))}catch(e){return null} }
function save(){ 
    localStorage.setItem(LS_KEYS.PRICES, JSON.stringify(APP.prices));
    localStorage.setItem(LS_KEYS.GAME, JSON.stringify(APP.game));
    localStorage.setItem(LS_KEYS.PURCHASES, JSON.stringify(APP.purchases));
    localStorage.setItem(LS_KEYS.WINNERS, JSON.stringify(APP.winners));
    localStorage.setItem(LS_KEYS.MODE, APP.mode);
    localStorage.setItem(LS_KEYS.ID, APP.idCounter);
}
function createDeck(){ return Array.from({length:54},(_,i)=>i+1); }
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]} return arr; }
function fmtMoney(n){ return '$'+Number(n||0).toFixed(2); }
function playSound(id) { const el = document.getElementById(id); if(el) { el.currentTime = 0; el.play().catch(e=>console.log('Audio error:',e)); } }

// CORE GAME FUNCTIONS
function drawCard() {
    if(APP.game.state === 'WINNER') return;
    if(APP.game.deck.length === 0) { alert('¬°Se acabaron las cartas! Barajea de nuevo.'); stopAuto(); return; }
    
    playSound('snd-flip');
    const card = APP.game.deck.shift();
    APP.game.drawn.push(card);
    APP.game.current = card;
    APP.game.state = 'PLAYING';
    
    checkWinners(card);
    save();
    renderUI();
}

function checkWinners(lastCard) {
    let winnersFound = [];
    APP.purchases.forEach(p => {
        if(p.state !== 'JUGANDO' || p.gamesLeft < 1) return;
        if(p.cards.includes(lastCard) && !p.marked.includes(lastCard)) {
            p.marked.push(lastCard);
        }
        if(p.marked.length === p.modality) {
            winnersFound.push(p);
        }
    });

    if(winnersFound.length > 0) {
        APP.game.state = 'WINNER';
        stopAuto();
        
        const winMod = winnersFound[0].modality;
        const activePot = APP.purchases.filter(p => p.modality === winMod && p.state === 'JUGANDO' && p.gamesLeft > 0)
                                       .reduce((sum, p) => sum + (p.price - p.profit), 0);
        const prizePerWinner = activePot / winnersFound.length;

        winnersFound.forEach(p => {
            p.state = 'GANADOR'; 
            APP.winners.unshift({
                ts: Date.now(), pid: p.id, name: p.name, mod: p.modality, 
                card: lastCard, prize: prizePerWinner, paid: false
            });
        });

        save();
        showWinnerModal(winnersFound, lastCard, prizePerWinner);
    }
}

function resetGame() {
    if(!confirm('¬øINICIAR NUEVA PARTIDA?\n\nSe descontar√° 1 partida a los jugadores activos de la modalidad actual ('+APP.mode+' cartas).')) return;
    
    APP.purchases.forEach(p => {
        if(p.modality === APP.mode && (p.state === 'JUGANDO' || p.state === 'GANADOR')) {
            if(p.state === 'GANADOR') p.state = 'JUGANDO'; 
            p.gamesLeft--;
            if(p.gamesLeft <= 0) p.state = 'FINALIZADO';
        }
        p.marked = []; 
    });

    APP.game.deck = shuffle(createDeck());
    APP.game.drawn = [];
    APP.game.current = null;
    APP.game.state = 'READY';
    
    save();
    renderUI();
    
    const overlay = document.getElementById('shuffle-overlay');
    overlay.classList.add('visible');
    setTimeout(() => { overlay.classList.remove('visible'); }, 2000);
}

// UI RENDERING
function renderUI() {
    const isPlayView = document.getElementById('view-admin').classList.contains('hidden');
    let totalPot = 0;
    if(isPlayView) {
        totalPot = APP.purchases.filter(p => p.modality === APP.mode && p.state === 'JUGANDO' && p.gamesLeft > 0)
                     .reduce((sum, p) => sum + (p.price - p.profit), 0);
        document.getElementById('bolsa-label').textContent = `üí∞ BOLSA (${APP.mode} CARTAS)`;
    } else {
         totalPot = APP.purchases.reduce((sum,p) => sum + (p.profit * p.initialGames), 0);
         document.getElementById('bolsa-label').textContent = `üè¶ CASA TOTAL`;
    }
    document.getElementById('bolsa-amount').textContent = fmtMoney(totalPot);

    const grid = document.getElementById('players-area');
    const activePlayers = APP.purchases.filter(p => p.modality === APP.mode && (p.state === 'JUGANDO' || p.state === 'GANADOR') && p.gamesLeft > 0);
    
    if(activePlayers.length === 0) {
        grid.innerHTML = '<div class="text-center small-muted" style="grid-column:1/-1; padding:30px; opacity:0.5;">No hay jugadores activos para '+APP.mode+' cartas.</div>';
    } else {
        grid.innerHTML = activePlayers.map(p => {
            let cardsHtml = p.cards.map(cid => {
                const isMarked = p.marked.includes(cid);
                const isPassed = !isMarked && APP.game.drawn.includes(cid);
                return `<div class="card-thumb ${isPassed?'passed':''}" style="background-image:url('${getCardUrl(cid)}')">
                    ${isMarked ? '<div class="sticker"><img src="logo_1_entrada.png"></div>' : ''}
                </div>`;
            }).join('');
            
            return `<div class="player-card" onclick="showPlayerDetail('${p.id}')">
                <div class="player-name" title="${p.name}">${p.name}</div>
                <div class="player-info">Partidas: <strong>${p.gamesLeft}</strong></div>
                <div class="player-cards" style="display:grid; grid-template-columns:repeat(${APP.mode===4?2:3}, 1fr); gap:3px;">
                    ${cardsHtml}
                </div>
            </div>`;
        }).join('');
    }

    const winnerPending = APP.game.state === 'WINNER';
    document.getElementById('game-controls-group').classList.toggle('hidden', winnerPending);
    document.getElementById('btn-reset-win').classList.toggle('hidden', !winnerPending);
    document.getElementById('deck-count').textContent = APP.game.deck.length;
    document.getElementById('select-modality').value = APP.mode;
    document.getElementById('select-modality').disabled = APP.game.state === 'PLAYING' || winnerPending;

    const curCardEl = document.getElementById('current-card');
    if(APP.game.current) {
        curCardEl.innerHTML = `<div class="current-card-img" style="background-image:url('${getCardUrl(APP.game.current)}')"></div>`;
    } else {
        curCardEl.innerHTML = '<div style="opacity:0.4; font-weight:bold; color:#999;">LISTO PARA JUGAR</div>';
    }
    
    const lastEl = document.getElementById('last-cards');
    lastEl.innerHTML = APP.game.drawn.slice(-4, -1).reverse().map(cid => 
        `<div class="card-thumb" style="width:40px;height:55px;background-image:url('${getCardUrl(cid)}')"></div>`
    ).join('');

    renderWinnersPanel();
    renderAdminTable();
}

function renderWinnersPanel() {
    const list = document.getElementById('winners-list');
    if(APP.winners.length === 0) {
        list.innerHTML = '<div class="text-center small-muted" style="padding:20px; opacity:0.6;">Sin ganadores hoy.</div>';
        return;
    }
    list.innerHTML = APP.winners.slice(0,5).map(w => `
        <div style="padding:8px; border-bottom:1px solid #eee; font-size:13px;">
            <div style="font-weight:bold; color:var(--azul)">${w.name}</div>
            <div style="display:flex; justify-content:space-between; color:#666;">
                <span>${fmtMoney(w.prize)} (${w.mod} CARTAS)</span>
                <span style="color:${w.paid?'var(--verde)':'var(--rojo)'}">${w.paid?'PAGADO':'PENDIENTE'}</span>
            </div>
        </div>
    `).join('');
}

// ADMIN FUNCTIONS
function registerPlayer() {
    const name = document.getElementById('input-name').value.trim();
    const cell = document.getElementById('input-cell').value.trim();
    const clabe = document.getElementById('input-clabe').value.trim();
    const q4 = parseInt(document.getElementById('qty4').value) || 0;
    const q6 = parseInt(document.getElementById('qty6').value) || 0;
    
    if(!name || (q4+q6) === 0) { alert('Faltan datos (Nombre, Cantidad de Partidas).'); return; }
    // CLABE es opcional pero recomendada.

    const batch = [];
    for(let i=0; i<q4; i++) batch.push(createPurchase(name, cell, clabe, 4));
    for(let i=0; i<q6; i++) batch.push(createPurchase(name, cell, clabe, 6));
    
    APP.purchases.push(...batch);
    save();
    renderUI();
    
    alert(`¬°${name} registrado con √©xito! (${q4+q6} partidas totales)`);
    
    // Limpiar todos los campos tras registro exitoso
    document.getElementById('input-name').value = '';
    document.getElementById('input-cell').value = '';
    document.getElementById('input-clabe').value = '';
    document.getElementById('qty4').value = 0;
    document.getElementById('qty6').value = 0;
    document.getElementById('input-budget').value = '';
    document.getElementById('calc-info').textContent = 'Ingresa un presupuesto para ver opciones.';
    
    // Enviar WhatsApp de bienvenida (toma el primer ID del batch para referencia)
    if(cell && batch.length > 0) sendWelcomeWhatsapp(batch[0].id, batch);
}

function createPurchase(name, cell, clabe, mod) {
    APP.idCounter++;
    const cards = generateUniqueCards(mod);
    // NUEVO FORMATO DE FOLIO: GanaYA!-XXXX
    const newId = `GanaYA!-` + String(APP.idCounter).padStart(4, '0');
    
    return {
        id: newId, name, cell, clabe, modality: mod, cards, marked: [],
        gamesLeft: 1, initialGames: 1, state: 'JUGANDO',
        price: mod===4 ? APP.prices.p4 : APP.prices.p6,
        profit: mod===4 ? APP.prices.g4 : APP.prices.g6,
        ts: Date.now()
    };
}

function generateUniqueCards(qty) {
    return shuffle(createDeck()).slice(0, qty);
}

function renderAdminTable() {
    const tbody = document.getElementById('players-table-body');
    tbody.innerHTML = APP.purchases.slice().reverse().map(p => `
        <tr>
            <td>${p.id}</td>
            <td><strong>${p.name}</strong><br><small>${p.cell || 'Sin Cel'}</small></td>
            <td class="text-center">${p.modality} Cartas</td>
            <td class="text-center">${p.gamesLeft}</td>
            <td class="text-center">${fmtMoney(p.price - p.profit)}</td>
            <td class="text-center">${fmtMoney(p.profit)}</td>
            <td class="text-center"><span class="badge ${p.state==='JUGANDO'?'badge-play':p.state==='GANADOR'?'badge-win':p.state==='PAGADO'?'badge-paid':'badge-end'}">${p.state}</span></td>
            <td class="text-center"><button class="btn btn-blue" style="padding:4px 8px; font-size:11px;" onclick="showPlayerDetail('${p.id}')">VER</button></td>
        </tr>
    `).join('');
}

// WHATSAPP MESSAGES
function sendWelcomeWhatsapp(pid, batch = []) {
    const p = APP.purchases.find(x => x.id === pid);
    if(!p || !p.cell) return;

    // Si es un lote, mandamos todas las cartas juntas
    const purchasesToSend = batch.length > 0 ? batch : [p];
    let cardsMsg = "";
    purchasesToSend.forEach(pur => {
         cardsMsg += `üéüÔ∏è *FOLIO ${pur.id}* (${pur.modality} Cartas):\n${pur.cards.map(id => getCardName(id)).join(', ')}\n\n`;
    });

    const msg = `üéâ ¬°HOLA ${p.name.toUpperCase()}! BIENVENIDO A GANA YA! üéâ\n\n‚úÖ Tu registro fue exitoso. Aqu√≠ est√°n tus tableros para hoy:\n\n${cardsMsg}üçÄ ¬°MUCHA SUERTE Y A GANAR! üçÄ`;
    window.open(`https://wa.me/${p.cell}?text=${encodeURIComponent(msg)}`, '_blank');
}

function sendPaymentWhatsapp(winRec) {
    const p = APP.purchases.find(x => x.id === winRec.pid);
    if(!p || !p.cell) { alert('No hay celular registrado para enviar confirmaci√≥n.'); return; }
    
    const now = new Date();
    const timeStr = now.toLocaleTimeString('es-MX', {hour: '2-digit', minute:'2-digit'});
    const accountStr = p.clabe ? `a la cuenta con terminaci√≥n *${p.clabe.slice(-4)}*` : 'a tu cuenta registrada';

    const msg = `ü§ë ¬°FELICIDADES ${p.name.toUpperCase()}! ü§ë\n\nüí∏ TU PAGO HA SIDO ENVIADO üí∏\n\nüí∞ Monto: *${fmtMoney(winRec.prize)}*\nüè¶ Destino: Enviado ${accountStr}\n‚è∞ Hora: ${timeStr}\n\nüÉè Carta Ganadora: *${getCardName(winRec.card)}*\n\nü•≥ ¬°Que siga la racha! ¬øListo para la pr√≥xima ronda? ¬°VAMOS POR M√ÅS! üí™üî•`;
    window.open(`https://wa.me/${p.cell}?text=${encodeURIComponent(msg)}`, '_blank');
}

// MODALS & INTERACTION
function showWinnerModal(winnersList, winningCard, prize) {
    playSound('snd-win');
    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, zIndex: 9999 });

    const winModal = document.getElementById('modal-winner');
    winModal.classList.add('active');
    
    let html = `Ganador(es) con la carta <strong>${getCardName(winningCard)}</strong>:<br><br>`;
    winnersList.forEach(w => {
        html += `<div style="color:var(--azul); font-weight:900; font-size:24px;">${w.name}</div>`;
    });
    html += `<br>Premio por jugador: <strong style="color:var(--verde);">${fmtMoney(prize)}</strong>`;
    document.getElementById('winner-body').innerHTML = html;
    document.getElementById('btn-winner-ok').onclick = () => { winModal.classList.remove('active'); showWinnerDetail(winnersList[0]); };
}

function showWinnerDetail(player) {
    const modal = document.getElementById('modal-winner-detail');
    modal.classList.add('active');
    document.getElementById('wd-player-name').textContent = player.name;
    const lastDrawn = APP.game.current;
    document.getElementById('wd-cards').innerHTML = player.cards.map(cid => {
        const isWinnerCard = (cid === lastDrawn);
        const isMarked = player.marked.includes(cid);
        return `<div class="card-thumb ${isWinnerCard ? 'winner-card' : ''}" style="width:80px; height:120px; background-image:url('${getCardUrl(cid)}')">
            ${isMarked ? '<div class="sticker"><img src="logo_1_entrada.png"></div>' : ''}
        </div>`;
    }).join('');
}

function showPlayerDetail(pid) {
    const p = APP.purchases.find(x => x.id === pid);
    if(!p) return;
    
    document.getElementById('modal-player').classList.add('active');
    document.getElementById('modal-player-title').textContent = p.name;
    
    // Detectar si tiene premio pendiente
    const winRec = APP.winners.find(w => w.pid === pid && !w.paid);

    let html = `<div class="text-center">
        <p>Folio: <strong>${p.id}</strong> | Cel: ${p.cell || 'N/A'}</p>
        <p>CLABE/Cta: <strong>${p.clabe || 'No registrada'}</strong></p>
        <p>Modalidad: ${p.modality} Cartas | Restantes: ${p.gamesLeft}</p>
        <hr>
        <div style="display:flex; justify-content:center; gap:8px; flex-wrap:wrap; margin:15px 0;">
             ${p.cards.map(cid => `<div class="card-thumb" style="width:60px; height:90px; background-image:url('${getCardUrl(cid)}')"></div>`).join('')}
        </div>
    </div>`;
    document.getElementById('modal-player-body').innerHTML = html;

    // Botones de acci√≥n din√°micos
    const actionsDiv = document.getElementById('modal-player-actions');
    actionsDiv.innerHTML = '';

    if(p.clabe) {
        actionsDiv.innerHTML += `<button class="btn btn-blue" onclick="copyToClipboard('${p.clabe}')">üìã Copiar CLABE/Cuenta</button>`;
    }
    if(winRec) {
        actionsDiv.innerHTML += `<button class="btn btn-green" onclick="markAsPaid('${winRec.pid}', ${winRec.ts})">üí∏ Marcar como PAGADO y Notificar</button>`;
    }
    actionsDiv.innerHTML += `<button class="btn btn-muted" onclick="sendWelcomeWhatsapp('${p.id}')">üì± Reenviar Cartas (WhatsApp)</button>`;
    actionsDiv.innerHTML += `<button class="btn btn-muted" onclick="document.getElementById('modal-player').classList.remove('active')">Cerrar</button>`;
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => alert('CLABE copiada al portapapeles'));
}

function markAsPaid(pid, ts) {
    const winIdx = APP.winners.findIndex(w => w.pid === pid && w.ts === ts);
    if(winIdx === -1) return;
    
    APP.winners[winIdx].paid = true;
    const p = APP.purchases.find(x => x.id === pid);
    if(p) p.state = 'PAGADO'; // Opcional, si quieres rastrear el estado final de esa "compra"
    
    save(); renderUI();
    document.getElementById('modal-player').classList.remove('active');
    
    if(confirm('Marcado como PAGADO. ¬øEnviar confirmaci√≥n por WhatsApp ahora?')) {
        sendPaymentWhatsapp(APP.winners[winIdx]);
    }
}

// AUTO PLAY
function toggleAuto() {
    if(APP.autoInterval) {
        stopAuto();
    } else {
        document.getElementById('btn-auto').textContent = '‚èπ DETENER';
        document.getElementById('btn-auto').classList.replace('btn-green','btn-muted');
        drawCard(); // Primera carta inmediata
        APP.autoInterval = setInterval(drawCard, 3000); // Cada 3 seg
    }
}
function stopAuto() {
    clearInterval(APP.autoInterval);
    APP.autoInterval = null;
    const btn = document.getElementById('btn-auto');
    if(btn) {
        btn.textContent = 'ü§ñ AUTO';
        btn.classList.replace('btn-muted','btn-green');
    }
}

// EVENT LISTENERS & INIT
document.addEventListener('DOMContentLoaded', () => {
    renderUI();

    // View Toggles
    document.getElementById('btn-view-play').onclick = () => {
        document.getElementById('view-admin').classList.add('hidden');
        document.getElementById('main-grid').classList.remove('hidden');
    };
    document.getElementById('btn-view-admin').onclick = () => {
        document.getElementById('view-admin').classList.remove('hidden');
        document.getElementById('main-grid').classList.add('hidden');
    };

    // Game Actions
    document.getElementById('btn-draw').onclick = drawCard;
    document.getElementById('btn-shuffle').onclick = resetGame; 
    document.getElementById('btn-reset-win').onclick = resetGame;
    document.getElementById('btn-auto').onclick = toggleAuto;
    document.getElementById('select-modality').onchange = (e) => {
        APP.mode = parseInt(e.target.value);
        APP.game.state = 'READY'; 
        save(); renderUI();
    };

    // Admin Actions
    document.getElementById('btn-register').onclick = registerPlayer;
    document.getElementById('save-prices').onclick = () => {
        APP.prices.p4 = parseFloat(document.getElementById('price4').value) || APP.prices.p4;
        APP.prices.g4 = parseFloat(document.getElementById('profit4').value) || APP.prices.g4;
        APP.prices.p6 = parseFloat(document.getElementById('price6').value) || APP.prices.p6;
        APP.prices.g6 = parseFloat(document.getElementById('profit6').value) || APP.prices.g6;
        save(); alert('Precios guardados');
    };
    document.getElementById('btn-reset-day').onclick = () => {
        if(confirm('¬øBORRAR TODAS LAS COMPRAS Y GANADORES DEL D√çA?')) {
            APP.purchases = []; APP.winners = []; APP.game = {deck:createDeck(), drawn:[], current:null, state:'READY'};
            save(); renderUI();
        }
    };

    // Calculator
    document.getElementById('input-budget').addEventListener('input', (e) => {
        const budget = parseFloat(e.target.value) || 0;
        const p4 = APP.prices.p4 || 1;
        const p6 = APP.prices.p6 || 1;
        const max4 = Math.floor(budget / p4);
        const max6 = Math.floor(budget / p6);
        
        document.getElementById('calc-info').innerHTML = 
            (budget > 0) 
            ? `Opciones: <strong style="color:var(--azul)">${max4}</strong> de 4 Cartas √≥ <strong style="color:var(--azul)">${max6}</strong> de 6 Cartas.`
            : 'Ingresa un presupuesto para ver opciones.';
    });

    // Modals
    document.querySelectorAll('.close-modal-x, #btn-wd-close').forEach(el => {
        el.onclick = () => document.querySelectorAll('.modal-back').forEach(m => m.classList.remove('active'));
    });

    // Init inputs with current prices
    document.getElementById('price4').value = APP.prices.p4;
    document.getElementById('profit4').value = APP.prices.g4;
    document.getElementById('price6').value = APP.prices.p6;
    document.getElementById('profit6').value = APP.prices.g6;
});
</script>
</body>
</html>
