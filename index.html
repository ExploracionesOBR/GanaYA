<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gana YA! - Loter√≠a</title>
<style>
:root{ --gold:#ffd966; --accent:#f9d65d; --bg:#fff8ec; }
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;background:var(--bg);color:#222}
.container{max-width:1200px;margin:0 auto;padding:12px;position:relative}
.header{display:flex;align-items:center;justify-content:center;gap:12px}
h1.title{margin:6px 0;font-size:26px;color:#b42222}
.intro{background:#fffbe6;padding:10px;border-radius:10px;text-align:center;margin:10px 0}
.controls-row{display:flex;gap:10px;justify-content:flex-end;align-items:center;margin-bottom:8px}
.controls-row .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
.btn-blue{background:#2b8af7;color:#fff}
.btn-yellow{background:var(--accent);color:#333}
.btn-green{background:#0f8a3c;color:#fff}
.bolsa{display:flex;justify-content:flex-end;margin-bottom:8px}
.bolsa .box{background:#fff;padding:8px 12px;border-radius:8px;box-shadow:0 6px 16px rgba(0,0,0,0.06);font-weight:700}
#players-area{margin:6px 0;padding:6px}
.players-title{text-align:center;margin:6px 0 12px 0;font-weight:700}
.players-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;align-items:start}
.card-thumb{width:120px;height:180px;border-radius:10px;background:#fff;box-shadow:0 8px 20px rgba(0,0,0,0.12);overflow:hidden;position:relative;background-size:cover;background-position:center}
.card-thumb .logo-small{position:absolute;right:8px;bottom:8px;width:40px;height:40px;background-image:url('logo_1_entrada.png');background-size:contain;background-repeat:no-repeat;opacity:.95}
.card-thumb.back-pattern{background:repeating-linear-gradient(45deg,#f6f6f6 0 10px,#ececec 10px 20px)}
.card-thumb.back-pattern::after{content:'';position:absolute;left:50%;top:50%;width:44px;height:44px;transform:translate(-50%,-50%);background-image:url('logo_1_entrada.png');background-size:contain;background-repeat:no-repeat;opacity:0.95}
.card-thumb.shine::before{content:'';position:absolute;top:0;left:-80%;width:60%;height:100%;background:linear-gradient(120deg, rgba(255,200,80,0.95), rgba(255,200,80,0.0));transform:skewX(-20deg);z-index:3;animation:shineMove .9s linear 0s 2}
@keyframes shineMove{100%{left:140%}}
#shuffle-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:9998}
.shuffle-center{position:relative;width:880px;height:520px}
.shuffle-card{position:absolute;width:120px;height:180px;border-radius:10px;background-size:cover;background-position:center;box-shadow:0 12px 28px rgba(0,0,0,0.28);transform-origin:center center}
.shuffle-card.flip{transform:rotateY(180deg) scale(.98);transition:transform .6s}
.shuffle-card.wave-move{transition:transform .9s,opacity .9s}
#winner-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.66);z-index:10000}
#winner-modal .card-wrap{width:420px;height:620px;border-radius:14px;box-shadow:0 30px 80px rgba(0,0,0,0.6);background-size:cover;background-position:center;position:relative;overflow:visible}
#winner-modal .badge{position:absolute;top:18px;left:50%;transform:translateX(-50%);font-size:34px;font-weight:900;color:#fff;text-shadow:0 6px 20px rgba(0,0,0,0.6)}
#winner-modal .amount{position:absolute;bottom:28px;left:50%;transform:translateX(-50%);font-size:44px;font-weight:900;color:var(--gold);text-shadow:0 8px 30px rgba(255,180,0,0.18)}
@keyframes winnerPop{0%{transform:scale(.7) rotateX(20deg);opacity:0}60%{transform:scale(1.12) rotateX(0);opacity:1}100%{transform:scale(1)}}
.panel-ultimos-ganadores{position:relative;padding-top:26px}
#logo-top-left{position:absolute;top:-26px;left:14px;width:64px;height:64px;background-image:url('logo_1_entrada.png');background-size:contain;background-repeat:no-repeat;z-index:50;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.12)}
.hidden{display:none !important}
</style>
</head>
<body>
<div class="container">
  <div id="totales-admin" style="display:none;position:sticky;top:0;background:#fff8e6;padding:10px;border-bottom:2px solid var(--accent);z-index:100">
    <div style="display:flex;justify-content:space-between;gap:10px;max-width:1200px;margin:0 auto;">
      <div>üè† Ganancia total de la casa: <span id="gananciaCasaTotal">$0</span></div>
      <div>üí∞ Bolsa total del juego: <span id="bolsaTotalInline">$0</span></div>
    </div>
  </div>
  <div class="header">
    <h1 class="title">üé¥ GANA YA!</h1>
  </div>
  <p class="intro">üéâ Gana YA! es un sitio de entretenimiento y convivencia familiar.</p>
  <div class="controls-row">
    <div class="bolsa box" style="margin-right:auto">
      <div class="box">üí∞ Bolsa: <span id="bolsaInline">$0</span></div>
    </div>
    <button id="btn-shuffle" class="btn btn-blue">üé≤ BARAJEAR</button>
    <button id="btn-auto-toggle" class="btn btn-yellow">‚è±Ô∏è CARTAS AUTOM√ÅTICO</button>
    <button id="btn-reiniciar" class="btn btn-green">üîÅ REINICIAR</button>
  </div>
  <div id="players-area">
    <h3 class="players-title">CARTAS DE JUGADORES ACTIVOS</h3>
    <div class="players-grid" id="players-grid"></div>
  </div>
  <div class="panel panel-ultimos-ganadores" id="ultimos-ganadores">
    <div id="logo-top-left" aria-hidden="true"></div>
    <h3 style="margin:6px 0 8px 0">√öLTIMOS GANADORES</h3>
    <div class="ultimos-ganadores-body" id="ultimos-ganadores-body"></div>
  </div>
</div>
<div id="shuffle-overlay" aria-hidden="true"></div>
<div id="winner-modal" role="dialog" aria-hidden="true"></div>
<script>
function $q(sel){return document.querySelector(sel)}
function $qa(sel){return Array.from(document.querySelectorAll(sel))}
function fmt(n){return '$'+(Number(n)||0)}
window.jugadoresActivos = window.jugadoresActivos || [];
window.deckRemaining = window.deckRemaining || new Set(Array.from({length:54},(_,i)=>i+1));
function buildDeck54(){ return Array.from({length:54},(_,i)=>i+1); }
function drawUniqueCard(){ if(!window.deckRemaining || window.deckRemaining.size===0) window.deckRemaining = new Set(buildDeck54()); const arr=Array.from(window.deckRemaining); const c=arr[Math.floor(Math.random()*arr.length)]; window.deckRemaining.delete(c); return c; }
function cardImageUrl(id){ return 'Cartas_baraja_loteria/'+id+'.png'; }
function shufflePendingToFullScreen(){
  if(window.animShuffling) return; window.animShuffling=true;
  if(typeof disableControls==='function') disableControls(true);
  const overlay = $q('#shuffle-overlay'); overlay.style.display='flex'; overlay.innerHTML='<div class="shuffle-center"></div>';
  const center = overlay.querySelector('.shuffle-center');
  const pending = buildDeck54();
  const sample = pending.slice(0,20);
  const cards = sample.map((cid,i)=>{
    const el=document.createElement('div'); el.className='shuffle-card shuffle-wave'; el.style.backgroundImage='url("'+cardImageUrl(cid)+'")'; el.style.left='50%'; el.style.top='50%'; el.style.transform='translate(-50%,-50%)'; el.style.zIndex=100+i; center.appendChild(el); return {el,cid};
  });
  cards.forEach((c,idx)=> setTimeout(()=>{
    const tx=(idx-cards.length/2)*18+(Math.random()*40-20); const ty=-160+Math.random()*100; const rot=(Math.random()*40-20);
    c.el.style.transition='transform 1.2s cubic-bezier(.22,.9,.32,1),opacity 1.2s';
    c.el.style.transform=`translate(${tx}px, ${ty}px) rotate(${rot}deg) scale(1)`;
    if(Math.random()>0.6) c.el.classList.add('flip');
  }, idx*60));
  setTimeout(()=>{ cards.forEach((c,idx)=> setTimeout(()=>{ const tx=(Math.random()*700-350); const ty=(Math.random()*260-130); const rot=(Math.random()*720-360); c.el.classList.remove('flip'); c.el.classList.add('wave-move'); c.el.style.transform=`translate(${tx}px, ${ty}px) rotate(${rot}deg) scale(.94)`; }, idx*50)); }, 1600);
  setTimeout(()=>{ cards.forEach((c,idx)=>{ c.el.style.transition='transform .6s ease, opacity .6s ease'; c.el.style.transform=`translate(${(idx-cards.length/2)*10}px, -30px) rotate(${Math.random()*18-9}deg) scale(.96)`; c.el.innerHTML='<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;"><img src="logo_1_entrada.png" style="width:80px;height:80px;opacity:.95"></div>'; c.el.style.backgroundImage='linear-gradient(#ddd,#bbb)'; }); }, 3200);
  setTimeout(()=>{
    $qa('#players-grid .card-thumb').forEach(c=>{ c.classList.add('shine'); setTimeout(()=>c.classList.remove('shine'),2600); });
    overlay.style.display='none'; overlay.innerHTML=''; window.animShuffling=false; if(typeof disableControls==='function') disableControls(false); if(typeof renderAll==='function') renderAll();
  }, 5200);
}
$q('#btn-shuffle')?.addEventListener('click', ()=>{ shufflePendingToFullScreen(); });
function actualizarBolsa(){ const total = window.jugadoresActivos.reduce((s,j)=>s+(Number(j.aporte)||0),0); $q('#bolsaInline').innerText = fmt(total); const gan = window.jugadoresActivos.reduce((s,j)=> s + (Number(j.gananciaCasa)||0),0); $q('#gananciaCasaTotal') && ($q('#gananciaCasaTotal').innerText = fmt(gan)); }
function registrarJugador(data){ const mod = (window.modalidades||[{key:'4cartas',precio:40,ganancia:10},{key:'6cartas',precio:60,ganancia:15}]).find(m=>m.key===data.modalidadKey) || {key:'4cartas',precio:40,ganancia:10}; const cardsNeeded = (mod.key==='6cartas')?6:4; data.cards = data.cards || []; for(let i=0;i<cardsNeeded;i++) data.cards.push(drawUniqueCard()); const gan = Number(mod.ganancia||0); const costo = Number(mod.precio||0); data.aporte = (data.comision===0)?(costo*cardsNeeded):((costo-gan)*cardsNeeded); data.gananciaCasa = (data.comision===0)?0:(gan*cardsNeeded); window.jugadoresActivos.push(data); actualizarBolsa(); renderPlayersGrid(); }
function renderPlayersGrid(){ const grid=$q('#players-grid'); grid.innerHTML=''; window.jugadoresActivos.forEach((p,idx)=>{ const d=document.createElement('div'); d.className='card-thumb'; d.id = 'player-'+(p.id||idx); if(p.cards && p.cards[0]) d.style.backgroundImage = 'url("'+cardImageUrl(p.cards[0])+'")'; else d.style.background='linear-gradient(#fff,#eee)'; const lg=document.createElement('div'); lg.className='logo-small'; d.appendChild(lg); if(p.isWinner) d.classList.add('winner'); grid.appendChild(d); }); }
function showWinnerModal(opts){ const modal = $q('#winner-modal'); modal.innerHTML=''; const wrap=document.createElement('div'); wrap.className='card-wrap'; const badge=document.createElement('div'); badge.className='badge'; badge.innerText='¬°FELICIDADES!'; const amount=document.createElement('div'); amount.className='amount'; amount.innerText = opts && opts.amount ? fmt(opts.amount) : ''; let source=null; if(opts && typeof opts.cardSelectorOrEl==='string') source=document.querySelector(opts.cardSelectorOrEl); else if(opts && opts.cardSelectorOrEl instanceof Element) source=opts.cardSelectorOrEl; else source=document.querySelector('#players-grid .card-thumb'); if(source && source.style.backgroundImage) wrap.style.backgroundImage = source.style.backgroundImage; else wrap.style.background='linear-gradient(#fff,#eee)'; wrap.appendChild(badge); wrap.appendChild(amount); modal.appendChild(wrap); modal.style.display='flex'; wrap.style.animation='winnerPop .9s cubic-bezier(.2,.9,.3,1)'; try{ const ap=new Audio('APLAUSOS_GANADOR.mp3'); ap.currentTime=1; ap.play().catch(()=>{}); }catch(e){} }
function closeWinnerModal(){ const m=$q('#winner-modal'); if(m) m.style.display='none'; }
document.addEventListener('click', (ev)=>{
  const el = ev.target.closest('.card-thumb'); if(!el) return;
  window.jugadoresActivos.forEach(j=> j.isWinner=false);
  const id = el.id;
  const idx = window.jugadoresActivos.findIndex(j=>('player-'+(j.id||'')).toString() === id);
  if(idx>=0){ window.jugadoresActivos[idx].isWinner=true; const amount = window.jugadoresActivos[idx].aporte || 0; renderPlayersGrid(); showWinnerModal({cardSelectorOrEl:'#'+id, amount: amount}); }
});
let autoRunning = false; let autoInterval = null;
$q('#btn-auto-toggle')?.addEventListener('click', ()=>{
  if(!autoRunning){ autoInterval = setInterval(()=>{ if(typeof drawOne==='function') drawOne(); }, 2000); autoRunning=true; $q('#btn-auto-toggle').textContent='‚èπÔ∏è DETENER AUTOM√ÅTICO'; }
  else{ clearInterval(autoInterval); autoInterval=null; autoRunning=false; $q('#btn-auto-toggle').textContent='‚è±Ô∏è CARTAS AUTOM√ÅTICO'; }
});
$q('#btn-reiniciar')?.addEventListener('click', ()=>{ window.jugadoresActivos=[]; window.deckRemaining = new Set(buildDeck54()); actualizarBolsa(); renderPlayersGrid(); closeWinnerModal(); });
window.addEventListener('DOMContentLoaded', ()=>{
  const panel = $q('#ultimos-ganadores-body'); if(panel){ Array.from(panel.childNodes).forEach(n=>{ if(n.nodeType===Node.TEXT_NODE){ if(/^[\s\\n\\r]*$/.test(n.textContent) || /\\n/.test(n.textContent)){ n.remove(); } else { n.textContent = n.textContent.replace(/\\n/g,'').trim(); if(n.textContent==='') n.remove(); } } }); }
  const logos = Array.from(document.querySelectorAll("#logo-top-left")); if(logos.length>1){ logos.slice(1).forEach(l=>l.remove()); }
  const g=$q('.players-grid'); if(g){ g.style.gridTemplateColumns='repeat(5,1fr)'; }
});
(function seedDemo(){ if(window.jugadoresActivos && window.jugadoresActivos.length) return; const demo=[{id:'p1',playerName:'Luis',modalidadKey:'4cartas',comision:1},{id:'p2',playerName:'Ana',modalidadKey:'4cartas',comision:1},{id:'p3',playerName:'Carlos',modalidadKey:'6cartas',comision:1}]; demo.forEach(d=> registrarJugador(d)); renderPlayersGrid(); })();
</script>
</body>
</html>
