<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GANA YA! ‚Äî Loter√≠a (v5)</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --rojo:#b42222;
      --verde:#0f8a3c;
      --dorado:#caa43f;
      --crema:#f6f1e6;
      --sombra: 0 10px 24px rgba(0,0,0,0.08);
      --accent:#c94a3d;
    }
    body{ font-family:Inter,system-ui,-apple-system; background:var(--crema); color:#1f2937; -webkit-font-smoothing:antialiased; }
    .brand-title{ font-family: 'Alfa Slab One', serif; color:var(--rojo); letter-spacing:1px; }
    .tab-btn{ border-radius:999px; padding:.45rem .85rem; font-weight:700; box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    .tab-active{ background: linear-gradient(90deg,#fef2f2,#fff); border: 3px solid var(--rojo); color: var(--rojo); }
    .mex-frame{ background:#fff; border-radius:12px; padding:14px; box-shadow: var(--sombra); position:relative; overflow:visible; }
    .mex-border{ border:4px solid var(--rojo); border-radius:10px; padding:10px; box-shadow: 0 6px 18px rgba(0,0,0,0.04); background:#fff; }
    .title-accent { display:inline-block; height:8px; width:72px; background: linear-gradient(90deg, var(--dorado), #e6c05b); border-radius:6px; margin-top:6px; }
    .card-cell { border-radius:8px; overflow:hidden; background-size:cover; background-position:center; min-height:50px; position:relative; box-shadow: 0 4px 8px rgba(0,0,0,0.06); display:flex; align-items:center; justify-content:center; }
    /* tama√±o peque√±o para im√°genes de jugador */
    .card-img-small { width:64px; height:64px; border-radius:6px; object-fit:cover; display:block; }
    .card-grid-gap { gap:6px; }
    /* sticker "ya pas√≥" */
    .sticker {
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center; z-index:20; pointer-events:none;
      opacity:0; transform:scale(.6);
      animation: stickerPop .6s ease forwards;
    }
    @keyframes stickerPop {
      0% { transform: scale(.4); opacity:0; }
      60% { transform: scale(1.2); opacity:1; }
      100% { transform: scale(1); opacity:1; }
    }
    .grayed { filter: grayscale(100%) contrast(.9); opacity:.5; transition:filter .35s, opacity .35s; }
    .current-card { border-radius:14px; box-shadow:0 12px 30px rgba(0,0,0,0.08); min-height:170px; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg,#fff,#fff); }
    .confetti{ position: fixed; width: 10px; height: 10px; top:100%; animation: confetti 2s ease-out forwards; z-index:120; border-radius:2px; }
    @keyframes confetti{ 0%{ transform: translateY(0) rotate(0); opacity:1 } 100%{ transform: translateY(-420px) rotate(720deg); opacity:0 } }
    /* barajear center animation container */
    .shuffle-overlay { position: fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:60; pointer-events:none; background:rgba(0,0,0,0.15); }
    .shuffle-card { width:120px; height:160px; border-radius:10px; background-size:cover; background-position:center; box-shadow:0 10px 30px rgba(0,0,0,0.25); transform-origin:center; }
    /* reset highlight */
    .reset-glow { box-shadow:0 0 18px 4px rgba(202,164,63,0.45); animation: glow 1.2s infinite; }
    @keyframes glow { 0%{ box-shadow:0 0 6px rgba(202,164,63,0.25);} 50%{ box-shadow:0 0 24px rgba(202,164,63,0.45);} 100%{ box-shadow:0 0 6px rgba(202,164,63,0.25);} }

    .btn{ padding:.55rem .9rem; border-radius:.6rem; font-weight:700; }
    .btn-red{ background:var(--rojo); color:white; }
    .btn-blue{ background:#1565d8; color:white; }
    .btn-green{ background:var(--verde); color:white; }
    .small{ font-size:.85rem; }
    .row-disabled { opacity: .45; filter: grayscale(.2); }
    .animate-create { transform-origin:center; animation: create-pop .45s ease forwards; }
    @keyframes create-pop { 0%{ transform: scale(.6); opacity:0 } 60%{ transform: scale(1.05); opacity:1 } 100%{ transform: scale(1); } }

    /* responsive tweaks */
    @media (max-width:1024px){ .current-card{ min-height:140px } .card-img-small{ width:52px;height:52px } }
  </style>
</head>
<body class="min-h-screen">

  <!-- HEADER -->
  <header class="max-w-7xl mx-auto px-4 py-6 flex flex-col md:flex-row items-center gap-6 justify-between">
    <div class="flex items-center gap-4">
      <img id="logo-top" src="logo_1_entrada.png" alt="Logo" class="w-16 h-16 rounded-full shadow-lg cursor-pointer" onerror="this.onerror=null;this.src='https://placehold.co/80x80/b42222/ffffff?text=LOGO'">
      <div>
        <h1 class="brand-title text-4xl md:text-5xl">GANA YA!</h1>
        <div class="text-xs text-gray-600 mt-1">Loter√≠a interactiva ‚Äî estilo tradicional mexicano</div>
      </div>
    </div>

    <div class="flex items-center gap-4">
      <div class="flex items-center gap-2">
        <button id="tab-game" class="tab-btn tab-active">üÉè En Juego</button>
        <button id="tab-admin" class="tab-btn">‚öô</button>
      </div>

      <div class="bg-green-700 text-white p-3 rounded-xl shadow-lg flex flex-col items-center min-w-[120px]">
        <span class="text-xs font-semibold uppercase">BOLSA EN JUEGO</span>
        <span id="pot-amount" class="text-xl md:text-2xl font-extrabold">$0.00</span>
      </div>
    </div>
  </header>

  <!-- MAIN LAYOUT -->
  <main class="max-w-7xl mx-auto px-4 pb-12">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

      <!-- EN JUEGO VIEW (Principal) -->
      <section id="view-en-game" class="lg:col-span-8">
        <div class="mex-frame">
          <div class="flex items-start justify-between">
            <div>
              <h2 class="text-2xl font-extrabold text-gray-800">Cartas Activas (Modalidad actual)</h2>
              <div class="title-accent"></div>
              <p class="text-sm text-gray-600 mt-2">Solo nombre y carta. No se muestran partidas/pagos/victorias en p√∫blico.</p>
            </div>
            <div class="w-80">
              <div class="bg-gray-50 p-3 rounded-lg border">
                <div class="text-sm small-muted">Total compras registradas:</div>
                <div id="summary-active-count" class="text-xl font-bold">0</div>
                <div class="text-sm small-muted mt-2">Total partidas vendidas:</div>
                <div id="summary-partidas" class="text-lg font-bold">0</div>
              </div>
            </div>
          </div>

          <div class="mt-6 mex-border">
            <div id="active-players-cards" class="grid gap-3 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 p-3">
              <div class="text-center text-gray-500 p-8 col-span-full">A√∫n no hay jugadores / compras en esta modalidad.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- ADMIN VIEW (oculto por defecto) -->
      <aside id="view-admin" class="lg:col-span-4 hidden flex-col gap-6">

        <!-- Caja / Config -->
        <div class="mex-frame">
          <h3 class="text-lg font-extrabold text-gray-800">Caja / Configuraci√≥n</h3>
          <div class="title-accent"></div>
          <div class="mt-4 space-y-3">
            <div class="grid grid-cols-3 gap-2">
              <div>
                <label class="text-xs text-gray-600">Precio 2x2</label>
                <input id="price-4" type="number" min="1" class="w-full p-2 border rounded" />
              </div>
              <div>
                <label class="text-xs text-gray-600">Precio 2x3</label>
                <input id="price-6" type="number" min="1" class="w-full p-2 border rounded" />
              </div>
              <div>
                <label class="text-xs text-gray-600">Precio 3x3</label>
                <input id="price-9" type="number" min="1" class="w-full p-2 border rounded" />
              </div>
            </div>

            <div>
              <label class="text-xs text-gray-600">Ganancia casa por carta</label>
              <input id="house-profit" type="number" min="0" class="w-full p-2 border rounded" />
            </div>

            <div class="flex gap-2">
              <button id="save-prices" class="btn btn-green flex-1 small">Guardar precios</button>
              <button id="reset-prices" class="btn small" style="background:#f3f4f6;border-radius:.6rem">Reset</button>
            </div>

            <div class="mt-2 bg-gray-50 p-3 rounded-lg">
              <div class="text-sm text-gray-600">Modalidad activa</div>
              <select id="modality-select" class="w-full p-2 border rounded-lg mt-2">
                <option value="4">4 im√°genes (2x2)</option>
                <option value="6">6 im√°genes (2x3)</option>
                <option value="9" selected>9 im√°genes (3x3)</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Registrar Jugador (Caja) -->
        <div class="mex-frame">
          <h3 class="text-lg font-extrabold text-gray-800">Registrar Jugador (Caja)</h3>
          <div class="title-accent"></div>
          <div class="mt-3 space-y-3">
            <label class="text-xs text-gray-600">Nombre del jugador</label>
            <input id="player-name-input" type="text" class="w-full p-2 border rounded" placeholder="Ej. Mar√≠a L√≥pez">

            <label class="text-xs text-gray-600">Presupuesto ($)</label>
            <input id="player-budget-input" type="number" min="1" class="w-full p-2 border rounded" placeholder="Ej. 100">

            <div>
              <label class="text-xs text-gray-600">Modalidades deseadas (elige 1 o m√°s)</label>
              <div class="flex gap-2 mt-2">
                <label class="inline-flex items-center gap-2"><input type="checkbox" class="modal-chk" value="4"> 2x2</label>
                <label class="inline-flex items-center gap-2"><input type="checkbox" class="modal-chk" value="6"> 2x3</label>
                <label class="inline-flex items-center gap-2"><input type="checkbox" class="modal-chk" value="9"> 3x3</label>
              </div>
            </div>

            <div class="flex gap-2">
              <button id="calc-btn" class="btn btn-blue flex-1 small">Calcular partidas</button>
              <button id="add-player-btn" class="btn btn-green flex-1 small">A√±adir jugador</button>
            </div>
            <div id="calc-result" class="text-sm text-gray-600"></div>
            <div id="calc-warning" class="text-sm text-red-600"></div>
          </div>
        </div>

        <!-- Control de Partida -->
        <div class="mex-frame">
          <h3 class="text-lg font-extrabold text-gray-800">Control de Partida</h3>
          <div class="title-accent"></div>

          <div class="mt-4 space-y-2">
            <div class="flex gap-2">
              <button id="shuffle-btn" class="btn btn-blue flex-1 small">BARAJEAR</button>
              <button id="draw-btn" class="btn btn-red flex-1 small">TIRAR CARTA</button>
            </div>

            <div class="flex gap-2">
              <button id="auto-btn" class="btn small" style="flex:1;background:#fee9d6;border-radius:.6rem">CARTAS AUTOM√ÅTICO</button>
              <button id="clean-btn" class="btn small" style="flex:1;background:#fff;border:1px solid #e5e7eb">LIMPIAR</button>
            </div>

            <div class="mt-2 bg-gray-50 p-3 rounded-lg">
              <div class="text-sm text-gray-600">Cartas restantes: <span id="deck-count" class="font-bold">54</span></div>
              <div class="text-sm text-gray-600 mt-1">Carta actual: <span id="current-card-name" class="font-bold text-red-600">Ninguna</span></div>
            </div>
          </div>
        </div>

        <!-- Carta en Juego -->
        <div class="mex-frame">
          <h3 class="text-lg font-extrabold text-gray-800">Carta en Juego</h3>
          <div class="title-accent"></div>
          <div class="mt-4 current-card" id="current-card">
            <div class="text-center">
              <div id="current-card-inner">
                <span class="text-6xl">üé≤</span>
                <div class="text-sm font-semibold mt-2 text-gray-600">Esperando...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- √öltimas 3 cartas -->
        <div class="mex-frame">
          <h3 class="text-lg font-extrabold text-gray-800">√öltimas 3 Cartas</h3>
          <div class="title-accent"></div>
          <div class="mt-4 bg-white p-3 rounded-lg border min-h-[72px]">
            <div id="last-cards" class="flex gap-2 flex-wrap">
              <div class="text-gray-400">Ninguna carta a√∫n.</div>
            </div>
          </div>
        </div>

        <!-- √öltimos Ganadores -->
        <div class="mex-frame">
          <h3 class="text-lg font-extrabold text-gray-800">√öltimos Ganadores</h3>
          <div class="title-accent"></div>
          <div class="mt-4 bg-white p-3 rounded-lg border min-h-[64px]">
            <div id="last-winners" class="text-center text-gray-500">A√∫n no hay ganadores.</div>
          </div>
        </div>

        <!-- Export / Reports -->
        <div class="mex-frame">
          <h3 class="text-lg font-extrabold text-gray-800">Reportes / Transacciones</h3>
          <div class="title-accent"></div>
          <div class="mt-3 space-y-2">
            <button id="export-btn" class="btn btn-blue w-full">Exportar reporte (JSON)</button>
            <button id="clear-transactions-btn" class="btn" style="background:#fee9d6;border-radius:.6rem;width:100%">Borrar registros / Nuevo d√≠a</button>
            <div class="text-xs text-gray-500 mt-2">Esto limpiar√° transacciones y compras (guarda el JSON antes si lo necesitas).</div>
          </div>
        </div>

      </aside>

    </div>

    <!-- Tabla de compras / jugadores (Admin, en secci√≥n aparte) -->
    <section id="admin-purchases-section" class="mt-8 mex-frame hidden">
      <h3 class="text-xl font-extrabold text-gray-800">Administraci√≥n de Compras / Jugadores</h3>
      <div class="title-accent"></div>
      <p class="text-sm text-gray-600 mt-2">Cada fila representa una compra del jugador en una modalidad.</p>

      <div class="mt-4 overflow-x-auto">
        <table class="min-w-full text-left">
          <thead class="bg-gray-50">
            <tr>
              <th class="p-2">Jugador</th>
              <th class="p-2">Modalidad</th>
              <th class="p-2">Partidas</th>
              <th class="p-2">Total pagado</th>
              <th class="p-2">Estado Pago</th>
              <th class="p-2">Acciones</th>
            </tr>
          </thead>
          <tbody id="players-table-body">
            <tr><td colspan="6" class="p-4 text-gray-500">No hay compras registradas.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

  </main>

  <!-- SHUFFLE OVERLAY (hidden) -->
  <div id="shuffle-overlay" class="shuffle-overlay hidden"></div>

  <!-- WINNER MODAL -->
  <div id="winner-modal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center">
    <div id="confetti-container" class="absolute inset-0 overflow-hidden pointer-events-none"></div>
    <div class="bg-yellow-300 p-6 rounded-2xl shadow-2xl text-center border-4 border-yellow-500 z-50">
      <h1 class="text-4xl font-black text-red-600 mb-2">¬°FELICIDADES!</h1>
      <p id="winner-text" class="text-2xl font-bold text-gray-800 mb-2">Nombre ha ganado</p>
      <p id="winner-amount" class="text-xl text-green-800 font-extrabold">$0.00</p>
      <div class="mt-6 flex justify-center gap-3">
        <button onclick="closeWinner()" class="btn btn-red">Cerrar</button>
      </div>
    </div>
  </div>

  <footer class="max-w-7xl mx-auto px-4 py-6 text-sm text-gray-600">
    <p>Sube <strong>logo_1_entrada.png</strong> en la ra√≠z y la carpeta <strong>Cartas_baraja_loteria/</strong> con las 54 im√°genes (.jpg) con nombres exactos.</p>
  </footer>

  <!-- SCRIPT (L√≥gica v5) -->
  <script>
  /* ------------------ CONFIG & MAPS ------------------ */
  const CARD_IMAGE_BASE_PATH = 'Cartas_baraja_loteria/';
  const CARD_NAME_MAP = {
    1:"1 el gallo-min.jpg",2:"2 el diablito-min.jpg",3:"3 la dama-min.jpg",4:"4 el catrin-min.jpg",
    5:"5 el paraguas-min.jpg",6:"6 la sirena-min.jpg",7:"7 la escalera-min.jpg",8:"8 la botella-min.jpg",
    9:"9 el barril-min.jpg",10:"10 arbol-min.jpg",11:"11 melon-min.jpg",12:"12 el valiente-min.jpg",
    13:"13 el gorrito-min.jpg",14:"14 la muerte-min.jpg",15:"15 la pera-min.jpg",16:"16 la bandera-min.jpg",
    17:"17 el bandolon-min.jpg",18:"18 el violoncello-min.jpg",19:"19 la garza-min.jpg",20:"20 el pajaro-min.jpg",
    21:"21 la mano-min.jpg",22:"22 la bota-min.jpg",23:"23 la luna-min.jpg",24:"24 el cotorro-min.jpg",
    25:"25 el borracho-min.jpg",26:"26 el negrito-min.jpg",27:"27 el corazon-min.jpg",28:"28 la sandia-min.jpg",
    29:"29 el tambor-min.jpg",30:"30 el camaron-min.jpg",31:"31 las jaras-min.jpg",32:"32 el musico-min.jpg",
    33:"33 la ara√±a-min.jpg",34:"34 el soldado-min.jpg",35:"35 la estrella-min.jpg",36:"36 el cazo-min.jpg",
    37:"37 el mundo-min.jpg",38:"38 el apache-min.jpg",39:"39 el nopal-min.jpg",40:"40 el alacran-min.jpg",
    41:"41 la rosa-min.jpg",42:"42 la calavera-min.jpg",43:"43 la campana-min.jpg",44:"44 el cantarito-min.jpg",
    45:"45 el venado-min.jpg",46:"46 el sol-min.jpg",47:"47 la corona-min.jpg",48:"48 la chalupa-min.jpg",
    49:"49 el pino-min.jpg",50:"50 el pescado-min.jpg",51:"51 la palma-min.jpg",52:"52 la maceta-min.jpg",
    53:"53 el arpa-min.jpg",54:"54 la rana-min.jpg"
  };

  // storage keys
  const KEY_PRICES = 'loteria_prices_v5';
  const KEY_GAME = 'loteria_game_v5';
  const KEY_PURCHASES = 'loteria_purchases_v5';
  const KEY_TRANSACTIONS = 'loteria_transactions_v5';

  // defaults
  const defaultPrices = () => ({ price4:10, price6:12, price9:15, houseProfit:2 });
  const defaultGame = () => ({ modality:9, deck: Array.from({length:54},(_,i)=>i+1), drawnCards:[], currentCardId:0, pendingWinners:[], lastWinners:[] });

  // state
  let prices = loadPrices();
  let gameState = loadGame();
  let purchases = loadPurchases();
  let transactions = loadTransactions();
  let isAuto = false;
  let autoInterval = null;
  let shuffleAnimating = false;
  let lastWinnerRecords = [];

  // util: storage
  function loadPrices(){ try{return JSON.parse(localStorage.getItem(KEY_PRICES))||defaultPrices();}catch(e){return defaultPrices();} }
  function savePrices(p){ localStorage.setItem(KEY_PRICES, JSON.stringify(p)); }
  function loadGame(){ try{return JSON.parse(localStorage.getItem(KEY_GAME))||defaultGame();}catch(e){return defaultGame();} }
  function saveGame(g){ localStorage.setItem(KEY_GAME, JSON.stringify(g)); }
  function loadPurchases(){ try{return JSON.parse(localStorage.getItem(KEY_PURCHASES))||[];}catch(e){return [];} }
  function savePurchases(arr){ localStorage.setItem(KEY_PURCHASES, JSON.stringify(arr)); }
  function loadTransactions(){ try{return JSON.parse(localStorage.getItem(KEY_TRANSACTIONS))||[];}catch(e){return [];} }
  function saveTransactions(arr){ localStorage.setItem(KEY_TRANSACTIONS, JSON.stringify(arr)); }

  // card url helper
  const cardImageUrl = id => CARD_IMAGE_BASE_PATH + (CARD_NAME_MAP[id] || `${id}.jpg`);

  // init deck if empty
  if (!gameState.deck || !gameState.deck.length) gameState.deck = Array.from({length:54},(_,i)=>i+1);

  /* ------------------ RENDER ------------------ */
  function renderAll(){
    // header prices
    document.getElementById('price-4').value = prices.price4;
    document.getElementById('price-6').value = prices.price6;
    document.getElementById('price-9').value = prices.price9;
    document.getElementById('house-profit').value = prices.houseProfit;

    // modality selection
    document.getElementById('modality-select').value = gameState.modality || 9;

    // active purchases for modality
    const modality = parseInt(document.getElementById('modality-select').value || gameState.modality || 9);
    gameState.modality = modality;
    const active = purchases.filter(p => p.modality === modality);
    const container = document.getElementById('active-players-cards');
    if (!active.length) {
      container.innerHTML = `<div class="text-center text-gray-500 p-8 col-span-full">A√∫n no hay jugadores / compras en esta modalidad.</div>`;
    } else {
      container.innerHTML = active.map(p => purchaseCardHtmlPublic(p)).join('');
    }

    // summary
    document.getElementById('summary-active-count').textContent = purchases.length;
    document.getElementById('summary-partidas').textContent = purchases.reduce((s,p)=>s+(p.gamesLeft||0),0);

    // current card
    const cInner = document.getElementById('current-card-inner');
    if (gameState.currentCardId) {
      cInner.innerHTML = `<div style="background-image:url('${cardImageUrl(gameState.currentCardId)}'); background-size:contain; background-position:center; background-repeat:no-repeat; width:140px; height:140px; margin:0 auto;"></div>
        <div class="text-sm font-semibold mt-2 text-gray-600">Carta: ${gameState.currentCardId}</div>`;
    } else {
      cInner.innerHTML = `<span class="text-6xl">üé≤</span><div class="text-sm font-semibold mt-2 text-gray-600">Esperando...</div>`;
    }

    // last 3 cards
    const last = (gameState.drawnCards||[]).slice(-3).reverse();
    const lc = document.getElementById('last-cards');
    lc.innerHTML = last.length ? last.map(cid => `<div class="w-14 h-18 bg-cover bg-center rounded shadow-md border" style="background-image:url('${cardImageUrl(cid)}')"></div>`).join('') : `<div class="text-gray-400">Ninguna carta a√∫n.</div>`;

    // deck count
    document.getElementById('deck-count').textContent = gameState.deck.length;
    document.getElementById('current-card-name').textContent = gameState.currentCardId ? `Carta ${gameState.currentCardId}` : 'Ninguna';

    // pot
    const totalPaid = purchases.reduce((s,p)=> s + (p.totalPaid||0), 0);
    const totalCardsSold = purchases.reduce((s,p)=> s + (p.initialGames||0), 0);
    const potAmount = Math.max(0, totalPaid - (prices.houseProfit * totalCardsSold));
    document.getElementById('pot-amount').textContent = `$${potAmount.toFixed(2)}`;

    // last winners
    const lw = document.getElementById('last-winners');
    lw.innerHTML = (gameState.lastWinners || []).slice(-5).reverse().map(w => `<div class="text-sm font-semibold">${w.name} ‚Äî $${w.amount.toFixed(2)} <span class="text-xs text-gray-500">(${new Date(w.timestamp).toLocaleString()})</span></div>`).join('') || 'A√∫n no hay ganadores.';

    // admin table (separate section)
    renderPlayersTable();

    // show/hide admin purchases section depending on admin tab
    const adminSection = document.getElementById('admin-purchases-section');
    adminSection.classList.toggle('hidden', document.getElementById('view-admin').classList.contains('hidden'));

    // persist
    savePrices(prices); saveGame(gameState); savePurchases(purchases); saveTransactions(transactions);
  }

  // Public purchase card (minimal info)
  function purchaseCardHtmlPublic(p) {
    const cols = p.modality === 4 ? 2 : p.modality === 6 ? 3 : 3;
    const cells = (p.card||[]).map(cid => {
      const passed = (p.markedCards||[]).includes(cid);
      return `<div class="card-cell ${passed ? 'grayed' : ''}" style="aspect-ratio:1/1; width:64px; height:64px; background-image:url('${cardImageUrl(cid)}')">
                ${passed ? `<div class="sticker"><img src="logo_1_entrada.png" style="width:46%;height:46%;object-fit:contain" /></div>` : ''}
              </div>`;
    }).join('');
    return `<div class="${p.gamesLeft<=0 ? 'row-disabled' : ''} mex-border p-3 animate-create">
      <div class="flex items-center justify-between mb-2">
        <div><div class="text-lg font-extrabold">${escapeHtml(p.playerName)}</div></div>
      </div>
      <div class="grid ${cols===2 ? 'grid-cols-2' : 'grid-cols-3'} card-grid-gap">${cells}</div>
    </div>`;
  }

  // render admin players table
  function renderPlayersTable(){
    const tbody = document.getElementById('players-table-body');
    if (!purchases.length) { tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-gray-500">No hay compras registradas.</td></tr>`; return; }
    tbody.innerHTML = purchases.map(p => {
      const state = p.paymentState === 'pending' ? `<span class="text-xs px-2 py-1 bg-yellow-100 rounded">Pendiente</span>` : `<span class="text-xs px-2 py-1 bg-green-100 rounded">Pagado</span>`;
      const modText = p.modality === 4 ? '2x2' : p.modality===6 ? '2x3' : '3x3';
      return `<tr class="${p.gamesLeft<=0 ? 'row-disabled' : ''}">
        <td class="p-2 font-semibold">${escapeHtml(p.playerName)}</td>
        <td class="p-2">${modText}</td>
        <td class="p-2">${p.gamesLeft}</td>
        <td class="p-2">$${(p.totalPaid||0).toFixed(2)}</td>
        <td class="p-2">${state}</td>
        <td class="p-2 space-x-2">
          <button class="px-2 py-1 bg-green-500 text-white rounded text-xs" onclick="addGamesPrompt('${p.id}')">+ Partidas</button>
          <button class="px-2 py-1 bg-yellow-500 text-white rounded text-xs" onclick="markPendingPaid('${p.id}')">Marcar Pagado</button>
          <button class="px-2 py-1 bg-gray-300 text-black rounded text-xs" onclick="viewCard('${p.id}')">Ver carta</button>
          <button class="px-2 py-1 bg-red-600 text-white rounded text-xs" onclick="deletePurchase('${p.id}')">Eliminar</button>
        </td>
      </tr>`;
    }).join('');
  }

  /* ------------------ GAME ACTIONS ------------------ */

  // shuffle visual with real cards
  function shuffleDeckVisual(){
    if (shuffleAnimating) return;
    shuffleAnimating = true;
    disableControls(true);
    const overlay = document.getElementById('shuffle-overlay');
    overlay.innerHTML = ''; overlay.classList.remove('hidden');
    // pick 12 random cards to show during animation
    const picks = shuffleArray(Array.from({length:54}, (_,i)=>i+1)).slice(0,12);
    // create card elements positioned randomly and animate them
    picks.forEach((cid, i) => {
      const div = document.createElement('div');
      div.className = 'shuffle-card';
      div.style.backgroundImage = `url('${cardImageUrl(cid)}')`;
      // random initial transform
      const angle = (Math.random()*60 - 30);
      div.style.transform = `translate(${(Math.random()*400 - 200)}px, ${(Math.random()*200 - 100)}px) rotate(${angle}deg) scale(${0.9 + Math.random()*0.4})`;
      overlay.appendChild(div);
      // animate to center then random jitter then fade
      setTimeout(() => {
        div.style.transition = 'transform .45s ease, opacity .5s ease';
        div.style.transform = `translate(0px,0px) rotate(${Math.random()*360 - 180}deg) scale(1)`;
      }, 80 + i*40);
      setTimeout(() => {
        div.style.transform = `translate(${(Math.random()*300 - 150)}px, ${(Math.random()*300 - 150)}px) rotate(${Math.random()*720 - 360}deg) scale(.6)`;
        div.style.opacity = '0';
      }, 900 + i*30);
    });
    // after animation, actually shuffle deck array logically
    setTimeout(() => {
      gameState.deck = shuffleArray(Array.from({length:54},(_,i)=>i+1));
      gameState.drawnCards = [];
      gameState.currentCardId = 0;
      saveGame(gameState);
      overlay.classList.add('hidden');
      overlay.innerHTML = '';
      shuffleAnimating = false;
      disableControls(false);
      renderAll();
      // log transaction
      transactions.push({ id: crypto.randomUUID(), type: 'shuffle', timestamp: Date.now() });
      saveTransactions(transactions);
    }, 1500);
  }

  // draw card
  function drawCard(){
    if (isAuto || shuffleAnimating) return;
    if (!gameState.deck.length) { alert('Mazo vac√≠o. Barajea para continuar.'); return; }
    const next = gameState.deck.pop();
    gameState.drawnCards.push(next);
    gameState.currentCardId = next;
    transactions.push({ id: crypto.randomUUID(), type: 'draw', card: next, timestamp: Date.now() });
    saveTransactions(transactions);
    processCard(next);
    renderAll();
  }

  // process drawn card
  function processCard(cardId){
    const winners = [];
    purchases.forEach((p, idx) => {
      if (!p.isActive || (p.gamesLeft||0) <= 0) return;
      if (p.modality && p.card && p.card.includes(cardId) && !(p.markedCards||[]).includes(cardId)) {
        purchases[idx].markedCards = [...(p.markedCards||[]), cardId];
      }
      if ((p.markedCards||[]).length === p.modality) winners.push({ idx, id: p.id, name: p.playerName });
    });

    // mark visuals: any purchase that included cardId -> its card images show sticker (render does this)
    // if winners -> handle
    if (winners.length > 0) {
      stopAutoMode();
      disableControls(true);
      // calculate pot
      const totalPaid = purchases.reduce((s,p)=> s + (p.totalPaid||0), 0);
      const totalCardsSold = purchases.reduce((s,p)=> s + (p.initialGames||0), 0);
      const potAmount = Math.max(0, totalPaid - (prices.houseProfit * totalCardsSold));
      const winnerRecords = [];
      winners.forEach((w) => {
        const p = purchases[w.idx];
        p.gamesLeft = Math.max(0, (p.gamesLeft||0) - 1);
        p.wins = (p.wins||0) + 1;
        p.paymentState = 'pending';
        p.markedCards = [];
        // create record
        const record = { id: crypto.randomUUID(), purchaseId: p.id, playerName: p.playerName, amount: potAmount / winners.length, timestamp: Date.now(), paid:false };
        gameState.pendingWinners = (gameState.pendingWinners||[]).concat(record);
        gameState.lastWinners = (gameState.lastWinners||[]).concat(record);
        transactions.push({ id: crypto.randomUUID(), type: 'winner', player: p.playerName, amount: record.amount, timestamp: Date.now() });
        winnerRecords.push(record);
      });
      saveTransactions(transactions);
      saveGame(gameState);
      savePurchases(purchases);
      // show modal
      const nameDisplay = winners.length === 1 ? winners[0].name : `${winners.length} jugadores`;
      showWinnerModal(nameDisplay, winnerRecords.reduce((s,r)=>s+r.amount,0), winnerRecords);
      // highlight reset button
      highlightResetButton(true);
      renderAll();
    } else {
      savePurchases(purchases); saveGame(gameState);
      renderAll();
    }
  }

  // clean action
  function cleanAction(){
    const mod = parseInt(document.getElementById('modality-select').value || gameState.modality || 9);
    if (!confirm(`¬øLimpiar cartas pasadas y restar 1 partida a compras de modalidad ${mod}?`)) return;
    gameState.drawnCards = [];
    gameState.currentCardId = 0;
    purchases = purchases.map(p => {
      if (p.modality === mod) {
        p.gamesLeft = Math.max(0, (p.gamesLeft||0) - 1);
        p.isActive = p.gamesLeft > 0;
      }
      return p;
    });
    transactions.push({ id: crypto.randomUUID(), type:'clean', modality: mod, timestamp: Date.now() });
    saveTransactions(transactions);
    savePurchases(purchases);
    renderAll();
  }

  // auto mode
  function toggleAuto(){
    if (isAuto) stopAutoMode(); else startAutoMode();
  }
  function startAutoMode(){
    if (!gameState.deck.length) { alert('Mazo vac√≠o. Barajea.'); return; }
    isAuto = true;
    document.getElementById('auto-btn').textContent = 'DETENER AUTOM√ÅTICO';
    document.getElementById('auto-btn').style.background = 'var(--verde)';
    autoInterval = setInterval(()=> {
      if (!isAuto) return;
      if (!gameState.deck.length) { stopAutoMode(); return; }
      const next = gameState.deck.pop();
      gameState.drawnCards.push(next);
      gameState.currentCardId = next;
      transactions.push({ id: crypto.randomUUID(), type:'draw', card: next, timestamp: Date.now() });
      processCard(next);
      renderAll();
    }, 2000);
  }
  function stopAutoMode(){
    isAuto = false;
    document.getElementById('auto-btn').textContent = 'CARTAS AUTOM√ÅTICO';
    document.getElementById('auto-btn').style.background = '#fee9d6';
    if (autoInterval) { clearInterval(autoInterval); autoInterval = null; }
  }

  // disable/enable controls
  function disableControls(disable){
    const ids = ['shuffle-btn','draw-btn','auto-btn','clean-btn','add-player-btn','calc-btn','save-prices'];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.disabled = disable;
    });
    // visually
  }

  // highlight reset button when winner occurs
  function highlightResetButton(on){
    const btn = document.getElementById('reset-prices');
    if (!btn) return;
    if (on) btn.classList.add('reset-glow'); else btn.classList.remove('reset-glow');
  }

  /* ------------------ REGISTRATION & PURCHASES ------------------ */

  function calculatePartitions(budget, selectedModalities){
    const shareRaw = budget / selectedModalities.length;
    const share = Math.floor(shareRaw * 100) / 100;
    return selectedModalities.map(m => {
      const price = m===4?prices.price4:(m===6?prices.price6:prices.price9);
      const games = Math.floor(share / price);
      return { modality: m, price, share, games };
    });
  }

  function addPlayer(){
    const name = (document.getElementById('player-name-input').value || '').trim();
    const budget = parseFloat(document.getElementById('player-budget-input').value || 0);
    const checked = Array.from(document.querySelectorAll('.modal-chk:checked')).map(i=>parseInt(i.value));
    document.getElementById('calc-warning').textContent = '';
    if (!name) { alert('Captura nombre'); return; }
    if (!budget || budget <= 0) { alert('Presupuesto inv√°lido'); return; }
    if (!checked.length) { alert('Selecciona modalidades'); return; }
    const parts = calculatePartitions(budget, checked);
    const zero = parts.find(p => p.games < 1);
    if (zero) {
      document.getElementById('calc-warning').textContent = `Modalidad ${zero.modality} no alcanza 1 partida con la porci√≥n (${zero.share}$).`;
      return;
    }
    // create purchases per modality
    const playerId = crypto.randomUUID();
    const created = [];
    parts.forEach(part => {
      const games = part.games;
      const totalPaid = games * part.price;
      const purchase = {
        id: crypto.randomUUID(),
        playerId,
        playerName: name,
        modality: part.modality,
        initialGames: games,
        gamesLeft: games,
        totalPaid,
        wins:0,
        paymentState:'paid',
        isActive: games>0,
        card: generateCardForPurchase(part.modality),
        markedCards: []
      };
      purchases.push(purchase);
      transactions.push({ id: crypto.randomUUID(), type:'purchase', player: name, modality: part.modality, games: games, amount: totalPaid, timestamp: Date.now() });
      created.push(purchase);
    });
    saveTransactions(transactions);
    savePurchases(purchases);
    // animate create
    animateCreateMiniConfetti();
    document.getElementById('player-name-input').value=''; document.getElementById('player-budget-input').value='';
    document.querySelectorAll('.modal-chk').forEach(c=>c.checked=false);
    renderAll();
  }

  // generate card avoiding duplicates when possible
  function generateCardForPurchase(modality){
    const used = new Set();
    purchases.forEach(p => (p.card||[]).forEach(cid=>used.add(cid)));
    let pool = Array.from({length:54}, (_,i)=>i+1).filter(id => !used.has(id));
    if (pool.length < modality) pool = Array.from({length:54}, (_,i)=>i+1);
    pool = shuffleArray(pool);
    return pool.slice(0, modality);
  }

  function addGamesPrompt(purchaseId){
    const val = prompt('¬øCu√°ntas partidas agregar?','1'); if (!val) return;
    const add = parseInt(val); if (isNaN(add)|| add<=0) return alert('N√∫mero inv√°lido');
    const p = purchases.find(x=>x.id===purchaseId); if (!p) return alert('Compra no encontrada');
    const price = p.modality===4?prices.price4:(p.modality===6?prices.price6:prices.price9);
    p.gamesLeft = (p.gamesLeft||0) + add;
    p.initialGames = (p.initialGames||0) + add;
    p.totalPaid = (p.totalPaid||0) + (add*price);
    p.isActive = p.gamesLeft>0;
    transactions.push({ id: crypto.randomUUID(), type:'add_games', player: p.playerName, purchaseId: p.id, added: add, amount: add*price, timestamp: Date.now()});
    saveTransactions(transactions);
    savePurchases(purchases);
    renderAll();
  }

  function markPendingPaid(purchaseId){
    const p = purchases.find(x=>x.id===purchaseId); if (!p) return;
    p.paymentState = 'paid';
    savePurchases(purchases);
    renderAll();
  }

  function deletePurchase(purchaseId){
    if (!confirm('Eliminar esta compra?')) return;
    purchases = purchases.filter(p => p.id !== purchaseId);
    transactions.push({ id: crypto.randomUUID(), type:'delete_purchase', purchaseId, timestamp: Date.now()});
    saveTransactions(transactions);
    savePurchases(purchases);
    renderAll();
  }

  function viewCard(purchaseId){
    const p = purchases.find(x=>x.id===purchaseId); if (!p) return alert('Compra no encontrada');
    const list = (p.card||[]).map(cid=>`<div style="background-image:url('${cardImageUrl(cid)}');background-size:cover;background-position:center;width:80px;height:80px;border-radius:8px;display:inline-block;margin:4px;"></div>`).join('');
    const w = window.open('','_blank','width=420,height=420'); w.document.write(`<title>Cartas - ${escapeHtml(p.playerName)}</title><body style="font-family:Inter;padding:12px"><h3>${escapeHtml(p.playerName)} ‚Äî Modalidad ${p.modality}</h3><div>${list}</div></body>`);
  }

  /* ------------------ WINNER MODAL & CONFETTI ------------------ */
  function showWinnerModal(name, amount, winnersList){
    document.getElementById('winner-text').textContent = `${name} ha ganado`;
    document.getElementById('winner-amount').textContent = `Ha recibido: $${amount.toFixed(2)}`;
    const modal = document.getElementById('winner-modal');
    modal.classList.remove('hidden');
    lastWinnerRecords = winnersList || [];
    // confetti mexican colors
    const container = document.getElementById('confetti-container');
    container.innerHTML = '';
    const colors = ['#b42222','#0f8a3c','#caa43f','#ff6b6b','#ffd86b','#7ad3a2'];
    for (let i=0;i<100;i++){
      const d = document.createElement('div');
      d.className = 'confetti';
      d.style.left = `${Math.random()*100}vw`;
      d.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
      d.style.width = `${6 + Math.random()*10}px`;
      d.style.height = d.style.width;
      d.style.animationDelay = `${Math.random()*0.6}s`;
      container.appendChild(d);
    }
  }
  function closeWinner(){ document.getElementById('winner-modal').classList.add('hidden'); document.getElementById('confetti-container').innerHTML=''; highlightResetButton(false); disableControls(false); }

  /* ------------------ TRANSACTIONS / EXPORT / CLEAR ------------------ */
  function exportReport(){
    // compute report: ventas, premios (pending & paid), ganancia casa, saldo en juego
    const sales = purchases.reduce((s,p)=> s + (p.totalPaid||0), 0);
    const totalCardsSold = purchases.reduce((s,p)=> s + (p.initialGames||0), 0);
    const totalHouse = prices.houseProfit * totalCardsSold;
    const winners = (gameState.lastWinners||[]).map(w=> ({ name: w.name, amount: w.amount, timestamp: w.timestamp }));
    const pending = (gameState.pendingWinners||[]).map(w=> ({ name: w.name, amount: w.amount, timestamp: w.timestamp }));
    const report = {
      generatedAt: Date.now(),
      prices,
      sales,
      totalCardsSold,
      totalHouse,
      pot: Math.max(0, sales - totalHouse),
      purchases,
      transactions,
      winners,
      pending
    };
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(report, null, 2));
    const a = document.createElement('a'); a.setAttribute('href', dataStr);
    a.setAttribute('download', `reporte_loteria_${new Date().toISOString().slice(0,10)}.json`);
    document.body.appendChild(a); a.click(); a.remove();
  }

  function clearRecordsForNewDay(){
    if (!confirm('Borrar todas las compras, transacciones y registros para iniciar un nuevo d√≠a?')) return;
    // optional: keep prices but clear purchases, transactions, game
    purchases = [];
    transactions.push({ id: crypto.randomUUID(), type:'clear_day', timestamp: Date.now() });
    saveTransactions(transactions);
    gameState = defaultGame();
    saveGame(gameState);
    savePurchases(purchases);
    renderAll();
    alert('Registros borrados. Nuevo d√≠a listo.');
  }

  /* ------------------ HELPERS ------------------ */
  function shuffleArray(a){ const arr=a.slice(); for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
  function escapeHtml(text){ return (text+'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  if (!crypto || !crypto.randomUUID) { crypto = (crypto||{}); crypto.randomUUID = ()=> 'id-'+Math.random().toString(36).slice(2,9); }

  /* ------------------ UI wiring ------------------ */
  document.getElementById('shuffle-btn').addEventListener('click', shuffleDeckVisual);
  document.getElementById('draw-btn').addEventListener('click', ()=> drawCard());
  document.getElementById('clean-btn').addEventListener('click', cleanAction);
  document.getElementById('auto-btn').addEventListener('click', toggleAuto);
  document.getElementById('calc-btn').addEventListener('click', ()=>{
    const budget = parseFloat(document.getElementById('player-budget-input').value||0);
    const checked = Array.from(document.querySelectorAll('.modal-chk:checked')).map(i=>parseInt(i.value));
    if (!budget || !checked.length) return alert('Captura presupuesto y modalidades');
    const parts = calculatePartitions(budget, checked);
    const zero = parts.find(p => p.games < 1);
    if (zero) { document.getElementById('calc-warning').textContent = `Modalidad ${zero.modality} no alcanza 1 partida con la porci√≥n (${zero.share}$).`; document.getElementById('calc-result').textContent=''; return; }
    document.getElementById('calc-warning').textContent = '';
    document.getElementById('calc-result').textContent = 'Resultado: ' + parts.map(p=>`${p.modality}: ${p.games} partidas (precio ${p.price}$, porci√≥n ${p.share}$)`).join(' ‚Ä¢ ');
  });
  document.getElementById('add-player-btn').addEventListener('click', addPlayer);
  document.getElementById('save-prices').addEventListener('click', ()=> {
    prices.price4 = Math.max(1, parseFloat(document.getElementById('price-4').value||0));
    prices.price6 = Math.max(1, parseFloat(document.getElementById('price-6').value||0));
    prices.price9 = Math.max(1, parseFloat(document.getElementById('price-9').value||0));
    prices.houseProfit = Math.max(0, parseFloat(document.getElementById('house-profit').value||0));
    savePrices(prices); renderAll(); alert('Precios guardados');
  });
  document.getElementById('reset-prices').addEventListener('click', ()=> {
    if (!confirm('Reestablecer precios por defecto?')) return;
    prices = defaultPrices(); savePrices(prices); renderAll();
  });

  // export / clear
  document.getElementById('export-btn').addEventListener('click', exportReport);
  document.getElementById('clear-transactions-btn').addEventListener('click', clearRecordsForNewDay);

  // tabs
  const tabGame = document.getElementById('tab-game'), tabAdmin = document.getElementById('tab-admin');
  tabGame.addEventListener('click', ()=> { tabGame.classList.add('tab-active'); tabAdmin.classList.remove('tab-active'); document.getElementById('view-admin').classList.add('hidden'); document.getElementById('view-en-game').classList.remove('hidden'); document.getElementById('admin-purchases-section').classList.add('hidden'); window.scrollTo({top:0, behavior:'smooth'}); });
  tabAdmin.addEventListener('click', ()=> { tabAdmin.classList.add('tab-active'); tabGame.classList.remove('tab-active'); document.getElementById('view-admin').classList.remove('hidden'); document.getElementById('view-en-game').classList.add('hidden'); document.getElementById('admin-purchases-section').classList.remove('hidden'); window.scrollTo({top:0, behavior:'smooth'}); });

  // keyboard space draw if not auto and admin view active
  document.addEventListener('keydown', (e)=> {
    if (e.code === 'Space') { e.preventDefault(); if (!isAuto && !shuffleAnimating && !document.getElementById('view-admin').classList.contains('hidden')) drawCard(); }
  });

  // storage sync
  window.addEventListener('storage', (e)=> {
    if (e.key === KEY_PRICES) prices = loadPrices();
    if (e.key === KEY_GAME) gameState = loadGame();
    if (e.key === KEY_PURCHASES) purchases = loadPurchases();
    if (e.key === KEY_TRANSACTIONS) transactions = loadTransactions();
    renderAll();
  });

  // helper exposures
  window.addGamesPrompt = addGamesPrompt;
  window.markPendingPaid = markPendingPaid;
  window.viewCard = viewCard;
  window.deletePurchase = deletePurchase;

  // animate mini confetti when creating
  function animateCreateMiniConfetti(){
    const container = document.createElement('div'); container.style.position='fixed'; container.style.left='20px'; container.style.top='80px'; container.style.zIndex=9999; document.body.appendChild(container);
    const colors = ['#b42222','#0f8a3c','#caa43f','#ff6b6b','#7ad3a2'];
    for (let i=0;i<20;i++){ const d=document.createElement('div'); d.style.width='6px'; d.style.height='6px'; d.style.borderRadius='50%'; d.style.position='absolute'; d.style.left=(Math.random()*40)+'px'; d.style.top=(Math.random()*40)+'px'; d.style.backgroundColor=colors[Math.floor(Math.random()*colors.length)]; container.appendChild(d); }
    setTimeout(()=>container.remove(),1200);
  }

  // shuffle helper exposed
  window.shuffleDeckVisual = shuffleDeckVisual;

  // initial render
  prices = loadPrices(); gameState = loadGame(); purchases = loadPurchases(); transactions = loadTransactions();
  renderAll();

  </script>
</body>
</html>
