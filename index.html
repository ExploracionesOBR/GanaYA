<!doctype html><html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üé¥ GANA YA! - Loter√≠a Interactiva Mexicana (v9.6)</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%23ff6bcb'/%3E%3Ctext x='50%25' y='55%25' font-size='18' font-family='Arial' fill='white' text-anchor='middle' font-weight='700'%3EG%3C/text%3E%3C/svg%3E">
<style>
/* Estilos generales */
:root{ --rojo:#b42222; --verde:#0f8a3c; --azul:#1565d8; --naranja:#f77f00; --crema:#fff8ec; --sombra:0 10px 28px rgba(0,0,0,0.12); --accent1:#ffd60a; --accent2:#ff6bcb; }
*{box-sizing:border-box} html,body{height:100%}
body{ font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; background:var(--crema); color:#222;
  background-image: radial-gradient(#ffd60a 1px, transparent 1px), radial-gradient(#e63946 1px, transparent 1px);
  background-position: 0 0, 25px 25px; background-size: 50px 50px; 
  overflow-x: hidden; 
}
.container{ max-width:1200px; margin:8px auto; padding:0 8px; position: relative; }

/* Header y T√≠tulo */
.main-header { display: flex; align-items: center; justify-content: space-between; height: 96px; margin-bottom: 8px; padding: 0; position: relative; }
.logo-box-wrapper{ flex-shrink: 0; width: 96px; height: 96px; position: relative; z-index: 10; padding-left: 8px; }
.logo-box img{ width:96px; height:96px; object-fit:contain; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.12); }
.title-container { flex-grow: 1; text-align: center; pointer-events: none; z-index: 5; }
.title { font-size:50px; font-weight:900; color:var(--rojo); margin:0; animation: fiesta 3.2s linear infinite; white-space: nowrap; width: 100%; }
.subtitle { color:#0b7a3b; font-size:14px; margin-top:4px; text-align:center; }
@keyframes fiesta { 0%{ color:#e63946 }15%{ color:var(--accent1) }30%{ color:#2a9d8f }45%{ color:#6d9df5 }60%{ color:var(--accent2) }75%{ color:#ff9e00 }100%{ color:#e63946 } }

/* Main Grid */
.main-grid{ 
  display:grid; 
  /* 280px (Ganadores) | 1fr (Jugadores Activos, Auto-Ajustable) | 400px (Controles) */
  grid-template-columns: 280px 1fr 400px; 
  gap:8px; 
  align-items:start; 
  padding: 0 8px; 
  margin-top: 0px; /* Revertimos el margen superior aqu√≠ */
}
@media(max-width:1200px){ .main-grid{ grid-template-columns:1fr; } }

/* FIX: Alineaci√≥n Vertical */
/* Compensamos la altura del bloque de controles en la columna 3 */
#winners-panel, #players-section {
  margin-top: 64px; 
}

/* Estilos de Frames */
.mex-frame{ background:#fff; border-radius:12px; padding:10px; border:4px solid var(--rojo); box-shadow:var(--sombra); }
.mex-frame-small{ background:#fff; border-radius:10px; padding:10px; border:3px solid var(--rojo); box-shadow:0 6px 14px rgba(0,0,0,.06); }
#control-partida { text-align: center; }
#control-partida h3 { text-align: center; }
#control-partida select { display: block !important; margin: 0 auto !important; width: 100%; text-align: center; text-align-last: center; }

/* Controles Superiores de Bolsa/Admin */
.header-controls-wrapper {
  display: flex; align-items: center; justify-content: flex-end; 
  padding: 8px 8px 8px 0; 
  margin-bottom: 8px; 
  z-index: 10;
  width: 100%; 
}
.header-controls{ 
  display:flex; gap:12px; align-items:center; flex-shrink: 0; padding: 0; margin: 0; justify-content: flex-end; 
} 
.bolsa-compact{ display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:10px; background:linear-gradient(90deg,#e6fff1,#fff7e6); border:3px solid #c9a700; box-shadow:0 8px 20px rgba(0,0,0,0.06); }
.bolsa-compact .label{ font-weight:900; color:#2d6b25; font-size:14px; }
.bolsa-compact .amount{ font-weight:900; color:#b45309; font-size:18px; }
.toggle-btn{ padding:8px 12px; border-radius:10px; border:none; font-weight:800; cursor:pointer; box-shadow:0 6px 14px rgba(0,0,0,0.08); }
.toggle-play{ background:#1565d8;color:white; }
.toggle-admin{ background:#f3f4f6;color:#111; }

/* Grid de Jugadores */
.players-grid{ display:grid; grid-template-columns: repeat(5,1fr); gap:8px; align-items:start; }
@media(max-width:1100px){ .players-grid{ grid-template-columns: repeat(4,1fr); } }
@media(max-width:900px){ .players-grid{ grid-template-columns: repeat(3,1fr); } }
@media(max-width:640px){ .players-grid{ grid-template-columns: 1fr; } }
.player-card{ background:#fff; border-radius:10px; padding:8px; text-align:center; box-shadow:0 6px 16px rgba(0,0,0,0.06); cursor:pointer; min-height:220px; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; transition:transform .18s ease, box-shadow .18s ease; }
.player-card:hover{ transform:translateY(-4px); box-shadow:0 18px 36px rgba(0,0,0,.12); }
.player-name{ font-weight:900; margin-top:4px; font-size:15px; }
.player-cards{ margin-top:8px; display:flex; flex-direction:column; gap:6px; align-items:center; overflow:hidden; }

/* ... Estilos para botones, cartas, modales, etc. (se mantienen) ... */
.btn { border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: 700; width: 100%; margin-top: 6px; }
.btn-blue { background-color: var(--azul); color: white; }
.btn-red { background-color: var(--rojo); color: white; }
.btn-green { background-color: var(--verde); color: white; }
.hidden { display: none !important; }
.card-img { width: 100px; height: 160px; object-fit: cover; border-radius: 6px; border: 2px solid #555; }
.card-mini-img { width: 40px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #999; }
.current-card .card-img { width: 140px; height: 220px; border-width: 4px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); }
.small-muted { font-size: 12px; color: #666; }
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
.modal-content { background: white; padding: 20px; border-radius: 12px; max-width: 400px; text-align: center; box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5); }

/* Admin View Styles */
#view-admin { margin-top: 8px; padding: 10px 8px; }
.admin-row { display: flex; gap: 8px; }
.admin-col { flex: 1; }
/* ... (A√±adir estilos para tabla, filtros de admin, etc.) ... */
.admin-table th, .admin-table td { padding: 6px 10px; border: 1px solid #eee; text-align: left; }
.admin-table { width: 100%; border-collapse: collapse; font-size: 14px; }
</style>
</head>
<body>

<div class="container">

  <header class="main-header">
      
      <div class="logo-box-wrapper">
          <div class="logo-box"><img id="logo-img" src="logo_1_entrada.png" alt="logo"></div>
      </div>

      <div class="title-container">
          <div class="title">üéâ GANA YA!</div>
          <div class="subtitle">Gana Ya! es una p√°gina de car√°cter interactivo y de entretenimiento.</div>
      </div>
      
      <div style="width: 96px; flex-shrink: 0; padding-right: 8px;"></div>
  </header>
  <div id="header-controls-admin-wrapper" class="header-controls-wrapper hidden" style="margin-top: 8px;">
      <div class="header-controls">
          <div class="bolsa-compact">
              <div class="bolsa-label" id="bolsa-label-admin">üí∞ Bolsa</div>
              <div class="amount bolsa-amount" id="bolsa-amount-admin">$0.00</div>
          </div>
          <button id="btn-view-play-admin" class="toggle-btn toggle-admin">EN JUEGO</button>
          <button id="btn-view-admin-admin" class="toggle-btn toggle-play">‚öôÔ∏è</button>
      </div>
  </div>

  <div class="main-grid" id="main-grid">

    <aside class="mex-frame-small winners" id="winners-panel" aria-label="√öltimos Ganadores">
      <h3 style="margin:0 0 8px 0; text-align:center">√öLTIMOS GANADORES</h3>
      <div class="winners-list" id="winners-list" style="margin-top:4px"><div class="small-muted" style="text-align:center">A√∫n no hay ganadores.</div></div>
    </aside>

    <section class="mex-frame" id="players-section" style="min-height:420px;">
      <h2 style="text-align:center;margin:0 0 8px 0">CARTAS DE JUGADORES ACTIVOS</h2>
      <div class="players-grid" id="players-area" style="margin-top:8px">
        <div class="small-muted" style="padding:18px; text-align:center">A√∫n no hay jugadores.</div>
      </div>
    </section>

    <aside class="controls-panel" id="controls-panel">
      
      <div id="header-controls-play-wrapper" class="header-controls-wrapper">
          <div class="header-controls">
              <div class="bolsa-compact">
                  <div class="bolsa-label" id="bolsa-label-play">üí∞ Bolsa</div>
                  <div class="amount bolsa-amount" id="bolsa-amount-play">$0.00</div>
              </div>
              <button id="btn-view-play-play" class="toggle-btn toggle-play">EN JUEGO</button>
              <button id="btn-view-admin-play" class="toggle-btn toggle-admin">‚öôÔ∏è</button>
          </div>
      </div>
      
      <div class="mex-frame-small" aria-label="Control de partida" id="control-partida" style="margin-top:0px"> 
        <h3 style="margin:0">CONTROL DE PARTIDA</h3>
        <div class="small-muted" style="margin-top:4px">Barajea, tira cartas o activa autom√°tico ‚Äî selecciona modalidad</div>

        <div style="margin-top:8px; text-align:center;">
          <select id="select-modality" style="padding:10px;border-radius:8px;border:1px solid #ddd;font-weight:800;">
            <option value="4">4 cartas</option>
            <option value="6">6 cartas</option>
          </select>
        </div>

        <div class="controls" style="margin-top:8px">
          <div id="game-controls">
            <button id="btn-shuffle" class="btn btn-blue">BARAJEAR</button>
            <button id="btn-draw" class="btn btn-red">TIRAR CARTA</button>
            <button id="btn-auto" class="btn btn-green">CARTAS AUTOM√ÅTICO</button>
          </div>
          <button id="btn-reset" class="btn btn-red hidden" style="width:100%; padding:12px; font-size:18px;">REINICIAR PARTIDA</button>
        </div>

        <div style="text-align:center;margin-top:6px" class="small-muted">Cartas restantes: <span id="deck-count">54</span></div>
      </div>

      <div class="mex-frame-small" style="margin-top:8px">
        <h3 style="text-align:center;margin:0">CARTA EN JUEGO</h3>
        <div id="current-card" class="current-card" style="margin-top:6px">
          <div class="small-muted">Esperando barajeo...</div>
        </div>
      </div>

      <div class="mex-frame-small" style="margin-top:8px">
        <h3 style="text-align:center;margin:0">√öLTIMAS 3 CARTAS</h3>
        <div id="last-cards" class="last-cards" style="margin-top:6px; display:flex; gap:8px; justify-content:center;"></div>
      </div>

    </aside>

  </div> <section id="view-admin" class="mex-frame hidden">
    
    <div class="admin-row">
      <div class="admin-col mex-frame-small">
        <h3 style="margin:0 0 8px 0">Modalidades - Precio & Ganancia</h3>
        <div id="prices-area"></div>
      </div>

      <div class="admin-col mex-frame-small">
        <h3 style="margin:0 0 8px 0">Registrar Jugador (Caja)</h3>
        <div id="register-area">
          <input type="text" id="new-player-name" placeholder="Nombre del jugador" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ddd;">
          <select id="new-player-modality" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ddd; margin-top:6px;">
            <option value="4">4 cartas ($1.00)</option>
            <option value="6">6 cartas ($1.50)</option>
          </select>
          <button id="btn-add-player" class="btn btn-green" style="margin-top:8px">A√±adir Jugador</button>
        </div>
      </div>
    </div>

    <div style="margin-top:8px" class="mex-frame-small">
      <h3 style="margin:0 0 8px 0">Transacciones y Jugadores (Hist√≥rico)</h3>
      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <button class="toggle-btn toggle-admin active-all filter-btn" id="filter-all">Todos</button>
        <button class="toggle-btn toggle-admin filter-btn" id="filter-4" data-mod="4">4 Cartas</button>
        <button class="toggle-btn toggle-admin filter-btn" id="filter-6" data-mod="6">6 Cartas</button>
      </div>
      <div style="max-height: 400px; overflow-y: auto;">
        <table class="admin-table" id="admin-table-purchases">
          <thead><tr><th>ID</th><th>Jugador</th><th>Mod</th><th>Costo</th><th>G/J</th><th>Fec.</th><th>Estado</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>
  
  <div id="modal-winner" class="modal hidden">
    <div class="modal-content">
      <h2 style="color:var(--rojo)">¬°GANADOR! üéâ</h2>
      <div id="modal-winner-body"></div>
      <div class="small-muted" id="modal-winner-subtitle" style="margin-top:4px"></div>
      <button onclick="closeWinnerModal()" class="btn btn-blue" style="margin-top:15px">Aceptar</button>
      <button onclick="resetGame()" class="btn btn-red" style="margin-top:10px">Reiniciar Partida</button>
    </div>
  </div>

  <div id="modal-player" class="modal hidden">
    <div class="modal-content">
      <h2 style="color:var(--azul)" id="modal-player-name">Detalles de Jugador</h2>
      <div id="modal-player-body"></div>
      <button onclick="closeGroupModal()" class="btn btn-blue" style="margin-top:15px">Cerrar</button>
    </div>
  </div>

  <button id="fab-controls-admin" class="btn btn-red hidden" style="position:fixed; bottom:20px; right:20px; width:120px; padding:10px 15px; border-radius:50px; font-size:16px;">
    ‚öôÔ∏è Admin
  </button>
  
  <footer style="text-align:center; padding:15px; font-size:12px; color:#999;">
    Gana Ya! v9.6. Todos los derechos reservados.
  </footer>

</div>

<script>
// === CONSTANTES & CONFIGURACI√ìN ===
const CARD_NAMES = [
  'El Gallo', 'El Diablito', 'La Dama', 'El Catr√≠n', 'El Paraguas', 'La Sirena', 'La Escalera', 'La Botella', 'El Barril', 'El √Årbol',
  'El Mel√≥n', 'El Valiente', 'El Gorrito', 'La Muerte', 'La Pera', 'La Bandera', 'El Bandol√≥n', 'El Violoncello', 'La Garza', 'El P√°jaro',
  'La Mano', 'La Bota', 'La Luna', 'El Cotorro', 'El Borracho', 'El Negrito', 'El Coraz√≥n', 'La Sand√≠a', 'El Tambor', 'El Camar√≥n',
  'Las Jaras', 'El Sol', 'El Mundo', 'El Apache', 'El Nopal', 'El Alacr√°n', 'La Rosa', 'La Calavera', 'La Campana', 'El Cantarito',
  'El Venado', 'El Tr√©bol', 'La Tabla', 'El Pino', 'El Pescado', 'La Palma', 'La Maceta', 'La Mano', 'La Rana', 'El Queso', 
  'El Cazo', 'El Mundo', 'La Corona', 'El Soldado', 'El Diablito', 'La Muerte' // Duplicados para completar 54 si es necesario, aunque lo ideal es 54 √∫nicas
];
const CARD_COUNT = 54;
const MODALITIES = {
  4: { price: 1.00, winFactor: 3.5, winAmount: 3.50, name: '4 cartas' },
  6: { price: 1.50, winFactor: 5.5, winAmount: 8.25, name: '6 cartas' },
};
// KEYS for Local Storage
const Kp = 'loteria_prices'; const Kg = 'loteria_game'; const Kpu = 'loteria_purchases'; 
const Ktx = 'loteria_tx'; const Kw = 'loteria_winners'; const Kpas = 'loteria_pasadas';
const Kmod = 'loteria_modality';

// === VARIABLES DE ESTADO ===
let prices = load(Kp) || MODALITIES;
let game = load(Kg) || { deck: buildDeck54(), currentCard: null, gameActive: false, autoInterval: null };
let purchases = load(Kpu) || [];
let tx = load(Ktx) || [];
let winners = load(Kw) || [];
let cartasPasadas = load(Kpas) || [];
let currentMode = Number(localStorage.getItem(Kmod)) || 4;
let autoRunning = false;
let currentFilter = 'all';

// === FUNCIONES DE UTILIDAD ===
function uuid() { return 'id-' + Math.random().toString(36).substring(2, 9) + Date.now().toString(36); }
function formatMoney(n) { return (Number(n) || 0).toLocaleString('es-MX', { style: 'currency', currency: 'MXN' }); }
function cardName(id) { return CARD_NAMES[id] || 'Carta Desconocida'; }
function cardImage(id) { return `card_${id + 1}.png`; }
function save(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
function load(key) { try { return JSON.parse(localStorage.getItem(key)); } catch (e) { return null; } }
function buildDeck54() { return Array.from({ length: CARD_COUNT }, (_, i) => i); } // IDs 0-53
function getRandomCardId(numCards) { return Math.floor(Math.random() * numCards); }
function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"\'":'&#39;'}[m])); }


// === L√ìGICA DE NEGOCIO ===

function initializePurchaseData(purchase) {
  const mod = prices[purchase.modality] || MODALITIES[purchase.modality] || MODALITIES[4];
  purchase.cost = mod.price;
  purchase.winFactor = mod.winFactor;
  purchase.winAmount = mod.winAmount;
  purchase.enJuego = (purchase.state === 'JUGANDO' || purchase.state === 'POR PAGAR') ? purchase.cost : 0;
  purchase.casa = (purchase.state === 'JUGANDO' || purchase.state === 'POR PAGAR') ? (purchase.cost - purchase.enJuego) : 0;
}

function saveAll(){ 
  save(Kp,prices); save(Kg,game); save(Kpu,purchases); save(Ktx,tx); save(Kw,winners); save(Kpas,cartasPasadas); 
  localStorage.setItem(Kmod,String(currentMode)); 
}

function shuffleDeck() {
  if (game.gameActive) return alert('La partida est√° activa, no se puede barajear.');
  game.deck = buildDeck54();
  for (let i = game.deck.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [game.deck[i], game.deck[j]] = [game.deck[j], game.deck[i]];
  }
  game.gameActive = true;
  game.currentCard = null;
  cartasPasadas = [];
  purchases.forEach(p => { p.cardsHit = []; }); // Resetear cartas marcadas
  
  // Animaci√≥n de Barajeo (simulada)
  document.getElementById('current-card').innerHTML = '<div style="animation: shuffle 1s ease-in-out infinite alternate;"><img src="reverso.png" alt="Barajeando" class="card-img"></div>';
  document.getElementById('current-card').style.textAlign = 'center';
  document.getElementById('deck-count').textContent = game.deck.length;

  setTimeout(() => {
    // Restaurar despu√©s de la animaci√≥n
    document.getElementById('current-card').innerHTML = '<div class="small-muted">Barajeo completado. Tira carta.</div>';
    renderAll(); 
  }, 1000); // 1 segundo de animaci√≥n simulada
}

function drawCard() {
  if (game.deck.length === 0) {
    if (autoRunning) stopAutoDraw();
    return alert('Se han tirado todas las cartas. Reinicia la partida.');
  }
  
  const cardId = game.deck.pop();
  game.currentCard = cardId;
  cartasPasadas.unshift(cardId);
  if (cartasPasadas.length > 5) cartasPasadas.pop(); 
  
  checkWinners(cardId);
  renderAll();
}

function checkWinners(cardId) {
  const cardNameStr = cardName(cardId);
  const newWinners = [];
  
  purchases.filter(p => p.state === 'JUGANDO' && p.modality === currentMode).forEach(p => {
    if (p.cards.includes(cardId)) {
      p.cardsHit.push(cardId);
    }
    
    if (p.cardsHit.length === p.modality) {
      p.state = 'POR PAGAR';
      p.wonAtCard = cartasPasadas.length;
      newWinners.push({
        purchaseId: p.id,
        playerName: p.playerName,
        cardId: cardId,
        cardName: cardNameStr,
        winAmount: p.winAmount,
        ts: Date.now()
      });
      // Detener el juego si es ganador
      if (autoRunning) stopAutoDraw(); 
    }
  });

  if (newWinners.length > 0) {
    winners.unshift(...newWinners);
    showWinnerModal(newWinners);
  }
}

function resetGame() {
  if (autoRunning) stopAutoDraw();
  game = { deck: buildDeck54(), currentCard: null, gameActive: false, autoInterval: null };
  cartasPasadas = [];
  purchases.forEach(p => { p.cardsHit = []; p.wonAtCard = null; });
  closeWinnerModal();
  renderAll();
}

function toggleAutoDraw() {
  if (autoRunning) {
    stopAutoDraw();
  } else {
    startAutoDraw();
  }
  renderAll();
}

function startAutoDraw() {
  if (game.deck.length === 0) return alert('Barajea primero para iniciar el juego.');
  if (game.autoInterval) clearInterval(game.autoInterval);
  autoRunning = true;
  game.autoInterval = setInterval(() => {
    if (game.deck.length === 0) {
      stopAutoDraw();
      alert('Fin de la baraja. Partida terminada.');
    } else {
      drawCard();
    }
  }, 3000); // 3 segundos entre carta y carta
}

function stopAutoDraw() {
  if (game.autoInterval) {
    clearInterval(game.autoInterval);
    game.autoInterval = null;
  }
  autoRunning = false;
}

// === RENDERIZADO ===

function renderCard(id, size = 'large') {
  if (id === null) return '<div class="small-muted">No hay carta en juego.</div>';
  const name = cardName(id);
  const imgUrl = cardImage(id);
  return `<div style="text-align:center;">
    <img src="${imgUrl}" alt="${name}" class="card-img" style="width:${size === 'large' ? '140px' : '40px'}; height:${size === 'large' ? '220px' : '60px'}; border-width:${size === 'large' ? '4px' : '1px'};">
    <div style="font-weight:700; font-size:${size === 'large' ? '18px' : '10px'}; margin-top:4px">${name}</div>
  </div>`;
}

function renderPlayerCard(player) {
  const modName = MODALITIES[player.modality].name;
  const hitCount = (player.cardsHit || []).length;
  const isWinner = player.state === 'POR PAGAR';
  
  let cardHtml = '';
  for(let i = 0; i < player.modality; i++) {
    const cardId = player.cards[i];
    const isHit = (player.cardsHit || []).includes(cardId);
    cardHtml += `
      <div style="display:flex; align-items:center; gap:6px; font-size:12px; font-weight:600; color:${isHit ? var(--rojo) : '#333'};">
        <img src="${cardImage(cardId)}" alt="${cardName(cardId)}" class="card-mini-img" style="border-color:${isHit ? var(--verde) : '#999'}; filter:${isHit ? 'none' : 'grayscale(100%)'};">
        <span>${cardName(cardId)}</span>
        <span style="color:${isHit ? var(--verde) : '#999'}">${isHit ? '‚úîÔ∏è' : '‚ùå'}</span>
      </div>
    `;
  }
  
  return `
    <div class="player-card" onclick="showPlayerModal('${player.id}')" style="border-color:${isWinner ? var(--verde) : var(--rojo)}; background:${isWinner ? '#f0fff5' : '#fff'};">
      <div class="player-name" style="color:${isWinner ? var(--verde) : var(--rojo)}">${escapeHtml(player.playerName)}</div>
      <div class="small-muted" style="margin-bottom:6px">${modName} - ${formatMoney(player.cost)}</div>
      <div style="font-size:24px; font-weight:900; color:${isWinner ? var(--verde) : var(--azul)}; margin:4px 0;">${hitCount}/${player.modality}</div>
      ${isWinner ? '<div style="font-weight:bold; color:'+var(--verde)+';">¬°GAN√ì EN LA CARTA #'+player.wonAtCard+'!</div>' : ''}
    </div>
  `;
}

function renderPlayersGrid() {
  const playersArea = document.getElementById('players-area');
  const activePlayers = purchases.filter(p => p.state === 'JUGANDO' || p.state === 'POR PAGAR').filter(p => p.modality === currentMode);
  
  if (activePlayers.length === 0) {
    playersArea.innerHTML = '<div class="small-muted" style="padding:18px; text-align:center">A√∫n no hay jugadores activos en esta modalidad.</div>';
    return;
  }
  
  playersArea.innerHTML = activePlayers.map(renderPlayerCard).join('');
}

function renderAdminTable() {
  const tbody = document.getElementById('admin-table-purchases').querySelector('tbody');
  tbody.innerHTML = '';
  
  const filteredPurchases = purchases.slice().reverse().filter(p => currentFilter === 'all' || String(p.modality) === currentFilter);
  
  filteredPurchases.forEach(p => {
    const modName = p.modality + 'C';
    let statusColor = '#333';
    if (p.state === 'POR PAGAR') statusColor = var(--verde);
    if (p.state === 'PAGADO') statusColor = var(--azul);
    if (p.state === 'CANCELADO') statusColor = var(--rojo);
    
    const row = tbody.insertRow();
    row.innerHTML = `
      <td>${p.id.substring(3, 8)}</td>
      <td>${escapeHtml(p.playerName)}</td>
      <td>${modName}</td>
      <td>${formatMoney(p.cost)}</td>
      <td>${p.gamesLeft}</td>
      <td>${new Date(p.ts).toLocaleDateString()}</td>
      <td style="color:${statusColor}; font-weight:700;">${p.state}</td>
    `;
    if (p.state === 'POR PAGAR') {
      const cell = row.insertCell();
      cell.innerHTML = `<button onclick="window.markPaidById('${p.id}')" class="toggle-btn toggle-play" style="padding:4px 8px; font-size:12px;">PAGAR</button>`;
    }
  });
  
  // Actualizar filtros de modalidad
  document.querySelectorAll('.filter-btn').forEach(b => {
    b.classList.remove('active-4', 'active-6', 'active-all');
    if ((b.id === 'filter-all' && currentFilter === 'all') || (b.dataset.mod === currentFilter)) {
      b.classList.add('active-' + currentFilter);
    }
  });
}

function renderAll(){
  // 1. Modality select
  const sel=document.getElementById('select-modality'); if(sel) sel.value=String(currentMode);
  
  // 2. Control Buttons
  const deckCount = game.deck.length;
  document.getElementById('deck-count').textContent = deckCount;
  document.getElementById('btn-draw').disabled = deckCount === 0 || !game.gameActive || autoRunning;
  document.getElementById('btn-shuffle').disabled = game.gameActive || autoRunning;
  
  const autoBtn = document.getElementById('btn-auto');
  if (autoRunning) {
    autoBtn.textContent = '‚è∏Ô∏è DETENER AUTOM√ÅTICO';
    autoBtn.classList.remove('btn-green');
    autoBtn.classList.add('btn-red');
  } else {
    autoBtn.textContent = 'CARTAS AUTOM√ÅTICO';
    autoBtn.classList.remove('btn-red');
    autoBtn.classList.add('btn-green');
  }
  
  // 3. Current Card
  document.getElementById('current-card').innerHTML = game.currentCard !== null ? renderCard(game.currentCard) : '<div class="small-muted">Barajea y tira la primera carta para iniciar.</div>';
  
  // 4. Last Cards
  document.getElementById('last-cards').innerHTML = cartasPasadas.map(id => renderCard(id, 'small')).join('');

  // 5. Views and Controls Visibility
  const viewAdminEl = document.getElementById('view-admin');
  const mainGridEl = document.getElementById('main-grid');
  const controlsPlayEl = document.getElementById('header-controls-play-wrapper');
  const controlsAdminEl = document.getElementById('header-controls-admin-wrapper');
  
  const isAdminView = viewAdminEl && !viewAdminEl.classList.contains('hidden');
  
  if (isAdminView) {
      if (mainGridEl) mainGridEl.style.display = 'none';
      if (controlsPlayEl) controlsPlayEl.classList.add('hidden'); // Oculta controles de juego
      if (controlsAdminEl) controlsAdminEl.classList.remove('hidden'); // Muestra controles admin replicados
      // ... (gesti√≥n de botones activos/inactivos) ...
  } else {
      if (mainGridEl) mainGridEl.style.display = 'grid';
      if (controlsPlayEl) controlsPlayEl.classList.remove('hidden'); // Muestra controles de juego
      if (controlsAdminEl) controlsAdminEl.classList.add('hidden'); // Oculta controles admin replicados
      // ... (gesti√≥n de botones activos/inactivos) ...
  }

  // 6. Bolsa/Casa Update
  let potAmount = 0;
  let potLabelText = 'üí∞ Bolsa';
  
  purchases.forEach(p => initializePurchaseData(p));

  if (isAdminView) {
    const totalHouseProfit = purchases.reduce((s, p) => s + (p.casa || 0), 0);
    potAmount = totalHouseProfit;
    potLabelText = 'üí∞ Casa';
    renderAdminTable(); // Renderizar la tabla solo en vista Admin
  } else {
    const activeForPot = purchases.filter(p=> 
      (p.state==='JUGANDO' || p.state==='POR PAGAR') && 
      (p.gamesLeft||0)>0 &&
      p.modality === currentMode 
    );
    const totalEnJuego = activeForPot.reduce((s,p)=> s + (p.enJuego||0),0);
    potAmount = totalEnJuego;
    potLabelText = 'üí∞ Bolsa';
    renderPlayersGrid(); // Renderizar la grilla de jugadores solo en vista Play
  }
  
  // FIX VISIBILITY: Se actualizan AMBOS elementos de la bolsa (play y admin)
  document.querySelectorAll('.bolsa-amount').forEach(el => animateBolsaElement(el, potAmount));
  document.querySelectorAll('.bolsa-label').forEach(el => { el.textContent = potLabelText; });

  // 7. Winners List
  const winnersList = document.getElementById('winners-list');
  winnersList.innerHTML = winners.slice(0, 10).map(w => `<div style="font-size:14px; margin-bottom:4px; border-bottom:1px dashed #eee; padding-bottom:4px;">${escapeHtml(w.playerName)} gan√≥ ${formatMoney(w.winAmount)} (${w.cardName})</div>`).join('');
  if (winners.length === 0) winnersList.innerHTML = '<div class="small-muted" style="text-align:center">A√∫n no hay ganadores.</div>';

  saveAll();
}

function animateBolsaElement(el, target){
  const current = parseFloat((el.dataset.value||'0')); const t = Number(target||0);
  const steps = 18; let i=0; const start=current; const diff = t - start;
  if(el._anim) clearInterval(el._anim);
  el._anim = setInterval(()=>{ 
    i++; 
    const val = start + diff*(i/steps); 
    el.textContent = formatMoney(val); 
    el.dataset.value = val; 
    el.style.transform = (i%2===0)?'scale(1.03)':'scale(1)'; 
    if(i>=steps){ 
      clearInterval(el._anim); 
      el.style.transform=''; 
      delete el._anim; 
    } 
  }, 30);
}

// === MODALS Y MENSAJES ===

function showWinnerModal(recs) {
  const modal = document.getElementById('modal-winner');
  const body = document.getElementById('modal-winner-body');
  const sub = document.getElementById('modal-winner-subtitle');
  const total = recs.reduce((s, r) => s + r.winAmount, 0);
  const names = recs.map(r => escapeHtml(r.playerName)).join(', ');
  body.innerHTML = `${names} ha ganado ${formatMoney(total)}`;
  sub.innerHTML = `Carta ganadora: ${cardName(recs[0].cardId)}`;
  modal.classList.remove('hidden');
  modal.style.display='flex';
  // Simulaci√≥n de efectos de celebraci√≥n
  // playApplause(); 
  // startConfettiFullScreen(); 
}

function closeWinnerModal() {
  const modal = document.getElementById('modal-winner');
  modal.classList.add('hidden');
  modal.style.display='none';
}

function showPlayerModal(playerId) {
  const p = purchases.find(x => x.id === playerId);
  if (!p) return;
  const modal = document.getElementById('modal-player');
  const nameEl = document.getElementById('modal-player-name');
  const body = document.getElementById('modal-player-body');

  nameEl.textContent = escapeHtml(p.playerName) + ' (' + MODALITIES[p.modality].name + ')';
  
  let cardHtml = p.cards.map(id => renderCard(id, 'small')).join('');
  let cardsDetail = `<div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:8px; justify-items:center; margin-top:10px;">${cardHtml}</div>`;

  body.innerHTML = `
    <p>Costo: <strong>${formatMoney(p.cost)}</strong></p>
    <p>Estado: <strong style="color:${p.state === 'JUGANDO' ? var(--azul) : var(--verde)}">${p.state}</strong></p>
    <p>Partidas Restantes: <strong>${p.gamesLeft}</strong></p>
    ${cardsDetail}
  `;
  
  modal.classList.remove('hidden');
  modal.style.display='flex';
}

function closeGroupModal(){ 
  const modal=document.getElementById('modal-player'); 
  modal.classList.add('hidden'); 
  modal.style.display='none'; 
}

// L√≥gica de Registro de Jugador (Admin)
function registerNewPlayer() {
  const nameInput = document.getElementById('new-player-name');
  const modSelect = document.getElementById('new-player-modality');
  const playerName = nameInput.value.trim();
  const modality = Number(modSelect.value);

  if (!playerName) {
    alert('Por favor, ingresa el nombre del jugador.');
    return;
  }
  
  const modConfig = MODALITIES[modality];
  if (!modConfig) {
    alert('Modalidad no v√°lida.');
    return;
  }
  
  // Generar cartas aleatorias (sin repetici√≥n dentro del set)
  let playerCardIds = [];
  const deck = buildDeck54();
  for (let i = 0; i < modality; i++) {
    let cardId;
    do {
      cardId = getRandomCardId(CARD_COUNT);
    } while (playerCardIds.includes(cardId));
    playerCardIds.push(cardId);
  }

  const newPurchase = {
    id: uuid(),
    playerName: playerName,
    modality: modality,
    cost: modConfig.price,
    winAmount: modConfig.winAmount,
    cards: playerCardIds,
    cardsHit: [],
    gamesLeft: 1, // Por simplicidad, 1 juego por registro
    state: 'JUGANDO',
    ts: Date.now()
  };
  
  purchases.push(newPurchase);
  tx.push({ id: uuid(), type: 'purchase', purchaseId: newPurchase.id, amount: newPurchase.cost, ts: Date.now() });
  
  nameInput.value = '';
  saveAll();
  renderAll();
  alert(`Jugador ${playerName} (${modConfig.name}) a√±adido con √©xito.`);
}


window.markPaidById = function(id){ 
  const p=purchases.find(x=>x.id===id); 
  if(!p) return alert('No encontrado'); 
  if(p.state!=='POR PAGAR') return alert('Solo marcar si est√° POR PAGAR'); 
  p.state='PAGADO'; 
  p.paidAt=Date.now(); 
  winners=winners.map(w=> w.purchaseId===id? {...w,paid:true}:w); 
  tx.push({id:uuid(),type:'mark_paid',purchaseId:id,ts:Date.now()}); 
  saveAll(); 
  renderAll(); 
  alert('Marcado como PAGADO'); 
};


// === INICIALIZACI√ìN Y EVENTOS ===
document.addEventListener('DOMContentLoaded', ()=>{
  // Eventos de control de partida
  document.getElementById('btn-shuffle').addEventListener('click', shuffleDeck);
  document.getElementById('btn-draw').addEventListener('click', drawCard);
  document.getElementById('btn-auto').addEventListener('click', toggleAutoDraw);
  document.getElementById('btn-reset').addEventListener('click', resetGame);
  
  // Evento de registro de jugador (Admin)
  document.getElementById('btn-add-player').addEventListener('click', registerNewPlayer);

  // Eventos de botones de vista (EN JUEGO / ADMINISTRADOR)
  const viewPlayHandler = ()=>{ 
    document.getElementById('view-admin').classList.add('hidden'); 
    currentFilter = 'all'; // Resetear filtro al volver
    renderAll(); 
  };
  const viewAdminHandler = ()=>{ 
    document.getElementById('view-admin').classList.remove('hidden'); 
    renderAll(); 
  };
  
  // Botones de la vista EN JUEGO (Columna 3)
  document.getElementById('btn-view-play-play').addEventListener('click', viewPlayHandler);
  document.getElementById('btn-view-admin-play').addEventListener('click', viewAdminHandler);
  
  // Botones de la vista ADMINISTRADOR (Replica)
  document.getElementById('btn-view-play-admin').addEventListener('click', viewPlayHandler);
  document.getElementById('btn-view-admin-admin').addEventListener('click', viewAdminHandler);
  
  // Botones de filtro de Admin
  document.querySelectorAll('.filter-btn').forEach(b => {
    b.addEventListener('click', () => {
      currentFilter = b.dataset.mod || 'all';
      renderAll();
    });
  });

  document.getElementById('select-modality').addEventListener('change', (e)=>{ 
    currentMode = Number(e.target.value); 
    localStorage.setItem(Kmod,String(currentMode)); 
    renderAll(); 
  });
  
  // Si la imagen de logo no carga, ocultar el contenedor
  const logoImg = document.getElementById('logo-img'); 
  logoImg.onerror = ()=>{ document.querySelector('.logo-box').style.display='none'; };

  // Inicializar vista forzando a EN JUEGO y asegurar ocultamiento/alineaci√≥n
  document.getElementById('view-admin').classList.add('hidden');
  renderAll();
});
</script>
</body>
</html>
