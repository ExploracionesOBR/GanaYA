<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GANA YA! ‚Äî Loter√≠a (v6.2)</title>

  <link href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  
  <style>
    /* Estilos Generales */
    :root{
      --rojo:#b42222; --verde:#0f8a3c; --dorado:#caa43f; --crema:#f6f1e6; --sombra: 0 10px 24px rgba(0,0,0,0.08);
    }
    *{box-sizing:border-box}
    body{ font-family:Inter,system-ui,-apple-system; background:var(--crema); color:#1f2937; margin:0; -webkit-font-smoothing:antialiased; padding:18px; }
    header{ text-align:center; margin-bottom:18px; position:relative; }
    .mex-title{ font-family:'Alfa Slab One', serif; font-size:36px; color:var(--rojo); line-height:1.02; margin-bottom:6px; display:inline-block; padding:6px 12px; background:#fff; border-radius:8px; border:2px solid var(--rojo); box-shadow:var(--sombra); }
    .subtitle{ font-size:14px; font-weight:600; color:#4b5563; }
    
    .hidden { display: none !important; }
    
    /* Logo de Entrada */
    .logo-container{
        position:absolute;
        left:0;
        top:50%;
        transform:translateY(-50%);
    }
    .logo-container img{
        /* üí° LOGO M√ÅS GRANDE */
        height: 90px;
        width:auto;
        object-fit:contain;
    }
    
    /* Controles de Juego */
    .controls{
        display:flex; justify-content:center; align-items:center; gap:12px; margin-top:20px;
    }
    .btn{
        background-color:var(--verde); color:#fff; border:none; padding:10px 20px; border-radius:6px; font-size:16px; font-weight:bold; cursor:pointer; transition:background-color 0.2s;
    }
    .btn:hover{ background-color:#0b6b2f; }
    .btn-red{ background-color:var(--rojo); }
    .btn-red:hover{ background-color:#991d1d; }
    .btn-yellow{ background-color:var(--dorado); color:#1f2937; }
    .btn-yellow:hover{ background-color:#b88b2a; }

    /* Carta Actual */
    .current-card-container{
        text-align:center; margin:24px 0;
    }
    .current-card{
        width: 100%; max-width: 300px; height: auto; border-radius: 12px; box-shadow: var(--sombra); border: 4px solid var(--rojo); object-fit: cover;
    }
    .current-card-name{
        font-family:'Alfa Slab One', serif; font-size:24px; color:var(--rojo); margin-top:8px;
    }

    /* Tablero de Cartas Salidas */
    .board-container{
        max-width: 900px; margin: 0 auto; padding: 12px; background:#fff; border-radius:12px; box-shadow:var(--sombra);
    }
    .board-grid{
        display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px;
    }
    .board-cell{
        aspect-ratio: 1 / 1; background-color: #eee; border-radius: 6px; overflow: hidden; position: relative;
    }
    .board-card-img{
        width: 100%; height: 100%; object-fit: cover; opacity: 0.2; transition: opacity 0.3s;
    }
    .board-cell.passed .board-card-img{
        opacity: 1; border: 2px solid var(--verde);
    }
    .board-cell.last-passed .board-card-img{
        border: 4px solid var(--dorado);
    }
    
    /* Contenedor de Jugadores (Compacto) */
    .player-list-container {
        margin-top: 24px; max-width: 900px; margin: 24px auto; padding: 12px; background: #fff; border-radius: 12px; box-shadow: var(--sombra);
    }
    .player-list-grid {
        display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px;
    }
    .player-card-compact {
        border: 1px solid #ccc; border-radius: 8px; padding: 10px; background-color: #f9f9f9; cursor: pointer; transition: background-color 0.2s; position: relative;
    }
    .player-card-compact:hover {
        background-color: #f0f0f0;
    }
    .player-card-compact h4 {
        margin: 0 0 5px 0; font-size: 1.1em; color: var(--rojo);
    }
    .player-card-compact p {
        margin: 2px 0; font-size: 0.9em;
    }
    .player-compact-card-grid {
        display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; margin-top: 8px;
    }
    .player-compact-card-grid img {
        width: 100%; height: 100%; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 4px; border: 1px solid #ddd;
    }
    .player-compact-card-grid .card-cell {
        position: relative;
    }
    .player-compact-card-grid .card-cell.passed img {
        opacity: 0.3;
        border: 1px solid var(--verde);
    }

    /* Admin Panel */
    #view-admin{
        margin-top: 24px; max-width: 900px; margin: 24px auto; padding: 12px; background: #fff; border-radius: 12px; box-shadow: var(--sombra);
    }
    #admin-controls{
        display:flex; justify-content:flex-start; gap:10px; margin-bottom:15px; flex-wrap:wrap;
    }
    #admin-tabs{
        display:flex; gap:10px; margin-bottom:15px; border-bottom:1px solid #ddd; padding-bottom:10px;
    }
    .tab-btn{
        background:#eee; padding:5px 10px; border-radius:5px; cursor:pointer; font-weight:bold;
    }
    .tab-btn.active{
        background:var(--verde); color:white;
    }
    .tab-content{
        border:1px solid #eee; padding:15px; border-radius:8px;
    }
    
    /* Tabla de Jugadores en Admin */
    #players-table{
        width:100%; border-collapse:collapse; margin-top:15px;
    }
    #players-table th, #players-table td{
        border:1px solid #ddd; padding:8px; text-align:left; font-size:14px;
    }
    #players-table th{
        background-color:#f2f2f2;
    }
    .action-btn{
        margin-right:5px; padding:4px 8px; font-size:12px;
    }
    .selection-link{
        font-size:12px; cursor:pointer; color:var(--rojo); text-decoration:underline;
    }

    /* Modal (Detalles de Jugador) */
    .modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 100;
    }
    .modal-content {
        background: #fff; padding: 20px; border-radius: 12px; max-width: 90%; max-height: 90%; overflow-y: auto; position: relative; box-shadow: var(--sombra);
    }
    .close-btn {
        position: absolute; top: 10px; right: 10px; font-size: 24px; cursor: pointer; border: none; background: transparent;
    }
    .player-detail-info h3 {
        color: var(--rojo); border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 0;
    }
    .player-detail-info p {
        margin: 5px 0;
    }
    .player-full-card-grid {
        display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 15px;
    }
    .player-full-card-grid .card-cell {
        aspect-ratio: 1 / 1.5; border-radius: 8px; overflow: hidden; position: relative; background: #eee;
    }
    .player-full-card-grid .card-cell img {
        width: 100%; height: 100%; object-fit: cover;
    }
    .player-full-card-grid .card-cell.passed img {
        opacity: 0.3;
    }
    
    /* Sticker (Estampa/Logo en las cartas) */
    .sticker{
        position:absolute; inset:0;
        display:flex; align-items:center; justify-content:center;
        z-index:20; pointer-events:none; opacity:0.95;
    }
    .player-full-card-grid .card-cell .sticker img {
        /* üí° ESTAMPA M√ÅS GRANDE EN EL MODAL */
        width: 70%;
        height: 70%;
        object-fit: contain;
    }
    .player-compact-card-grid .card-cell .sticker img {
        /* üí° ESTAMPA M√ÅS GRANDE EN LA VISTA COMPACTA */
        width: 70%;
        height: 70%;
        object-fit: contain;
    }

    /* Controles de AutoPlay */
    .autoplay-controls {
        display: flex; align-items: center; gap: 10px; margin-top: 10px;
    }
    .autoplay-controls label {
        font-size: 14px; font-weight: 600;
    }
    .autoplay-controls input[type="number"] {
        width: 60px; padding: 5px; border-radius: 4px; border: 1px solid #ccc;
    }

    /* Modal de Selecci√≥n de Cartas (Solo cuando el enlace tiene ?select=...) */
    #selection-interface {
        padding: 20px; text-align: center;
    }
    #selection-grid {
        display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 20px; max-width: 800px; margin: 20px auto;
    }
    #selection-grid .card-cell {
        aspect-ratio: 1 / 1.5; border-radius: 8px; overflow: hidden; position: relative; cursor: pointer; border: 3px solid transparent; transition: border-color 0.2s;
    }
    #selection-grid .card-cell.selected {
        border-color: var(--verde);
        box-shadow: 0 0 8px var(--verde);
    }
    #selection-grid .card-cell img {
        width: 100%; height: 100%; object-fit: cover;
    }
    #selection-message {
        font-size: 1.2em; font-weight: bold; margin-bottom: 15px;
    }
    .selection-controls {
        margin-top: 20px;
    }
    .selection-controls input, .selection-controls button {
        padding: 10px; margin: 5px; border-radius: 6px; border: 1px solid #ccc;
    }
    .selection-controls button {
        border: none; background: var(--rojo); color: white; cursor: pointer;
    }
    .selection-controls button:disabled {
        background: #aaa; cursor: not-allowed;
    }
  </style>

</head>
<body>

<header>
    <div class="logo-container">
        <img src="logo_1_entrada.png" alt="Logo Loter√≠a">
    </div>
    <div class="mex-title">GANA YA!</div>
    <div class="subtitle">Administrador de Loter√≠a - v6.2</div>
</header>

<div class="controls">
    <button id="draw-btn" class="btn">Sacar Carta (Espacio)</button>
    <button id="shuffle-btn" class="btn btn-red">Barajar y Reiniciar</button>
</div>

<div class="autoplay-controls">
    <label for="autoplay-interval">
        <input type="checkbox" id="autoplay-toggle">
        Auto Play (segundos):
    </label>
    <input type="number" id="autoplay-interval" value="3" min="1" max="60">
    <button id="toggle-admin" class="btn-yellow">Toggle Admin</button>
</div>

<div class="current-card-container">
    <img id="current-card-img" class="current-card" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="Carta Actual">
    <div id="current-card-name" class="current-card-name">...</div>
</div>

<div class="board-container">
    <h3>Cartas que han Salido:</h3>
    <div id="board-grid" class="board-grid">
        </div>
</div>

<div id="player-list-container" class="player-list-container hidden">
    <h3>Jugadores Registrados:</h3>
    <div id="player-list-grid" class="player-list-grid">
        </div>
</div>

<div id="view-admin" class="hidden">
    <div id="admin-tabs">
        <div class="tab-btn active" data-tab="players">Jugadores</div>
        <div class="tab-btn" data-tab="settings">Configuraci√≥n</div>
    </div>
    
    <div id="tab-content-players" class="tab-content">
        <div id="admin-controls">
            <button id="new-player-btn" class="btn">Registrar Nuevo Jugador</button>
            <button id="export-btn" class="btn-yellow">Exportar Reporte (PDF)</button>
            <button id="clear-btn" class="btn-red">Limpiar Registros (Nuevo D√≠a)</button>
        </div>
        
        <h4>Tabla de Jugadores:</h4>
        <table id="players-table">
            <thead>
                <tr>
                    <th>Cuenta</th>
                    <th>Celular</th>
                    <th>Pagado</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <div id="tab-content-settings" class="tab-content hidden">
        <h4>Ajuste de Precios y Pagos:</h4>
        <p>Edita los valores y presiona "Guardar Precios" para aplicar.</p>
        <div id="price-settings">
            </div>
        <button id="save-prices-btn" class="btn">Guardar Precios</button>
        <button id="reset-prices" class="btn-red">Restablecer Precios</button>
    </div>
</div>

<div id="player-detail-modal" class="modal hidden">
    <div class="modal-content">
        <button class="close-btn" id="close-modal-btn">&times;</button>
        <div id="player-detail-info" class="player-detail-info">
            </div>
        <div id="player-full-card-grid" class="player-full-card-grid">
            </div>
        <div class="controls" style="justify-content:space-between;">
            <button id="pay-player-btn" class="btn-yellow hidden">Marcar como Pagado</button>
            <button id="delete-player-btn" class="btn-red">Eliminar Jugador</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" referrerpolicy="no-referrer"></script>

<script>
// --- Constantes y Variables Globales ---

const KEY_PRICES = 'loteria_prices_v70';
const KEY_GAME = 'loteria_game_v70';
const KEY_PUR = 'loteria_purchases_v70';
const KEY_TX = 'loteria_transactions_v70';

const totalCards = 54;
const cardsPerPlayer = 16;
const cardImagePath = 'Cartas_baraja_loteria/'; // ASEG√öRATE DE QUE ESTA CARPETA EXISTE

let gameState = {
    deck: Array.from({ length: totalCards }, (_, i) => i + 1), // [1, 2, ..., 54]
    passed: [], // Cartas que ya salieron
    lastPassed: null,
};
let purchases = []; // Registros de { id, cuenta, celular, cards: [1, 2, ...], paid: false, txId: null }
let transactions = []; // Registros de { id, amount, type, date }
let prices = {}; // { cardPrice: X, loteriaPrize: Y, tablitaPrize: Z, ... }
let isAuto = false;
let autoIntervalId = null;
let shuffleAnimating = false; // Para evitar doble clic durante la animaci√≥n

// --- Datos por Defecto ---
const defaultPrices = () => ({
    cardPrice: 100,
    loteriaPrize: 1000,
    tablitaPrize: 500,
    cuatroEsquinasPrize: 300,
    pozoPrize: 5000, // Premio acumulado
    totalEarnings: 0 // Ganancias totales (se guarda, pero se calcula)
});
const defaultCardNames = [
    "el gallo", "el diablito", "la dama", "el catr√≠n", "el paraguas", "la sirena",
    "la escalera", "la botella", "el barril", "el √°rbol", "el mel√≥n", "el valiente",
    "el gorrito", "la muerte", "la pera", "la bandera", "el bandol√≥n", "el violoncello",
    "la garza", "el p√°jaro", "la mano", "la bota", "la luna", "el cotorro",
    "el borracho", "el negrito", "el coraz√≥n", "la sand√≠a", "el tambor", "el camar√≥n",
    "las jaras", "el m√∫sico", "la ara√±a", "el soldado", "la estrella", "el cazo",
    "el mundo", "el apache", "el nopal", "el alacr√°n", "la rosa", "la calavera",
    "la campana", "el cantarito", "el venado", "el Sol", "la corona", "la chalupa",
    "el pino", "el pescado", "la palma", "la maceta", "el rayo", "la rana"
];
// Para los archivos: 1 el gallo-min.jpg, etc.
const cardNames = defaultCardNames.map((name, index) => `${index + 1} ${name}-min.jpg`);

// --- Funciones de Utilidad ---

// Carga de estado
const loadPrices = () => JSON.parse(localStorage.getItem(KEY_PRICES)) || defaultPrices();
const loadGame = () => JSON.parse(localStorage.getItem(KEY_GAME)) || { deck: Array.from({ length: totalCards }, (_, i) => i + 1), passed: [], lastPassed: null };
const loadPurchases = () => JSON.parse(localStorage.getItem(KEY_PUR)) || [];
const loadTransactions = () => JSON.parse(localStorage.getItem(KEY_TX)) || [];

// Guardado de estado
const savePrices = (p) => localStorage.setItem(KEY_PRICES, JSON.stringify(p));
const saveGame = (g) => localStorage.setItem(KEY_GAME, JSON.stringify(g));
const savePurchases = (p) => localStorage.setItem(KEY_PUR, JSON.stringify(p));
const saveTransactions = (t) => localStorage.setItem(KEY_TX, JSON.stringify(t));

// C√°lculo de Ganancias (Se calcula siempre, no se guarda como estado)
const calculateEarnings = () => {
    const totalRevenue = purchases.length * prices.cardPrice;
    const totalPrizesPaid = transactions
        .filter(t => t.type === 'prize')
        .reduce((sum, t) => sum + t.amount, 0);
    return totalRevenue - totalPrizesPaid;
};

// --- L√≥gica del Juego ---

function shuffleDeck() {
    let array = Array.from({ length: totalCards }, (_, i) => i + 1);
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function resetGame() {
    gameState = {
        deck: shuffleDeck(),
        passed: [],
        lastPassed: null,
    };
    saveGame(gameState);
    renderAll();
    // Animaci√≥n de Barajado (opcional)
    shuffleAnimating = true;
    document.getElementById('current-card-name').textContent = '¬°Barajando...!';
    document.getElementById('current-card-img').src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; // Imagen vac√≠a
    setTimeout(() => {
        shuffleAnimating = false;
        renderAll();
        alert('Juego Reiniciado y Barajado. ¬°A jugar!');
    }, 1500);
}

function drawCard() {
    if (shuffleAnimating) return;
    if (gameState.deck.length === 0) {
        alert('¬°Se han sacado todas las cartas! Reinicia el juego.');
        return;
    }
    
    // Sacar la carta
    const cardId = gameState.deck.pop();
    gameState.passed.push(cardId);
    gameState.lastPassed = cardId;
    
    saveGame(gameState);
    renderAll();
}

function generatePlayerCard(cardIds) {
    let availableCards = Array.from({ length: totalCards }, (_, i) => i + 1).filter(id => !cardIds.includes(id));
    
    if (cardIds.length !== 16) {
        // Genera 16 cartas si el array est√° incompleto o vac√≠o.
        const deck = shuffleDeck();
        cardIds = deck.slice(0, cardsPerPlayer);
    }
    
    return cardIds;
}

function registerNewPlayer(account, phone, cardIds) {
    if (purchases.some(p => p.cuenta === account)) {
        alert('Error: Ya existe un jugador con esa cuenta.');
        return false;
    }
    
    const newPlayer = {
        id: Date.now(),
        cuenta: account,
        celular: phone,
        cards: cardIds,
        paid: false,
        txId: null, // ID de transacci√≥n de pago (compra)
    };
    purchases.push(newPlayer);
    
    // Registrar transacci√≥n de compra
    const tx = {
        id: Date.now() + 1, // Asegura un ID √∫nico
        amount: prices.cardPrice,
        type: 'purchase', // Tipo de transacci√≥n: compra de tarjeta
        date: new Date().toISOString(),
        playerId: newPlayer.id
    };
    transactions.push(tx);
    newPlayer.txId = tx.id; // Enlazar el pago de la tarjeta al jugador
    
    savePurchases(purchases);
    saveTransactions(transactions);
    renderAll();
    return newPlayer;
}

function deletePlayer(playerId) {
    if (!confirm('¬øEst√°s seguro de que quieres eliminar este jugador? Se perder√°n todos los registros asociados.')) return;
    
    purchases = purchases.filter(p => p.id !== playerId);
    transactions = transactions.filter(t => t.playerId !== playerId); // Eliminar transacciones relacionadas
    
    savePurchases(purchases);
    saveTransactions(transactions);
    renderAll();
    closeModal();
}

function markPlayerAsPaid(playerId, prizeType, prizeAmount) {
    const player = purchases.find(p => p.id === playerId);
    if (player) {
        if (!confirm(`¬øConfirmar pago de ${prizeType} a ${player.cuenta} por $${prizeAmount}?`)) return;
        
        player.paid = true;
        
        // Registrar transacci√≥n de premio
        const tx = {
            id: Date.now(),
            amount: prizeAmount,
            type: 'prize', // Tipo de transacci√≥n: premio
            prizeType: prizeType,
            date: new Date().toISOString(),
            playerId: playerId
        };
        transactions.push(tx);
        
        savePurchases(purchases);
        saveTransactions(transactions);
        renderAll();
        closeModal();
    }
}

function checkWin(player, passedCards) {
    const playerCards = player.cards;
    
    // 1. Loter√≠a (Todas las 16 cartas)
    const loteria = playerCards.every(cardId => passedCards.includes(cardId));
    
    if (loteria) return { win: true, type: 'Loter√≠a', prize: prices.loteriaPrize };
    
    // 2. Tablita (Las primeras 4 cartas por fila)
    // El tablero es un 4x4. Los √≠ndices son 0-3, 4-7, 8-11, 12-15
    const rows = [
        [0, 1, 2, 3], [4, 5, 6, 7], [8, 9, 10, 11], [12, 13, 14, 15]
    ];
    
    const tablita = rows.some(rowIndices => {
        return rowIndices.every(i => passedCards.includes(playerCards[i]));
    });
    
    if (tablita) return { win: true, type: 'Tablita', prize: prices.tablitaPrize };
    
    // 3. Cuatro Esquinas
    const fourCornersIndices = [0, 3, 12, 15]; // Esquinas del 4x4
    const fourCorners = fourCornersIndices.every(i => passedCards.includes(playerCards[i]));
    
    if (fourCorners) return { win: true, type: 'Cuatro Esquinas', prize: prices.cuatroEsquinasPrize };
    
    return { win: false, type: null, prize: 0 };
}

function clearRecordsForNewDay() {
    if (!confirm('¬°ADVERTENCIA! Esta acci√≥n borrar√° **TODOS** los jugadores registrados y sus transacciones de esta partida. ¬øEst√°s seguro de que quieres empezar un nuevo d√≠a?')) return;
    
    purchases = [];
    transactions = [];
    
    savePurchases(purchases);
    saveTransactions(transactions);
    resetGame(); // Tambi√©n baraja y limpia las cartas pasadas
    alert('Registros de jugadores limpiados y juego reiniciado. ¬°Nuevo d√≠a!');
}

// --- Renderizado (Actualizaci√≥n de la Interfaz) ---

function getCardImagePath(cardId) {
    if (cardId < 1 || cardId > totalCards) return '';
    // cardId 1 -> cardNames[0]
    return `${cardImagePath}${cardNames[cardId - 1]}`;
}

function renderBoard() {
    const boardGrid = document.getElementById('board-grid');
    boardGrid.innerHTML = ''; // Limpiar
    
    for (let i = 1; i <= totalCards; i++) {
        const cell = document.createElement('div');
        cell.className = 'board-cell';
        const isPassed = gameState.passed.includes(i);
        const isLastPassed = gameState.lastPassed === i;
        
        if (isPassed) cell.classList.add('passed');
        if (isLastPassed) cell.classList.add('last-passed');
        
        const img = document.createElement('img');
        img.className = 'board-card-img';
        img.src = getCardImagePath(i);
        img.alt = `Carta ${i}`;
        
        cell.appendChild(img);
        boardGrid.appendChild(cell);
    }
    
    // Renderizar la carta actual
    const currentCardImg = document.getElementById('current-card-img');
    const currentCardName = document.getElementById('current-card-name');
    
    if (gameState.lastPassed) {
        currentCardImg.src = getCardImagePath(gameState.lastPassed);
        currentCardName.textContent = cardNames[gameState.lastPassed - 1].split(' ')[1].toUpperCase();
    } else {
        currentCardImg.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
        currentCardName.textContent = 'Presiona "Sacar Carta" para empezar.';
    }
}

function renderPlayerList() {
    const playerListGrid = document.getElementById('player-list-grid');
    playerListGrid.innerHTML = '';
    
    // Mostrar u ocultar el contenedor de jugadores si no hay ninguno
    document.getElementById('player-list-container').classList.toggle('hidden', purchases.length === 0);

    purchases.forEach(player => {
        const win = checkWin(player, gameState.passed);
        
        const card = document.createElement('div');
        card.className = 'player-card-compact';
        card.onclick = () => showPlayerDetails(player.id);
        
        card.innerHTML = `
            <h4>${player.cuenta}</h4>
            <p>Cel: ${player.celular || 'N/A'}</p>
            <p style="font-weight:bold; color:${win.win ? 'var(--verde)' : player.paid ? 'var(--rojo)' : '#4b5563'};">
                ${win.win ? `¬°GAN√ì ${win.type.toUpperCase()}! ($${win.prize})` : player.paid ? 'PAGADO' : 'PENDIENTE'}
            </p>
            <div class="player-compact-card-grid">
                ${player.cards.map(cardId => {
                    const passed = gameState.passed.includes(cardId);
                    return `
                        <div class="card-cell ${passed ? 'passed' : ''}">
                            <img src="${getCardImagePath(cardId)}" alt="Carta ${cardId}">
                            ${passed? `<div class="sticker" style="opacity:1;"><img src="logo_1_entrada.png" style="width:70%;height:70%;object-fit:contain"/></div>` : ''}
                        </div>
                    `;
                }).join('')}
            </div>
        `;
        
        playerListGrid.appendChild(card);
    });
}

function renderAdminTable() {
    const playersTableBody = document.querySelector('#players-table tbody');
    playersTableBody.innerHTML = '';
    
    purchases.forEach(player => {
        const win = checkWin(player, gameState.passed);
        
        const row = playersTableBody.insertRow();
        row.innerHTML = `
            <td>${player.cuenta}</td>
            <td>${player.celular || 'N/A'}</td>
            <td>$${prices.cardPrice}</td>
            <td style="color:${win.win ? 'var(--verde)' : player.paid ? 'var(--rojo)' : '#4b5563'}; font-weight:bold;">
                ${win.win ? win.type.toUpperCase() : player.paid ? 'PAGADO' : 'ACTIVO'}
            </td>
            <td>
                <button class="action-btn btn-yellow" onclick="showPlayerDetails(${player.id})">Detalles</button>
                <button class="action-btn btn-red" onclick="deletePlayer(${player.id})">Eliminar</button>
                <span class="selection-link" onclick="copySelectionLink('${player.id}')">Copiar Enlace</span>
            </td>
        `;
    });
}

function renderPriceSettings() {
    const container = document.getElementById('price-settings');
    container.innerHTML = '';
    
    // Calcular las ganancias antes de renderizar
    const currentEarnings = calculateEarnings();
    
    const fields = [
        { key: 'cardPrice', label: 'Costo por Tarjeta' },
        { key: 'loteriaPrize', label: 'Premio Loter√≠a' },
        { key: 'tablitaPrize', label: 'Premio Tablita' },
        { key: 'cuatroEsquinasPrize', label: 'Premio 4 Esquinas' },
    ];
    
    fields.forEach(field => {
        const div = document.createElement('div');
        div.innerHTML = `
            <label for="${field.key}">${field.label}:</label>
            <input type="number" id="${field.key}" value="${prices[field.key]}" min="0" style="width:100px; margin-left:10px;">
        `;
        container.appendChild(div);
    });
    
    // Mostrar ganancias calculadas
    const earningsDiv = document.createElement('div');
    earningsDiv.style.marginTop = '15px';
    earningsDiv.innerHTML = `
        <p style="font-weight:bold; color: ${currentEarnings >= 0 ? 'var(--verde)' : 'var(--rojo)'};">
            Ganancias NETAS Actuales: $${currentEarnings}
        </p>
        <p style="font-size: 0.9em; color: #666;">
            (Calculado como Ingresos por Tarjetas - Premios Pagados)
        </p>
    `;
    container.appendChild(earningsDiv);
}

function renderAll() {
    renderBoard();
    renderPlayerList();
    renderAdminTable();
    renderPriceSettings();
}

// --- Funciones del Modal ---

function showPlayerDetails(playerId) {
    const player = purchases.find(p => p.id === playerId);
    if (!player) return;
    
    const win = checkWin(player, gameState.passed);
    
    document.getElementById('player-detail-info').innerHTML = `
        <h3>Detalles del Jugador: ${player.cuenta}</h3>
        <p><strong>Celular:</strong> ${player.celular || 'N/A'}</p>
        <p><strong>Pagado:</strong> $${prices.cardPrice}</p>
        <p><strong>Estado:</strong> <span style="font-weight:bold; color:${win.win ? 'var(--verde)' : player.paid ? 'var(--rojo)' : '#4b5563'};">${win.win ? `¬°GANADOR! ${win.type} ($${win.prize})` : player.paid ? 'PAGADO' : 'ACTIVO'}</span></p>
    `;
    
    const cardGrid = document.getElementById('player-full-card-grid');
    cardGrid.innerHTML = '';
    
    player.cards.forEach(cardId => {
        const cell = document.createElement('div');
        const passed = gameState.passed.includes(cardId);
        cell.className = `card-cell ${passed ? 'passed' : ''}`;
        
        cell.innerHTML = `
            <img src="${getCardImagePath(cardId)}" alt="Carta ${cardId}">
            ${passed? `<div class="sticker" style="opacity:1;"><img src="logo_1_entrada.png" style="width:70%;height:70%;object-fit:contain"/></div>` : ''}
        `;
        cardGrid.appendChild(cell);
    });
    
    // L√≥gica del bot√≥n de pago
    const payBtn = document.getElementById('pay-player-btn');
    payBtn.onclick = () => markPlayerAsPaid(player.id, win.type, win.prize);
    
    if (win.win && !player.paid) {
        payBtn.classList.remove('hidden');
        payBtn.textContent = `Marcar como Pagado (${win.type} $${win.prize})`;
    } else {
        payBtn.classList.add('hidden');
    }
    
    // Bot√≥n de eliminar
    document.getElementById('delete-player-btn').onclick = () => deletePlayer(player.id);

    document.getElementById('player-detail-modal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('player-detail-modal').classList.add('hidden');
}

// --- Funciones de Selecci√≥n de Cartas (URL ?select=...) ---

function handleSelectionLinkOnLoad() {
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('select');

    if (token) {
        const existingPlayer = purchases.find(p => p.id == token); // Compara id (number) con token (string)
        
        if (existingPlayer) {
            // Si el token ya existe, solo muestra la tarjeta del jugador (modo solo vista)
            renderSelectionView(existingPlayer.cards, existingPlayer);
        } else {
            // Si el token no existe, permite crear una nueva tarjeta
            const newCardIds = generatePlayerCard([]); // Genera cartas aleatorias
            renderSelectionView(newCardIds, null, token);
        }
    }
}

function renderSelectionView(selectedCards, existingPlayer = null, token = null) {
    // Si entramos en modo selecci√≥n, reemplazamos el body (o al menos el contenido principal)
    document.body.innerHTML = `
        <style>
            .selection-interface h1 { color: var(--rojo); font-family: 'Alfa Slab One', serif; }
            .selection-interface { padding: 40px; text-align: center; }
            /* ... (Asegurar que los estilos de selecci√≥n se incluyan si no est√°n en el head) ... */
        </style>
        <div id="selection-interface" class="selection-interface">
            <h1>Selecci√≥n de Tarjeta de Loter√≠a</h1>
            <div id="selection-message"></div>
            <div id="selection-grid"></div>
            <div class="selection-controls">
                <input type="text" id="player-account" placeholder="Nombre/Cuenta">
                <input type="tel" id="player-phone" placeholder="Celular (Opcional)">
                <button id="save-selection-btn" class="btn">Guardar Tarjeta</button>
            </div>
            <p style="margin-top:20px; font-size:12px;">URL de selecci√≥n: <span id="selection-url-display"></span></p>
        </div>
    `;

    const selectionGrid = document.getElementById('selection-grid');
    selectionGrid.innerHTML = '';

    for (let cardId of selectedCards) {
        const cell = document.createElement('div');
        cell.className = 'card-cell selected'; // Se marcan como seleccionadas por defecto
        
        const img = document.createElement('img');
        img.src = getCardImagePath(cardId);
        img.alt = `Carta ${cardId}`;
        
        cell.appendChild(img);
        selectionGrid.appendChild(cell);
    }

    const saveBtn = document.getElementById('save-selection-btn');
    const accountInput = document.getElementById('player-account');
    const phoneInput = document.getElementById('player-phone');
    const msgDiv = document.getElementById('selection-message');
    const urlDisplay = document.getElementById('selection-url-display');
    
    urlDisplay.textContent = window.location.href; // Muestra el enlace completo

    if (existingPlayer) {
        msgDiv.textContent = `¬°Tu tarjeta ya est√° registrada, ${existingPlayer.cuenta}!`;
        accountInput.value = existingPlayer.cuenta;
        phoneInput.value = existingPlayer.celular || '';
        saveBtn.textContent = 'Tarjeta Registrada';
        saveBtn.disabled = true;
        accountInput.disabled = true;
        phoneInput.disabled = true;
    } else {
        msgDiv.textContent = `Confirma tu selecci√≥n y reg√≠strate.`;
        saveBtn.onclick = () => {
            const account = accountInput.value.trim();
            const phone = phoneInput.value.trim();
            
            if (!account) {
                alert('Por favor, ingresa un nombre o cuenta.');
                return;
            }
            
            const newPlayer = registerNewPlayer(account, phone, selectedCards);
            
            if (newPlayer) {
                msgDiv.textContent = `¬°Registro exitoso! Tu tarjeta est√° lista, ${newPlayer.cuenta}.`;
                saveBtn.textContent = 'Tarjeta Registrada';
                saveBtn.disabled = true;
                accountInput.disabled = true;
                phoneInput.disabled = true;
                
                // Limpiar la URL para evitar el modo selecci√≥n despu√©s del registro
                history.pushState({}, document.title, window.location.pathname);
            }
        };
    }
}

function copySelectionLink(playerId) {
    const baseUrl = window.location.href.split('?')[0]; // URL base sin par√°metros
    const link = `${baseUrl}?select=${playerId}`;
    
    navigator.clipboard.writeText(link).then(() => {
        alert('Enlace de selecci√≥n copiado al portapapeles:\n' + link);
    }).catch(err => {
        console.error('Error al copiar: ', err);
        alert('Error al copiar. Copia manualmente: ' + link);
    });
}


// --- Funciones de Exportaci√≥n (PDF) ---

function exportPdfReport() {
    if (typeof jspdf === 'undefined') {
        alert('Error: La librer√≠a jsPDF no carg√≥ correctamente. Revisa la consola para ver el error de seguridad (SRI).');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    let y = 10;
    const margin = 10;
    const lineHeight = 7;
    const pageWidth = 210;
    
    doc.setFont('Helvetica', 'bold');
    doc.setFontSize(16);
    doc.text('Reporte de Loter√≠a GANA YA!', margin, y);
    y += lineHeight;
    
    doc.setFont('Helvetica', 'normal');
    doc.setFontSize(12);
    doc.text(`Fecha del Reporte: ${new Date().toLocaleDateString()}`, margin, y);
    y += lineHeight * 2;
    
    // --- Secci√≥n de Ganancias ---
    doc.setFont('Helvetica', 'bold');
    doc.text('üí∞ Resumen Financiero:', margin, y);
    y += lineHeight;
    
    doc.setFont('Helvetica', 'normal');
    const currentEarnings = calculateEarnings();
    const totalRevenue = purchases.length * prices.cardPrice;
    const totalPrizesPaid = transactions
        .filter(t => t.type === 'prize')
        .reduce((sum, t) => sum + t.amount, 0);

    doc.text(`Ingresos Totales (Tarjetas vendidas): $${totalRevenue}`, margin, y); y += lineHeight;
    doc.text(`Premios Pagados: $${totalPrizesPaid}`, margin, y); y += lineHeight;
    doc.setFont('Helvetica', 'bold');
    doc.setTextColor(currentEarnings >= 0 ? '#0f8a3c' : '#b42222'); // Verde o Rojo
    doc.text(`GANANCIAS NETAS: $${currentEarnings}`, margin, y);
    doc.setTextColor(0, 0, 0); // Reset color
    y += lineHeight * 2;

    // --- Secci√≥n de Jugadores ---
    doc.setFont('Helvetica', 'bold');
    doc.text(`üë• Jugadores Registrados (${purchases.length}):`, margin, y);
    y += lineHeight;

    const tableHeaders = ["Cuenta", "Celular", "Estado", "Premio Pagado"];
    const tableData = purchases.map(player => {
        const win = checkWin(player, gameState.passed);
        const prizeTx = transactions.find(t => t.playerId === player.id && t.type === 'prize');
        
        return [
            player.cuenta,
            player.celular || 'N/A',
            win.win ? `${win.type} (${player.paid ? 'PAGADO' : 'PENDIENTE'})` : (player.paid ? 'PAGADO' : 'ACTIVO'),
            prizeTx ? `$${prizeTx.amount} (${prizeTx.prizeType})` : '$0'
        ];
    });

    // A√±adir tabla (usa autoTable si la librer√≠a est√° disponible o dibuja manual)
    // Para simplificar, asumiremos que se usa una implementaci√≥n simple o se espera autoTable (si el usuario la incluye)
    
    const startY = y;
    const colWidths = [40, 40, 60, 40]; // Ancho de las columnas en mm
    
    // Dibujar encabezados
    doc.setFont('Helvetica', 'bold');
    doc.setFillColor(200, 200, 200);
    doc.rect(margin, y, colWidths.reduce((a, b) => a + b), lineHeight, 'F');
    let currentX = margin;
    tableHeaders.forEach((header, i) => {
        doc.text(header, currentX + 2, y + lineHeight - 2);
        currentX += colWidths[i];
    });
    y += lineHeight;

    // Dibujar filas de datos
    doc.setFont('Helvetica', 'normal');
    tableData.forEach(row => {
        if (y > 280) { // Si llega al final de la p√°gina, a√±ade una nueva
            doc.addPage();
            y = 10;
        }
        currentX = margin;
        row.forEach((cell, i) => {
            doc.rect(currentX, y, colWidths[i], lineHeight);
            doc.text(cell, currentX + 2, y + lineHeight - 2);
            currentX += colWidths[i];
        });
        y += lineHeight;
    });

    doc.save('reporte_loteria.pdf');
}

// --- Listeners de Eventos ---

// Bot√≥n de Sacar Carta
document.getElementById('draw-btn').addEventListener('click', drawCard);

// Bot√≥n de Reiniciar
document.getElementById('shuffle-btn').addEventListener('click', resetGame);

// Bot√≥n de Cerrar Modal
document.getElementById('close-modal-btn').addEventListener('click', closeModal);

// Botones de Pesta√±as de Admin
document.getElementById('admin-tabs').addEventListener('click', (e) => {
    if (e.target.classList.contains('tab-btn')) {
        const tab = e.target.getAttribute('data-tab');
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
        document.getElementById(`tab-content-${tab}`).classList.remove('hidden');
    }
});

// Bot√≥n de Guardar Precios
document.getElementById('save-prices-btn').addEventListener('click', () => {
    const newPrices = { ...prices };
    newPrices.cardPrice = parseInt(document.getElementById('cardPrice').value) || 0;
    newPrices.loteriaPrize = parseInt(document.getElementById('loteriaPrize').value) || 0;
    newPrices.tablitaPrize = parseInt(document.getElementById('tablitaPrize').value) || 0;
    newPrices.cuatroEsquinasPrize = parseInt(document.getElementById('cuatroEsquinasPrize').value) || 0;
    
    prices = newPrices;
    savePrices(prices);
    renderAll();
    alert('Precios guardados.');
});

// Bot√≥n de Restablecer Precios
document.getElementById('reset-prices').addEventListener('click', () => {
    if (!confirm('Reestablecer precios por defecto?')) return;
    prices = defaultPrices();
    savePrices(prices);
    renderAll();
    alert('Precios restablecidos.');
});

// Bot√≥n de Exportar
document.getElementById('export-btn').addEventListener('click', exportPdfReport);

// Bot√≥n de Limpiar Registros
document.getElementById('clear-btn').addEventListener('click', clearRecordsForNewDay);

// Bot√≥n de Toggle Admin
document.getElementById('toggle-admin').addEventListener('click', () => {
    const v = document.getElementById('view-admin');
    v.classList.toggle('hidden');
});

// Bot√≥n de Nuevo Jugador
document.getElementById('new-player-btn').addEventListener('click', () => {
    const account = prompt('Ingrese Cuenta/Nombre del Jugador:');
    if (!account) return;
    
    const phone = prompt('Ingrese Celular (opcional):') || '';
    
    // Generaci√≥n de cartas aleatoria por defecto
    const newCardIds = generatePlayerCard([]);
    
    const newPlayer = registerNewPlayer(account, phone, newCardIds);
    if (newPlayer) {
        alert(`Jugador ${newPlayer.cuenta} registrado con √©xito.`);
    }
});

// Control de AutoPlay
document.getElementById('autoplay-toggle').addEventListener('change', (e) => {
    isAuto = e.target.checked;
    const interval = parseInt(document.getElementById('autoplay-interval').value) * 1000;
    
    if (isAuto) {
        // Ejecutar la primera carta de inmediato y luego cada 'interval'
        if (!gameState.lastPassed) drawCard();
        
        autoIntervalId = setInterval(() => {
            if (gameState.deck.length === 0) {
                clearInterval(autoIntervalId);
                isAuto = false;
                e.target.checked = false;
                alert('¬°Se han sacado todas las cartas! Auto Play detenido.');
            } else {
                drawCard();
            }
        }, interval);
    } else {
        clearInterval(autoIntervalId);
    }
});

document.getElementById('autoplay-interval').addEventListener('change', (e) => {
    if (isAuto) {
        // Si est√° en auto, reinicia el intervalo con el nuevo tiempo
        clearInterval(autoIntervalId);
        const interval = parseInt(e.target.value) * 1000;
        autoIntervalId = setInterval(drawCard, interval);
    }
});


/* Keyboard: space draws only if admin panel is NOT hidden (Admin mode) */
document.addEventListener('keydown', (e) => {
    if (e.code === 'Space') {
        e.preventDefault();
        // Solo dibuja si NO es modo Auto y NO hay animaci√≥n, O si el admin est√° visible.
        // Se permite sacar carta en modo "administrador" (aunque el toggle est√© oculto, si lo mostramos con el bot√≥n).
        if (isAuto || shuffleAnimating) return;
        
        const isAdminVisible = !document.getElementById('view-admin').classList.contains('hidden');
        
        if (isAdminVisible) {
            drawCard();
        }
    }
});

/* storage sync */
window.addEventListener('storage', (e) => {
    if (e.key === KEY_PRICES) prices = loadPrices();
    if (e.key === KEY_GAME) gameState = loadGame();
    if (e.key === KEY_PUR) purchases = loadPurchases();
    if (e.key === KEY_TX) transactions = loadTransactions();
    renderAll();
});

/* handle selection link on load (if present) */
(function init(){
  prices = loadPrices(); gameState = loadGame(); purchases = loadPurchases(); transactions = loadTransactions();
  // If page opened for selection token, handle it and exit (that function replaces body)
  handleSelectionLinkOnLoad();
  renderAll();
})();

</script>
</body>
</html>
