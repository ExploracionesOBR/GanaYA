<!doctype html><html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üé¥ GANA YA! - Loter√≠a Interactiva Mexicana (v9.9)</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%23ff6bcb'/%3E%3Ctext x='50%25' y='55%25' font-size='18' font-family='Arial' fill='white' text-anchor='middle' font-weight='700'%3EG%3C/text%3E%3C/svg%3E">
<style>
/* VARIABLES DE COLOR */
:root{ 
    --rojo:#b42222; 
    --verde:#0f8a3c; 
    --azul:#1565d8; 
    --naranja:#f77f00; 
    --crema:#fff8ec; 
    --sombra:0 10px 28px rgba(0,0,0,0.12); 
    --accent1:#ffd60a; 
    --accent2:#ff6bcb; 
}

/* GENERALES */
*{box-sizing:border-box} 
html,body{height:100%}
body{ 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
  margin:0; 
  padding:0; 
  background:var(--crema); 
  color:#222;
  background-image: radial-gradient(#ffd60a 1px, transparent 1px), radial-gradient(#e63946 1px, transparent 1px);
  background-position: 0 0, 25px 25px; 
  background-size: 50px 50px;
  overflow-x: hidden; 
}

/* CONTENEDOR PRINCIPAL - MARGEN REDUCIDO */
.container{ 
  max-width:1200px; 
  margin:4px auto; /* Reducido a 4px */
  padding:0 4px; /* Reducido a 4px */
  position: relative; 
}

/* ENCABEZADO */
.main-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    height: 96px; 
    margin-bottom: 4px; /* Reducido */
    padding: 0; 
    position: relative;
}

.logo-box-wrapper{
  flex-shrink: 0;
  width: 96px; 
  height: 96px;
  position: relative;
  z-index: 10;
  padding-left: 4px; /* Reducido */
}

.logo-box img{ 
  width:96px; 
  height:96px;
  object-fit:contain; 
  border-radius:12px; 
  box-shadow:0 8px 20px rgba(0,0,0,0.12); 
}

/* T√çTULO - CENTRADO SOBRE LA COLUMNA CENTRAL (players-section) */
.title-container {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: absolute; /* Permite posicionamiento m√°s fino */
    left: 50%;
    transform: translateX(-50%);
    width: 450px; /* Ancho estimado de la columna central */
    pointer-events: none; 
    z-index: 5;
    padding-top: 10px; 
}

.title { 
  font-size:50px; 
  font-weight:900; 
  color:var(--rojo); 
  margin:0; 
  animation: fiesta 3.2s linear infinite; 
  white-space: nowrap;
  width: 100%;
  text-align: center;
}

.subtitle { 
  color:#0b7a3b; 
  font-size:14px;
  margin-top:4px; 
  text-align:center; 
}

@keyframes fiesta { 
  0%{ color:#e63946 }
  15%{ color:var(--accent1) }
  30%{ color:#2a9d8f }
  45%{ color:#6d9df5 }
  60%{ color:var(--accent2) }
  75%{ color:#ff9e00 }
  100%{ color:#e63946 } 
}


/* MAIN GRID: 3 Columnas */
.main-grid{ 
  display:grid;
  grid-template-columns: 280px 1fr 400px; 
  gap:8px; 
  align-items:start; 
  margin-top:4px; /* Reducido */
  padding: 0 4px; /* Reducido */
}
@media(max-width:1200px){ 
  .main-grid{ grid-template-columns:1fr; } 
  .title-container { position: relative; width: 100%; left: auto; transform: none; }
}

.mex-frame{ 
  background:#fff; 
  border-radius:12px; 
  padding:10px; 
  border:4px solid var(--rojo); 
  box-shadow:var(--sombra); 
}
.mex-frame-small{ 
  background:#fff;
  border-radius:10px; 
  padding:10px; 
  border:3px solid var(--rojo); 
  box-shadow:0 6px 14px rgba(0,0,0,.06); 
}

/* CONTROLES */
#control-partida { text-align: center; }
#control-partida h3 { margin:0; }

#control-partida select {
    display: block !important;
    margin: 0 auto !important;
    width: 100%; 
    text-align: center; 
    text-align-last: center;
}

/* CONTROLES DE BOLSA/ADMIN (MOVIDOS DENTRO DE LA COLUMNA DE CONTROL) */
.controls-panel {
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.header-controls-wrapper {
  display: flex;
  align-items: center; 
  justify-content: space-between; 
  padding: 8px 10px; 
  margin: 0;
  border-radius: 12px;
  background: white;
  border: 3px solid #ccc;
  box-shadow: var(--sombra); 
}

.header-controls{ 
  display:flex;
  gap:8px; 
  align-items:center; 
  flex-shrink: 0; 
} 

.bolsa-compact{ 
  display:flex; 
  align-items:center; 
  gap:10px; 
  padding:6px 10px; /* Reducido */
  border-radius:8px; /* Reducido */
  background:linear-gradient(90deg,#e6fff1,#fff7e6);
  border:2px solid #c9a700; 
  box-shadow:0 4px 10px rgba(0,0,0,0.06); 
}
.bolsa-compact .label{ 
  font-weight:900; 
  color:#2d6b25; 
  font-size:13px; /* Reducido */
}
.bolsa-compact .amount{ 
  font-weight:900; 
  color:#b45309; 
  font-size:16px; /* Reducido */
}

/* ... (rest of styles remain largely the same, except for the player card winning effect) ... */

/* MINIATURA DE CARTA */
.card-thumb{ 
  width:74px; 
  height:106px; 
  border-radius:8px; 
  background-size:cover; 
  background-position:center; 
  position:relative; 
  transition:transform .28s ease, opacity .28s ease, box-shadow .28s ease; /* Transici√≥n para box-shadow */
}
  /* Estilo para la carta ganadora en el tablero del jugador */
  .card-thumb.winner-highlight {
      box-shadow: 0 0 0 4px var(--accent1), 0 0 20px rgba(255,200,80,0.8);
      transform: scale(1.1); /* Peque√±o zoom */
      transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
      background-image: radial-gradient(circle at center, #fff, var(--accent1), #fff), var(--original-bg-image);
      animation: mexicanGlow 1.2s infinite alternate; 
  }
  
  @keyframes mexicanGlow {
      0% { box-shadow: 0 0 0 4px var(--accent1), 0 0 10px rgba(255,100,0,0.5); }
      100% { box-shadow: 0 0 0 4px var(--rojo), 0 0 25px rgba(255,255,0,0.8); }
  }

/* APLICAR BLANCO Y NEGRO/DIMMING A CARTAS YA PASADAS */
.card-thumb.passed{ filter:grayscale(1) brightness(0.6); }

/* ... (el resto de los estilos) ... */


/* MODAL CARTA GANADORA (WINNER FOCUS) */
#modal-winner-focus{ 
  position:fixed; 
  inset:0; 
  background:rgba(0,0,0,0.85); 
  display:none; 
  align-items:center; 
  justify-content:center; 
  z-index:9990; /* Debajo de confetti */
}

.focus-card-container{
  text-align: center;
  position: relative;
  animation: cardFlyIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.27);
  padding: 20px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 20px;
}

.focus-card {
  width: 320px; 
  height: 460px; 
  border-radius: 16px; 
  background-size: cover; 
  background-position: center;
  box-shadow: 0 25px 50px rgba(0,0,0,0.5), 0 0 0 8px var(--accent1), 0 0 0 16px var(--rojo);
  position: relative;
  z-index: 9995;
  border: 1px solid #fff;
  animation: winningCardPulse 1.5s infinite alternate;
}

.focus-card-info{
    color: white;
    font-size: 24px;
    font-weight: 900;
    margin-top: 15px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
}

@keyframes cardFlyIn {
    0% { transform: scale(0.5) translateY(200px); opacity: 0; }
    100% { transform: scale(1) translateY(0); opacity: 1; }
}

@keyframes winningCardPulse {
    0% { box-shadow: 0 25px 50px rgba(0,0,0,0.5), 0 0 0 8px var(--accent1), 0 0 0 16px var(--rojo); }
    100% { box-shadow: 0 25px 50px rgba(0,0,0,0.7), 0 0 0 10px var(--rojo), 0 0 0 20px var(--accent1); }
}

</style>
</head>
<body>

<div class="container">

  <header class="main-header">
      
      <div class="logo-box-wrapper">
          <div class="logo-box"><img id="logo-img" src="logo_1_entrada.png" alt="logo"></div>
      </div>

      <div class="title-container">
          <div class="title">üéâ GANA YA!</div>
          <div class="subtitle">Gana Ya! es una p√°gina de car√°cter interactivo y de entretenimiento.</div>
      </div>
      
      <div style="width: 400px; flex-shrink: 0; padding-right: 4px;">&nbsp;</div>
  </header>
  
  <div class="main-grid" id="main-grid">

    <aside class="mex-frame-small winners" id="winners-panel" aria-label="√öltimos Ganadores">
      <h3 style="margin:0 0 8px 0; text-align:center">√öLTIMOS GANADORES</h3>
      <div class="winners-list" id="winners-list" style="margin-top:4px"><div class="small-muted" style="text-align:center">A√∫n no hay ganadores.</div></div>
    </aside>

    <section class="mex-frame" id="players-section" style="min-height:420px;">
      <h2 style="text-align:center;margin:0 0 8px 0">CARTAS DE JUGADORES ACTIVOS</h2>
   
      <div class="players-grid" id="players-area" style="margin-top:8px">
        <div class="small-muted" style="padding:18px; text-align:center">A√∫n no hay jugadores.</div>
      </div>
    </section>

    <aside class="controls-panel" id="controls-panel">
      
      <div class="header-controls-wrapper">
          <div class="bolsa-compact">
              <div id="bolsa-label">üí∞ Bolsa</div>

              <div class="amount" id="bolsa-amount">$0.00</div>
          </div>
          <div class="header-controls">
              <button id="btn-view-play" class="toggle-btn toggle-play">EN JUEGO</button>
              <button id="btn-view-admin" class="toggle-btn toggle-admin">‚öôÔ∏è</button>
          </div>
      </div>

      <div class="mex-frame-small" aria-label="Control de partida" id="control-partida" style="margin-top:0px"> 
 
        <h3>CONTROL DE PARTIDA</h3>
        <div class="small-muted" style="margin-top:4px">Barajea, tira cartas o activa autom√°tico ‚Äî selecciona modalidad</div>

        <div style="margin-top:8px; text-align:center;">
          <select id="select-modality" style="padding:10px;border-radius:8px;border:1px solid #ddd;font-weight:800;">
            <option value="4">4 cartas</option>
            <option value="6">6 cartas</option>
          </select>
        </div>

        <div class="controls" style="margin-top:8px">
          <div id="game-controls">
            <button id="btn-shuffle" class="btn btn-blue">BARAJEAR</button>
    
            <button id="btn-draw" class="btn btn-red">TIRAR CARTA</button>
            <button id="btn-auto" class="btn btn-green">CARTAS AUTOM√ÅTICO</button>
          </div>
          <button id="btn-reset" class="btn btn-red hidden" style="width:100%;
          padding:12px; font-size:18px;">REINICIAR PARTIDA</button>
        </div>

        <div style="text-align:center;margin-top:6px" class="small-muted">Cartas restantes: <span id="deck-count">54</span></div>
      </div>

      <div class="mex-frame-small" style="margin-top:8px">
        <h3 style="text-align:center;margin:0">CARTA EN JUEGO</h3>
        <div id="current-card" class="current-card" style="margin-top:6px">
          <div class="small-muted">Esperando barajeo...</div>
        </div>
      </div>

      <div class="mex-frame-small" style="margin-top:8px">
       
        <h3 style="text-align:center;margin:0">√öLTIMAS 3 CARTAS</h3>
        <div id="last-cards" class="last-cards" style="margin-top:6px; display:flex; gap:8px;
        justify-content:center;"></div>
      </div>

    </aside>

  </div> 
  
  <section id="view-admin" class="mex-frame hidden" style="margin-top:8px; padding: 10px 8px;">
    
    <div class="admin-row">
      <div class="admin-col mex-frame-small">
        <h3 style="margin:0 0 8px 0">Modalidades - Precio & Ganancia</h3>
        <div class="price-grid" style="margin-top:4px">
          <div class="price-box">
            <div style="font-size:16px">4 Cartas</div>
            <div style="display:flex; gap:6px; margin-top:6px;">
              <input id="price4" class="input" type="number" value="10" min="1">
              <input id="profit4" class="input" type="number" value="2" min="0">
            </div>
            <div class="small-muted" style="margin-top:4px">Precio ‚Ä¢ Ganancia</div>
          </div>
          <div class="price-box">
            <div style="font-size:16px">6 Cartas</div>
            <div style="display:flex; gap:6px; margin-top:6px;">
              <input id="price6" class="input" type="number" value="12" min="1">
              <input id="profit6" class="input" type="number" value="3" min="0">
            </div>
            <div class="small-muted" style="margin-top:4px">Precio ‚Ä¢ Ganancia</div>
          </div>
        </div>
        <div style="display:flex; gap:8px; margin-top:10px;">
          <button id="save-prices" class="btn btn-green">Guardar</button>
          <button id="reset-prices" class="btn btn-muted">Reset</button>
        </div>
      </div>

      <div class="admin-col mex-frame-small">
        <h3 style="margin:0 0 8px 0">Registrar Jugador (Caja)</h3>
        <div style="display:grid; gap:8px; margin-top:4px">
          <input id="input-name" placeholder="Nombre completo" class="input">
          <input id="input-cell" placeholder="Celular (ej. 5512345678)" class="input">
          <input id="input-clabe" placeholder="CLABE / Cuenta" class="input">
          <input id="input-budget" placeholder="Ingresa presupuesto" class="input" type="number" min="0" value="">
          <div style="display:flex; gap:4px;">
            <div style="flex:1">
              <label class="small-muted">Partidas 4C (Cantidad)</label>
              <input id="qty4" type="number" min="0" value="0" class="input">
            </div>
            <div style="flex:1">
              <label class="small-muted">Partidas 6C (Cantidad)</label>
              <input id="qty6" type="number" min="0" value="0" class="input">
            </div>
          </div>
          <div style="display:flex; gap:8px;">
            <button id="btn-register" class="btn btn-green">Registrar</button>
          </div>
          <div id="calc-info" class="small-muted"></div>
        </div>
      </div>
    </div>

    <div style="margin-top:8px" class="mex-frame-small">
      <div style="display:flex; flex-wrap: wrap; gap: 8px; align-items:center; justify-content:space-between; margin-bottom:8px">
          <div style="font-weight:900">Administraci√≥n de Jugadores / Compras</div>
          <div class="admin-actions-top">
              <button id="btn-export" class="btn btn-blue" title="Generar PDF (Con logo)">üìÑ Generar PDF</button>
              <button id="btn-reset-day" class="btn btn-red" title="Reiniciar D√≠a">üßπ Reiniciar D√≠a</button>
          </div>
      </div>

      <div style="display:flex; gap:8px; align-items:center; justify-content:flex-start;">
          <div style="font-weight:700; font-size:14px;">Filtro:</div>
          <div class="admin-actions">
            <button id="filter-all" class="filter-btn filter-all filter-btn active-all">VER TODO</button>
            <button id="filter-4" class="filter-btn">4 CARTAS</button>
            <button id="filter-6" class="filter-btn">6 CARTAS</button>
          </div>
      </div>
      
      <div class="table-wrap" style="margin-top:6px">
        <table style="width:100%; border-collapse:collapse;">
          <thead style="background:#f8f8ff; position:sticky; top:0">
            <tr>
              <th style="text-align:left;padding:6px">ID</th>
              <th style="text-align:left;padding:6px">Jugador</th>
              <th style="padding:6px">Modalidad</th>
              <th style="padding:6px">Partidas</th>
              <th style="padding:6px">En Juego</th>
              <th style="padding:6px">Casa</th>
              <th style="padding:6px">Estado</th>
              <th style="padding:6px">Acciones</th>
            </tr>
          </thead>
          <tbody id="players-table">
            <tr>
              <td colspan="8" style="text-align:center;padding:18px;color:#888">No hay operaciones.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
  
  <footer style="text-align:center; margin-top:8px; padding-bottom:8px;" class="small-muted">Coloca <strong>logo_1_entrada.png</strong>, <strong>APLAUSOS_GANADOR.mp3</strong> en la ra√≠z y la carpeta <strong>Cartas_baraja_loteria/</strong> con las 54 im√°genes.</footer>
</div>

<div id="modal-player" class="hidden"><div class="modal-back" id="modal-player-back"><div class="modal"><button id="modal-close-x" style="position:absolute;right:10px;top:8px;border:none;background:transparent;font-size:18px;cursor:pointer">‚úñ</button><h3 id="modal-player-name">Jugador</h3><div id="modal-body"></div><div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px"><button id="modal-close" class="btn btn-muted">Cerrar</button></div></div></div></div>
<div id="modal-winner" class="hidden"><div class="modal-back" id="modal-winner-back"><div class="modal" style="text-align:center"><button id="winner-close" style="position:absolute; right:10px; top:8px; border:none; background:transparent; font-size:20px; cursor:pointer;">‚ùå</button><div style="font-size:28px; font-weight:900; color:var(--rojo); margin-bottom:6px" id="winner-title">üéâ ¬°FELICIDADES!</div><div id="winner-body" style="font-size:18px; font-weight:700; margin-bottom:10px;"></div><div style="margin-bottom:6px" id="winner-sub"></div><div style="display:flex; gap:8px; justify:center;"><button id="winner-ok" class="btn btn-blue">Ver Carta Ganadora</button></div></div></div></div>
<div id="modal-winner-detail" class="hidden"><div class="modal-back" id="modal-winner-detail-back"><div class="modal"><button id="winner-detail-close-x" style="position:absolute;right:10px;top:8px;border:none;background:transparent;font-size:24px;cursor:pointer">‚ùå</button><h2 style="margin:0 0 10px 0; color:var(--verde)">¬°LOTER√çA GANADA!</h2><h3 style="margin:0 0 10px 0; font-weight:900" id="winner-detail-player-name"></h3><div style="font-weight:700; color:var(--rojo);" id="winner-detail-card-name"></div><div id="winner-detail-player-cards"></div><div style="margin-top:20px"><button id="winner-detail-ok" class="btn btn-blue" style="width:200px">Cerrar Detalle</button></div></div></div></div>
<div id="modal-winner-focus" class="hidden">
    <div class="modal-back" id="modal-winner-focus-back">
        <div class="focus-card-container">
            <div id="focus-card-display" class="focus-card"></div>
            <div id="focus-card-info" class="focus-card-info"></div>
            <button id="focus-card-close" class="btn btn-red" style="margin-top:20px; font-size:16px;">Cerrar (ESC)</button>
        </div>
    </div>
</div>

<div id="shuffle-overlay" class="shuffle-overlay"></div>
<canvas id="confetti-canvas"></canvas>

<script>
/* index_v9.9_final - code block */
const CARD_IMAGE_BASE_PATH='Cartas_baraja_loteria/';
const CARD_NAME_MAP = {1:"1 el gallo-min.jpg",2:"2 el diablito-min.jpg",3:"3 la dama-min.jpg",4:"4 el catrin-min.jpg",5:"5 el paraguas-min.jpg",6:"6 la sirena-min.jpg",7:"7 la escalera-min.jpg",8:"8 la botella-min.jpg",9:"9 el barril-min.jpg",10:"10 arbol-min.jpg",11:"11 melon-min.jpg",12:"12 el valiente-min.jpg",13:"13 el gorrito-min.jpg",14:"14 la muerte-min.jpg",15:"15 la pera-min.jpg",16:"16 la bandera-min.jpg",17:"17 el bandolon-min.jpg",18:"18 el violoncello-min.jpg",19:"19 la garza-min.jpg",20:"20 el pajaro-min.jpg",21:"21 la mano-min.jpg",22:"22 la bota-min.jpg",23:"23 la luna-min.jpg",24:"24 el cotorro-min.jpg",25:"25 el borracho-min.jpg",26:"26 el negrito-min.jpg",27:"27 el corazon-min.jpg",28:"28 la sandia-min.jpg",29:"29 el tambor-min.jpg",30:"30 el camaron-min.jpg",31:"31 las jaras-min.jpg",32:"32 el musico-min.jpg",33:"33 la ara√±a-min.jpg",34:"34 el soldado-min.jpg",35:"35 la estrella-min.jpg",36:"36 el cazo-min.jpg",37:"37 el mundo-min.min.jpg",38:"38 el apache-min.jpg",39:"39 el nopal-min.jpg",40:"40 el alacran-min.jpg",41:"41 la rosa-min.jpg",42:"42 la calavera-min.jpg",43:"43 la campana-min.jpg",44:"44 el cantarito-min.jpg",45:"45 el venado-min.jpg",46:"46 el sol-min.jpg",47:"47 la corona-min.jpg",48:"48 la chalupa-min.jpg",50:"50 el pescado-min.jpg",51:"51 la palma-min.jpg",52:"52 la maceta-min.jpg",53:"53 el arpa-min.jpg",54:"54 la rana-min.jpg",49:"49 el pino-min.jpg"};
const cardImageUrl = id => CARD_IMAGE_BASE_PATH + (CARD_NAME_MAP[id] ? CARD_NAME_MAP[id] : `${id}.jpg`);

const Kp='ganya_v90_prices', Kg='ganya_v90_game', Kpu='ganya_v90_purchases', Ktx='ganya_v90_tx', Kw='ganya_v90_winners', Kdig='ganya_v90_dig', Kmod='ganya_v90_mod';
const Kid='ganya_v90_id_counter'; 
const defaultsPrices=()=>({price4:10,profit4:2,price6:12,profit6:3});
const defaultsGame=()=>({deck:Array.from({length:54},(_,i)=>i+1),drawn:[],current:0,pending:[]});

let prices = load(Kp) || defaultsPrices();
let game = load(Kg) || defaultsGame();
let purchases = load(Kpu) || [];
let tx = load(Ktx) || [];
let winners = load(Kw) || [];
let drawnInGame = load(Kdig) || [];
let currentMode = Number(localStorage.getItem(Kmod) || 4);
if(currentMode===8) currentMode=4; 
let currentIdCounter = Number(localStorage.getItem(Kid) || 233); 

let isAuto=false, autoInterval=null, animShuffling=false;
let audioCtx=null;
try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch(e){ audioCtx=null; }

function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function load(k){ try{ const v=localStorage.getItem(k); return v? JSON.parse(v): null;}catch(e){return null;} }
function saveAll(){ save(Kp,prices); save(Kg,game); save(Kpu,purchases); save(Ktx,tx); save(Kw,winners); save(Kdig,drawnInGame); localStorage.setItem(Kmod,String(currentMode)); localStorage.setItem(Kid,String(currentIdCounter)); }

function getNextPurchaseId() {
    currentIdCounter += 1;
    localStorage.setItem(Kid, String(currentIdCounter));
    return `GanaYA!-` + String(currentIdCounter).padStart(4, '0');
}

function uuid(){ return 'id-'+Math.random().toString(36).slice(2,10); } 
function shuffle(a){ const arr=a.slice();
for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }
function formatMoney(n){ return '$'+Number(n||0).toFixed(2); }
function cardName(id){ 
    let baseName = CARD_NAME_MAP[id] ? CARD_NAME_MAP[id].replace(/^\d+\s*/,'').replace(/-min\.jpg$/,'').replace(/\.min\.jpg$/,'') : ('Carta '+id);
    return baseName.replace(/_/g, ' ').replace(/\.jpg/i, '').trim(); 
}

function playShuffleSound(){ if(!audioCtx) return; const now=audioCtx.currentTime; const buf=audioCtx.createBuffer(1,audioCtx.sampleRate*0.22,audioCtx.sampleRate); const d=buf.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*(1-i/d.length); const s=audioCtx.createBufferSource(); s.buffer=buf;
const g=audioCtx.createGain();g.gain.setValueAtTime(0.04,now);s.connect(g);g.connect(audioCtx.destination);s.start(0); }

function playWinSound(){ 
    if(!audioCtx) return; 
    const now=audioCtx.currentTime; 
    const osc=audioCtx.createOscillator(); 
    osc.type='triangle'; 
    const gain=audioCtx.createGain(); 
    gain.gain.setValueAtTime(0.0,now); 
    gain.gain.linearRampToValueAtTime(0.3,now+0.05); 
    gain.gain.exponentialRampToValueAtTime(0.0001,now+1.2); 
    osc.connect(gain); 
    gain.connect(audioCtx.destination); 
    osc.frequency.setValueAtTime(500,now); 
    osc.frequency.exponentialRampToValueAtTime(800,now+0.3); 
    osc.frequency.exponentialRampToValueAtTime(1000,now+0.8); 
    osc.start(now); 
    osc.stop(now+1.2); 
}

function playWinSoundApplause(){
    if(!audioCtx) return;
    const audio = new Audio('APLAUSOS_GANADOR.mp3'); 
    audio.volume = 0.6; // Ajustar volumen si es necesario
    audio.play().catch(e => console.log('Error al reproducir audio:', e));
}


let confettiInstance = null;
function startConfettiFullScreen(){
    const canvas=document.getElementById('confetti-canvas');
    if(!canvas) return;
    canvas.style.display='block';
    if(confettiInstance){ confettiInstance.clear(); }
    confettiInstance=confetti.create(canvas,{ resize:true, useWorker:true });
    const defaults = { origin: { y: 0.7 }, zIndex: 3000 };
    confettiInstance({ ...defaults, particleCount: 50, spread: 150, startVelocity: 40, scalar: 0.8 });
    confettiInstance({ ...defaults, particleCount: 40, spread: 90, startVelocity: 60, scalar: 1.0 });
}

function stopConfettiFullScreen(){
    const canvas=document.getElementById('confetti-canvas');
    if(canvas) canvas.style.display='none';
    if(confettiInstance){ confettiInstance.clear(); confettiInstance=null; }
}

function stopAuto(){
    if(autoInterval){ clearInterval(autoInterval); autoInterval=null; }
    isAuto=false;
    const btn=document.getElementById('btn-auto');
    if(btn){ btn.textContent='CARTAS AUTOM√ÅTICO'; btn.classList.remove('btn-muted'); btn.classList.add('btn-green'); }
    disableControls(false); 
}
function startAuto(){
    if(animShuffling || game.winnerPending) return;
    isAuto=true;
    const btn=document.getElementById('btn-auto');
    if(btn){ btn.textContent='AUTOM√ÅTICO ACTIVO'; btn.classList.remove('btn-green'); btn.classList.add('btn-muted'); }
    autoInterval=setInterval(drawOne, 2500);
    disableControls(true);
    document.getElementById('btn-auto').disabled = false;
}

function disableControls(disable){
    document.getElementById('btn-shuffle').disabled = disable;
    document.getElementById('btn-draw').disabled = disable;
    document.getElementById('select-modality').disabled = disable;
    document.getElementById('btn-reset').disabled = disable;
    if(disable){ document.getElementById('btn-auto').disabled = true; }
}

function renderPlayerCard(p){
    let html=`<div class="player-card" tabindex="0" data-player-id="${p.id}">`;
    html+=`<div class="player-name">${escapeHtml(p.playerName)}</div>`;
    html+=`<div class="small-muted">${p.modality} cartas - ${p.gamesLeft||0} restantes</div>`;
    html+=`<div class="player-cards" style="display:grid;grid-template-columns:repeat(${p.modality===4?2:3},1fr);gap:8px;justify-items:center;">`;
    (p.card||[]).forEach(cid=>{
        const isMarked = (p.markedCards||[]).includes(cid);
        const passed = drawnInGame.includes(cid) && !isMarked; 
        
        // Determinar si esta carta es la ganadora para aplicar el efecto de zoom/luz
        const isWinnerCard = (window._tempWinnerRecs && window._tempWinnerRecs.some(rec => rec.purchaseId === p.id && rec.cardId === cid));
        const winnerClass = isWinnerCard ? 'winner-highlight' : '';

        const sticker = isMarked? `<div class="sticker"><img src="logo_1_entrada.png" alt="lg"/></div>` : '';
        html+=`<div class="card-thumb ${passed?'passed':''} ${winnerClass}" style="background-image:url('${cardImageUrl(cid)}')">${sticker}</div>`;
    });
    html+='</div></div>';
    return html;
}

function renderAll(){
    const isAdminView = !document.getElementById('view-admin').classList.contains('hidden');
    const mainGridEl = document.getElementById('main-grid');
    
    if (isAdminView) {
        if (mainGridEl) mainGridEl.style.display = 'none';
        document.getElementById('btn-view-admin').classList.add('toggle-play');
        document.getElementById('btn-view-admin').classList.remove('toggle-admin');
        document.getElementById('btn-view-play').classList.remove('toggle-play');
        document.getElementById('btn-view-play').classList.add('toggle-admin');
    } else {
        if (mainGridEl) mainGridEl.style.display = 'grid';
        document.getElementById('btn-view-play').classList.add('toggle-play');
        document.getElementById('btn-view-play').classList.remove('toggle-admin');
        document.getElementById('btn-view-admin').classList.remove('toggle-play');
        document.getElementById('btn-view-admin').classList.add('toggle-admin');
    }

    let potAmount = 0;
    let potLabelText = 'üí∞ Bolsa';
    purchases.forEach(p => initializePurchaseData(p));
    
    if (isAdminView) {
        const totalHouseProfit = purchases.reduce((s, p) => s + (p.casa || 0), 0);
        potAmount = totalHouseProfit;
        potLabelText = 'üí∞ Casa';
    } else {
        const activeForPot = purchases.filter(p=> (p.state==='JUGANDO' || p.state==='POR PAGAR') && (p.gamesLeft||0)>0 && p.modality === currentMode );
        const totalEnJuego = activeForPot.reduce((s,p)=> s + (p.enJuego||0),0);
        potAmount = totalEnJuego;
        potLabelText = 'üí∞ Bolsa';
    }

    animateBolsa(potAmount);
    const bolsaLabelEl = document.getElementById('bolsa-label');
    if(bolsaLabelEl) bolsaLabelEl.textContent = potLabelText;
    
    const deckCount=document.getElementById('deck-count');
    if(deckCount) deckCount.textContent=game.deck.length;
    
    const area=document.getElementById('players-area');
    const active = purchases.filter(p=> (p.gamesLeft||0)>0 && (p.state==='JUGANDO' || p.state==='POR PAGAR') && p.modality===currentMode);
    const maxPlayersInRow = 5; 
    let numActive = active.length;
    let numSimulated = 0;
    
    if(numActive < maxPlayersInRow) { 
        numSimulated = maxPlayersInRow - numActive; 
    }
    
    let finalHtml = active.map(p=> renderPlayerCard(p)).join('');

    if(numSimulated > 0) {
        const gridCols = currentMode === 4 ? 2 : 3;
        const numPattern = currentMode;
        let emptyHtml = '';
        for(let i=0; i<numSimulated; i++) {
            let cardSlotsHtml = '';
            for(let j=0; j<numPattern; j++) {
                cardSlotsHtml += `<div class="card-thumb back-pattern"></div>`;
            }
            emptyHtml += `<div class="player-card simulated"> 
                <div class="player-name small-muted">&nbsp;</div> 
                <div class="player-cards" style="display:grid;grid-template-columns:repeat(${gridCols},1fr);gap:8px;justify-items:center;margin-top:10px;"> 
                    ${cardSlotsHtml} 
                </div> 
            </div>`;
        }
        finalHtml += emptyHtml;
    } 
    
    if (area) area.innerHTML = finalHtml || '<div class="small-muted" style="padding:18px; text-align:center">A√∫n no hay jugadores.</div>';
    
    const cur=document.getElementById('current-card');
    if(game.current && cur) cur.innerHTML=`<div style="width:160px;height:220px;background-image:url('${cardImageUrl(game.current)}');background-size:contain;background-repeat:no-repeat;background-position:center;"></div>`; 
    else if(cur) cur.innerHTML='<div class="small-muted">Esperando barajeo...</div>';
    
    const last=(game.drawn||[]).slice(-3).reverse(); 
    const lastEl=document.getElementById('last-cards'); 
    if(lastEl) lastEl.innerHTML = last.length? 
        last.map(id=> `<div style="width:50px;height:70px;background-image:url('${cardImageUrl(id)}');background-size:cover;border-radius:6px;box-shadow:0 4px 10px rgba(0,0,0,0.1)"></div>`).join('') : '<div class="small-muted">...</div>';

    const currentFilter = document.querySelector('.filter-btn.active-4') ? 4 : (document.querySelector('.filter-btn.active-6') ? 6 : null);
    renderPlayersTable(currentFilter);
    renderWinnersList();
    updateCalculatorInfo();
}


function renderWinnersList(){
    const listEl=document.getElementById('winners-list');
    const sortedWinners = winners.slice().sort((a,b)=> b.ts-a.ts).slice(0,5);
    if(!listEl) return;
    if(!sortedWinners.length){ listEl.innerHTML='<div class="small-muted" style="text-align:center">A√∫n no hay ganadores.</div>'; return; }

    listEl.innerHTML=sortedWinners.map(w=>{
        const player=purchases.find(p=>p.id===w.purchaseId);
        if(!player) return ''; 
        const badgeClass = w.paid ? 'badge-pagado' : 'badge-porpagar';
        const cardNameText = cardName(w.cardId);
        return `<div style="padding:6px 0; border-bottom:1px solid #f0f0f0; display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="showWinnerDetailModal('${w.purchaseId}','${w.cardId}', true)">
            <div style="font-weight:700; font-size:13px; color:#111;">${escapeHtml(player.playerName)}</div>
            <div style="font-size:12px; color:#555; display:flex; gap:6px; align-items:center;">
                <div class="badge ${badgeClass}">${w.paid ? 'PAGADO' : 'PENDIENTE'}</div>
                <div style="font-size:11px;">(${cardNameText})</div>
            </div>
        </div>`;
    }).join('');
}


// ... (otras funciones como renderPlayersTable, openPurchaseDetail, etc., se mantienen igual o con cambios menores) ...

function processCard(cardId){
    const winnersFound=[];
    purchases.forEach((p,i)=>{
        if(!(p.gamesLeft>0 && p.state==='JUGANDO' && p.modality===currentMode)) return;
        
        if(p.card && p.card.includes(cardId) && !(p.markedCards||[]).includes(cardId)){
            p.markedCards = [...(p.markedCards||[]), cardId];
        }

        if((p.markedCards||[]).length === p.modality){
            winnersFound.push({idx:i,purchaseId:p.id});
        }
    });

    if(winnersFound.length){
        stopAuto();
        game.winnerPending = true;
        disableControls(true);
        
        const winningModality = purchases.find(p => p.id === winnersFound[0].purchaseId)?.modality || currentMode;
        
        const activeForPot = purchases.filter(p=> p.state==='JUGANDO' && (p.gamesLeft||0)>0 && p.modality === winningModality );
        activeForPot.forEach(p => initializePurchaseData(p));
        const totalEnJuego = activeForPot.reduce((s,p)=> s + (p.enJuego||0),0);
        
        const share = totalEnJuego / winnersFound.length;

        const recs=[];

        winnersFound.forEach(w=>{
            const p=purchases[w.idx];
            p.wins=(p.wins||0)+1;
            p.state='POR PAGAR';
            p.prize=share;
            p.casa = (p.casa || 0) - share; 
            
            const rec = {
                id: uuid(),
                purchaseId: p.id,
                playerName: p.playerName,
                modality: p.modality,
                cardId: cardId, 
                prize: share,
                paid: false,
                ts: Date.now()
            };
            winners.push(rec);
            recs.push(rec);
            tx.push({id:uuid(),type:'win',player:p.playerName,modality:p.modality,amount:share,card:cardId,purchaseId:p.id,ts:Date.now()});
        });

        saveAll();
        window._tempWinnerRecs = recs; 

        const modal = document.getElementById('modal-winner');
        document.getElementById('winner-title').textContent = `üéâ ¬°LOTER√çA!`;
        const winnerNames = winnersFound.map(w=> purchases[w.idx].playerName).join(' y ');
        document.getElementById('winner-body').innerHTML = `¬°El jugador <strong>${escapeHtml(winnerNames)}</strong> ha ganado con la carta <strong>${cardName(cardId)}</strong>!`;
        document.getElementById('winner-sub').innerHTML = `Premio de ${formatMoney(share)} para cada uno.`;
        modal.classList.remove('hidden');
        modal.style.display='flex';
        
        playWinSound(); // Sonido simple de win
        playWinSoundApplause(); // Aplausos
        startConfettiFullScreen();

        renderAll();
    }
}


function showWinnerFocusModal(cardId){
    if(!cardId) {
        if(!window._tempWinnerRecs || window._tempWinnerRecs.length === 0) return;
        cardId = window._tempWinnerRecs[0].cardId;
    }
    
    // Ocultar modal de "Felicidades"
    document.getElementById('modal-winner').classList.add('hidden');
    document.getElementById('modal-winner').style.display='none';
    
    // Mostrar modal de Focus
    const modalFocus = document.getElementById('modal-winner-focus');
    const focusCardDisplay = document.getElementById('focus-card-display');
    const focusCardInfo = document.getElementById('focus-card-info');

    focusCardDisplay.style.backgroundImage = `url('${cardImageUrl(cardId)}')`;
    focusCardInfo.textContent = cardName(cardId).toUpperCase();
    
    modalFocus.classList.remove('hidden');
    modalFocus.style.display = 'flex';
}

function closeWinnerFocusModal(){
    const modalFocus = document.getElementById('modal-winner-focus');
    modalFocus.classList.add('hidden');
    modalFocus.style.display = 'none';
    
    // Detener confetti solo cuando se cierra el foco
    delete window._tempWinnerRecs;
    stopConfettiFullScreen(); 
    game.winnerPending = false;
    disableControls(false); // Habilitar controles
    renderAll();
}

// Se mantiene el detalle, pero ya no es la acci√≥n principal al ganar
window.showWinnerDetailModal = function(purchaseId, cardId, fromWinnerList = false){
    const player = purchases.find(p=>p.id===purchaseId);
    if(!player) return;
    if(!fromWinnerList) {
        document.getElementById('modal-winner').classList.add('hidden');
        document.getElementById('modal-winner').style.display='none';
    }

    const detailPlayerName = document.getElementById('winner-detail-player-name');
    const detailCardName = document.getElementById('winner-detail-card-name');
    const detailCardsContainer = document.getElementById('winner-detail-player-cards');

    detailPlayerName.textContent = escapeHtml(player.playerName) + ' - Modalidad ' + player.modality + ' cartas';
    detailCardName.textContent = 'Carta Ganadora: ' + cardName(cardId);

    const cardListHtml = (player.card || []).map(cid => {
        const isMarked = (player.markedCards || []).includes(cid);
        const isWinner = cid === cardId;
        const passed = drawnInGame.includes(cid) && !isMarked; 
        const sticker = isMarked ? `<div class="sticker"><img src="logo_1_entrada.png" alt="lg"/></div>` : '';
        return `<div class="card-thumb ${isWinner ? 'winner-card' : ''} ${passed ? 'passed' : ''}" style="background-image:url('${cardImageUrl(cid)}')">${sticker}</div>`;
    }).join('');
    detailCardsContainer.innerHTML = cardListHtml;

    const modalDetail = document.getElementById('modal-winner-detail');
    modalDetail.classList.remove('hidden');
    modalDetail.style.display = 'flex';
}

window.closeWinnerDetailModal = function(){
    const modalDetail = document.getElementById('modal-winner-detail');
    modalDetail.classList.add('hidden');
    modalDetail.style.display = 'none';
    delete window._tempWinnerRecs;
    stopConfettiFullScreen(); 
    renderAll();
}

function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"\'":'&#39;'}[m])); }

function initializePurchaseData(p){
    p.price = p.price || (p.modality === 4 ? prices.price4 : prices.price6);
    p.profit = p.profit || (p.modality === 4 ? prices.profit4 : prices.profit6);
    p.enJuego = p.price - p.profit;
    p.casa = p.profit;
    p.state = p.state || 'JUGANDO'; 
    p.markedCards = p.markedCards || [];
    p.gamesLeft = p.gamesLeft === undefined ? 1 : p.gamesLeft;
    p.totalPaid = p.totalPaid || p.price;
}

// REFACTORIZACI√ìN: La funci√≥n ya no autollena, solo calcula y muestra posibilidades.
function updateCalculatorInfo(){
    const p4=prices.price4, p6=prices.price6;
    const budgetRaw=document.getElementById('input-budget').value;
    const budget = budgetRaw===''?0:parseFloat(budgetRaw||0);

    const q4=parseInt(document.getElementById('qty4').value||0);
    const q6=parseInt(document.getElementById('qty6').value||0);
    
    // 1. C√°lculo de posibilidades para que el jugador elija
    let maxQ4=0, maxQ6=0;
    if(budget >= p4) maxQ4 = Math.floor(budget / p4);
    if(budget >= p6) maxQ6 = Math.floor(budget / p6);

    // 2. C√°lculo del costo actual
    const cost4 = q4*p4;
    const cost6 = q6*p6;
    const totalCost = cost4 + cost6;
    
    // 3. Generaci√≥n del mensaje
    let msg = `
        <div style="margin-top:4px;">
            <strong style="color:var(--azul);">POSIBILIDADES CON ${formatMoney(budget)}:</strong>
            <br> ${maxQ4} Partidas de 4 Cartas (Costo ${formatMoney(p4)} c/u)
            <br> ${maxQ6} Partidas de 6 Cartas (Costo ${formatMoney(p6)} c/u)
        </div>
        <div style="margin-top:8px;">
            <strong style="color:#111;">COSTO ACTUAL:</strong>
            <br> ${q4} Partidas 4C: ${formatMoney(cost4)}
            <br> ${q6} Partidas 6C: ${formatMoney(cost6)}
            <br> Total: <strong style="color:var(--rojo);">${formatMoney(totalCost)}</strong>
        </div>
    `;
    
    if(totalCost > budget && budget > 0){
        msg += `<br><span style="color:var(--rojo);font-weight:700;">¬°Faltan: ${formatMoney(totalCost - budget)}!</span>`;
    } else if (budget > totalCost && totalCost > 0){
        msg += `<br><span style="color:var(--verde);font-weight:700;">Sobrante: ${formatMoney(budget - totalCost)}</span>`;
    } else if (budget > 0 && totalCost === 0) {
        msg += `<br><span style="color:var(--azul);font-weight:700;">Presupuesto de ${formatMoney(budget)} sin asignar.</span>`;
    }

    document.getElementById('calc-info').innerHTML = msg;
    
    // Mostrar/Ocultar campos de cantidad si el presupuesto lo permite
    document.getElementById('qty4').parentElement.style.display = budget>=p4 || q4>0? 'block':'none';
    document.getElementById('qty6').parentElement.style.display = budget>=p6 || q6>0? 'block':'none';
}

// ... (El resto de las funciones se mantienen igual, incluyendo registerPlayer, resetGame, etc.) ...

// INICIALIZACI√ìN Y EVENT LISTENERS
document.addEventListener('DOMContentLoaded', ()=>{
    
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js';
    document.head.appendChild(script);

    // Inicializar la vista y el estado del juego
    renderAll();
    
    // Asegurar que el select de modalidad refleje el estado
    document.getElementById('select-modality').value = String(currentMode);

    // Event listeners
    document.getElementById('btn-shuffle').addEventListener('click', animateShuffle);
    document.getElementById('btn-draw').addEventListener('click', drawOne);
    document.getElementById('btn-auto').addEventListener('click', ()=>{ isAuto? stopAuto() : startAuto(); });
    document.getElementById('btn-reset').addEventListener('click', resetGame);
    
    // ... (Event listeners para precios, filtros, etc.) ...
    document.getElementById('save-prices').addEventListener('click', ()=>{
        prices.price4=parseFloat(document.getElementById('price4').value||0);
        prices.profit4=parseFloat(document.getElementById('profit4').value||0);
        prices.price6=parseFloat(document.getElementById('price6').value||0);
        prices.profit6=parseFloat(document.getElementById('profit6').value||0);
        saveAll();
        renderAll();
        alert('Precios guardados. La bolsa/casa se actualizar√° al reiniciar la partida o al siguiente registro.');
    });
    document.getElementById('reset-prices').addEventListener('click', ()=>{
        prices=defaultsPrices();
        document.getElementById('price4').value=prices.price4;
        document.getElementById('profit4').value=prices.profit4;
        document.getElementById('price6').value=prices.price6;
        document.getElementById('profit6').value=prices.profit6;
        saveAll();
        renderAll();
        alert('Precios reseteados a los valores por defecto.');
    });

    document.getElementById('btn-register').addEventListener('click', registerPlayer);
    
    document.getElementById('input-budget').addEventListener('input', updateCalculatorInfo); 
    document.getElementById('qty4').addEventListener('input', updateCalculatorInfo);
    document.getElementById('qty6').addEventListener('input', updateCalculatorInfo);
    
    document.getElementById('btn-view-play').addEventListener('click', ()=>{ 
        document.getElementById('view-admin').classList.add('hidden'); 
        renderAll(); 
    });
    document.getElementById('btn-view-admin').addEventListener('click', ()=>{ 
        document.getElementById('view-admin').classList.remove('hidden'); 
        renderAll(); 
    });
    
    document.getElementById('select-modality').addEventListener('change', (e)=>{ 
        currentMode = Number(e.target.value); 
        localStorage.setItem(Kmod,String(currentMode)); 
        renderAll(); 
        // Asegura que los controles se re-habiliten si el juego estaba en pausa por un ganador de otra mod.
        if(!game.winnerPending) disableControls(false); 
    });

    document.getElementById('btn-export').addEventListener('click', exportPdf);
    document.getElementById('btn-reset-day').addEventListener('click', ()=>{ 
        if(!confirm('Borrar todo y reiniciar d√≠a? Esto eliminar√° compras, transacciones y registros de ganadores. El contador de IDs **NO** se reiniciar√°.')) return;
        purchases=[];
        tx.push({id:uuid(),type:'clear',ts:Date.now()});
        game=defaultsGame();
        winners=[];
        drawnInGame=[];
        saveAll();
        renderAll();
        alert('D√≠a reiniciado. Todos los datos de compras y ganancias se borraron.');
    });

    document.getElementById('filter-all').addEventListener('click', ()=>{ setActiveFilter('all'); renderPlayersTable(); });
    document.getElementById('filter-4').addEventListener('click', ()=>{ setActiveFilter(4); renderPlayersTable(4); });
    document.getElementById('filter-6').addEventListener('click', ()=>{ setActiveFilter(6); renderPlayersTable(6); });

    // Modales
    document.getElementById('modal-player-back').addEventListener('click', (e)=>{ if(e.target.id==='modal-player-back') closeGroupModal(); });
    document.getElementById('modal-close').addEventListener('click', closeGroupModal);
    document.getElementById('modal-close-x').addEventListener('click', closeGroupModal);
    
    // Cambiado: Ahora va a mostrar la carta con foco
    document.getElementById('winner-ok').addEventListener('click', ()=>{
        if(window._tempWinnerRecs && window._tempWinnerRecs.length > 0) {
            showWinnerFocusModal(window._tempWinnerRecs[0].cardId);
        }
    }); 
    document.getElementById('winner-close').addEventListener('click', ()=>{ 
        const m=document.getElementById('modal-winner'); 
        m.classList.add('hidden'); 
        m.style.display='none'; 
        stopConfettiFullScreen(); 
        delete window._tempWinnerRecs;
        game.winnerPending = false;
        disableControls(false); 
        renderAll();
    });
    
    // Cierre de Modal de Foco
    document.getElementById('focus-card-close').addEventListener('click', closeWinnerFocusModal);
    document.getElementById('modal-winner-focus-back').addEventListener('click', (e)=>{ if(e.target.id==='modal-winner-focus-back') closeWinnerFocusModal(); });
    
    // Cierre de Modal de Detalle
    document.getElementById('winner-detail-ok').addEventListener('click', closeWinnerDetailModal);
    document.getElementById('winner-detail-close-x').addEventListener('click', closeWinnerDetailModal);
    document.getElementById('modal-winner-detail-back').addEventListener('click', (e)=>{ if(e.target.id==='modal-winner-detail-back') closeWinnerDetailModal(); });


    document.addEventListener('keydown', (e)=>{
        if(e.key==='Escape'){ 
            closeGroupModal(); 
            const mw=document.getElementById('modal-winner'); 
            if(mw && !mw.classList.contains('hidden')){ mw.classList.add('hidden'); mw.style.display='none'; stopConfettiFullScreen(); }
            const mwd=document.getElementById('modal-winner-detail'); 
            if(mwd && !mwd.classList.contains('hidden')){ closeWinnerDetailModal(); }
            const mwf=document.getElementById('modal-winner-focus'); 
            if(mwf && !mwf.classList.contains('hidden')){ closeWinnerFocusModal(); } // Cierra el foco con ESC
        }
    });

    const playersAreaEl = document.getElementById('players-area');
    if (playersAreaEl) {
        playersAreaEl.addEventListener('click', (e) => {
            let target = e.target.closest('.player-card');
            if (target && !target.classList.contains('simulated')) {
                const playerId = target.getAttribute('data-player-id');
                if (playerId) {
                    openPurchaseDetail(playerId);
                }
            }
        });
    }

});

</script>
</body>
</html>
