<!-- Asumiendo que esto va al final del body, tras tu bloque HTML principal -->
<canvas id="confetti-canvas" style="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;display:none;z-index:9999"></canvas>
<script>
/********************
 Variables principales
********************/
let game = { deck: Array.from({length:54},(_,i)=>i+1), drawn: [], current: null };
let purchases = [], winners = [], cartasPasadas = [], tx = [];
let isAuto = false, autoInterval = null, animShuffling = false;
let prices = {price4:50,profit4:20,price6:75,profit6:30,price8:100,profit8:40};
let lastPlayerId = 0; // para generar IDs GanaYA!

/********************
 Funciones auxiliares
********************/
function uuid(){ return 'xxxx-xxxx'.replace(/[xy]/g,c=>{ const r=Math.random()*16|0; return r.toString(16); }); }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function formatMoney(v){ return '$'+(v||0).toFixed(2); }
function cardName(id){ const names=['El Gallo','La Dama','El Valiente','El Catr铆n','El Paraguas','La Sirena','La Escalera','La Botella','El Barril','El rbol','El Mel贸n','El Valiente','La Bandera','El Pino','La Chalupa','El Mundo','El Apache','El Nopal','El Coraz贸n','La Sand铆a','El Tambor','El Camar贸n','El Sol','La Luna','La Corona','El Bandol贸n','El Violoncello','La Jarana','El Gallo II','La Dama II','El Valiente II','La Rosa','El Sol II','La Luna II','El Catr铆n II','La Chalupa II','El Pescado','El Diablito','La Estrella','El Gallo III','La Dama III','El Valiente III','La Bandera II','El Pino II','La Chalupa II','El Mundo II','El Apache II','El Nopal II','El Coraz贸n II','La Sand铆a II','El Tambor II']; return names[(id-1)%names.length]||`Carta-${id}`; }
function cardImageUrl(id){ return `cards/${id}.png`; }

/********************
 Animaciones y confeti
********************/
let confettiInterval=null;
function startConfettiFullScreen(){
  const canvas=document.getElementById('confetti-canvas'); canvas.style.display='block';
  const ctx=canvas.getContext('2d'); const w=canvas.width=window.innerWidth; const h=canvas.height=window.innerHeight;
  const colors=['#e63946','#ffd60a','#2a9d8f','#ff9e00','#ff6bcb','#6d9df5'];
  let conf=Array.from({length:220},()=>({x:Math.random()*w,y:Math.random()*-h,r:Math.random()*6+3,c:colors[Math.floor(Math.random()*colors.length)],s:Math.random()*3+2,rrot:Math.random()*6}));
  function draw(){ ctx.clearRect(0,0,w,h); conf.forEach(c=>{ ctx.save(); ctx.translate(c.x,c.y); ctx.rotate(c.rrot); ctx.fillStyle=c.c; ctx.fillRect(-c.r,-c.r,c.r*2,c.r*2); ctx.restore(); c.y+=c.s; c.x+=Math.sin(c.y*0.01)*2; if(c.y>h+30){ c.y=-20; c.x=Math.random()*w; } }); }
  if(confettiInterval) clearInterval(confettiInterval);
  confettiInterval=setInterval(draw,20);
  setTimeout(stopConfettiFullScreen,6000);
}
function stopConfettiFullScreen(){ if(confettiInterval) clearInterval(confettiInterval); const c=document.getElementById('confetti-canvas'); c.style.display='none'; }

/********************
 Render y animaciones de cartas
********************/
function renderAll(){
  renderCurrentCard();
  renderLastCards();
  renderPlayersTable();
  saveAll();
}
function renderCurrentCard(){
  const cur=document.getElementById('current-card');
  if(cur){
    if(game.current){
      cur.innerHTML=`<div style="width:160px;height:220px;background-image:url('${cardImageUrl(game.current)}');background-size:contain;background-repeat:no-repeat;background-position:center;border:2px solid gold;box-shadow:0 0 20px #ffd700;"></div>`;
    } else cur.innerHTML='<div class="small-muted">Esperando barajeo...</div>';
  }
}
function renderLastCards(){
  const last=(game.drawn||[]).slice(-3).reverse();
  const lastEl=document.getElementById('last-cards');
  if(lastEl){
    lastEl.innerHTML = last.length ? last.map(c=>`<div style="width:64px;height:96px;background-image:url('${cardImageUrl(c)}');background-size:cover;border-radius:6px;margin:0 2px;border:1px solid #ccc"></div>`).join('') : '<div class="small-muted">Ninguna carta a煤n.</div>';
  }
}

/********************
 Registro de jugador con WhatsApp
********************/
function registerPlayer(){
  const name=document.getElementById('input-name').value.trim();
  const cell=document.getElementById('input-cell').value.trim();
  const clabe=document.getElementById('input-clabe').value.trim();
  const budgetRaw=document.getElementById('input-budget').value;
  const budget = budgetRaw===''?0:parseFloat(budgetRaw||0);
  const q4=parseInt(document.getElementById('qty4').value||0), q6=parseInt(document.getElementById('qty6').value||0), q8=parseInt(document.getElementById('qty8').value||0);
  if(!name) return alert('Captura el nombre'); if(!cell) return alert('Captura el celular');
  if(q4+q6+q8<=0) return alert('Selecciona al menos una partida (cantidad)');
  const needed = q4*prices.price4 + q6*prices.price6 + q8*prices.price8;
  if(budget < needed) return alert(`El presupuesto no alcanza. Se requiere ${formatMoney(needed)}.`);
  if(budget > needed) return alert(`Hay sobrante de ${formatMoney(budget-needed)}. Ajusta cantidades o presupuesto.`);
  // Crear compras separadas
  const parts=[];
  if(q4>0) parts.push({modality:4,qty:q4,price:prices.price4});
  if(q6>0) parts.push({modality:6,qty:q6,price:prices.price6});
  if(q8>0) parts.push({modality:8,qty:q8,price:prices.price8});
  let whatsappMsg=`隆Bienvenido a GANA YA! \nTus partidas han sido registradas:\n`;
  parts.forEach(pt=>{
    for(let i=0;i<pt.qty;i++){
      lastPlayerId++;
      const idSeq = 'GanaYA!-'+String(1000+lastPlayerId).slice(-4);
      const p={id:uuid(),playerName:name,cell:cell,clabe:clabe,modality:pt.modality,initialGames:1,gamesLeft:1,totalPaid:pt.price,wins:0,state:'JUGANDO',card:[],markedCards:[],selectionUsed:true,createdAt:Date.now(),seqId:idSeq};
      p.card=generateCardForPurchase(pt.modality);
      purchases.push(p);
      tx.push({id:uuid(),type:'purchase',player:name,modality:pt.modality,amount:pt.price,purchaseId:p.id,ts:Date.now()});
      whatsappMsg+=`${idSeq}\nCartas asignadas: ${p.card.map(c=>cardName(c)).join(', ')}\n\n`;
    }
  });
  saveAll(); renderAll();
  // Abrir WhatsApp
  window.open(`https://wa.me/${cell}?text=${encodeURIComponent(whatsappMsg)}`,'_blank');
  // Limpiar campos
  document.getElementById('input-name').value=''; document.getElementById('input-cell').value=''; document.getElementById('input-clabe').value=''; document.getElementById('input-budget').value=''; document.getElementById('qty4').value='0'; document.getElementById('qty6').value='0'; document.getElementById('qty8').value='0';
  alert('Jugador(s) registrado(s) y cartas asignadas autom谩ticamente.');
}

/********************
 Generaci贸n de cartas
********************/
function generateCardForPurchase(modality){
  const assigned = new Set(); const pool = Array.from({length:54},(_,i)=>i+1); const out=[];
  while(out.length<modality && pool.length){
    const idx=Math.floor(Math.random()*pool.length);
    const v=pool.splice(idx,1)[0];
    if(!assigned.has(v)){ assigned.add(v); out.push(v); }
  }
  return out;
}

/********************
 Pago y carta de la suerte
********************/
window.markPaidById = function(id){
  const p=purchases.find(x=>x.id===id); if(!p) return alert('No encontrado'); if(p.state!=='POR PAGAR') return alert('Solo marcar si est谩 POR PAGAR');
  p.state='PAGADO'; p.paidAt=Date.now();
  winners=winners.map(w=> w.purchaseId===id? {...w,paid:true}:w);
  tx.push({id:uuid(),type:'mark_paid',purchaseId:id,ts:Date.now()});
  saveAll(); renderAll();
  // Mensaje WhatsApp con carta de la suerte
  if(p.wins>0){
    const msg=`Hola ${p.playerName},\nse ha realizado tu pago de ${formatMoney(p.totalPaid)}\na la cuenta ${p.clabe} el ${new Date().toLocaleString()}.\n\nTu carta de la suerte en esta partida fue:\n ${cardName(p.card[0])} \n\n隆Felicidades por tu premio en GANA YA! 拆`;
    navigator.clipboard.writeText(p.clabe||'');
    window.open(`https://wa.me/${p.cell}?text=${encodeURIComponent(msg)}`,'_blank');
  }
  alert('Marcado como PAGADO y WhatsApp listo.');
};

/********************
 Guardado local
********************/
function saveAll(){ localStorage.setItem('purchases',JSON.stringify(purchases)); localStorage.setItem('game',JSON.stringify(game)); localStorage.setItem('winners',JSON.stringify(winners)); localStorage.setItem('cartasPasadas',JSON.stringify(cartasPasadas)); localStorage.setItem('tx',JSON.stringify(tx)); }

/********************
 Inicializaci贸n
********************/
document.addEventListener('DOMContentLoaded',()=>{
  renderAll();
});
</script>
