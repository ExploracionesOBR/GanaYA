<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GANA YA! ‚Äî Loter√≠a (Admin avanzado)</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --rojo:#b42222;
      --verde:#0f8a3c;
      --dorado:#caa43f;
      --crema:#f6f1e6;
      --sombra: 0 10px 24px rgba(0,0,0,0.08);
    }
    body{ font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--crema); color:#1f2937; }
    .brand-title{ font-family: "Alfa Slab One", serif; color:var(--rojo); letter-spacing:1px; }
    .tab-btn{ border-radius:999px; padding:.5rem .9rem; font-weight:700; box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    .tab-active{ background: linear-gradient(90deg,#fef2f2,#fff); border: 3px solid var(--rojo); color: var(--rojo); }
    .mex-frame{ background:#fff; border-radius:12px; padding:16px; box-shadow: var(--sombra); position:relative; }
    .mex-border{ border:4px solid var(--rojo); border-radius:10px; padding:10px; background:#fff; box-shadow: 0 6px 18px rgba(0,0,0,0.04); }
    .title-accent { display:inline-block; height:8px; width:72px; background: linear-gradient(90deg, var(--dorado), #e6c05b); border-radius:6px; margin-top:6px; }
    .card-cell { border-radius:8px; overflow:hidden; background-size:cover; background-position:center; min-height:64px; position:relative; box-shadow: 0 4px 10px rgba(0,0,0,0.06); display:flex; align-items:center; justify-content:center; }
    .card-cell.marked::after{ content:""; position:absolute; inset:0; background-color: rgba(0,0,0,0.45); background-image:url('logo_1_entrada.png'); background-repeat:no-repeat; background-position:center; background-size:36%; z-index:10; }
    .current-card { border-radius:14px; border:6px solid #fff; box-shadow: 0 12px 30px rgba(0,0,0,0.08); min-height:180px; display:flex; align-items:center; justify-content:center; background: linear-gradient(180deg,#fff,#fff); }
    .confetti{ position: fixed; width: 10px; height: 10px; top:100%; animation: confetti 2s ease-out forwards; z-index:120; }
    @keyframes confetti{ 0%{ transform: translateY(0) rotate(0); opacity:1 } 100%{ transform: translateY(-420px) rotate(720deg); opacity:0 } }
    .btn{ padding:.55rem .9rem; border-radius:.6rem; font-weight:700; }
    .btn-red{ background:var(--rojo); color:white; }
    .btn-blue{ background:#1565d8; color:white; }
    .btn-green{ background:var(--verde); color:white; }
    .small{ font-size:.85rem; }
    .pulse-green { animation: pulse-green 1s ease; }
    @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(15,138,60,0.6);} 70% { box-shadow: 0 0 0 14px rgba(15,138,60,0);} 100% { box-shadow: none; } }
    .row-disabled { opacity: .45; filter: grayscale(.2); }
    .confetti-mini {position:absolute; width:6px; height:6px; border-radius:50%; }
    .animate-create { transform-origin: center; animation: create-pop .45s ease forwards; }
    @keyframes create-pop { 0% { transform: scale(.6); opacity:0 } 60% { transform: scale(1.05); opacity:1 } 100% { transform: scale(1); } }
    @media (max-width:1024px){ .current-card{ min-height:140px } }
    /* small helper */
    .small-muted{ font-size:.85rem; color:#6b7280; }
  </style>
</head>
<body class="min-h-screen">

  <!-- HEADER -->
  <header class="max-w-7xl mx-auto px-4 py-6 flex flex-col md:flex-row items-center gap-6 justify-between">
    <div class="flex items-center gap-4">
      <img src="logo_1_entrada.png" alt="Logo" class="w-16 h-16 rounded-full shadow-lg" onerror="this.onerror=null;this.src='https://placehold.co/80x80/b42222/ffffff?text=LOGO'">
      <div>
        <h1 class="brand-title text-4xl md:text-5xl">GANA YA!</h1>
        <div class="text-xs text-gray-600 mt-1">Loter√≠a interactiva ‚Äî estilo tradicional mexicano</div>
      </div>
    </div>

    <div class="flex items-center gap-4">
      <div class="flex items-center gap-2">
        <button id="tab-player" class="tab-btn tab-active">Vista Jugador</button>
        <button id="tab-admin" class="tab-btn">Vista Administrador</button>
      </div>

      <div class="bg-green-700 text-white p-3 rounded-xl shadow-lg flex flex-col items-center min-w-[120px]">
        <span class="text-xs font-semibold uppercase">BOLSA EN JUEGO</span>
        <span id="pot-amount" class="text-xl md:text-2xl font-extrabold">$0.00</span>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-7xl mx-auto px-4 pb-12">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

      <!-- CENTRAL: Cartas de jugadores -->
      <section id="view-player" class="lg:col-span-8">
        <div class="mex-frame">
          <div class="flex items-start justify-between">
            <div>
              <h2 class="text-2xl font-extrabold text-gray-800">Cartas Activas (Modalidad actual)</h2>
              <div class="title-accent"></div>
              <p class="text-sm text-gray-600 mt-2">Se muestran las cartas asociadas a compras/partidas en la modalidad seleccionada desde Administraci√≥n.</p>
            </div>

            <!-- quick summary -->
            <div class="w-80">
              <div class="bg-gray-50 p-3 rounded-lg border">
                <div class="text-sm small-muted">Total compras activas:</div>
                <div id="summary-active-count" class="text-xl font-bold">0</div>
                <div class="text-sm small-muted mt-2">Total partidas vendidas:</div>
                <div id="summary-partidas" class="text-lg font-bold">0</div>
              </div>
            </div>
          </div>

          <div class="mt-6 mex-border">
            <div id="active-players-cards" class="grid gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 p-3">
              <div class="text-center text-gray-500 p-8 col-span-full">A√∫n no hay jugadores / compras en esta modalidad.</div>
            </div>
          </div>
        </div>
      </section>

      <!-- LATERAL: Admin + Carta en juego -->
      <aside class="lg:col-span-4 flex flex-col gap-6">

        <!-- PANEL Admin (Caja) -->
        <div class="mex-frame">
          <h3 class="text-lg font-extrabold text-gray-800">Caja / Configuraci√≥n</h3>
          <div class="title-accent"></div>

          <div class="mt-4 space-y-3">
            <!-- Prices per modality -->
            <div class="grid grid-cols-3 gap-2">
              <div>
                <label class="text-xs text-gray-600">Precio 2x2</label>
                <input id="price-4" type="number" min="1" class="w-full p-2 border rounded" />
              </div>
              <div>
                <label class="text-xs text-gray-600">Precio 2x3</label>
                <input id="price-6" type="number" min="1" class="w-full p-2 border rounded" />
              </div>
              <div>
                <label class="text-xs text-gray-600">Precio 3x3</label>
                <input id="price-9" type="number" min="1" class="w-full p-2 border rounded" />
              </div>
            </div>

            <div>
              <label class="text-xs text-gray-600">Ganancia casa por carta</label>
              <input id="house-profit" type="number" min="0" class="w-full p-2 border rounded" />
              <p class="text-xs text-gray-500 mt-1">Se resta por cada carta vendida para calcular la bolsa.</p>
            </div>

            <div class="flex gap-2">
              <button id="save-prices" class="btn btn-green flex-1 small">Guardar precios</button>
              <button id="reset-prices" class="btn small" style="background:#f3f4f6;border-radius:.6rem">Reset</button>
            </div>

            <div class="mt-2 bg-gray-50 p-3 rounded-lg">
              <div class="text-sm text-gray-600">Modalidad activa</div>
              <select id="modality-select" class="w-full p-2 border rounded-lg mt-2">
                <option value="4">4 im√°genes (2x2)</option>
                <option value="6">6 im√°genes (2x3)</option>
                <option value="9" selected>9 im√°genes (3x3)</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Panel de compra / registrar jugador -->
        <div class="mex-frame">
          <h3 class="text-lg font-extrabold text-gray-800">Registrar Jugador (Caja)</h3>
          <div class="title-accent"></div>

          <div class="mt-3 space-y-3">
            <label class="text-xs text-gray-600">Nombre del jugador</label>
            <input id="player-name-input" type="text" class="w-full p-2 border rounded" placeholder="Ej. Mar√≠a L√≥pez">

            <label class="text-xs text-gray-600">Presupuesto ($)</label>
            <input id="player-budget-input" type="number" min="1" class="w-full p-2 border rounded" placeholder="Ej. 100">

            <div>
              <label class="text-xs text-gray-600">Modalidades deseadas (elige 1 o m√°s)</label>
              <div class="flex gap-2 mt-2">
                <label class="inline-flex items-center gap-2"><input type="checkbox" class="modal-chk" value="4"> 2x2</label>
                <label class="inline-flex items-center gap-2"><input type="checkbox" class="modal-chk" value="6"> 2x3</label>
                <label class="inline-flex items-center gap-2"><input type="checkbox" class="modal-chk" value="9"> 3x3</label>
              </div>
            </div>

            <div class="flex gap-2">
              <button id="calc-btn" class="btn btn-blue flex-1 small">Calcular partidas</button>
              <button id="add-player-btn" class="btn btn-green flex-1 small">A√±adir jugador</button>
            </div>

            <div id="calc-result" class="text-sm text-gray-600"></div>
            <div id="calc-warning" class="text-sm text-red-600"></div>
          </div>
        </div>

        <!-- Control de juego -->
        <div class="mex-frame">
          <h3 class="text-lg font-extrabold text-gray-800">Control de Partida</h3>
          <div class="title-accent"></div>

          <div class="mt-4 space-y-2">
            <div class="flex gap-2">
              <button id="shuffle-btn" class="btn btn-blue flex-1 small">BARAJEAR</button>
              <button id="draw-btn" class="btn btn-red flex-1 small">TIRAR CARTA</button>
            </div>
            <div class="flex gap-2">
              <button id="auto-btn" class="btn small" style="flex:1;background:#fee9d6;border-radius:.6rem">CARTAS AUTOM√ÅTICO</button>
              <button id="clean-btn" class="btn small" style="flex:1;background:#fff;border:1px solid #e5e7eb">LIMPIAR</button>
            </div>

            <div class="mt-2 bg-gray-50 p-3 rounded-lg">
              <div class="text-sm text-gray-600">Cartas restantes: <span id="deck-count" class="font-bold">54</span></div>
              <div class="text-sm text-gray-600 mt-1">Carta actual: <span id="current-card-name" class="font-bold text-red-600">Ninguna</span></div>
            </div>
          </div>
        </div>

        <!-- CARTA EN JUEGO -->
        <div class="mex-frame">
          <h3 class="text-lg font-extrabold text-gray-800">Carta en Juego</h3>
          <div class="title-accent"></div>

          <div class="mt-4 current-card" id="current-card">
            <div class="text-center">
              <div id="current-card-inner">
                <span class="text-6xl">üé≤</span>
                <div class="text-sm font-semibold mt-2 text-gray-600">Esperando...</div>
              </div>
            </div>
          </div>
        </div>

        <!-- √öltimas 3 cartas -->
        <div class="mex-frame">
          <h3 class="text-lg font-extrabold text-gray-800">√öltimas 3 Cartas</h3>
          <div class="title-accent"></div>
          <div class="mt-4 bg-white p-3 rounded-lg border min-h-[72px]">
            <div id="last-cards" class="flex gap-2 flex-wrap">
              <div class="text-gray-400">Ninguna carta a√∫n.</div>
            </div>
          </div>
        </div>

        <!-- √öltimos Ganadores -->
        <div class="mex-frame">
          <h3 class="text-lg font-extrabold text-gray-800">√öltimos Ganadores</h3>
          <div class="title-accent"></div>
          <div class="mt-4 bg-white p-3 rounded-lg border min-h-[64px]">
            <div id="last-winners" class="text-center text-gray-500">A√∫n no hay ganadores.</div>
          </div>
        </div>

      </aside>
    </div>

    <!-- Secci√≥n: Jugadores / compras (tabla) -->
    <section class="mt-8 mex-frame">
      <h3 class="text-xl font-extrabold text-gray-800">Administraci√≥n de Compras / Jugadores</h3>
      <div class="title-accent"></div>
      <p class="text-sm text-gray-600 mt-2">Cada fila representa una compra del jugador en una modalidad determinada.</p>

      <div class="mt-4 overflow-x-auto">
        <table class="min-w-full text-left">
          <thead class="bg-gray-50">
            <tr>
              <th class="p-2">Jugador</th>
              <th class="p-2">Modalidad</th>
              <th class="p-2">Partidas</th>
              <th class="p-2">Total pagado</th>
              <th class="p-2">Ganadas</th>
              <th class="p-2">Estado Pago</th>
              <th class="p-2">Acciones</th>
            </tr>
          </thead>
          <tbody id="players-table-body">
            <tr><td colspan="7" class="p-4 text-gray-500">No hay compras registradas.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

  </main>

  <!-- WINNER MODAL -->
  <div id="winner-modal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center">
    <div id="confetti-container" class="absolute inset-0 overflow-hidden pointer-events-none"></div>
    <div class="bg-yellow-300 p-8 rounded-2xl shadow-2xl text-center border-4 border-yellow-500 z-50">
      <h1 class="text-5xl font-black text-red-600 mb-2">¬°FELICIDADES!</h1>
      <p id="winner-text" class="text-2xl font-bold text-gray-800 mb-2">Nombre ha ganado</p>
      <p id="winner-amount" class="text-xl text-green-800 font-extrabold">$0.00</p>
      <div class="mt-6 flex justify-center gap-3">
        <button onclick="closeWinner()" class="btn btn-red">Cerrar</button>
        <button id="mark-paid-btn" class="btn btn-green">Marcar pagado</button>
      </div>
    </div>
  </div>

  <!-- EXPORT / FOOTER -->
  <footer class="max-w-7xl mx-auto px-4 py-6 text-sm text-gray-600">
    <p>Sube <strong>logo_1_entrada.png</strong> en la ra√≠z y la carpeta <strong>Cartas_baraja_loteria/</strong> con las 54 im√°genes (nombres exactos).</p>
  </footer>

  <!-- SCRIPT (L√≥gica completa) -->
  <script>
  /************************************************************************
   *  GANA YA! - V3 (Admin avanzado)
   *  - Storage keys
   *  - Prices per modality + house profit
   *  - Players stored as "purchases" rows (each purchase = one modality for a player)
   *  - Deck simulated, draw, auto mode, clean, etc.
   ************************************************************************/

  // --- constants and maps ---
  const CARD_IMAGE_BASE_PATH = 'Cartas_baraja_loteria/';
  const CARD_NAME_MAP = {
    1:"1 el gallo-min.png",2:"2 el diablito-min.png",3:"3 la dama-min.png",4:"4 el catrin-min.png",
    5:"5 el paraguas-min.png",6:"6 la sirena-min.png",7:"7 la escalera-min.png",8:"8 la botella-min.png",
    9:"9 el barril-min.png",10:"10 el √°rbol-min.png",11:"11 el mel√≥n-min.png",12:"12 el valiente-min.png",
    13:"13 el gorrito-min.png",14:"14 la muerte-min.png",15:"15 la pera-min.png",16:"16 la bandera-min.png",
    17:"17 el bandol√≥n-min.png",18:"18 el violoncello-min.png",19:"19 la garza-min.png",20:"20 el p√°jaro-min.png",
    21:"21 la mano-min.png",22:"22 la bota-min.png",23:"23 la luna-min.png",24:"24 el cotorro-min.png",
    25:"25 el borracho-min.png",26:"26 el negrito-min.png",27:"27 el coraz√≥n-min.png",28:"28 la sand√≠a-min.png",
    29:"29 el tambor-min.png",30:"30 el camar√≥n-min.png",31:"31 las jaras-min.png",32:"32 el m√∫sico-min.png",
    33:"33 la ara√±a-min.png",34:"34 el soldado-min.png",35:"35 la estrella-min.png",36:"36 el cazo-min.png",
    37:"37 el mundo-min.png",38:"38 el apache-min.png",39:"39 el nopal-min.png",40:"40 el alacr√°n-min.png",
    41:"41 la rosa-min.png",42:"42 la calavera-min.png",43:"43 la campana-min.png",44:"44 el cantarito-min.png",
    45:"45 el venado-min.png",46:"46 el sol-min.png",47:"47 la corona-min.png",48:"48 la chalupa-min.png",
    49:"49 el pino-min.png",50:"50 el pescado-min.png",51:"51 la palma-min.png",52:"52 la maceta-min.png",
    53:"53 el rayo-min.png",54:"54 la rana-min.png"
  };

  // storage keys
  const KEY_PRICES = 'loteria_prices_v3';
  const KEY_GAME = 'loteria_game_v3';
  const KEY_PURCHASES = 'loteria_players_v3'; // purchases list

  // default prices object
  const defaultPrices = () => ({
    price4: 10,
    price6: 12,
    price9: 15,
    houseProfit: 2
  });

  const defaultGame = () => ({
    modality: 9,
    deck: Array.from({length:54}, (_,i) => i+1),
    drawnCards: [],
    currentCardId: 0,
    pendingWinners: [],
    lastWinners: []
  });

  // load/save
  const loadPrices = ()=> JSON.parse(localStorage.getItem(KEY_PRICES) || JSON.stringify(defaultPrices()));
  const savePrices = (p)=> localStorage.setItem(KEY_PRICES, JSON.stringify(p));

  const loadGame = ()=> JSON.parse(localStorage.getItem(KEY_GAME) || JSON.stringify(defaultGame()));
  const saveGame = (g)=> localStorage.setItem(KEY_GAME, JSON.stringify(g));

  const loadPurchases = ()=> JSON.parse(localStorage.getItem(KEY_PURCHASES) || '[]');
  const savePurchases = (arr)=> localStorage.setItem(KEY_PURCHASES, JSON.stringify(arr));

  // state
  let prices = loadPrices();
  let gameState = loadGame();
  let purchases = loadPurchases(); // list of purchase rows
  let isAuto = false;
  let autoInterval = null;
  let lastWinnerRecords = []; // ephemeral to show modal link

  // util: card image url
  const cardImageUrl = id => CARD_IMAGE_BASE_PATH + (CARD_NAME_MAP[id] || `${id}.png`);

  // ensure deck exists
  if (!gameState.deck || !gameState.deck.length) gameState.deck = Array.from({length:54}, (_,i)=>i+1);

  // --- render functions ---
  function renderAll(){
    // prices
    document.getElementById('price-4').value = prices.price4;
    document.getElementById('price-6').value = prices.price6;
    document.getElementById('price-9').value = prices.price9;
    document.getElementById('house-profit').value = prices.houseProfit;

    // modal selected
    document.getElementById('modality-select').value = gameState.modality || 9;

    // active purchases grid (for view-player)
    const modality = parseInt(document.getElementById('modality-select').value || gameState.modality || 9);
    gameState.modality = modality;

    const activePurchases = purchases.filter(p => p.modality === modality);
    const activeContainer = document.getElementById('active-players-cards');
    if (!activePurchases.length) {
      activeContainer.innerHTML = `<div class="text-center text-gray-500 p-8 col-span-full">No hay compras activas en esta modalidad.</div>`;
    } else {
      activeContainer.innerHTML = activePurchases.map(p => renderPurchaseCardHtml(p)).join('');
    }

    // summary
    document.getElementById('summary-active-count').textContent = purchases.length;
    document.getElementById('summary-partidas').textContent = purchases.reduce((s,r)=>s+(r.gamesLeft||0),0);

    // current card
    const currentCardElem = document.getElementById('current-card-inner');
    if (gameState.currentCardId) {
      const img = cardImageUrl(gameState.currentCardId);
      currentCardElem.innerHTML = `<div style="background-image:url('${img}'); background-size:contain; background-position:center; background-repeat:no-repeat; width:140px; height:140px; margin:0 auto;"></div>
      <div class="text-sm font-semibold mt-2 text-gray-600">Carta: ${gameState.currentCardId}</div>`;
    } else {
      currentCardElem.innerHTML = `<span class="text-6xl">üé≤</span><div class="text-sm font-semibold mt-2 text-gray-600">Esperando...</div>`;
    }

    // last 3 cards
    const last = (gameState.drawnCards || []).slice(-3).reverse();
    const lc = document.getElementById('last-cards');
    if (!last.length) lc.innerHTML = `<div class="text-gray-400">Ninguna carta a√∫n.</div>`; else {
      lc.innerHTML = last.map(cid => `<div class="w-14 h-18 bg-cover bg-center rounded shadow-md border" style="background-image:url('${cardImageUrl(cid)}')"></div>`).join('');
    }

    // deck counts
    document.getElementById('deck-count').textContent = gameState.deck.length;
    document.getElementById('current-card-name').textContent = gameState.currentCardId ? `Carta ${gameState.currentCardId}` : 'Ninguna';

    // pot calculation: sum(payments) - houseProfit * totalCardsSold
    const totalPaid = purchases.reduce((s,p)=> s + (p.totalPaid||0), 0);
    const totalCardsSold = purchases.reduce((s,p)=> s + (p.initialGames||0), 0); // initialGames tracks how many bought originally
    // We'll use totalActiveGames sold (sum of all initialGames) ‚Äî this approximates sold count
    const potAmount = Math.max(0, totalPaid - (prices.houseProfit * totalCardsSold));
    document.getElementById('pot-amount').textContent = `$${potAmount.toFixed(2)}`;

    // last winners list
    const lw = document.getElementById('last-winners');
    if (!(gameState.lastWinners && gameState.lastWinners.length)) lw.innerHTML = 'A√∫n no hay ganadores.'; else {
      lw.innerHTML = (gameState.lastWinners||[]).slice(-5).reverse().map(w => `<div class="text-sm font-semibold">${w.name} ‚Äî $${w.amount.toFixed(2)} <span class="text-xs text-gray-500">(${new Date(w.timestamp).toLocaleString()})</span></div>`).join('');
    }

    // players table
    renderPlayersTable();

    // persist
    savePrices(prices);
    saveGame(gameState);
    savePurchases(purchases);
  }

  // render purchase card for grid
  function renderPurchaseCardHtml(p) {
    const gridClass = p.modality === 4 ? 'grid-cols-2' : 'grid-cols-3';
    const cells = (p.card || []).map(cid => `<div class="card-cell ${ (p.markedCards||[]).includes(cid) ? 'marked' : '' }" style="background-image:url('${cardImageUrl(cid)}'); aspect-ratio:1/1"></div>`).join('');
    return `<div class="${p.gamesLeft <= 0 ? 'row-disabled' : ''} mex-border p-3 animate-create">
      <div class="flex items-center justify-between mb-2">
        <div>
          <div class="text-lg font-extrabold">${escapeHtml(p.playerName)}</div>
          <div class="text-xs text-gray-600">Partidas: ${p.gamesLeft}  ‚Ä¢  Pagado: $${(p.totalPaid||0).toFixed(2)}</div>
        </div>
        <div class="text-sm text-green-700 font-bold">${p.wins||0} victorias</div>
      </div>
      <div class="grid ${gridClass} gap-2">${cells}</div>
    </div>`;
  }

  // render players table rows
  function renderPlayersTable(){
    const tbody = document.getElementById('players-table-body');
    if (!purchases.length) {
      tbody.innerHTML = `<tr><td colspan="7" class="p-4 text-gray-500">No hay compras registradas.</td></tr>`;
      return;
    }
    const rows = purchases.map(p => {
      const stateLabel = p.paymentState === 'pending' ? `<span class="text-xs px-2 py-1 bg-yellow-100 rounded">Pendiente</span>` : `<span class="text-xs px-2 py-1 bg-green-100 rounded">Pagado</span>`;
      const disabledClass = p.gamesLeft <= 0 ? 'row-disabled' : '';
      const modalityText = p.modality === 4 ? '2x2' : p.modality === 6 ? '2x3' : '3x3';
      return `<tr class="${disabledClass}">
        <td class="p-2 font-semibold">${escapeHtml(p.playerName)}</td>
        <td class="p-2">${modalityText}</td>
        <td class="p-2">${p.gamesLeft}</td>
        <td class="p-2">$${(p.totalPaid||0).toFixed(2)}</td>
        <td class="p-2">${p.wins||0}</td>
        <td class="p-2">${stateLabel}</td>
        <td class="p-2 space-x-2">
          <button class="px-2 py-1 bg-green-500 text-white rounded text-xs" onclick="addGamesPrompt('${p.id}')">+ Partidas</button>
          <button class="px-2 py-1 bg-yellow-500 text-white rounded text-xs" onclick="markPendingPaid('${p.id}')">Pagar premio</button>
          <button class="px-2 py-1 bg-gray-300 text-black rounded text-xs" onclick="viewCard('${p.id}')">Ver carta</button>
          <button class="px-2 py-1 bg-red-600 text-white rounded text-xs" onclick="deletePurchase('${p.id}')">Eliminar</button>
        </td>
      </tr>`;
    }).join('');
    tbody.innerHTML = rows;
  }

  // --- logic functions ---

  // shuffle deck (visually)
  function shuffleDeck(){
    const btn = document.getElementById('shuffle-btn');
    btn.disabled = true; btn.textContent = 'BARAJANDO...';
    setTimeout(()=> {
      gameState.deck = shuffleArray(Array.from({length:54}, (_,i)=>i+1));
      gameState.drawnCards = [];
      gameState.currentCardId = 0;
      saveGame(gameState);
      btn.disabled = false; btn.textContent = 'BARAJEAR';
      renderAll();
    }, 800);
  }

  // draw a card (manual)
  function drawCard(){
    if (isAuto) return;
    if (!gameState.deck || gameState.deck.length === 0) { alert('El mazo est√° vac√≠o. Barajea para continuar.'); return; }
    const next = gameState.deck.pop();
    gameState.drawnCards.push(next);
    gameState.currentCardId = next;
    processCard(next);
    renderAll();
  }

  // process drawn card: mark purchases, check winners
  function processCard(cardId){
    const winners = [];
    purchases.forEach((p, idx) => {
      if (!p.isActive || (p.gamesLeft||0) <= 0) return;
      if (p.modality && p.card && p.card.includes(cardId) && !(p.markedCards||[]).includes(cardId)) {
        purchases[idx].markedCards = [...(p.markedCards||[]), cardId];
      }
      // winner condition: all card images in purchase are marked
      if ((p.markedCards || []).length === p.modality) {
        winners.push({ idx, id: p.id, name: p.playerName });
      }
    });

    if (winners.length > 0) {
      // stop auto
      stopAutoMode();
      // calculate pot
      const totalPaid = purchases.reduce((s,p)=> s + (p.totalPaid||0), 0);
      const totalCardsSold = purchases.reduce((s,p)=> s + (p.initialGames||0), 0);
      const potAmount = Math.max(0, totalPaid - (prices.houseProfit * totalCardsSold));
      // create winner records and change purchases (reduce gamesLeft by 1)
      const newWinners = [];
      winners.forEach(w => {
        const p = purchases[w.idx];
        // subtract 1 partida from that purchase
        p.gamesLeft = Math.max(0, (p.gamesLeft||0) - 1);
        p.wins = (p.wins||0) + 1;
        // mark payment pending
        p.paymentState = 'pending';
        // reset marked cards for that purchase
        p.markedCards = [];
        // create winner record
        const record = { id: crypto.randomUUID(), playerId: p.playerId, name: p.playerName, purchaseId: p.id, amount: potAmount / winners.length, timestamp: Date.now(), paid:false };
        newWinners.push(record);
        gameState.pendingWinners = (gameState.pendingWinners||[]).concat(record);
        gameState.lastWinners = (gameState.lastWinners||[]).concat(record);
      });
      saveGame(gameState); savePurchases(purchases);
      renderAll();
      // show modal for first winner (or show aggregate text)
      const first = newWinners[0];
      const winnerName = newWinners.length === 1 ? first.name : `${newWinners.length} jugadores`;
      showWinnerModal(winnerName, newWinners.reduce((s,w)=>s+w.amount,0), newWinners);
    } else {
      saveGame(gameState); savePurchases(purchases);
      renderAll();
    }
  }

  // clean: clear drawnCards & subtract 1 partida to purchases of current modality
  function cleanAction(){
    const mod = parseInt(document.getElementById('modality-select').value || gameState.modality || 9);
    if (!confirm(`¬øLimpiar cartas pasadas y restar 1 partida a compras de la modalidad ${mod}?`)) return;
    gameState.drawnCards = [];
    gameState.currentCardId = 0;
    purchases = purchases.map(p => {
      if (p.modality === mod) {
        p.gamesLeft = Math.max(0, (p.gamesLeft||0) - 1);
        p.isActive = p.gamesLeft > 0;
      }
      return p;
    });
    // do not delete purchases with 0; keep them grayed
    savePurchases(purchases);
    renderAll();
  }

  // auto mode toggle
  function toggleAuto(){
    if (isAuto) stopAutoMode(); else startAutoMode();
  }
  function startAutoMode(){
    if (!gameState.deck || gameState.deck.length === 0) { alert('El mazo est√° vac√≠o. Barajea para continuar.'); return; }
    isAuto = true;
    document.getElementById('auto-btn').textContent = 'DETENER AUTOM√ÅTICO';
    document.getElementById('auto-btn').style.background = 'var(--verde)';
    autoInterval = setInterval(()=> {
      if (!isAuto) return;
      if (!gameState.deck.length) { stopAutoMode(); return; }
      const next = gameState.deck.pop();
      gameState.drawnCards.push(next);
      gameState.currentCardId = next;
      processCard(next);
      renderAll();
    }, 2000);
  }
  function stopAutoMode(){
    isAuto = false;
    document.getElementById('auto-btn').textContent = 'CARTAS AUTOM√ÅTICO';
    document.getElementById('auto-btn').style.background = '#fee9d6';
    if (autoInterval) { clearInterval(autoInterval); autoInterval = null; }
  }

  // mark pending winners as paid (button from modal or table)
  function markPendingPaid(purchaseId){
    const p = purchases.find(x => x.id === purchaseId);
    if (!p) { alert('Compra no encontrada'); return; }
    p.paymentState = 'paid';
    savePurchases(purchases);
    renderAll();
  }
  window.markPendingPaid = markPendingPaid;

  // Add purchases when registering a player with budget and selected modalities
  function calculatePartitions(budget, selectedModalities){
    // divide equally the budget between selected modalities
    const share = Math.floor((budget / selectedModalities.length) * 100) / 100; // two decimals
    // for each modality compute number of partidas = floor(share / price)
    const parts = selectedModalities.map(m => {
      const price = m === 4 ? prices.price4 : m === 6 ? prices.price6 : prices.price9;
      const games = Math.floor(share / price);
      return { modality: m, price, share, games, requiredShareFor1: price };
    });
    return parts;
  }

  // Add player (creates purchases per modality)
  function addPlayer(){
    const name = (document.getElementById('player-name-input').value || '').trim();
    const budget = parseFloat(document.getElementById('player-budget-input').value || 0);
    const checked = Array.from(document.querySelectorAll('.modal-chk:checked')).map(i => parseInt(i.value));
    const warningEl = document.getElementById('calc-warning');
    warningEl.textContent = '';
    if (!name) { alert('Captura el nombre del jugador'); return; }
    if (!budget || budget <= 0) { alert('Captura un presupuesto v√°lido'); return; }
    if (!checked.length) { alert('Selecciona al menos una modalidad'); return; }

    // compute partitions
    const parts = calculatePartitions(budget, checked);
    // if any modality has 0 games -> block registration
    const zero = parts.find(p => p.games < 1);
    if (zero) {
      document.getElementById('calc-warning').textContent = `La modalidad ${zero.modality} no alcanza 1 partida con la porci√≥n (${zero.share}$). Aumenta presupuesto o elige menos modalidades.`;
      return;
    }

    // proceed: for each modality create a purchase record
    const playerId = crypto.randomUUID();
    const created = [];
    parts.forEach(part => {
      const games = part.games;
      const totalPaid = games * part.price;
      const purchase = {
        id: crypto.randomUUID(),
        playerId,
        playerName: name,
        modality: part.modality,
        gamesLeft: games,
        initialGames: games,
        totalPaid,
        wins: 0,
        paymentState: 'paid', // initial payments considered paid at registration
        isActive: games > 0,
        card: generateCardForPurchase(part.modality),
        markedCards: []
      };
      purchases.push(purchase);
      created.push(purchase);
    });

    // animation: confetti mini + pop
    animateCreatePlayer(created);

    // clear inputs
    document.getElementById('player-name-input').value = '';
    document.getElementById('player-budget-input').value = '';
    document.querySelectorAll('.modal-chk').forEach(c => c.checked = false);

    // persist
    savePurchases(purchases);
    renderAll();
  }

  // generate a card for a purchase: avoid duplicates across purchases if possible
  function generateCardForPurchase(modality){
    // gather already used card ids across purchases
    const used = new Set();
    purchases.forEach(p => (p.card || []).forEach(cid => used.add(cid)));
    // pool = all cards not used
    let pool = Array.from({length:54}, (_,i)=>i+1).filter(id => !used.has(id));
    // if pool too small, allow reuse
    if (pool.length < modality) pool = Array.from({length:54}, (_,i)=>i+1);
    // shuffle and take first modality
    pool = shuffleArray(pool);
    return pool.slice(0, modality);
  }

  // addGamesPrompt: prompt to add partidas to a purchase
  function addGamesPrompt(purchaseId){
    const val = prompt('¬øCu√°ntas partidas quieres agregar (entero mayor 0)?', '1');
    if (!val) return;
    const add = parseInt(val);
    if (isNaN(add) || add <= 0) return alert('Ingresa un n√∫mero v√°lido');
    const p = purchases.find(x => x.id === purchaseId);
    if (!p) return alert('Compra no encontrada');
    // increase games and totalPaid accordingly (use price per modality)
    const price = p.modality === 4 ? prices.price4 : p.modality === 6 ? prices.price6 : prices.price9;
    p.gamesLeft = (p.gamesLeft || 0) + add;
    p.initialGames = (p.initialGames||0) + add;
    p.totalPaid = (p.totalPaid||0) + (add * price);
    p.isActive = p.gamesLeft > 0;
    // small visual effect: highlight row
    highlightRow(purchaseId);
    savePurchases(purchases);
    renderAll();
  }

  // mark purchased prize as paid (table action)
  function markPendingPaid(purchaseId){
    const p = purchases.find(x => x.id === purchaseId);
    if (!p) return alert('Compra no encontrada');
    p.paymentState = 'paid';
    // optional: clear pending winners entries linked to this purchase
    if (gameState.pendingWinners && gameState.pendingWinners.length) {
      gameState.pendingWinners = gameState.pendingWinners.filter(w => w.purchaseId !== purchaseId);
      saveGame(gameState);
    }
    savePurchases(purchases);
    renderAll();
  }
  window.markPendingPaid = markPendingPaid;

  // delete purchase
  function deletePurchase(purchaseId){
    if (!confirm('Eliminar esta compra para siempre?')) return;
    purchases = purchases.filter(p => p.id !== purchaseId);
    savePurchases(purchases);
    renderAll();
  }
  window.deletePurchase = deletePurchase;

  // view card (popup)
  function viewCard(purchaseId){
    const p = purchases.find(x => x.id === purchaseId);
    if (!p) return alert('Compra no encontrada');
    const list = (p.card||[]).map(cid => `<div style="background-image:url('${cardImageUrl(cid)}'); background-size:cover; background-position:center; width:80px; height:80px; border-radius:8px; display:inline-block; margin:4px;"></div>`).join('');
    const w = window.open('', '_blank', 'width=420,height=420');
    w.document.write(`<title>Cartas - ${escapeHtml(p.playerName)}</title><body style="font-family:Inter;padding:12px"><h3>${escapeHtml(p.playerName)} ‚Äî Modalidad ${p.modality}</h3><div>${list}</div></body>`);
  }
  window.viewCard = viewCard;

  // show winner modal
  function showWinnerModal(name, amount, winnersList){
    document.getElementById('winner-text').textContent = `${name} ha ganado`;
    document.getElementById('winner-amount').textContent = `Ha recibido: $${amount.toFixed(2)}`;
    const modal = document.getElementById('winner-modal');
    modal.classList.remove('hidden');

    // store last winners for marking payment
    lastWinnerRecords = winnersList || [];

    // confetti
    const container = document.getElementById('confetti-container');
    container.innerHTML = '';
    const colors = ['#b42222','#0f8a3c','#caa43f','#ff6b6b','#ffd86b','#7ad3a2'];
    for (let i=0;i<80;i++){
      const d = document.createElement('div');
      d.className = 'confetti';
      d.style.left = `${Math.random()*100}vw`;
      d.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
      d.style.width = `${6 + Math.random()*8}px`;
      d.style.height = d.style.width;
      d.style.animationDelay = `${Math.random()*0.6}s`;
      container.appendChild(d);
    }
  }

  function closeWinner(){
    document.getElementById('winner-modal').classList.add('hidden');
    document.getElementById('confetti-container').innerHTML = '';
  }

  // mark paid from modal: marks all winner records as paid and sets purchase.paymentState = 'paid'
  document.getElementById('mark-paid-btn').addEventListener('click', ()=> {
    lastWinnerRecords.forEach(r => {
      const purchase = purchases.find(p => p.id === r.purchaseId);
      if (purchase) purchase.paymentState = 'paid';
      // mark pending winners removal
      if (gameState.pendingWinners) gameState.pendingWinners = gameState.pendingWinners.filter(w => w.id !== r.id);
    });
    savePurchases(purchases);
    saveGame(gameState);
    renderAll();
    closeWinner();
  });

  // animate create player purchases
  function animateCreatePlayer(createdArray){
    // small confetti and pop for grid items ‚Äî we will create mini confetti at top-right
    createdArray.forEach(c => {
      // find active grid container and prepend? We will trigger CSS class on renderAll by using animate-create (already added)
    });
    // mini confetti at top-left
    const container = document.createElement('div');
    container.style.position = 'fixed';
    container.style.left = '20px';
    container.style.top = '80px';
    container.style.zIndex = 9999;
    document.body.appendChild(container);
    const colors = ['#b42222','#0f8a3c','#caa43f','#ff6b6b','#7ad3a2'];
    for (let i=0;i<20;i++){
      const d = document.createElement('div');
      d.className = 'confetti-mini';
      d.style.left = `${Math.random()*40}px`;
      d.style.top = `${Math.random()*40}px`;
      d.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
      container.appendChild(d);
    }
    setTimeout(()=> container.remove(), 1200);
  }

  // helper: highlight row briefly
  function highlightRow(purchaseId){
    // nothing complex: renderAll will show row with normal style; we can flash background by creating a temporary overlay
    // For simplicity, do nothing heavy here
  }

  // calculate function (button)
  function calculateForForm(){
    document.getElementById('calc-warning').textContent = '';
    const budget = parseFloat(document.getElementById('player-budget-input').value || 0);
    const checked = Array.from(document.querySelectorAll('.modal-chk:checked')).map(i => parseInt(i.value));
    if (!budget || budget <= 0) { document.getElementById('calc-result').textContent = ''; return alert('Captura presupuesto v√°lido'); }
    if (!checked.length) { document.getElementById('calc-result').textContent = ''; return alert('Selecciona al menos una modalidad'); }
    const parts = calculatePartitions(budget, checked);
    // check any zero
    const zero = parts.find(p => p.games < 1);
    if (zero) {
      document.getElementById('calc-warning').textContent = `La modalidad ${zero.modality} no alcanza 1 partida con la porci√≥n (${zero.share}$).`;
      document.getElementById('calc-result').textContent = '';
      return;
    }
    // show breakdown
    document.getElementById('calc-result').innerHTML = 'Resultado: ' + parts.map(p => `${p.modality}: ${p.games} partidas (precio ${p.price}$, porci√≥n ${p.share}$)`).join(' ‚Ä¢ ');
  }

  // helper shuffle
  function shuffleArray(a){
    const arr = a.slice();
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  // util: escape html
  function escapeHtml(text){ return (text+'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // helper: generate uuid (if crypto not available)
  if (!crypto || !crypto.randomUUID) {
    crypto.randomUUID = function() { return 'id-' + Math.random().toString(36).slice(2, 9); };
  }

  // event wiring
  document.getElementById('shuffle-btn').addEventListener('click', shuffleDeck);
  document.getElementById('draw-btn').addEventListener('click', () => { if (!isAuto) drawCard(); });
  document.getElementById('clean-btn').addEventListener('click', cleanAction);
  document.getElementById('auto-btn').addEventListener('click', toggleAuto);
  document.getElementById('calc-btn').addEventListener('click', calculateForForm);
  document.getElementById('add-player-btn').addEventListener('click', addPlayer);

  // prices save / reset
  document.getElementById('save-prices').addEventListener('click', ()=> {
    prices.price4 = Math.max(1, parseFloat(document.getElementById('price-4').value || 0));
    prices.price6 = Math.max(1, parseFloat(document.getElementById('price-6').value || 0));
    prices.price9 = Math.max(1, parseFloat(document.getElementById('price-9').value || 0));
    prices.houseProfit = Math.max(0, parseFloat(document.getElementById('house-profit').value || 0));
    savePrices(prices);
    renderAll();
    alert('Precios guardados');
  });
  document.getElementById('reset-prices').addEventListener('click', ()=> {
    if (!confirm('Restablecer precios por defecto?')) return;
    prices = defaultPrices();
    savePrices(prices);
    renderAll();
  });

  // toggle tabs
  const tabPlayer = document.getElementById('tab-player');
  const tabAdmin = document.getElementById('tab-admin');
  tabPlayer.addEventListener('click', ()=> { tabPlayer.classList.add('tab-active'); tabAdmin.classList.remove('tab-active'); window.scrollTo({top:0, behavior:'smooth'}); });
  tabAdmin.addEventListener('click', ()=> { tabAdmin.classList.add('tab-active'); tabPlayer.classList.remove('tab-active'); window.scrollTo({top:0, behavior:'smooth'}); });

  // keyboard: space to draw
  document.addEventListener('keydown', (e)=> {
    if (e.code === 'Space') {
      e.preventDefault();
      if (!isAuto) drawCard();
    }
  });

  // storage sync
  window.addEventListener('storage', (e)=> {
    if (e.key === KEY_PRICES) prices = loadPrices();
    if (e.key === KEY_GAME) gameState = loadGame();
    if (e.key === KEY_PURCHASES) purchases = loadPurchases();
    renderAll();
  });

  // helpers used above
  function calculatePartitions(budget, selectedModalities){
    const shareRaw = budget / selectedModalities.length;
    // limit to 2 decimals
    const share = Math.floor(shareRaw * 100) / 100;
    return selectedModalities.map(m => {
      const price = m === 4 ? prices.price4 : m === 6 ? prices.price6 : prices.price9;
      const games = Math.floor(share / price);
      return { modality: m, price, share, games };
    });
  }

  // initializations and UI hookups
  document.getElementById('modality-select').addEventListener('change', (e)=> { gameState.modality = parseInt(e.target.value); saveGame(gameState); renderAll(); });

  // addGames prompt exposed
  window.addGamesPrompt = addGamesPrompt;
  window.markPendingPaid = markPendingPaid;
  window.viewCard = viewCard;
  window.deletePurchase = deletePurchase;

  // helper: generate a visual card for manual draw of sample (not used)
  function generateCardForDebug(modality) { return generateCardForPurchase(modality); }

  // initial render
  prices = loadPrices();
  gameState = loadGame();
  purchases = loadPurchases();
  renderAll();

  // helper: drawCard exposure
  window.drawCard = drawCard;
  window.shuffleDeck = shuffleDeck;
  window.cleanAction = cleanAction;
  window.addPlayer = addPlayer;
  window.resetAll = ()=> {
    if (!confirm('¬øReiniciar todo? Se borrar√° localStorage del juego.')) return;
    localStorage.removeItem(KEY_PRICES);
    localStorage.removeItem(KEY_GAME);
    localStorage.removeItem(KEY_PURCHASES);
    prices = defaultPrices();
    gameState = defaultGame();
    purchases = [];
    savePrices(prices); saveGame(gameState); savePurchases(purchases);
    renderAll();
  };
  </script>
</body>
</html>
