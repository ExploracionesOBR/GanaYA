<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<!-- =========================
     Versi√≥n 9.5 - Gana YA!
     Actualizaci√≥n: Efectos, l√≥gica y dise√±o mejorados
     - Barajeo 3s (doble brillo c√°lido)
     - Reverso malla gris claro + logo centrado
     - Ganancia de la casa descontada al registrar
     - Bolsa siempre visible; Ganancia casa visible solo en admin ‚öôÔ∏è
     - Carta ganadora centrada y fija hasta reinicio
     - Eliminada modalidad 8 cartas (solo 4 y 6)
     - Grid fijo de 5 columnas para jugadores activos
     ========================= -->
<title>Gana YA! - Loter√≠a</title>
<style>
:root{
  --rojo:#b42222; --verde:#0f8a3c; --azul:#1565d8;
  --crema:#fff8ec;
  --gold-warm: rgba(255,200,80,1);
}
*{box-sizing:border-box}
body{
  font-family: 'Segoe UI', Tahoma, sans-serif;
  margin:0; padding:0; background:var(--crema); color:#222;
}

/* Container centered and aligned */
.container{
  max-width:1200px;
  margin:0 auto;
  padding:14px;
  display:flex;
  flex-direction:column;
  align-items:center;
}

/* Header / Title */
.header-row{
  width:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
}
h1.site-title{ margin:8px 0; font-size:28px; color:var(--rojo); text-align:center; }

/* Intro text */
.intro-text{
  text-align:center;
  color:#444;
  font-size:15px;
  margin:10px 0 18px 0;
  background:#fffbe6;
  padding:8px 14px;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
  max-width:980px;
}

/* Top controls row */
.controls-row{
  width:100%;
  display:flex;
  gap:10px;
  justify-content:center;
  margin-bottom:8px;
  flex-wrap:wrap;
}
input[type="number"]{ padding:8px 10px; border-radius:6px; border:1px solid #ddd; width:160px; }
button.btn{ padding:8px 12px; border-radius:8px; border:0; cursor:pointer; font-weight:600; }
.btn-blue{ background:#2b8af7; color:white; }
.btn-green{ background:#0f8a3c; color:white; }
.btn-yellow{ background:#f9d65d; color:#333; }

/* Admin totals fixed top inside container (only shown on admin panel or if toggled) */
.admin-totales{
  width:100%;
  position:sticky;
  top:0;
  background:#fff8e6;
  padding:10px;
  border-bottom:2px solid #f9d65d;
  display:flex;
  justify-content:space-around;
  font-weight:600;
  color:#333;
  z-index:100;
  box-shadow:0 2px 8px rgba(0,0,0,0.03);
}

/* Bolsa total: always visible */
.bolsa-panel{
  width:100%;
  display:flex;
  justify-content:center;
  margin:10px 0;
  gap:20px;
  align-items:center;
}
.bolsa-box{
  background:linear-gradient(180deg,#fff,#fff8ec);
  border-radius:10px;
  padding:8px 14px;
  box-shadow:0 4px 12px rgba(0,0,0,0.06);
  font-weight:700;
  color:#222;
}

/* Players area */
#players-area{
  width:100%;
  max-width:980px;
  margin:14px 0;
}
.players-grid{
  display:grid;
  grid-template-columns: repeat(5, 1fr); /* fixed 5 columns */
  gap:14px;
  justify-items:center;
  align-items:start;
}

/* Card thumb */
.card-thumb{
  width:120px;
  height:180px;
  border-radius:12px;
  background-size:cover;
  background-position:center;
  position:relative;
  transition: transform .28s ease, opacity .28s ease;
  box-shadow:0 8px 18px rgba(0,0,0,0.16);
  overflow:hidden;
}

/* Back pattern (malla gris claro) with centered logo (use your logo file name from v9.0) */
.card-thumb.back-pattern{
  background: repeating-linear-gradient(45deg, #f6f6f6 0 10px, #ececec 10px 20px);
  position:relative;
  filter:none;
}
.card-thumb.back-pattern::after{
  content:'';
  position:absolute;
  left:50%;
  top:50%;
  width:48px;
  height:48px;
  transform:translate(-50%,-50%);
  background-image: url('logo_1_entrada.png');
  background-size: contain;
  background-repeat: no-repeat;
  opacity:0.95;
  pointer-events:none;
}

/* Logo overlay on front corners */
.card-thumb .logo-overlay{
  position:absolute;
  right:8px;
  bottom:8px;
  width:44px;
  height:44px;
  background-image: url('logo_1_entrada.png');
  background-size:contain;
  background-repeat:no-repeat;
  filter:none !important;
  pointer-events:none;
}

/* Shine effect (gold warm) - 2 passes handled by animation iteration */
.card-thumb.shine::before{
  content:'';
  position:absolute;
  top:0; left:-90%;
  width:60%;
  height:100%;
  background: linear-gradient(120deg, rgba(255,200,80,0.95) 0%, rgba(255,200,80,0.7) 30%, rgba(255,200,80,0.3) 50%, rgba(255,200,80,0) 100%);
  transform: skewX(-20deg);
  pointer-events:none;
  z-index:3;
  animation: shineMove 0.9s linear 0s 2;
}
@keyframes shineMove{ 100% { left:140%; } }

/* Shuffle overlay (full screen) */
#shuffle-overlay{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background: rgba(0,0,0,0.35);
  z-index:9998;
}
#shuffle-overlay .shuffle-center{
  position:relative;
  width:760px;
  height:420px;
  pointer-events:none;
}

/* Visual sample cards inside overlay */
.shuffle-card{
  position:absolute;
  width:120px;
  height:180px;
  border-radius:10px;
  background-size:cover;
  background-position:center;
  box-shadow:0 8px 20px rgba(0,0,0,0.25);
  transform-origin:center center;
}

/* Winning card styling (center, large, fixed until reset) */
.winning-card{
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%) scale(1.8);
  z-index:9999;
  border:4px solid gold;
  box-shadow:0 0 30px rgba(255,215,0,0.95);
  transition:transform .6s ease;
  background-size:cover;
  background-position:center;
  border-radius:12px;
  width:240px;
  height:360px;
}

/* Utility small styles */
.info-muted{ color:#666; font-size:13px; margin-top:6px; text-align:center; }
.hidden{ display:none !important; }

.removed-8{ display:none !important; } /* fallback to hide residual 8-card elements */

</style>
</head>
<body>
  <div class="container">
    <!-- admin totals (Ganancia casa visible solo en administrador view) -->
    <div id="totales-admin" class="admin-totales" style="display:none;">
      <div>üè† Ganancia total de la casa: <span id="gananciaCasaTotal">$0</span></div>
      <div>üí∞ Bolsa total del juego: <span id="bolsaTotal">$0</span></div>
    </div>

    <div class="header-row">
      <h1 class="site-title">üé¥ GANA YA!</h1>
    </div>

    <p class="intro-text">
      üéâ <strong>Gana YA!</strong> es un sitio de entretenimiento y convivencia familiar.
      Disfruta de la emoci√≥n de la loter√≠a mexicana en un ambiente responsable y divertido.
    </p>

    <div class="controls-row" role="region" aria-label="Controles">
      <input id="input-budget" type="number" placeholder="Ingresa tu presupuesto üí∞" />
      <button id="btn-save-purchase" class="btn btn-green">Guardar compra</button>
      <button id="btn-shuffle" class="btn btn-blue">üé≤ BARAJEAR</button>
      <button id="btn-auto-toggle" class="btn btn-yellow">‚è±Ô∏è CARTAS AUTOM√ÅTICO</button>
    </div>

    <div class="bolsa-panel">
      <!-- Bolsa always visible -->
      <div class="bolsa-box">üí∞ Bolsa total: <span id="bolsaTotalInline">$0</span></div>
    </div>

    <!-- Players area -->
    <div id="players-area">
      <div class="players-grid" id="players-grid">
        <!-- Cards will be injected here -->
      </div>
      <p class="info-muted">Cartas de jugadores activos (m√°x. 5 por fila; crece hacia abajo si hay m√°s).</p>
    </div>

    <!-- Shuffle overlay placeholder -->
    <div id="shuffle-overlay" aria-hidden="true"></div>

    <!-- NOTE: keep any other modals / markup from v9.0 here (not removed) -->
  </div>

<script>
/* ===========================================
   index_v9.5 - Script section
   Organized into labeled blocks for easy navigation
   // üé¥ BARAJEO Y EFECTOS
   // üí∞ ADMINISTRACI√ìN Y C√ÅLCULOS
   // üèÜ GANADOR Y SONIDO
   // ‚öôÔ∏è FUNCIONES ADICIONALES / AUTO-DRAW
   =========================================== */

/* -----------------------------
   Helper utilities
   ----------------------------- */
function $qs(sel){ return document.querySelector(sel); }
function $qsa(sel){ return Array.from(document.querySelectorAll(sel)); }
function formatMoney(n){ return '$' + (Number(n)||0); }

/* Globals (preserve any that existed) */
window.jugadoresActivos = window.jugadoresActivos || []; // array of player objects
window.modalidades = window.modalidades || [
  { key: '4cartas', nombre:'4 Cartas', precio:40, ganancia:10 },
  { key: '6cartas', nombre:'6 Cartas', precio:60, ganancia:15 }
]; // default example; your real data may populate this

/* -----------------------------
   üé¥ BARAJEO Y EFECTOS
   - shufflePendingToFullScreen() main visual flow
   - shine effect activation for visible main cards
   ----------------------------- */

function cardImageUrl(id){
  // adapt to your resource path - keep as in original project
  return `Cartas_baraja_loteria/${id}.png`;
}

/* Visual shuffle + overlay: 3 seconds total; applies back-pattern to visible cards
   and triggers a warm gold shine double pass at the end (CSS handles 2 iterations). */
function shufflePendingToFullScreen(){
  if(window.animShuffling) return;
  window.animShuffling = true;
  if(typeof disableControls === 'function') disableControls(true);

  // overlay prepare
  const overlay = document.getElementById('shuffle-overlay') || (function(){ const o=document.createElement('div'); o.id='shuffle-overlay'; document.body.appendChild(o); return o; })();
  overlay.classList.add('visible');
  overlay.style.display = 'flex';
  overlay.innerHTML = '<div class="shuffle-center"></div>';

  // mark visible main cards with back-pattern
  const visibleCards = Array.from(document.querySelectorAll('#players-area .card-thumb'));
  visibleCards.forEach(c => c.classList.add('back-pattern'));

  // sample pending deck (we assume window.game.deck exists; fallback to sequential numbers)
  const pending = (window.game && window.game.deck) ? game.deck.filter(id=> !window.cartasPasadas?.includes(id)) : Array.from({length:36}, (_,i)=> i+1);
  const sample = pending.slice(0,14);
  const center = overlay.querySelector('.shuffle-center');

  const cards = sample.map((cid,i)=>{
    const el = document.createElement('div');
    el.className = 'shuffle-card';
    el.style.backgroundImage = `url('${cardImageUrl(cid)}')`;
    el.style.left = '50%';
    el.style.top = '50%';
    el.style.transform = 'translate(-50%,-50%)';
    el.style.zIndex = 100 + i;
    center.appendChild(el);
    return {el, cid};
  });

  // staggered explosion effect (approx 3s total)
  cards.forEach((c, idx) => {
    setTimeout(()=> {
      c.el.style.transition='transform .8s ease, opacity .8s ease';
      const tx = (Math.random()*640 - 320);
      const ty = (Math.random()*320 - 160);
      const rot = (Math.random()*720 - 360);
      c.el.style.transform = `translate(${tx}px, ${ty}px) rotate(${rot}deg) scale(.92)`;
    }, idx * 120);
  });

  // after some time, bring into a tidy stack
  setTimeout(()=> {
    cards.forEach((c, ii) => {
      c.el.style.transition='transform .6s ease, opacity .6s ease';
      c.el.style.transform = `translate(${(ii - cards.length/2) * 8}px, -40px) rotate(${(Math.random()*12)-6}deg) scale(.95)`;
    });
  }, 1600);

  // then convert to back-pattern with logo visual
  setTimeout(()=> {
    cards.forEach((c, ii) => {
      c.el.style.transition='transform .45s ease, opacity .45s ease';
      c.el.style.backgroundImage = `linear-gradient(#ddd,#bbb)`;
      c.el.innerHTML = '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;"><img src="logo_1_entrada.png" style="width:80px;height:80px;opacity:.95"></div>';
    });
  }, 2200);

  // finalize
  setTimeout(()=> {
    overlay.classList.remove('visible');
    overlay.style.display = 'none';
    overlay.innerHTML = '';
    window.animShuffling = false;
    if(typeof disableControls === 'function') disableControls(false);
    if(typeof shufflePending === 'function') shufflePending();
    if(typeof renderAll === 'function') renderAll();

    // Trigger shine on visible cards (CSS handles double pass; remove class after duration)
    const vis = Array.from(document.querySelectorAll('#players-area .card-thumb'));
    vis.forEach(c=>{
      c.classList.add('shine');
      setTimeout(()=> c.classList.remove('shine'), 1900);
    });
  }, 3000);
}

/* connect existing BARAJEAR button to visual shuffle
   (keeps compatibility with any existing shuffle logic) */
(function connectShuffleButton(){
  const btn = document.getElementById('btn-shuffle');
  if(!btn) return;
  btn.addEventListener('click', (e)=>{
    // call existing shufflePendingToFullScreen if already present logic, else run our visual
    if(typeof window.originalShufflePendingToFullScreen === 'function'){
      window.originalShufflePendingToFullScreen();
    } else {
      shufflePendingToFullScreen();
    }
  });
})();

/* -----------------------------
   üí∞ ADMINISTRACI√ìN Y C√ÅLCULOS
   - registrarJugador()
   - actualizarBolsa()
   - showAdminTotalsIfAdmin()
   ----------------------------- */

/* Register player helper: deduct house gain per card on registration
   j: { id, playerName, modalidadKey, costo, comision }
   - modalidadKey should match one in window.modalidades
   - comision === 0 means exempt (no house gain subtracted)
*/
function registrarJugador(j){
  window.modalidades = window.modalidades || window.modalidades;
  const mod = window.modalidades.find(m=> m.key === j.modalidadKey) || window.modalidades[0] || {};
  const gananciaCasa = Number(mod.ganancia || 0);
  const costo = Number(mod.precio || j.costo || 0);
  const aporte = (j.comision === 0) ? costo : (costo - gananciaCasa);
  j.aporte = aporte;
  j.gananciaCasa = (j.comision === 0) ? 0 : gananciaCasa;
  window.jugadoresActivos = window.jugadoresActivos || [];
  window.jugadoresActivos.push(j);
  actualizarBolsa();
}

/* actualizarBolsa: calculates both totals and updates UI
   - Bolsa total (lo que hay para premios) visible always (bolsaTotalInline)
   - Ganancia casa total visible only in admin panel (gananciaCasaTotal)
*/
function actualizarBolsa(){
  window.jugadoresActivos = window.jugadoresActivos || [];
  const totalAporte = window.jugadoresActivos.reduce((s,j)=> s + (Number(j.aporte)||0), 0);
  const totalGananciaCasa = window.jugadoresActivos.reduce((s,j)=> s + (Number(j.gananciaCasa)||0), 0);

  // Bolsa inline always visible
  const bolsaInline = document.getElementById('bolsaTotalInline');
  if(bolsaInline) bolsaInline.innerText = '$' + totalAporte;

  // Ganancia casa panel (admin)
  const ganEl = document.getElementById('gananciaCasaTotal');
  if(ganEl) ganEl.innerText = '$' + totalGananciaCasa;

  // Also update the twin panel if present (keeps backward compatibility)
  const bolsaEl = document.getElementById('bolsaTotal');
  if(bolsaEl) bolsaEl.innerText = '$' + totalAporte;
}

/* Show admin totals only if user is in admin panel or role is admin.
   Integration note: call this function from your login/init flow (check role or current view).
*/
function showAdminTotalsIfAdmin(isAdminView){
  try{
    const totales = document.getElementById('totales-admin');
    if(!totales) return;
    // If called with boolean flag: show only if true; otherwise attempt to detect currentUser role
    if(typeof isAdminView === 'boolean'){
      totales.style.display = isAdminView ? 'flex' : 'none';
      return;
    }
    if(window.currentUser && window.currentUser.role === 'ADMINISTRADOR'){
      totales.style.display = 'flex';
    } else {
      totales.style.display = 'none';
    }
  }catch(e){}
}

/* -----------------------------
   üèÜ GANADOR Y SONIDO
   - showWinnerEnhancements(): plays applause and shows winning card centered (fixed)
   - clearWinningCard(): remove fixed winning card (on reset)
   ----------------------------- */

function showWinnerEnhancements(selectorOrEl){
  // play applause skipping initial silence
  try{
    const ap = new Audio('APLAUSOS_GANADOR.mp3');
    ap.currentTime = 1;
    ap.play().catch(()=>{});
  }catch(e){}

  try{
    let el = null;
    if(typeof selectorOrEl === 'string') el = document.querySelector(selectorOrEl);
    else if(selectorOrEl instanceof Element) el = selectorOrEl;
    else el = document.querySelector('#players-area .card-thumb.winner') || document.querySelector('#players-area .card-thumb');

    if(!el) return;
    // clone visual to avoid moving original DOM element
    const clone = el.cloneNode(true);
    clone.id = 'card-winner';
    clone.classList.add('winning-card');
    // ensure it is big and centered
    clone.style.width = '240px';
    clone.style.height = '360px';
    document.body.appendChild(clone);
  }catch(e){}
}

/* Clear winning card (call when restarting game) */
function clearWinningCard(){
  const w = document.getElementById('card-winner');
  if(w) w.remove();
}

/* -----------------------------
   ‚öôÔ∏è FUNCIONES ADICIONALES / AUTO-DRAW
   - startAutoDraw / stopAutoDraw
   - helper UI wiring to toggle auto
   ----------------------------- */

window.autoInterval = null;
function startAutoDraw(intervalMs){
  if(window.autoInterval) return;
  window.autoInterval = setInterval(()=>{
    if(typeof drawOne === 'function') drawOne();
  }, intervalMs || 2000);
}
function stopAutoDraw(){
  if(window.autoInterval){ clearInterval(window.autoInterval); window.autoInterval = null; }
}

/* Connect the CARTAS AUTOMATICO toggle button */
(function connectAutoToggle(){
  const btn = document.getElementById('btn-auto-toggle');
  if(!btn) return;
  let running = false;
  btn.addEventListener('click', ()=>{
    if(!running){
      startAutoDraw(2000);
      btn.classList.add('btn-green');
      btn.textContent = '‚èπÔ∏è DETENER AUTOM√ÅTICO';
      running = true;
    } else {
      stopAutoDraw();
      btn.classList.remove('btn-green');
      btn.textContent = '‚è±Ô∏è CARTAS AUTOM√ÅTICO';
      running = false;
    }
  });
})();

/* -----------------------------
   Initialization helpers:
   - renderPlayersGrid (small renderer for players active)
   - sample data / binding for testing
   ----------------------------- */

function renderPlayersGrid(){
  const grid = document.getElementById('players-grid');
  if(!grid) return;
  grid.innerHTML = '';
  window.jugadoresActivos = window.jugadoresActivos || [];
  window.jugadoresActivos.forEach((p, idx)=>{
    const slot = document.createElement('div');
    slot.className = 'card-thumb';
    slot.id = 'player-' + (p.id || idx);
    // if player has assigned card id, show that image, else a placeholder
    const cardId = p.cardId || ((p.cards && p.cards[0]) ? p.cards[0] : null);
    if(cardId){
      slot.style.backgroundImage = `url('${cardImageUrl(cardId)}')`;
    } else {
      slot.style.backgroundImage = `linear-gradient(#fff,#eee)`;
      slot.innerHTML = `<div style="padding:8px;text-align:center;color:#666;">${p.playerName || 'Jugador'}</div>`;
    }
    // if player is winner flag, add class 'winner'
    if(p.isWinner) slot.classList.add('winner');
    // add logo overlay to front
    const logo = document.createElement('div');
    logo.className = 'logo-overlay';
    slot.appendChild(logo);

    grid.appendChild(slot);
  });
}

/* Example: when page loads we can seed some sample players (remove in production) */
(function seedSamplePlayers(){
  if(window.jugadoresActivos && window.jugadoresActivos.length) return;
  // sample demo players (you can remove or replace)
  const demo = [
    { id:'p1', playerName:'Luis P.', modalidadKey:'4cartas', cardId:1, comision:1 },
    { id:'p2', playerName:'Ana G.', modalidadKey:'4cartas', cardId:2, comision:1 },
    { id:'p3', playerName:'Carlos R.', modalidadKey:'6cartas', cardId:3, comision:1 },
  ];
  // register via registrarJugador to compute aporte and gananciaCasa
  demo.forEach(d => registrarJugador(d));
  renderPlayersGrid();
  actualizarBolsa();
})();

/* If your system has a login flow, call showAdminTotalsIfAdmin(true/false) accordingly.
   For demo here, we hide admin totals by default (only visible when admin view toggled).
*/

/* -----------------------------
   Wire up some quick UI actions for demo/testing
   - btn-save-purchase: simple demo add player (for manual test)
   - clicking on a card in grid will mark it as winner (demo)
   ----------------------------- */

document.getElementById('btn-save-purchase')?.addEventListener('click', ()=>{
  // demo quick-add (in production replace with your purchase flow)
  const name = prompt('Nombre del jugador:');
  if(!name) return;
  // choose modality default 4cartas
  const mod = window.modalidades[0] || { key:'4cartas', precio:40, ganancia:10 };
  const newP = { id: 'p' + (Math.random()*100000|0), playerName: name, modalidadKey: mod.key, cardId: Math.floor(Math.random()*54)+1, comision:1 };
  registrarJugador(newP);
  renderPlayersGrid();
});

/* Winner demo: click a player card to set as winner (for testing) */
document.addEventListener('click', (e)=>{
  const card = e.target.closest('.card-thumb');
  if(!card) return;
  // mark clicked as winner for demo
  const id = card.id;
  // clear previous winners
  window.jugadoresActivos.forEach(j=> j.isWinner = false);
  // find matching player by id if available
  const pIdx = window.jugadoresActivos.findIndex(j=> ('player-' + (j.id||'')).toString() === id);
  if(pIdx >= 0){
    window.jugadoresActivos[pIdx].isWinner = true;
    // show winner enhancements
    // show applause and fixed card
    const selector = `#${id}`;
    showWinnerEnhancements(selector);
  } else {
    // fallback for demo: clone clicked card
    showWinnerEnhancements(card);
  }
  renderPlayersGrid();
});

/* Expose clearWinningCard for your reset action */
window.clearWinningCard = clearWinningCard;

/* -----------------------------
   End script
   ----------------------------- */
</script>
</body>
</html>
