<!doctype html><html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üé¥ GANA YA! - Loter√≠a Interactiva Mexicana (v9.6)</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%23ff6bcb'/%3E%3Ctext x='50%25' y='55%25' font-size='18' font-family='Arial' fill='white' text-anchor='middle' font-weight='700'%3EG%3C/text%3E%3C/svg%3E">
<style>
:root{ --rojo:#b42222; --verde:#0f8a3c; --azul:#1565d8; --naranja:#f77f00; --crema:#fff8ec; --sombra:0 10px 28px rgba(0,0,0,0.12); --accent1:#ffd60a; --accent2:#ff6bcb; }
*{box-sizing:border-box} html,body{height:100%}
body{ font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; padding:0; background:var(--crema); color:#222;
  background-image: radial-gradient(#ffd60a 1px, transparent 1px), radial-gradient(#e63946 1px, transparent 1px);
  background-position: 0 0, 25px 25px; background-size: 50px 50px; }

/* A J U S T E S   D E   A N C H O S  (COMPACTOS) */
.container{ max-width:1200px; margin:8px auto; padding:0 8px; }
.header-row-top{ display:flex; align-items:center; gap:12px; justify-content:space-between; margin-bottom:4px; } /* Reducido de 6px a 4px */

/* AJUSTE CLAVE: Reposicionamiento de elementos */
.title-box{ display:flex; align-items:center; gap:12px; flex:1; justify-content:center; } /* Mantiene el t√≠tulo centrado */
.title { font-size:56px; font-weight:900; color:var(--rojo); margin:0; animation: fiesta 3.2s linear infinite; }
.subtitle { color:#0b7a3b; font-size:14px; margin-top:4px; text-align:center; }

@keyframes fiesta { 0%{ color:#e63946 }15%{ color:var(--accent1) }30%{ color:#2a9d8f }45%{ color:#6d9df5 }60%{ color:var(--accent2) }75%{ color:#ff9e00 }100%{ color:#e63946 } }

.header-controls{ display:flex; gap:12px; align-items:center; } /* Controls a la izquierda */
.header-right{ display:flex; align-items:center; gap:12px; } /* Nuevo contenedor para el logo a la derecha */
.logo-box img{ width:96px; height:96px; object-fit:contain; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.12); }

.bolsa-compact{ display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:10px; background:linear-gradient(90deg,#e6fff1,#fff7e6); border:3px solid #c9a700; box-shadow:0 8px 20px rgba(0,0,0,0.06); }
.bolsa-compact .label{ font-weight:900; color:#2d6b25; font-size:14px; }
.bolsa-compact .amount{ font-weight:900; color:#b45309; font-size:18px; }

.toggle-btn{ padding:8px 12px; border-radius:10px; border:none; font-weight:800; cursor:pointer; box-shadow:0 6px 14px rgba(0,0,0,0.08); }
.toggle-play{ background:#1565d8;color:white; }
.toggle-admin{ background:#f3f4f6;color:#111; }

/* AJUSTE CLAVE: Ancho fijo para las columnas y reducci√≥n de gap/margin */
.main-grid{ display:grid; grid-template-columns: 280px 1fr 400px; gap:8px; align-items:start; margin-top:8px; }
@media(max-width:1200px){ .main-grid{ grid-template-columns:1fr; } }

.mex-frame{ background:#fff; border-radius:12px; padding:10px; border:4px solid var(--rojo); box-shadow:var(--sombra); }
.mex-frame-small{ background:#fff; border-radius:10px; padding:10px; border:3px solid var(--rojo); box-shadow:0 6px 14px rgba(0,0,0,.06); }

/* AJUSTE UX: Centrar contenido de mex-frame-small por defecto */
#control-partida {
  text-align: center;
}
#control-partida h3 {
  text-align: center;
}

/* AJUSTE CLAVE: Forzar 5 columnas de jugadores */
.players-grid{ display:grid; grid-template-columns: repeat(5,1fr); gap:8px; align-items:start; }
@media(max-width:1100px){ .players-grid{ grid-template-columns: repeat(4,1fr); } }
@media(max-width:900px){ .players-grid{ grid-template-columns: repeat(3,1fr); } }
@media(max-width:640px){ .players-grid{ grid-template-columns: 1fr; } }

.player-card{ background:#fff; border-radius:10px; padding:8px; text-align:center; box-shadow:0 6px 16px rgba(0,0,0,0.06); cursor:pointer; min-height:220px; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; transition:transform .18s ease, box-shadow .18s ease; }
.player-card:hover{ transform:translateY(-4px); box-shadow:0 18px 36px rgba(0,0,0,.12); }
.player-name{ font-weight:900; margin-top:4px; font-size:15px; }
.player-cards{ margin-top:8px; display:flex; flex-direction:column; gap:6px; align-items:center; overflow:hidden; }

/* AJUSTE CLAVE: Estilo para la simulaci√≥n de espacios vac√≠os */
.player-card.simulated {
  cursor:default; 
  opacity:1; /* Totalmente visible para mantener el espacio */
  background:#fff; 
  border:1px solid #ddd; 
  box-shadow:none;
  min-height:220px; 
}
.player-card.simulated .player-name, 
.player-card.simulated .player-cards .card-thumb.back-pattern::after {
  display: none; /* Oculta texto y logo del patr√≥n */
}
.player-card.simulated .player-cards .card-thumb{
  background: #ffffff !important; /* Fuerza fondo blanco */
  border: 1px dashed #eee; /* Borde sutil para que se vea el espacio */
  filter: none !important; /* Asegura que no tenga filtros */
}

.card-thumb{ width:74px; height:106px; border-radius:8px; background-size:cover; background-position:center; position:relative; transition:transform .28s ease, opacity .28s ease; }
  .card-thumb.back-pattern{
    background: repeating-linear-gradient(45deg, #f6f6f6 0 10px, #ececec 10px 20px);
    position:relative;
    filter:none;
  }
  .card-thumb.back-pattern::after{
    content:'';
    position:absolute;
    left:50%; top:50%;
    width:48px; height:48px;
    transform:translate(-50%,-50%);
    background-image: url('logo_1_entrada.png');
    background-size: contain;
    background-repeat: no-repeat;
    opacity:0.95;
    pointer-events:none;
  }
  .card-thumb.shine::before{
    content:'';
    position:absolute; top:0; left:-90%;
    width:60%; height:100%;
    background: linear-gradient(120deg, rgba(255,200,80,0.9) 0%, rgba(255,200,80,0.6) 30%, rgba(255,200,80,0.2) 50%, rgba(255,200,80,0) 100%);
    transform: skewX(-20deg);
    pointer-events:none;
    z-index:3;
    animation: shineMove 0.8s linear 0s 2;
  }
  @keyframes shineMove{ 100% { left:140%; } }

.card-thumb.passed{ filter:grayscale(0.4) brightness(.7); }
.sticker{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; }
.sticker img{ width:42px; height:42px; filter:none; }

.controls { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; justify-content:center; }
.btn{ padding:8px 10px; border-radius:8px; font-weight:800; border:none; cursor:pointer; color:white; }
.btn-blue{ background:#1565d8 } .btn-red{ background:var(--rojo)} .btn-green{ background:var(--verde)} .btn-muted{ background:#f3f4f6; color:#111 }

.current-card{ min-height:180px; border-radius:8px; display:flex; align-items:center; justify-content:center; background:#fff; box-shadow:var(--sombra); border:3px solid #eee; padding:8px; }
.last-cards{ display:flex; gap:6px; justify-content:center; }

.admin-row{ display:flex; gap:8px; align-items:flex-start; }
.admin-col{ flex:1; }

.price-grid{ display:flex; gap:8px; }
.price-box{ padding:12px; border-radius:12px; border:2px dashed #eee; background:#fff; text-align:center; font-weight:800; box-shadow:0 6px 14px rgba(0,0,0,0.03); min-height:100px; flex:1; }

.table-wrap{ overflow:auto; max-height:300px; border:1px solid #eee; border-radius:8px; padding:6px; background:#fff; font-size:12px; }

.filter-btn{ padding:6px 8px; border-radius:8px; border:none; cursor:pointer; font-weight:800; background:#f3f4f6 }
.filter-btn.active-4{ background: #d1fae5; box-shadow:0 8px 18px rgba(34,197,94,0.08); }
.filter-btn.active-6{ background: #dbeafe; box-shadow:0 8px 18px rgba(37,99,235,0.08); }
.filter-btn.active-all{ background: #f8fafc; box-shadow:0 8px 18px rgba(99,102,241,0.04); }

.modal-back{ position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:9999; }
.modal{ background:#fff; border-radius:12px; padding:12px; width:820px; max-width:96%; box-shadow:var(--sombra); position:relative; }
.hidden{ display:none; }

.shuffle-overlay{ position:fixed; inset:0; z-index:2200; display:none; align-items:center; justify-content:center; background:rgba(255,255,255,0.98); }
.shuffle-overlay.visible{ display:flex; }
.shuffle-card{ width:240px; height:340px; background-size:cover; border-radius:12px; box-shadow:0 20px 40px rgba(0,0,0,.25); position:absolute; transform-origin:center; transition:transform .45s ease, opacity .45s ease; }

#confetti-canvas{ position:fixed; left:0; top:0; width:100vw; height:100vh; z-index:3000; pointer-events:none; display:none; }

.small-muted{ color:#6b7280; font-size:12px; }
.badge{ display:inline-block; padding:4px 8px; border-radius:999px; color:white; font-weight:700; font-size:11px; margin-left:4px; }
.badge-porpagar{ background:#d97706 } .badge-pagado{ background:#2a9d8f } .badge-jugando{ background:#1565d8 }

.input{ width:100%; padding:8px 10px; border-radius:8px; border:1px solid #ddd; }

.tooltip{ position:relative; }
.tooltip .tip{ position:absolute; bottom:110%; left:50%; transform:translateX(-50%); background:#111; color:#fff; padding:6px 8px; border-radius:6px; font-size:12px; display:none; white-space:nowrap; }
.tooltip.show .tip{ display:block; }
/* Estilo del Modal de Detalle de Ganador */
#modal-winner-detail .modal{
  width: auto;
  padding: 20px;
  max-width: 96%;
  text-align: center;
  border: 5px solid var(--accent1);
  background: #fff;
}
#winner-detail-player-cards{
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  margin-top: 16px;
}
#winner-detail-player-cards .card-thumb{
  width: 90px;
  height: 130px;
}
#winner-detail-player-cards .card-thumb.winner-card{
  box-shadow: 0 0 0 6px var(--rojo), 0 0 20px rgba(255,200,80,0.8);
  transform: scale(1.15);
  transition: transform 0.3s ease-in-out;
}
</style>
</head>
<body>

<div class="container">

  <div class="header-row-top">

    <div class="header-controls">
      <div class="bolsa-compact">
        <div style="font-weight:900">üí∞ Bolsa</div>
        <div class="amount" id="bolsa-amount">$0.00</div>
      </div>
      <button id="btn-view-play" class="toggle-btn toggle-play">EN JUEGO</button>
      <button id="btn-view-admin" class="toggle-btn toggle-admin">‚öôÔ∏è</button>
    </div>

    <div class="title-box">
      <div>
        <div class="title">üéâ GANA YA!</div>
        <div class="subtitle">Gana Ya! es una p√°gina de car√°cter interactivo y de entretenimiento.</div>
      </div>
    </div>

    <div class="header-right">
      <div class="logo-box"><img id="logo-img" src="logo_1_entrada.png" alt="logo"></div>
    </div>
  </div>

  <div class="main-grid" id="main-grid">

    <aside class="mex-frame-small winners" id="winners-panel" aria-label="√öltimos Ganadores">
      <h3 style="margin:0 0 8px 0; text-align:center">√öLTIMOS GANADORES</h3>
      <div class="winners-list" id="winners-list" style="margin-top:4px"><div class="small-muted" style="text-align:center">A√∫n no hay ganadores.</div></div>
    </aside>

    <section class="mex-frame" id="players-section" style="min-height:420px;">
      <h2 style="text-align:center;margin:0 0 8px 0">CARTAS DE JUGADORES ACTIVOS</h2>
      <div class="players-grid" id="players-area" style="margin-top:8px">
        <div class="small-muted" style="padding:18px; text-align:center">A√∫n no hay jugadores.</div>
      </div>
    </section>

    <aside class="controls-panel" id="controls-panel">
      <div class="mex-frame-small" aria-label="Control de partida" id="control-partida" style="margin-top:4px">
        <h3 style="margin:0">CONTROL DE PARTIDA</h3>
        <div class="small-muted" style="margin-top:4px">Barajea, tira cartas o activa autom√°tico ‚Äî selecciona modalidad</div>

        <div style="margin-top:8px; text-align:center;">
          <select id="select-modality" style="padding:10px;border-radius:8px;border:1px solid #ddd;font-weight:800;width:90%;">
            <option value="4">4 cartas</option>
            <option value="6">6 cartas</option>
          </select>
        </div>

        <div class="controls" style="margin-top:8px">
          <div id="game-controls">
            <button id="btn-shuffle" class="btn btn-blue">BARAJEAR</button>
            <button id="btn-draw" class="btn btn-red">TIRAR CARTA</button>
            <button id="btn-auto" class="btn btn-green">CARTAS AUTOM√ÅTICO</button>
          </div>
          <button id="btn-reset" class="btn btn-red hidden" style="width:100%; padding:12px; font-size:18px;">REINICIAR PARTIDA</button>
        </div>

        <div style="text-align:center;margin-top:6px" class="small-muted">Cartas restantes: <span id="deck-count">54</span></div>
      </div>

      <div class="mex-frame-small" style="margin-top:8px">
        <h3 style="text-align:center;margin:0">CARTA EN JUEGO</h3>
        <div id="current-card" class="current-card" style="margin-top:6px">
          <div class="small-muted">Esperando barajeo...</div>
        </div>
      </div>

      <div class="mex-frame-small" style="margin-top:8px">
        <h3 style="text-align:center;margin:0">√öLTIMAS 3 CARTAS</h3>
        <div id="last-cards" class="last-cards" style="margin-top:6px; display:flex; gap:8px; justify-content:center;"></div>
      </div>

    </aside>

  </div> <section id="view-admin" class="mex-frame hidden" style="margin-top:8px">
    <div style="display:flex;gap:8px; justify-content:flex-end; margin-bottom:8px;">
      <button id="btn-export-admin" class="btn btn-blue">üìÑ Generar PDF (Con logo)</button>
      <button id="btn-clear-admin" class="btn btn-red">üßπ Reiniciar D√≠a</button>
    </div>
    
    <div class="mex-frame-small" id="house-winnings-box" style="margin-bottom:8px; text-align:center;">
      <h3 style="margin:0 0 4px 0">GANANCIA BRUTA DE LA CASA (ACUMULADA)</h3>
      <div id="house-profit-amount" style="font-size:24px; font-weight:900; color:var(--verde)">$0.00</div>
      <div class="small-muted">(Ventas - Premios Pagados)</div>
    </div>

    <div class="admin-row">
      <div class="admin-col mex-frame-small">
        <h3 style="margin:0 0 8px 0">Modalidades - Precio & Ganancia</h3>
        <div class="price-grid" style="margin-top:4px">
          <div class="price-box"><div style="font-size:16px">4 Cartas</div><div style="display:flex; gap:6px; margin-top:6px;"><input id="price4" class="input" type="number" value="10" min="1"><input id="profit4" class="input" type="number" value="2" min="0"></div><div class="small-muted" style="margin-top:4px">Precio ‚Ä¢ Ganancia</div></div>
          <div class="price-box"><div style="font-size:16px">6 Cartas</div><div style="display:flex; gap:6px; margin-top:6px;"><input id="price6" class="input" type="number" value="12" min="1"><input id="profit6" class="input" type="number" value="3" min="0"></div><div class="small-muted" style="margin-top:4px">Precio ‚Ä¢ Ganancia</div></div>
        </div>
        <div style="display:flex; gap:8px; margin-top:10px;"><button id="save-prices" class="btn btn-green">Guardar</button><button id="reset-prices" class="btn btn-muted">Reset</button></div>
      </div>

      <div class="admin-col mex-frame-small">
        <h3 style="margin:0 0 8px 0">Registrar Jugador (Caja)</h3>
        <div style="display:grid; gap:8px; margin-top:4px">
          <input id="input-name" placeholder="Nombre completo" class="input">
          <input id="input-cell" placeholder="Celular (ej. 5512345678)" class="input">
          <input id="input-clabe" placeholder="CLABE / Cuenta" class="input">
          <input id="input-budget" placeholder="Ingresa presupuesto" class="input" type="number" min="0" value="">
          <div style="display:flex; gap:4px;">
            <div style="flex:1"><label class="small-muted">4 cartas - Cantidad</label><input id="qty4" type="number" min="0" value="0" class="input"></div>
            <div style="flex:1"><label class="small-muted">6 cartas - Cantidad</label><input id="qty6" type="number" min="0" value="0" class="input"></div>
          </div>
          <div style="display:flex; gap:8px;"><button id="btn-register" class="btn btn-green">Registrar</button></div>
          <div id="calc-info" class="small-muted"></div>
        </div>
      </div>
    </div>

    <div style="margin-top:8px" class="mex-frame-small">
      <div style="display:flex; gap:8px; align-items:center; justify-content:space-between;"><div style="font-weight:900">Administraci√≥n de Jugadores / Compras</div><div class="admin-actions"><button id="filter-all" class="filter-btn filter-all filter-btn active-all">VER TODO</button><button id="filter-4" class="filter-btn">4 CARTAS</button><button id="filter-6" class="filter-btn">6 CARTAS</button></div></div>
      <div class="table-wrap" style="margin-top:6px">
        <table style="width:100%; border-collapse:collapse;">
          <thead style="background:#fafafa; position:sticky; top:0"><tr><th style="text-align:left;padding:6px">ID</th><th style="text-align:left;padding:6px">Jugador</th><th style="padding:6px">Modalidad</th><th style="padding:6px">Partidas</th><th style="padding:6px">Pagado</th><th style="padding:6px">Estado</th><th style="padding:6px">Acciones</th></tr></thead>
          <tbody id="players-table"><tr><td colspan="7" style="text-align:center;padding:18px;color:#888">No hay operaciones.</td></tr></tbody>
        </table>
      </div>
    </div>
  </section>

  <footer style="text-align:center; margin-top:8px; padding-bottom:8px;" class="small-muted">Coloca <strong>logo_1_entrada.png</strong> en la ra√≠z y la carpeta <strong>Cartas_baraja_loteria/</strong> con las 54 im√°genes.</footer>
</div>

<div id="modal-player" class="hidden"><div class="modal-back" id="modal-player-back"><div class="modal"><button id="modal-close-x" style="position:absolute;right:10px;top:8px;border:none;background:transparent;font-size:18px;cursor:pointer">‚úñ</button><h3 id="modal-player-name">Jugador</h3><div id="modal-body"></div><div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px"><button id="modal-close" class="btn btn-muted">Cerrar</button></div></div></div></div>

<div id="modal-winner" class="hidden"><div class="modal-back" id="modal-winner-back"><div class="modal" style="text-align:center"><button id="winner-close" style="position:absolute; right:10px; top:8px; border:none; background:transparent; font-size:20px; cursor:pointer;">‚ùå</button><div style="font-size:28px; font-weight:900; color:var(--rojo); margin-bottom:6px" id="winner-title">üéâ ¬°FELICIDADES!</div><div id="winner-body" style="font-size:18px; font-weight:700; margin-bottom:10px;"></div><div style="margin-bottom:6px" id="winner-sub"></div><div style="display:flex; gap:8px; justify-content:center;"><button id="winner-ok" class="btn btn-blue">Aceptar</button></div></div></div></div>

<div id="modal-winner-detail" class="hidden"><div class="modal-back" id="modal-winner-detail-back"><div class="modal"><button id="winner-detail-close-x" style="position:absolute;right:10px;top:8px;border:none;background:transparent;font-size:24px;cursor:pointer">‚ùå</button><h2 style="margin:0 0 10px 0; color:var(--verde)">¬°LOTER√çA GANADA!</h2><h3 style="margin:0 0 10px 0; font-weight:900" id="winner-detail-player-name"></h3><div style="font-weight:700; color:var(--rojo);" id="winner-detail-card-name"></div><div id="winner-detail-player-cards"></div><div style="margin-top:20px"><button id="winner-detail-ok" class="btn btn-blue" style="width:200px">Cerrar Detalle</button></div></div></div></div>

<div id="shuffle-overlay" class="shuffle-overlay"></div>
<canvas id="confetti-canvas"></canvas>

<script>
/* index_v9.4_efx_perfecto v3.3 - code block */
const CARD_IMAGE_BASE_PATH='Cartas_baraja_loteria/';
const CARD_NAME_MAP = {1:"1 el gallo-min.jpg",2:"2 el diablito-min.jpg",3:"3 la dama-min.jpg",4:"4 el catrin-min.jpg",5:"5 el paraguas-min.jpg",6:"6 la sirena-min.jpg",7:"7 la escalera-min.jpg",8:"8 la botella-min.jpg",9:"9 el barril-min.jpg",10:"10 arbol-min.jpg",11:"11 melon-min.jpg",12:"12 el valiente-min.jpg",13:"13 el gorrito-min.jpg",14:"14 la muerte-min.jpg",15:"15 la pera-min.jpg",16:"16 la bandera-min.jpg",17:"17 el bandolon-min.jpg",18:"18 el violoncello-min.jpg",19:"19 la garza-min.jpg",20:"20 el pajaro-min.jpg",21:"21 la mano-min.jpg",22:"22 la bota-min.jpg",23:"23 la luna-min.jpg",24:"24 el cotorro-min.jpg",25:"25 el borracho-min.jpg",26:"26 el negrito-min.jpg",27:"27 el corazon-min.jpg",28:"28 la sandia-min.jpg",29:"29 el tambor-min.jpg",30:"30 el camaron-min.jpg",31:"31 las jaras-min.jpg",32:"32 el musico-min.jpg",33:"33 la ara√±a-min.jpg",34:"34 el soldado-min.jpg",35:"35 la estrella-min.jpg",36:"36 el cazo-min.jpg",37:"37 el mundo-min.min.jpg",38:"38 el apache-min.jpg",39:"39 el nopal-min.jpg",40:"40 el alacran-min.jpg",41:"41 la rosa-min.jpg",42:"42 la calavera-min.jpg",43:"43 la campana-min.jpg",44:"44 el cantarito-min.jpg",45:"45 el venado-min.jpg",46:"46 el sol-min.jpg",47:"47 la corona-min.jpg",48:"48 la chalupa-min.jpg",49:"49 el pino-min.jpg",50:"50 el pescado-min.jpg",51:"51 la palma-min.jpg",52:"52 la maceta-min.jpg",53:"53 el arpa-min.jpg",54:"54 la rana-min.jpg"};
const cardImageUrl = id => CARD_IMAGE_BASE_PATH + (CARD_NAME_MAP[id] || `${id}.jpg`);

const Kp='ganya_v90_prices', Kg='ganya_v90_game', Kpu='ganya_v90_purchases', Ktx='ganya_v90_tx', Kw='ganya_v90_winners', Kpas='ganya_v90_pas', Kmod='ganya_v90_mod';

const defaultsPrices=()=>({price4:10,profit4:2,price6:12,profit6:3});
const defaultsGame=()=>({deck:Array.from({length:54},(_,i)=>i+1),drawn:[],current:0,pending:[],winnerPending:false});

let prices = load(Kp) || defaultsPrices();
let game = load(Kg) || defaultsGame();
let purchases = load(Kpu) || [];
let tx = load(Ktx) || [];
let winners = load(Kw) || [];
let cartasPasadas = load(Kpas) || [];
let currentMode = Number(localStorage.getItem(Kmod) || 4);
if(currentMode===8) currentMode=4;

let isAuto=false, autoInterval=null, animShuffling=false;
let audioCtx=null; try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }catch(e){ audioCtx=null; }

function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function load(k){ try{ const v=localStorage.getItem(k); return v? JSON.parse(v): null;}catch(e){return null;} }
function saveAll(){ save(Kp,prices); save(Kg,game); save(Kpu,purchases); save(Ktx,tx); save(Kw,winners); save(Kpas,cartasPasadas); localStorage.setItem(Kmod,String(currentMode)); }

function uuid(){ return 'id-'+Math.random().toString(36).slice(2,10); }
function shuffle(a){ const arr=a.slice(); for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }
function formatMoney(n){ return '$'+Number(n||0).toFixed(2); }
function cardName(id){ return CARD_NAME_MAP[id] ? CARD_NAME_MAP[id].replace(/^\d+\s*/,'').replace(/-min\.jpg$/,'').replace(/\.min\.jpg$/,'') : ('Carta '+id); }

function playShuffleSound(){ if(!audioCtx) return; const now=audioCtx.currentTime; const buf=audioCtx.createBuffer(1,audioCtx.sampleRate*0.22,audioCtx.sampleRate); const d=buf.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*(1-i/d.length); const s=audioCtx.createBufferSource(); s.buffer=buf; const g=audioCtx.createGain(); g.gain.setValueAtTime(0.001,now); g.gain.exponentialRampToValueAtTime(0.6,now+0.02); g.gain.exponentialRampToValueAtTime(0.001,now+0.2); s.connect(g); g.connect(audioCtx.destination); s.start(now); s.stop(now+0.22); }
function playApplause(){ if(!audioCtx) return; const now=audioCtx.currentTime; for(let i=0;i<6;i++){ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='square'; o.frequency.setValueAtTime(200+Math.random()*800, now + i*0.02); o.connect(g); g.connect(audioCtx.destination); g.gain.setValueAtTime(0.002, now + i*0.02); g.gain.exponentialRampToValueAtTime(0.3, now + i*0.02 + 0.05); g.gain.exponentialRampToValueAtTime(0.001, now + i*0.02 + 0.6); o.start(now + i*0.02); o.stop(now + i*0.02 + 0.65); } }

function renderAll(){
  const sel=document.getElementById('select-modality'); if(sel) sel.value=String(currentMode);
  if(document.getElementById('price4')) document.getElementById('price4').value=prices.price4;
  if(document.getElementById('price6')) document.getElementById('price6').value=prices.price6;

  // C√°lculo de la bolsa (Pot)
  const activeForPot = purchases.filter(p=> p.state==='JUGANDO' && (p.gamesLeft||0)>0);
  const totalSalesActive = activeForPot.reduce((s,p)=> s + (p.totalPaid||0),0);
  const houseActive = activeForPot.reduce((s,p)=> s + ((p.modality===4?prices.profit4: prices.profit6) * (p.initialGames||0)),0);
  const pot = Math.max(0, totalSalesActive - houseActive);
  animateBolsa(pot);

  // AJUSTE UX: Ganancia de la Casa (Admin View)
  const totalSales = purchases.reduce((s,p)=> s + (p.totalPaid||0), 0); 
  const totalPrizesPaid = winners.reduce((s,w)=> s + (w.paid ? w.amount : 0), 0); 
  const houseProfit = totalSales - totalPrizesPaid; 
  const houseEl = document.getElementById('house-profit-amount');
  if(houseEl) houseEl.textContent = formatMoney(houseProfit);


  const deckCount=document.getElementById('deck-count'); if(deckCount) deckCount.textContent=game.deck.length;

  const area=document.getElementById('players-area');
  const active = purchases.filter(p=> (p.gamesLeft||0)>0 && p.state==='JUGANDO' && p.modality===currentMode);
  if(!active.length){
    // AJUSTE CLAVE: Simular 5 cartas vac√≠as (simuladas)
    let emptyHtml = '';
    const numSimulated = 5;
    // Usamos grid 2x2 para 4 cartas, ya que es el menor y mantiene la forma.
    const gridCols = 2; 
    
    for(let i=0; i<numSimulated; i++) {
        // Clase 'simulated' para aplicar los estilos de ocultaci√≥n de texto
        emptyHtml += `<div class="player-card simulated">
            <div class="player-name small-muted"></div>
            <div class="player-cards" style="display:grid;grid-template-columns:repeat(${gridCols},1fr);gap:8px;justify-items:center;margin-top:10px;">
                <div class="card-thumb back-pattern"></div>
                <div class="card-thumb back-pattern"></div>
                <div class="card-thumb back-pattern"></div>
                <div class="card-thumb back-pattern"></div>
            </div>
        </div>`;
    }
    area.innerHTML = emptyHtml;
  }
  else area.innerHTML = active.map(p=> renderPlayerCard(p)).join('');

  const cur=document.getElementById('current-card'); if(game.current && cur) cur.innerHTML=`<div style="width:160px;height:220px;background-image:url('${cardImageUrl(game.current)}');background-size:contain;background-repeat:no-repeat;background-position:center;"></div>`; else if(cur) cur.innerHTML='<div class="small-muted">Esperando barajeo...</div>';

  const last=(game.drawn||[]).slice(-3).reverse(); const lastEl=document.getElementById('last-cards'); if(lastEl) lastEl.innerHTML = last.length? last.map(c=>`<div style="width:64px;height:96px;background-image:url('${cardImageUrl(c)}');background-size:cover;border-radius:6px"></div>`).join('') : '<div class="small-muted">Ninguna carta a√∫n.</div>';

  // AJUSTE UX: Control de visibilidad de botones al ganar
  const gameControls = document.getElementById('game-controls');
  const btnReset = document.getElementById('btn-reset');
  if(gameControls && btnReset){
    if(game.winnerPending){
      gameControls.classList.add('hidden');
      btnReset.classList.remove('hidden');
    } else {
      gameControls.classList.remove('hidden');
      btnReset.classList.add('hidden');
    }
  }

  renderPlayersTable();
  saveAll();
}

function animateBolsa(target){
  const el=document.getElementById('bolsa-amount'); if(!el) return;
  const current = parseFloat((el.dataset.value||'0')); const t = Number(target||0);
  const steps = 18; let i=0; const start=current; const diff = t - start;
  if(el._anim) clearInterval(el._anim);
  el._anim = setInterval(()=>{ i++; const val = start + diff*(i/steps); el.textContent = formatMoney(val); el.dataset.value = val; el.style.transform = (i%2===0)?'scale(1.03)':'scale(1)'; if(i>=steps){ clearInterval(el._anim); el.style.transform=''; delete el._anim; } }, 30);
}

function renderPlayerCard(p){
  let cols=4, displayCount=p.modality;
  if(p.modality===4){ cols=2; displayCount=4; }
  else if(p.modality===6){ cols=3; displayCount=6; }
  const cardList=(p.card||[]).slice(0,displayCount);
  let html = `<div class="player-card" onclick="openPurchaseDetail('${p.id}')"><div class="player-name">${escapeHtml(p.playerName)}</div><div class="player-cards" style="display:grid;grid-template-columns:repeat(${cols},1fr);gap:6px;justify-items:center;margin-top:8px">`;
  cardList.forEach(cid=>{ const passed = cartasPasadas.includes(cid); const isMarked = (p.markedCards||[]).includes(cid); const sticker = isMarked? `<div class="sticker"><img src="logo_1_entrada.png" alt="lg"/></div>` : ''; html+=`<div class="card-thumb ${passed?'passed':''}" style="background-image:url('${cardImageUrl(cid)}')">${sticker}</div>`; });
  let missing = displayCount - cardList.length; while(missing-->0) html+=`<div style="width:74px;height:106px;border-radius:8px;background:#fafafa;border:1px dashed #eee"></div>`;
  html+='</div></div>'; return html;
}

function renderPlayersTable(filter){ const tbody=document.getElementById('players-table'); const list = purchases.slice().filter(p=> !filter || p.modality===filter); if(!tbody) return; if(!list.length){ tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:18px;color:#888">No hay operaciones.</td></tr>'; return; } tbody.innerHTML = list.map(p=>`<tr><td style="padding:6px">${p.id}</td><td style="padding:6px">${escapeHtml(p.playerName)}<div class="small-muted">${escapeHtml(p.cell||'‚Äî')}</div></td><td style="padding:6px;text-align:center">${p.modality}</td><td style="padding:6px;text-align:center">${p.gamesLeft||0}</td><td style="padding:6px;text-align:center">${formatMoney(p.totalPaid)}</td><td style="padding:6px;text-align:center">${p.state||'JUGANDO'}</td><td style="padding:6px;text-align:center"><button class="btn btn-blue" onclick="openPurchaseDetail('${p.id}')">Detalle</button></td></tr>`).join(''); }

function openPurchaseDetail(id){ const p=purchases.find(x=>x.id===id); if(!p) return alert('No encontrado'); const modal=document.getElementById('modal-player'); document.getElementById('modal-player-name').textContent=`${p.playerName} ‚Ä¢ ${p.cell||''} ‚Ä¢ ${p.id}`; const cards=(p.card||[]).map(cid=>{ const isMarked = (p.markedCards||[]).includes(cid); const sticker = isMarked? `<div class="sticker"><img src="logo_1_entrada.png" alt="lg"/></div>` : ''; return `<div style="width:100px;height:150px;background-image:url('${cardImageUrl(cid)}');background-size:cover;border-radius:8px;display:inline-block;margin-right:8px;position:relative">${sticker}</div>`; }).join(''); const details = `<div><strong>Modalidad:</strong> ${p.modality} cartas</div><div><strong>Partidas restantes:</strong> ${p.gamesLeft||0}</div><div><strong>Total pagado:</strong> ${formatMoney(p.totalPaid)}</div><div style="margin-top:8px"><strong>Cartas asignadas:</strong></div><div style="margin-top:8px">${cards}</div><div style="margin-top:8px"><strong>CLABE / Cuenta:</strong> ${escapeHtml(p.clabe||'')}</div><div style="margin-top:8px"><strong>Estado:</strong> ${p.state||'JUGANDO'}</div><div style="margin-top:8px"><button class="btn btn-blue" onclick="printPurchase('${p.id}');">Tomar captura / Imprimir</button> <button class="btn btn-green" onclick="copyClabe('${p.id}');">Copiar CLABE</button> <button class="btn btn-green" onclick="confirmWhatsapp('${p.id}');">Confirmar pago WhatsApp</button> <button class="btn btn-green" onclick="markPaidById('${p.id}');">Marcar Pagado</button></div>`; document.getElementById('modal-body').innerHTML = details; modal.classList.remove('hidden'); modal.style.display='block';
  document.getElementById('modal-close').onclick=closeGroupModal; document.getElementById('modal-close-x').onclick=closeGroupModal;
}

function copyClabe(id){ const p=purchases.find(x=>x.id===id); if(!p) return; const text = p.clabe||''; if(!text) return alert('No hay CLABE registrada'); navigator.clipboard.writeText(text).then(()=>{ alert('CLABE copiada al portapapeles'); }); }

function confirmWhatsapp(id){ const p=purchases.find(x=>x.id===id); if(!p) return; if(!p.cell) return alert('No hay n√∫mero de celular registrado'); const amount = formatMoney(p.totalPaid); const date = new Date().toLocaleString(); const msg = `Hola ${p.playerName}, se ha realizado tu pago de ${amount} para tus partidas. ¬°Mucha suerte en GANA YA! üéâ`; const url = `https://wa.me/${p.cell}?text=${encodeURIComponent(msg)}`; window.open(url,'_blank'); }

function printPurchase(id){ const p=purchases.find(x=>x.id===id); if(!p) return; const logo = 'logo_1_entrada.png'; const html = `<html><head><title>Compra ${p.id}</title></head><body style="font-family:Arial;padding:12px"><div style="display:flex;align-items:center;gap:12px"><img src="${logo}" style="width:80px;height:80px;object-fit:contain"/> <div><h2>Reporte de partidas ‚Äî GANA YA!</h2><div>${new Date().toLocaleString()}</div></div></div><hr/> <h3>Compra: ${p.id}</h3><div><strong>Jugador:</strong> ${escapeHtml(p.playerName)}</div><div><strong>Celular:</strong> ${escapeHtml(p.cell||'')}</div><div><strong>Modalidad:</strong> ${p.modality} cartas</div><div><strong>Partidas:</strong> ${p.gamesLeft||0}</div><div><strong>Total pagado:</strong> ${formatMoney(p.totalPaid)}</div><div style="margin-top:8px"><strong>Cartas:</strong></div>${(p.card||[]).map(cid=>`<div style="display:inline-block;margin:6px"><img src='${cardImageUrl(cid)}' style='width:120px;height:180px;object-fit:cover;border:1px solid #ccc;border-radius:8px'></div>`).join('')}<div style="margin-top:12px"><em>Generado: ${new Date().toLocaleString()}</em></div></body></html>`; const w=window.open('','_blank'); w.document.write(html); w.document.close(); setTimeout(()=>w.print(),500); }


function shufflePendingToFullScreen(){
  if(animShuffling || game.winnerPending) return;
  animShuffling=true;
  disableControls(true);
  playShuffleSound();
  const pending = game.deck.filter(id=> !cartasPasadas.includes(id));
  if(!pending.length){
    alert('No hay cartas pendientes para barajar.');
    animShuffling=false;
    disableControls(false);
    return;
  }
  const overlay=document.getElementById('shuffle-overlay');
  overlay.classList.add('visible');
  overlay.innerHTML='';
  overlay.style.display='flex';
  const center=document.createElement('div');
  center.style.position='relative';
  center.style.width='800px';
  center.style.height='500px';
  overlay.appendChild(center);

  const visibleCards = Array.from(document.querySelectorAll('#players-area .card-thumb'));
  visibleCards.forEach(c => c.classList.add('back-pattern'));

  const sample = shuffle(pending).slice(0,30);
  const cards = sample.map((cid,i)=>{
    const el=document.createElement('div');
    el.className='shuffle-card';
    el.style.backgroundImage=`url('${cardImageUrl(cid)}')`;
    el.style.left='50%'; el.style.top='50%';
    const rot = (Math.random()*360)-180;
    const scale = 1 - Math.abs(i - (sample.length/2))*0.01;
    el.style.transform=`translate(-50%,-50%) rotate(${rot}deg) scale(${scale})`;
    el.style.zIndex=100+i;
    center.appendChild(el);
    return {el, cid};
  });

  // 1. Dispersi√≥n inicial
  cards.forEach((c,idx)=>{
    setTimeout(()=>{
      c.el.style.transition='transform 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 1.5s ease';
      c.el.style.transform = `translate(${(Math.random()*900-450)}px, ${(Math.random()*360-180)}px) rotate(${Math.random()*90-45}deg) scale(0.85)`;
      c.el.style.opacity = 1;
      playShuffleSound();
    }, idx * 60);
  });

  // 2. Traer al centro apilado
  setTimeout(()=>{
    cards.forEach((c,ii)=>{
      c.el.style.transition='transform 1.0s ease-in-out, opacity 1.0s ease';
      c.el.style.transform = `translate(${(ii - cards.length/2) * 2}px, -20px) rotate(${(Math.random()*8)-4}deg) scale(0.98)`;
    });
    playShuffleSound();
  }, 2000); // 2.0s

  // 3. Convertir a patr√≥n reverso
  setTimeout(()=>{
    cards.forEach((c,ii)=>{
      c.el.style.transition='transform 0.8s ease, opacity 0.8s ease, background-image 0.2s';
      c.el.style.backgroundImage = `linear-gradient(#ddd,#bbb)`;
      c.el.innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;"><img src="logo_1_entrada.png" style="width:80px;height:80px;opacity:.95"></div>`;
    });
    playShuffleSound();
  }, 3200); // 3.2s

  // after full animation, hide overlay and finalize shuffle
  setTimeout(()=>{
    overlay.classList.remove('visible');
    overlay.style.display='none';
    overlay.innerHTML='';
    animShuffling=false;
    disableControls(false);
    shufflePending();
    renderAll();

    const visible = Array.from(document.querySelectorAll('#players-area .card-thumb'));
    visible.forEach(c=>{
      c.classList.add('shine');
      setTimeout(()=> c.classList.remove('shine'), 1800);
    });

  }, 4000); // Tiempo final total de 4.0s
}


function shufflePending(){ const pending=game.deck.filter(id=> !cartasPasadas.includes(id)); const past=game.deck.filter(id=> cartasPasadas.includes(id)); game.deck = shuffle(pending).concat(past); tx.push({id:uuid(),type:'shuffle',ts:Date.now()}); saveAll(); }

function drawOne(){
  if(animShuffling || game.winnerPending) return;

  let idx=-1; for(let i=0;i<game.deck.length;i++){ if(!cartasPasadas.includes(game.deck[i])){ idx=i; break; } }
  if(idx===-1){
    alert('No hay cartas pendientes. Barajea para continuar.');
    stopAuto();
    return;
  }
  const card = game.deck.splice(idx,1)[0];
  game.drawn.push(card);
  game.current=card;
  cartasPasadas.push(card);
  tx.push({id:uuid(),type:'draw',card:card,ts:Date.now()});
  saveAll();
  processCard(card);
  renderAll();
}

function processCard(cardId){
  const winnersFound=[];
  purchases.forEach((p,i)=>{
    if(!(p.gamesLeft>0 && p.state==='JUGANDO')) return;
    if(p.card && p.card.includes(cardId) && !(p.markedCards||[]).includes(cardId)){
      p.markedCards = [...(p.markedCards||[]), cardId];
    }
    if((p.markedCards||[]).length === p.modality){
      winnersFound.push({idx:i,purchaseId:p.id});
    }
  });

  if(winnersFound.length){
    stopAuto();
    game.winnerPending = true;
    disableControls(true);

    const activeForPot = purchases.filter(p=> p.state==='JUGANDO' && (p.gamesLeft||0)>0);
    const totalSalesActive = activeForPot.reduce((s,p)=> s + (p.totalPaid||0), 0);
    const houseActive = activeForPot.reduce((s,p)=> s + ((p.modality===4?prices.profit4: prices.profit6) * (p.initialGames||0)), 0);
    const pot = Math.max(0, totalSalesActive - houseActive);
    const share = pot / winnersFound.length;

    const recs=[];
    winnersFound.forEach(w=>{
      const p=purchases[w.idx];
      p.wins=(p.wins||0)+1;
      p.state='POR PAGAR';
      const rec={id:uuid(),purchaseId:p.id,playerName:p.playerName,amount:share,timestamp:Date.now(),paid:false,cardId:cardId,clabe:p.clabe||'',cell:p.cell||''};
      winners.push({timestamp:rec.timestamp,playerName:rec.playerName,amount:rec.amount,cardId:rec.cardId,paid:false,purchaseId:p.id});
      tx.push({id:uuid(),type:'winner',player:p.playerName,amount:share,ts:Date.now()});
      recs.push(rec);
    });
    saveAll();
    showWinner(recs);
    renderAll();
  } else {
    saveAll();
  }
}

function startAuto(){
  if(!game.deck.length){ alert('Mazo vac√≠o. Barajea'); return; }
  isAuto=true;
  document.getElementById('btn-auto').textContent='DETENER AUTOM√ÅTICO';
  autoInterval=setInterval(()=>{ drawOne(); },2000);
}
function stopAuto(){
  isAuto=false;
  if(document.getElementById('btn-auto')) document.getElementById('btn-auto').textContent='CARTAS AUTOM√ÅTICO';
  if(autoInterval){ clearInterval(autoInterval); autoInterval=null; }
}
function toggleAuto(){ if(isAuto) stopAuto(); else startAuto(); }

function disableControls(d){
  ['btn-shuffle','btn-draw','btn-auto'].forEach(id=>{ const el=document.getElementById(id); if(el) el.disabled=!!d; });
  ['btn-register','save-prices','btn-export-admin','btn-clear-admin'].forEach(id=>{ const el=document.getElementById(id); if(el) el.disabled=!!d; });
}

function generateCardForPurchase(modality){
  const pool = Array.from({length:54},(_,i)=>i+1);
  const out=[];
  const shuffledPool = shuffle(pool);
  while(out.length < modality && shuffledPool.length){
    out.push(shuffledPool.pop());
  }
  return out;
}


function suggestFromBudget(budget){
  budget = Number(budget||0);
  const p4 = prices.price4, p6 = prices.price6;
  const max4 = Math.floor(budget / p4);
  const max6 = Math.floor(budget / p6);
  let msg = '';
  if(budget<=0) msg = 'Ingresa presupuesto para ver sugerencias.';
  else msg = `Con ${formatMoney(budget)} puedes comprar: ${max4} partidas de 4 cartas ‚Ä¢ ${max6} partidas de 6 cartas.`;
  document.getElementById('calc-info').textContent = msg;
  document.getElementById('qty4').parentElement.style.display = budget>=p4? 'block':'none';
  document.getElementById('qty6').parentElement.style.display = budget>=p6? 'block':'none';
}

function registerPlayer(){
  const name=(document.getElementById('input-name').value||'').trim();
  const cell=(document.getElementById('input-cell').value||'').trim();
  const clabe=(document.getElementById('input-clabe').value||'').trim();
  const budgetRaw=document.getElementById('input-budget').value;
  const budget = budgetRaw===''?0:parseFloat(budgetRaw||0);
  const q4=parseInt(document.getElementById('qty4').value||0), q6=parseInt(document.getElementById('qty6').value||0);
  if(!name) return alert('Captura el nombre');
  if(!cell) return alert('Captura el celular');
  if(q4+q6<=0) return alert('Selecciona al menos una partida (cantidad)');
  const needed = q4*prices.price4 + q6*prices.price6;
  if(budget < needed) return alert(`El presupuesto no alcanza. Se requiere ${formatMoney(needed)}.`);
  if(budget > needed) return alert(`Hay sobrante de ${formatMoney(budget-needed)}. Ajusta las cantidades o el presupuesto para continuar.`);
  const parts=[];
  if(q4>0) parts.push({modality:4,qty:q4,price:prices.price4});
  if(q6>0) parts.push({modality:6,qty:q6,price:prices.price6});
  parts.forEach(pt=>{
    for(let i=0;i<pt.qty;i++){
      const p={id:uuid(),playerName:name,cell:cell,clabe:clabe,modality:pt.modality,initialGames:1,gamesLeft:1,totalPaid:pt.price,wins:0,state:'JUGANDO',card:[],markedCards:[],selectionUsed:true,createdAt:Date.now()};
      p.card=generateCardForPurchase(pt.modality);
      purchases.push(p);
      tx.push({id:uuid(),type:'purchase',player:name,modality:pt.modality,amount:pt.price,purchaseId:p.id,ts:Date.now()});
    }
  });
  saveAll();
  document.getElementById('input-name').value=''; document.getElementById('input-cell').value=''; document.getElementById('input-clabe').value=''; document.getElementById('input-budget').value='';
  document.getElementById('qty4').value='0'; document.getElementById('qty6').value='0';
  alert('Jugador(s) registrado(s) y cartas asignadas autom√°ticamente.');
  renderAll();
}

function resetGame(){
  if(!confirm('Iniciar un juego nuevo: se reiniciar√° el mazo y se quitar√° 1 partida a todos los jugadores activos. ¬øContinuar?')) return;
  stopAuto();
  purchases.forEach(p=>{
    if(p.state==='JUGANDO' || p.state==='POR PAGAR'){
      p.gamesLeft = Math.max(0,(p.gamesLeft||0)-1);
      if(p.gamesLeft<=0) p.state='FINALIZADO';
    }
    p.markedCards=[];
  });
  game.deck = Array.from({length:54},(_,i)=>i+1);
  game.drawn=[];
  game.current=0;
  cartasPasadas=[];
  game.winnerPending = false;
  document.getElementById('shuffle-overlay').classList.remove('visible');
  document.getElementById('shuffle-overlay').style.display='none';
  tx.push({id:uuid(),type:'reset',ts:Date.now()});
  saveAll();
  renderAll();
  alert('Juego reiniciado y partidas descontadas.');
  disableControls(false);
}

function exportPdf(){ const date=new Date(); const header=`Reporte de partidas ‚Äî GANA YA!`; const logo='logo_1_entrada.png'; let html=`<html><head><title>${header}</title></head><body style="font-family:Arial;padding:12px">`; html+=`<div style="display:flex;gap:12px;align-items:center"><img src="${logo}" style="width:80px;height:80px;object-fit:contain"/><div><h1 style="margin:0">${header}</h1><div style="font-size:13px;color:#555">${date.toLocaleString()}</div></div></div><hr/>`; html+=`<h2>Compras</h2><table border="1" cellpadding="6" style="border-collapse:collapse;width:100%"><thead><tr><th>ID</th><th>Jugador</th><th>Celular</th><th>Modalidad</th><th>Partidas</th><th>Total</th><th>Estado</th></tr></thead><tbody>`; purchases.forEach(p=>{ html+=`<tr><td>${p.id}</td><td>${escapeHtml(p.playerName)}</td><td>${escapeHtml(p.cell||'')}</td><td>${p.modality}</td><td>${p.gamesLeft||0}</td><td>${formatMoney(p.totalPaid)}</td><td>${p.state||'JUGANDO'}</td></tr>`; }); html+='</tbody></table>'; html+='<h2>Ganadores</h2><table border="1" cellpadding="6" style="border-collapse:collapse;width:100%"><thead><tr><th>Fecha</th><th>Jugador</th><th>Importe</th><th>Carta</th><th>Pagado</th></tr></thead><tbody>'; winners.forEach(w=>{ html+=`<tr><td>${new Date(w.timestamp).toLocaleString()}</td><td>${escapeHtml(w.playerName)}</td><td>${formatMoney(w.amount)}</td><td>${escapeHtml(cardName(w.cardId))}</td><td>${w.paid?'PAGADO':'PENDIENTE'}</td></tr>`; }); html+='</tbody></table>'; html+=`<div style="margin-top:12px"><em>Generado: ${new Date().toLocaleString()}</em></div></body></html>`; const w=window.open('','_blank'); w.document.write(html); w.document.close(); setTimeout(()=>w.print(),600); }

document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('btn-shuffle').addEventListener('click', ()=>{ shufflePendingToFullScreen(); });
  document.getElementById('btn-draw').addEventListener('click', ()=>{
    if(isAuto) { alert('Det√©n el modo "CARTAS AUTOM√ÅTICO" para tirar una carta manualmente.'); return; }
    drawOne();
  });
  document.getElementById('btn-auto').addEventListener('click', ()=>{ toggleAuto(); });
  document.getElementById('btn-reset').addEventListener('click', resetGame);

  document.getElementById('btn-register').addEventListener('click', registerPlayer);

  document.getElementById('save-prices').addEventListener('click', ()=>{
    prices.price4=Math.max(1,Number(document.getElementById('price4').value||1));
    prices.profit4=Math.max(0,Number(document.getElementById('profit4').value||0));
    prices.price6=Math.max(1,Number(document.getElementById('price6').value||1));
    prices.profit6=Math.max(0,Number(document.getElementById('profit6').value||0));
    saveAll(); renderAll(); alert('Precios guardados');
  });
  document.getElementById('reset-prices').addEventListener('click', ()=>{ if(!confirm('Restablecer precios por defecto?')) return; prices=defaultsPrices(); saveAll(); renderAll(); });

  document.getElementById('btn-view-play').addEventListener('click', ()=>{ document.getElementById('view-admin').classList.add('hidden'); document.getElementById('main-grid').style.display='grid'; document.getElementById('btn-view-play').classList.add('active'); document.getElementById('btn-view-admin').classList.remove('active'); });
  document.getElementById('btn-view-admin').addEventListener('click', ()=>{ document.getElementById('view-admin').classList.remove('hidden'); document.getElementById('main-grid').style.display='none'; document.getElementById('btn-view-admin').classList.add('active'); document.getElementById('btn-view-play').classList.remove('active'); });

  document.getElementById('select-modality').addEventListener('change', (e)=>{ currentMode = Number(e.target.value); localStorage.setItem(Kmod,String(currentMode)); renderAll(); });

  document.getElementById('btn-export-admin').addEventListener('click', exportPdf);
  document.getElementById('btn-clear-admin').addEventListener('click', ()=>{ if(!confirm('Borrar todo y reiniciar d√≠a? Esto eliminar√° compras y registros.')) return; purchases=[]; tx.push({id:uuid(),type:'clear',ts:Date.now()}); game=defaultsGame(); winners=[]; cartasPasadas=[]; saveAll(); renderAll(); alert('D√≠a reiniciado.'); });

  // filters with active visual state
  document.getElementById('filter-all').addEventListener('click', ()=>{ setActiveFilter('all'); renderPlayersTable(); });
  document.getElementById('filter-4').addEventListener('click', ()=>{ setActiveFilter(4); renderPlayersTable(4); });
  document.getElementById('filter-6').addEventListener('click', ()=>{ setActiveFilter(6); renderPlayersTable(6); });

  // modal overlay clicks to close
  document.getElementById('modal-player-back').addEventListener('click', (e)=>{ if(e.target.id==='modal-player-back') closeGroupModal(); });
  document.getElementById('modal-winner-back').addEventListener('click', (e)=>{ if(e.target.id==='modal-winner-back') { document.getElementById('modal-winner').classList.add('hidden'); document.getElementById('modal-winner').style.display='none'; stopConfettiFullScreen(); } });

  document.getElementById('modal-close').addEventListener('click', closeGroupModal);
  document.getElementById('modal-close-x').addEventListener('click', closeGroupModal);

  // AJUSTE UX: Botones de confirmaci√≥n del modal de Felicitaci√≥n. Se cierra y se muestra el detalle.
  document.getElementById('winner-ok').addEventListener('click', showWinnerDetailModal);
  // FIX CONFETTI: Asegurar que el bot√≥n X pare el confetti
  document.getElementById('winner-close').addEventListener('click', ()=>{ const m=document.getElementById('modal-winner'); m.classList.add('hidden'); m.style.display='none'; stopConfettiFullScreen(); });

  // AJUSTE UX: Botones del modal de Detalle del Ganador
  document.getElementById('winner-detail-ok').addEventListener('click', closeWinnerDetailModal);
  document.getElementById('winner-detail-close-x').addEventListener('click', closeWinnerDetailModal);
  document.getElementById('modal-winner-detail-back').addEventListener('click', (e)=>{ if(e.target.id==='modal-winner-detail-back') closeWinnerDetailModal(); });


  document.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){
      closeGroupModal();
      const mw=document.getElementById('modal-winner'); if(mw && !mw.classList.contains('hidden')){ mw.classList.add('hidden'); mw.style.display='none'; stopConfettiFullScreen(); } // Stop confetti on ESC for initial winner modal
      // AJUSTE UX: Permitir cerrar el modal de detalle con ESC
      closeWinnerDetailModal(); // This will also stop the confetti if it was somehow still running
    }
    if(e.code==='Space'){ e.preventDefault(); if(!isAuto) drawOne(); }
  });

  document.getElementById('input-budget').addEventListener('input',(e)=>{ suggestFromBudget(Number(e.target.value||0)); });

  document.getElementById('view-admin').classList.add('hidden');
  document.getElementById('main-grid').style.display = 'grid';
  document.getElementById('btn-view-play').classList.add('active');

  const logoImg = document.getElementById('logo-img'); logoImg.onerror = ()=>{ document.querySelector('.logo-box').style.display='none'; };
  renderAll();
});

let confettiInterval=null;
function startConfettiFullScreen(){ const canvas=document.getElementById('confetti-canvas'); canvas.style.display='block'; const ctx=canvas.getContext('2d'); const w=canvas.width=window.innerWidth; const h=canvas.height=window.innerHeight; const colors=['#e63946','#ffd60a','#2a9d8f','#ff9e00','#ff6bcb','#6d9df5']; let conf=Array.from({length:220}, ()=>({x:Math.random()*w,y:Math.random()*-h,r:Math.random()*6+3,c:colors[Math.floor(Math.random()*colors.length)],s:Math.random()*3+2,rrot:Math.random()*6})); function draw(){ ctx.clearRect(0,0,w,h); conf.forEach(c=>{ ctx.save(); ctx.translate(c.x,c.y); ctx.rotate(c.rrot); ctx.fillStyle=c.c; ctx.fillRect(-c.r,-c.r,c.r*2,c.r*2); ctx.restore(); c.y += c.s; c.x += Math.sin(c.y*0.01)*2; if(c.y > h+30){ c.y = -20; c.x = Math.random()*w; } }); } if(confettiInterval) clearInterval(confettiInterval); confettiInterval=setInterval(draw,20); }
function stopConfettiFullScreen(){ if(confettiInterval) clearInterval(confettiInterval); confettiInterval=null; const canvas=document.getElementById('confetti-canvas'); if(canvas){ const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height); canvas.style.display='none'; } }

function showWinner(recs){
  const modal=document.getElementById('modal-winner');
  const body=document.getElementById('winner-body');
  const sub=document.getElementById('winner-sub');
  const winningCardId = recs[0].cardId;
  window._tempWinnerRecs = recs;

  const total=recs.reduce((s,r)=> s + (r.amount||0),0);
  const names=recs.map(r=> escapeHtml(r.playerName)).join(', ');
  body.innerHTML = `${names} ha ganado ${formatMoney(total)}`;
  sub.innerHTML = `Carta ganadora: ${cardName(winningCardId)}`;

  modal.classList.remove('hidden');
  modal.style.display='block';
  playApplause();
  startConfettiFullScreen();
}

function showWinnerDetailModal(){
  const recs = window._tempWinnerRecs;
  if(!recs || !recs.length) return;

  // Cerrar el modal de felicitaci√≥n y parar el confetti (previo al detalle)
  document.getElementById('modal-winner').classList.add('hidden');
  document.getElementById('modal-winner').style.display='none';
  stopConfettiFullScreen(); // Aseguramos que pare aqu√≠ antes de la vista de detalle.

  const winningCardId = recs[0].cardId;
  const winnerPlayer = purchases.find(p => p.id === recs[0].purchaseId);
  if (!winnerPlayer) return;

  document.getElementById('winner-detail-player-name').textContent = `Jugador: ${winnerPlayer.playerName}`;
  document.getElementById('winner-detail-card-name').textContent = `Carta Ganadora: ${cardName(winningCardId)}`;
  const detailCardsContainer = document.getElementById('winner-detail-player-cards');

  const cardListHtml = (winnerPlayer.card || []).map(cid => {
    const isWinner = cid === winningCardId;
    const isMarked = (winnerPlayer.markedCards || []).includes(cid) || isWinner;
    const sticker = isMarked ? `<div class="sticker"><img src="logo_1_entrada.png" alt="lg"/></div>` : '';
    return `<div class="card-thumb ${isWinner ? 'winner-card' : ''} ${isMarked ? 'passed' : ''}" style="background-image:url('${cardImageUrl(cid)}')">${sticker}</div>`;
  }).join('');

  detailCardsContainer.innerHTML = cardListHtml;

  const modalDetail = document.getElementById('modal-winner-detail');
  modalDetail.classList.remove('hidden');
  modalDetail.style.display = 'flex';
}

function closeWinnerDetailModal(){
  const modalDetail = document.getElementById('modal-winner-detail');
  modalDetail.classList.add('hidden');
  modalDetail.style.display = 'none';
  delete window._tempWinnerRecs;
  stopConfettiFullScreen(); // FIX CONFETTI: Aseguramos que pare al cerrar el modal de detalle.
  renderAll();
}

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

window.markPaidById = function(id){ const p=purchases.find(x=>x.id===id); if(!p) return alert('No encontrado'); if(p.state!=='POR PAGAR') return alert('Solo marcar si est√° POR PAGAR'); p.state='PAGADO'; p.paidAt=Date.now(); winners=winners.map(w=> w.purchaseId===id? {...w,paid:true}:w); tx.push({id:uuid(),type:'mark_paid',purchaseId:id,ts:Date.now()}); saveAll(); renderAll(); alert('Marcado como PAGADO'); };

function closeGroupModal(){ const modal=document.getElementById('modal-player'); modal.classList.add('hidden'); modal.style.display='none'; }

function setActiveFilter(f){ document.querySelectorAll('.filter-btn').forEach(b=> b.classList.remove('active-4','active-6','active-all')); if(f==='all'){ document.getElementById('filter-all').classList.add('active-all'); } else if(f===4){ document.getElementById('filter-4').classList.add('active-4'); } else if(f===6){ document.getElementById('filter-6').classList.add('active-6'); } }
</script>
</body>
</html>
