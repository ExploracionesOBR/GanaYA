<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GANA YA! - Loter√≠a Interactiva (Admin + Jugador)</title>

  <!-- Tailwind (cdn) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f7f3e8; }
    .card-loteria {
      background-color: white;
      border: 4px solid #a32a2a;
      box-shadow: 0 8px 16px rgba(0,0,0,.12);
      border-radius: 1rem;
      transition: transform .2s, opacity .3s;
    }
    .card-cell {
      background-color: #f0f0f0;
      position: relative;
      border-radius: .5rem;
      overflow: hidden;
      background-size: cover;
      background-position: center;
      min-height: 56px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    /* Marca cuando est√° marcada: overlay oscuro + logo centrado */
    .card-cell.marked::after {
      content: '';
      position: absolute;
      inset: 0;
      background-color: rgba(0,0,0,0.45);
      background-image: url('logo_1_entrada.png');
      background-size: 35%;
      background-repeat: no-repeat;
      background-position: center;
      z-index: 10;
      pointer-events: none;
    }
    #current-card {
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      background-color: white;
      transition: all .5s;
    }
    .card-placeholder {
      background-color: #e0e0e0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:3rem;
    }

    /* Modal confetti very simple */
    @keyframes confetti {
      0% { transform: translateY(0) rotate(0); opacity: 1; }
      100% { transform: translateY(-420px) rotate(720deg); opacity: 0; }
    }
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      top: 100%;
      animation: confetti 2s ease-out forwards;
      z-index: 60;
    }

    /* Toggle bot√≥n activo */
    .tab-active { background: linear-gradient(90deg,#fef3f3,#fff); border-bottom: 4px solid #a32a2a; }
  </style>
</head>
<body class="min-h-screen p-4 md:p-8">

  <!-- NAV superior / conmutador -->
  <nav class="max-w-6xl mx-auto flex items-center justify-between gap-4 mb-6">
    <div class="flex items-center gap-4">
      <img src="logo_1_entrada.png" alt="Logo" class="w-14 h-14 rounded-full shadow-md" onerror="this.onerror=null;this.src='https://placehold.co/60x60/a32a2a/ffffff?text=LOGO'">
      <h1 class="text-3xl md:text-4xl font-black text-[#a32a2a] uppercase tracking-wide">GANA YA!</h1>
    </div>

    <div class="flex items-center gap-2">
      <button id="tab-player" class="px-4 py-2 rounded-lg font-bold tab-active">Vista Jugador</button>
      <button id="tab-admin" class="px-4 py-2 rounded-lg font-bold">Vista Administrador</button>
    </div>
  </nav>

  <!-- CONTENEDOR PRINCIPAL -->
  <main class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6">

    <!-- VISTA JUGADOR (oculta/visible seg√∫n pesta√±a) -->
    <section id="view-player" class="lg:col-span-3">
      <!-- Header Jugador -->
      <header class="flex items-center justify-between mb-6 p-4 rounded-xl bg-white shadow-lg border-b-4 border-red-600">
        <div class="flex items-center gap-4">
          <img src="logo_1_entrada.png" alt="Logo" class="w-12 h-12 rounded-full shadow" onerror="this.onerror=null;this.src='https://placehold.co/60x60/a32a2a/ffffff?text=LOGO'">
          <div>
            <h2 class="text-2xl font-black text-[#a32a2a]">GANA YA! - Vista Jugador</h2>
            <p class="text-sm text-gray-600">Interfaz p√∫blica ‚Äî muestra cartas y cartas marcadas</p>
          </div>
        </div>

        <div class="bg-green-700 text-white p-3 rounded-xl shadow-xl border-4 border-green-800 flex flex-col items-center min-w-[150px]">
          <span class="text-xs font-bold uppercase">Bolsa en Juego</span>
          <span id="pot-amount" class="text-3xl font-extrabold">$0.00</span>
        </div>
      </header>

      <div class="grid lg:grid-cols-3 gap-6">

        <!-- Cartas de jugadores -->
        <div class="lg:col-span-2">
          <h3 class="text-xl font-black text-gray-700 mb-3">Cartas de Jugadores Activos</h3>
          <div id="active-players-cards" class="grid gap-4 grid-cols-1 sm:grid-cols-2 cards-grid">
            <div class="text-center text-gray-500 p-8 card-loteria col-span-full">Cargando jugadores...</div>
          </div>
        </div>

        <!-- Columna derecha: carta actual, √∫ltimas cartas, ganadores -->
        <aside class="lg:col-span-1 flex flex-col space-y-6">
          <div class="bg-white p-4 rounded-2xl shadow-xl border-4 border-red-500 text-center">
            <h4 class="text-xl font-bold text-red-600 mb-2">Carta en Juego</h4>
            <div id="current-card" class="card-loteria w-full h-48 p-4 card-placeholder">
              <div class="flex flex-col items-center justify-center">
                <span class="text-6xl">üé≤</span>
                <span class="text-sm font-semibold mt-2 text-gray-600">Esperando...</span>
              </div>
            </div>
          </div>

          <div class="bg-white p-4 rounded-2xl shadow-xl border-4 border-gray-300">
            <h4 class="text-xl font-bold text-gray-700 mb-2">√öltimas 5 Cartas</h4>
            <div id="last-cards" class="flex flex-wrap gap-2 justify-center">
              <span class="text-gray-400 text-sm">Ninguna carta a√∫n.</span>
            </div>
          </div>

          <div class="bg-white p-4 rounded-2xl shadow-xl border-4 border-gray-300">
            <h4 class="text-xl font-bold text-gray-700 mb-2">√öltimos Ganadores</h4>
            <div id="last-winners" class="flex flex-col justify-center gap-2 text-center">
              <span class="text-gray-500">A√∫n no hay ganadores.</span>
            </div>
          </div>
        </aside>
      </div>

      <!-- Modal Ganador -->
      <div id="winner-modal" class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div id="confetti-container" class="absolute inset-0 overflow-hidden pointer-events-none"></div>
        <div class="bg-yellow-300 p-8 md:p-12 rounded-2xl shadow-2xl text-center border-4 border-yellow-500 z-50">
          <h1 class="text-6xl font-black text-red-600 mb-4 animate-bounce">¬°GANA YA!</h1>
          <h2 class="text-4xl font-extrabold text-gray-800 mb-2">¬°FELICIDADES!</h2>
          <p id="winner-name" class="text-5xl font-black text-red-800 mb-4">NOMBRE</p>
          <p class="text-3xl font-bold text-gray-700">Ganaste <span id="winner-amount" class="text-green-700 text-5xl font-extrabold">$0.00 MXN</span></p>
          <button onclick="hideWinnerModal()" class="mt-8 px-8 py-3 bg-red-600 text-white font-bold text-xl rounded-full shadow-lg hover:bg-red-700">Cerrar</button>
        </div>
      </div>
    </section>

    <!-- VISTA ADMIN -->
    <section id="view-admin" class="hidden lg:col-span-1">
      <div class="bg-white p-6 rounded-2xl shadow-2xl border-4 border-red-700">
        <header class="mb-6">
          <h3 class="text-2xl font-black text-red-700 uppercase text-center">PANEL DE ADMINISTRACI√ìN</h3>
          <p class="text-center text-gray-500 text-sm mt-1">Control de partida y gesti√≥n</p>
        </header>

        <!-- Controles principales -->
        <div class="grid gap-4 mb-6">
          <label class="text-sm font-semibold">Modalidad</label>
          <select id="modality-select" class="w-full p-2 border rounded-lg">
            <option value="4">4 im√°genes (2x2)</option>
            <option value="6">6 im√°genes (2x3)</option>
            <option value="9" selected>9 im√°genes (3x3)</option>
          </select>

          <div class="flex gap-2">
            <button id="shuffle-btn" onclick="shuffleDeck()" class="flex-1 px-4 py-2 rounded-lg bg-blue-600 text-white font-bold">BARAJEAR</button>
            <button id="draw-btn" onclick="drawCard()" class="flex-1 px-4 py-2 rounded-lg bg-red-600 text-white font-bold">TIRAR CARTA (Espacio)</button>
          </div>

          <div class="flex justify-between text-sm text-gray-600 p-2 rounded-lg bg-gray-100">
            <span>Cartas restantes: <span id="deck-count" class="font-bold">0</span></span>
            <span>Carta actual: <span id="current-card-name" class="font-bold text-red-600">Ninguna</span></span>
          </div>
        </div>

        <!-- Finanzas -->
        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-300 mb-6">
          <p class="flex justify-between"><span>Jugadores registrados:</span> <span id="admin-player-count" class="font-bold">0</span></p>
          <p class="flex justify-between"><span>Total de cartas activas:</span> <span id="admin-active-card-count" class="font-bold">0</span></p>
          <p class="flex justify-between font-extrabold text-green-700"><span>Ganancia Potencial:</span> <span id="admin-profit">$0.00</span></p>
          <p class="flex justify-between text-blue-700"><span>Bolsa en juego:</span> <span id="admin-pot-amount">$0.00</span></p>
        </div>

        <!-- Registrar jugador -->
        <div class="mb-4">
          <h4 class="font-bold mb-2">Registrar nuevo jugador</h4>
          <div class="grid grid-cols-1 gap-2">
            <input id="player-name-input" type="text" placeholder="Nombre del jugador" class="p-2 border rounded" />
            <input id="player-games-input" type="number" min="1" value="1" class="p-2 border rounded" />
            <button onclick="addPlayer()" class="mt-2 p-2 bg-green-600 text-white rounded font-bold">A√±adir Jugador</button>
          </div>
        </div>

        <!-- Lista jugadores -->
        <div>
          <h4 class="font-bold mb-2">Jugadores activos</h4>
          <div class="max-h-56 overflow-y-auto">
            <table class="min-w-full text-left">
              <thead class="text-sm text-gray-600">
                <tr>
                  <th class="p-2">Nombre</th>
                  <th class="p-2">Partidas</th>
                  <th class="p-2">Pagado</th>
                  <th class="p-2">Victorias</th>
                  <th class="p-2">Acciones</th>
                </tr>
              </thead>
              <tbody id="admin-players-list" class="text-sm">
                <tr><td colspan="5" class="p-2 text-gray-500">Cargando jugadores...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Ganadores pendientes -->
        <div class="mt-4">
          <h4 class="font-bold mb-2">Ganadores pendientes</h4>
          <div id="pending-winners-list" class="space-y-2 max-h-36 overflow-y-auto">
            <p class="text-gray-500">Ning√∫n ganador pendiente.</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- SCRIPT: L√ìGICA SIMULADA (localStorage) -->
  <script>
    /* ----------- CONFIG ----------
       Guarda/lee todo desde localStorage para simular Firebase.
       Key: 'loteria_game' y 'loteria_players'
    --------------------------------*/
    const CARD_COST = 10;
    const HOUSE_PROFIT = 2;
    const CARD_IMAGE_BASE_PATH = 'Cartas_baraja_loteria/';
    const LOTERIA_CARDS = Array.from({length:54}, (_,i) => {
      const id = i+1;
      // nombres no estrictamente necesarios en simulaci√≥n - puedes mantener los tuyos en assets
      return { id, name: `Carta ${id}`, fileName: `${id} ${id===1?'el gallo-min.png':(id===2?'el diablito-min.png':`${id} carta.png`)}` };
    });
    // NOTE: user has real images named "1 el gallo-min.png" etc in folder, we'll generate filename mapping
    const CARD_NAME_MAP = {
      1: "1 el gallo-min.png",2:"2 el diablito-min.png",3:"3 la dama-min.png",4:"4 el catrin-min.png",
      5:"5 el paraguas-min.png",6:"6 la sirena-min.png",7:"7 la escalera-min.png",8:"8 la botella-min.png",
      9:"9 el barril-min.png",10:"10 el √°rbol-min.png",11:"11 el mel√≥n-min.png",12:"12 el valiente-min.png",
      13:"13 el gorrito-min.png",14:"14 la muerte-min.png",15:"15 la pera-min.png",16:"16 la bandera-min.png",
      17:"17 el bandol√≥n-min.png",18:"18 el violoncello-min.png",19:"19 la garza-min.png",20:"20 el p√°jaro-min.png",
      21:"21 la mano-min.png",22:"22 la bota-min.png",23:"23 la luna-min.png",24:"24 el cotorro-min.png",
      25:"25 el borracho-min.png",26:"26 el negrito-min.png",27:"27 el coraz√≥n-min.png",28:"28 la sand√≠a-min.png",
      29:"29 el tambor-min.png",30:"30 el camar√≥n-min.png",31:"31 las jaras-min.png",32:"32 el m√∫sico-min.png",
      33:"33 la ara√±a-min.png",34:"34 el soldado-min.png",35:"35 la estrella-min.png",36:"36 el cazo-min.png",
      37:"37 el mundo-min.png",38:"38 el apache-min.png",39:"39 el nopal-min.png",40:"40 el alacr√°n-min.png",
      41:"41 la rosa-min.png",42:"42 la calavera-min.png",43:"43 la campana-min.png",44:"44 el cantarito-min.png",
      45:"45 el venado-min.png",46:"46 el sol-min.png",47:"47 la corona-min.png",48:"48 la chalupa-min.png",
      49:"49 el pino-min.png",50:"50 el pescado-min.png",51:"51 la palma-min.png",52:"52 la maceta-min.png",
      53:"53 el rayo-min.png",54:"54 la rana-min.png"
    };

    // Utilidades de localStorage
    const saveGame = (game) => localStorage.setItem('loteria_game', JSON.stringify(game));
    const loadGame = () => {
      const raw = localStorage.getItem('loteria_game');
      if (!raw) return null;
      try { return JSON.parse(raw); } catch(e){ return null; }
    };
    const savePlayers = (players) => localStorage.setItem('loteria_players', JSON.stringify(players));
    const loadPlayers = () => {
      const raw = localStorage.getItem('loteria_players');
      if (!raw) return [];
      try { return JSON.parse(raw); } catch(e){ return []; }
    };

    // Estado por defecto (si no existe en localStorage)
    const defaultGame = () => ({
      modality: 9,
      deck: Array.from({length:54}, (_,i) => i+1),
      drawnCards: [],
      currentCardId: 0,
      totalActiveCards: 0,
      isShuffling: false,
      status: 'setup',
      pendingWinners: [],
      lastWinners: []
    });

    // Inicializa si no existe
    if (!loadGame()) {
      const g = defaultGame();
      saveGame(g);
    }
    if (!localStorage.getItem('loteria_players')) {
      savePlayers([]);
    }

    // Estado en memoria
    let gameState = loadGame();
    let players = loadPlayers();

    // Helpers
    const cardImageUrl = (cardId) => {
      const fname = CARD_NAME_MAP[cardId] || `${cardId}.png`;
      return `${CARD_IMAGE_BASE_PATH}${fname}`;
    };
    const getCardById = (id) => ({ id, name: `Carta ${id}`, fileName: CARD_NAME_MAP[id] || `${id}.png` });
    const persistAll = () => { saveGame(gameState); savePlayers(players); renderAll(); };

    /* ---------------- RENDER (Ambas vistas) ---------------- */

    // Render Vista Jugador: carta de cada jugador
    const renderPlayerCard = (player, currentCardId, modality) => {
      if (!player.isActive || player.gamesLeft <= 0) return '';
      const numCols = modality === 4 ? 2 : (modality === 6 ? 3 : 3);
      const cardSizeClass = modality === 4 ? 'grid-cols-2' : 'grid-cols-3';
      const cells = player.card.map(cardId => {
        const imageUrl = cardImageUrl(cardId);
        const isMarked = (player.markedCards || []).includes(cardId);
        const isCurrent = cardId === currentCardId;
        return `
          <div class="card-cell ${isMarked ? 'marked' : ''}" title="${cardId}"
               style="background-image: url('${imageUrl}');">
            ${isCurrent ? `<div class="absolute inset-0 border-4 border-yellow-400 rounded-lg animate-pulse z-10"></div>` : ''}
          </div>
        `;
      }).join('');
      return `
        <div class="card-loteria p-3 flex flex-col">
          <div class="text-lg font-extrabold text-gray-800 mb-2 truncate text-center">${player.name}</div>
          <div class="text-sm font-semibold text-red-600 mb-2 text-center">Partidas ${player.gamesLeft}</div>
          <div class="grid ${cardSizeClass} gap-1.5 h-full flex-grow">${cells}</div>
        </div>
      `;
    };

    const renderGameView = () => {
      // Jugadores activos
      const activePlayersHtml = players.filter(p => p.isActive && p.gamesLeft > 0)
        .map(p => renderPlayerCard(p, gameState.currentCardId, gameState.modality))
        .join('') || `<div class="text-center text-gray-500 p-8 card-loteria col-span-full">¬°A√∫n no hay jugadores activos!</div>`;
      document.getElementById('active-players-cards').innerHTML = activePlayersHtml;

      // Carta actual
      const currentCardElem = document.getElementById('current-card');
      if (gameState.currentCardId) {
        const imageUrl = cardImageUrl(gameState.currentCardId);
        currentCardElem.innerHTML = '';
        currentCardElem.style.backgroundImage = `url('${imageUrl}')`;
        currentCardElem.classList.remove('card-placeholder');
      } else {
        currentCardElem.innerHTML = `<div class="flex flex-col items-center justify-center"><span class="text-6xl">üé≤</span><span class="text-sm font-semibold mt-2 text-gray-600">Esperando...</span></div>`;
        currentCardElem.style.backgroundImage = 'none';
        currentCardElem.classList.add('card-placeholder');
      }

      // √öltimas 5 cartas
      const last = gameState.drawnCards.slice(-5).reverse();
      const lastHtml = last.map(cid => {
        const img = cardImageUrl(cid);
        const name = getCardById(cid).name;
        return `<div class="w-12 h-16 bg-cover bg-center rounded-lg shadow-md border-2 border-gray-300" style="background-image:url('${img}')" title="${name}"></div>`;
      }).join('') || `<span class="text-gray-400 text-sm">Ninguna carta a√∫n.</span>`;
      document.getElementById('last-cards').innerHTML = lastHtml;

      // √öltimos ganadores (feed)
      const lastWinnersHtml = (gameState.lastWinners || []).slice(-5).reverse().map(w => `
        <div class="bg-yellow-100 p-2 rounded-lg text-sm font-medium border border-yellow-300 w-full">
          <span class="font-bold">${w.name}</span> gan√≥ <span class="text-green-700 font-extrabold">$${w.amount.toFixed(2)}</span>
        </div>
      `).join('') || `<span class="text-gray-500">A√∫n no hay ganadores.</span>`;
      document.getElementById('last-winners').innerHTML = lastWinnersHtml;

      // Bolsa
      const potAmount = ((gameState.totalActiveCards || 0) * (CARD_COST - HOUSE_PROFIT));
      document.getElementById('pot-amount').textContent = `$${potAmount.toFixed(2)}`;

      // Admin: counts, monies, lists
      document.getElementById('deck-count').textContent = gameState.deck.length;
      const currentCardObj = getCardById(gameState.currentCardId);
      document.getElementById('current-card-name').textContent = currentCardObj ? (currentCardObj.name || `Carta ${gameState.currentCardId}`) : 'Ninguna';

      const activeCardsCount = players.filter(p => p.isActive && p.gamesLeft > 0).reduce((s,p)=>s+p.gamesLeft,0);
      document.getElementById('admin-player-count').textContent = players.length;
      document.getElementById('admin-active-card-count').textContent = activeCardsCount;
      const profit = activeCardsCount * HOUSE_PROFIT;
      document.getElementById('admin-profit').textContent = `$${profit.toFixed(2)}`;
      document.getElementById('admin-pot-amount').textContent = `$${potAmount.toFixed(2)}`;

      // Admin players list
      const adminList = players.map(p => `
        <tr class="${p.isActive ? '' : 'bg-red-50'}">
          <td class="p-2 font-semibold">${p.name}</td>
          <td class="p-2 text-lg font-bold ${p.gamesLeft>0 ? 'text-green-600' : 'text-red-600'}">${p.gamesLeft}</td>
          <td class="p-2">$${(p.totalPaid||0).toFixed(2)}</td>
          <td class="p-2 font-bold">${p.wins||0}</td>
          <td class="p-2">
            <button onclick="adjustPlayerGames('${p.id}',1)" class="px-2 py-1 bg-green-500 text-white rounded text-xs">+1</button>
            <button onclick="adjustPlayerGames('${p.id}',-1)" class="px-2 py-1 bg-red-500 text-white rounded text-xs">-1</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="5" class="p-2 text-gray-500">No hay jugadores registrados.</td></tr>';
      document.getElementById('admin-players-list').innerHTML = adminList;

      // Pending winners
      const pendingHtml = (gameState.pendingWinners || []).map(w => `
        <div class="flex justify-between items-center p-2 border-b">
          <span class="font-semibold text-gray-800">${w.name}</span>
          <span class="font-bold text-lg text-red-600">$${w.amount.toFixed(2)}</span>
          <button onclick="markWinnerPaid('${w.id}')" class="px-3 py-1 bg-red-600 text-white rounded-lg text-sm">Pagar</button>
        </div>
      `).join('') || '<p class="text-gray-500 p-2">Ning√∫n ganador pendiente.</p>';
      document.getElementById('pending-winners-list').innerHTML = pendingHtml;
    };

    const renderAll = () => {
      gameState = loadGame() || gameState;
      players = loadPlayers() || players;
      renderGameView();
    };

    // Inicial render
    renderAll();

    /* ------------- FUNCIONES DEL JUEGO ------------- */

    const setModality = (val) => {
      gameState.modality = parseInt(val);
      saveGame(gameState);
      renderAll();
    };
    window.setModality = setModality;
    document.getElementById('modality-select').addEventListener('change', (e) => {
      setModality(e.target.value);
    });

    const shuffleArray = (arr) => {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    };

    const shuffleDeck = () => {
      gameState.isShuffling = true;
      saveGame(gameState);
      renderAll();
      // Simular tiempo de barajado
      setTimeout(() => {
        const full = Array.from({length:54}, (_,i)=>i+1);
        const deck = shuffleArray(full);
        gameState.deck = deck;
        gameState.drawnCards = [];
        gameState.currentCardId = 0;
        gameState.status = 'playing';
        gameState.isShuffling = false;

        // reset marked cards for players who are active
        players = players.map(p => ({...p, markedCards: p.gamesLeft>0 ? [] : p.markedCards}));
        // recalcular totalActiveCards
        gameState.totalActiveCards = players.reduce((s,p) => s + (p.gamesLeft||0), 0);

        persistAll();
      }, 800);
    };
    window.shuffleDeck = shuffleDeck;

    const drawCard = () => {
      if (!gameState.deck || gameState.deck.length === 0) {
        alert('El mazo est√° vac√≠o. Barajea para continuar.');
        return;
      }
      // Pop next
      const next = gameState.deck.pop();
      gameState.drawnCards.push(next);
      gameState.currentCardId = next;
      saveGame(gameState);

      // Marcar en jugadores y verificar ganador
      checkWinner(next);

      persistAll();
    };
    window.drawCard = drawCard;

    // Agregar jugador
    const addPlayer = () => {
      const nameInput = document.getElementById('player-name-input');
      const gamesInput = document.getElementById('player-games-input');
      const name = (nameInput.value || '').trim();
      const games = parseInt(gamesInput.value) || 0;
      if (!name || games <= 0) { alert('Ingresa nombre y partidas v√°lidas.'); return; }

      const id = crypto.randomUUID();
      const modality = gameState.modality || 9;
      // generar tablero aleatorio
      const ids = shuffleArray(Array.from({length:54}, (_,i)=>i+1)).slice(0, modality);
      const totalPaid = games * CARD_COST;
      const player = {
        id,
        name,
        gamesLeft: games,
        totalPaid,
        wins: 0,
        card: ids,
        markedCards: [],
        isActive: true,
        addedAt: Date.now()
      };
      players.push(player);
      gameState.totalActiveCards = (gameState.totalActiveCards || 0) + games;
      persistAll();

      nameInput.value = '';
      gamesInput.value = '1';
    };
    window.addPlayer = addPlayer;

    // Ajustar partidas de jugador
    const adjustPlayerGames = (playerId, delta) => {
      const idx = players.findIndex(p => p.id === playerId);
      if (idx === -1) return;
      const p = players[idx];
      p.gamesLeft = Math.max(0, (p.gamesLeft||0) + delta);
      p.totalPaid = (p.totalPaid || 0) + (delta>0? delta*CARD_COST : 0);
      p.isActive = p.gamesLeft > 0;
      // actualizar totalActiveCards: recomputar
      gameState.totalActiveCards = players.reduce((s,pl)=>s+(pl.gamesLeft||0),0);
      persistAll();
    };
    window.adjustPlayerGames = adjustPlayerGames;

    // Marcar ganador como pagado
    const markWinnerPaid = (winnerId) => {
      gameState.pendingWinners = (gameState.pendingWinners || []).filter(w => w.id !== winnerId);
      persistAll();
    };
    window.markWinnerPaid = markWinnerPaid;

    // Check winner (similar a la l√≥gica del admin real)
    const checkWinner = (newCardId) => {
      if (!newCardId) return;
      const modality = gameState.modality || 9;
      const cardsToWin = modality;
      const winners = [];
      let totalCardsToDeduct = 0;

      // Para updates de jugadores usaremos marcado por transaction simulated
      players.forEach((p, idx) => {
        if (!p.isActive || p.gamesLeft <= 0) return;
        const playerCard = p.card || [];
        const marked = p.markedCards || [];
        let localMarked = [...marked];

        if (playerCard.includes(newCardId) && !marked.includes(newCardId)) {
          localMarked.push(newCardId);
          players[idx].markedCards = localMarked;
        }

        if ((players[idx].markedCards || []).length === cardsToWin) {
          winners.push({ id: p.id, name: p.name, refIdx: idx });
          totalCardsToDeduct++;
        }
      });

      if (winners.length > 0) {
        const totalActive = gameState.totalActiveCards || 0;
        const potAmount = totalActive * (CARD_COST - HOUSE_PROFIT);
        const winAmount = potAmount / winners.length;

        const newPending = [];
        winners.forEach(w => {
          const p = players[w.refIdx];
          p.gamesLeft = Math.max(0, (p.gamesLeft||0) - 1);
          p.wins = (p.wins||0) + 1;
          p.markedCards = [];
          p.isActive = p.gamesLeft > 0;

          const record = {
            id: crypto.randomUUID(),
            playerId: p.id,
            name: p.name,
            amount: winAmount,
            timestamp: Date.now(),
            status: 'pending'
          };
          newPending.push(record);

          // Mostrar modal en Jugador
          showWinnerModal(p.name, winAmount);
        });

        // Reiniciar y actualizar el mazo para siguiente ronda
        const fullDeck = shuffleArray(Array.from({length:54}, (_,i)=>i+1));
        gameState.deck = fullDeck;
        gameState.drawnCards = [];
        gameState.currentCardId = 0;
        gameState.totalActiveCards = Math.max(0, (gameState.totalActiveCards||0) - totalCardsToDeduct);

        // a√±adir pending winners y lastWinners
        gameState.pendingWinners = (gameState.pendingWinners || []).concat(newPending);
        gameState.lastWinners = (gameState.lastWinners || []).concat(newPending.map(w => ({ name: w.name, amount: w.amount, timestamp: w.timestamp })));
      } else {
        // si no hubo ganador, nada particular; persistimos marcas ya hechas arriba
      }
      persistAll();
    };

    // Mostrar modal ganador (visual + confetti)
    const showWinnerModal = (name, amount) => {
      document.getElementById('winner-name').textContent = name;
      document.getElementById('winner-amount').textContent = `$${amount.toFixed(2)}`;
      const modal = document.getElementById('winner-modal');
      modal.classList.remove('hidden');

      // Confetti simple
      const container = document.getElementById('confetti-container');
      container.innerHTML = '';
      const colors = ['#f00','#0f0','#00f','#ff0','#0ff','#f0f'];
      for (let i=0;i<60;i++){
        const div = document.createElement('div');
        div.className = 'confetti';
        div.style.left = `${Math.random()*100}vw`;
        div.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
        div.style.animationDelay = `${Math.random()*0.6}s`;
        div.style.width = `${6 + Math.random()*8}px`;
        div.style.height = div.style.width;
        container.appendChild(div);
      }
      setTimeout(() => {
        // Ocultar autom√°ticamente despu√©s de 4s
        hideWinnerModal();
      }, 4200);
    };
    window.showWinnerModal = showWinnerModal;

    const hideWinnerModal = () => {
      document.getElementById('winner-modal').classList.add('hidden');
      const cont = document.getElementById('confetti-container');
      cont.innerHTML = '';
    };
    window.hideWinnerModal = hideWinnerModal;

    // Marcar ganador pagado ya implementado m√°s arriba

    /* ------------- Sincronizaci√≥n UI y eventos ------------- */

    // Toggle vistas
    const tabPlayer = document.getElementById('tab-player');
    const tabAdmin = document.getElementById('tab-admin');
    const viewPlayer = document.getElementById('view-player');
    const viewAdmin = document.getElementById('view-admin');

    const activatePlayerView = () => {
      tabPlayer.classList.add('tab-active');
      tabAdmin.classList.remove('tab-active');
      viewPlayer.classList.remove('hidden');
      viewAdmin.classList.add('hidden');
    };
    const activateAdminView = () => {
      tabPlayer.classList.remove('tab-active');
      tabAdmin.classList.add('tab-active');
      viewPlayer.classList.add('hidden');
      viewAdmin.classList.remove('hidden');
    };
    tabPlayer.addEventListener('click', activatePlayerView);
    tabAdmin.addEventListener('click', activateAdminView);

    // Tecla espacio para tirar carta (cuando admin visible)
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space') {
        e.preventDefault();
        // solo si admin visible
        if (!viewAdmin.classList.contains('hidden')) drawCard();
      }
    });

    // Observador storage para sincronizar entre pesta√±as del navegador (opcional)
    window.addEventListener('storage', (e) => {
      if (e.key === 'loteria_game' || e.key === 'loteria_players') {
        renderAll();
      }
    });

    // Guardar con bot√≥n de modalidad
    document.getElementById('modality-select').addEventListener('change', (e) => {
      const v = parseInt(e.target.value);
      gameState.modality = v;
      saveGame(gameState);
      renderAll();
    });

    // Inicial: asegurar modalidad consistente
    (function init(){
      // Si juego no tiene deck, crear full deck
      if (!gameState.deck || gameState.deck.length===0) {
        gameState.deck = Array.from({length:54}, (_,i)=>i+1);
      }
      // Si totalActiveCards no definido, calcular
      if (typeof gameState.totalActiveCards === 'undefined') {
        gameState.totalActiveCards = players.reduce((s,p)=>s + (p.gamesLeft||0),0);
      }
      saveGame(gameState);
      savePlayers(players);
      renderAll();
    })();

  </script>

  <!-- Instrucciones r√°pidas -->
  <footer class="max-w-6xl mx-auto mt-8 text-sm text-gray-600">
    <p>Instrucciones: sube este <strong>index.html</strong>, coloca <strong>logo_1_entrada.png</strong> en la ra√≠z y la carpeta <strong>Cartas_baraja_loteria/</strong> con las 54 im√°genes. Abre en el navegador o publica en GitHub Pages.</p>
  </footer>
</body>
</html>
