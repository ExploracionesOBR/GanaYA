<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>GANA YA! - Juego de Cartas</title>
<style>
  body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f5f5f5}
  .btn{padding:6px 12px;border:none;border-radius:4px;cursor:pointer;margin:2px}
  .btn-blue{background:#3498db;color:#fff}
  .btn-green{background:#2ecc71;color:#fff}
  .hidden{display:none}
  .filter-btn.active-4,.filter-btn.active-6,.filter-btn.active-8,.filter-btn.active-all{font-weight:bold;text-decoration:underline}
  #shuffle-overlay{position:fixed;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:2000}
  .shuffle-card{position:absolute;width:120px;height:180px;border-radius:8px;background-size:cover;background-position:center;box-shadow:0 2px 6px rgba(0,0,0,0.2);}
  .modal{position:relative;max-width:600px;margin:auto;padding:16px;background:#fff;border-radius:8px;opacity:0;transition:opacity 0.25s ease}
  .modal.show{opacity:1}
  #confetti-canvas{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;display:none;z-index:5000}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #ccc;padding:6px;text-align:center}
</style>
</head>
<body>
<canvas id="confetti-canvas"></canvas>

<div id="main-grid">
  <!-- AquÃ­ irÃ­an inputs de registro, botones de control, filtros y tabla de jugadores -->
</div>

<div id="view-admin" class="hidden">
  <!-- Vista de administraciÃ³n -->
</div>

<!-- Modal jugador -->
<div id="modal-player" class="hidden">
  <div class="modal">
    <div id="modal-player-name"></div>
    <div id="modal-body"></div>
    <button id="modal-close" class="btn btn-blue">Cerrar</button>
    <button id="modal-close-x" class="btn btn-blue">X</button>
  </div>
</div>

<!-- Modal ganador -->
<div id="modal-winner" class="hidden">
  <div class="modal">
    <div id="winner-body"></div>
    <div id="winner-sub"></div>
    <button id="winner-ok" class="btn btn-blue">OK</button>
    <button id="winner-close" class="btn btn-blue">Cerrar</button>
  </div>
</div>

<script>
/************** Variables globales **************/
let purchases = [], winners = [], tx = [], cartasPasadas = [];
let game = {deck: Array.from({length:54},(_,i)=>i+1), drawn:[], current:0};
let prices = {price4:20, profit4:5, price6:30, profit6:7, price8:40, profit8:10};
let isAuto = false, autoInterval = null, animShuffling = false;
let currentMode = 4; // modo por defecto
const Kmod = 'currentMode';

/************** Funciones utilitarias **************/
function uuid(){ return 'xxxx-xxxx-xxxx-xxxx'.replace(/[x]/g,()=>Math.floor(Math.random()*16).toString(16)); }
function formatMoney(v){ return `$${(v||0).toFixed(2)}`; }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function cardImageUrl(id){ return `cards/${id}.png`; }
function cardName(id){ return `Carta ${id}`; }

/************** Registro de jugadores **************/
function generateCardForPurchase(modality){
  const assigned = new Set();
  const pool = Array.from({length:54},(_,i)=>i+1);
  const out = [];
  while(out.length<modality && pool.length){
    const idx = Math.floor(Math.random()*pool.length);
    const v = pool.splice(idx,1)[0];
    if(!assigned.has(v)){ assigned.add(v); out.push(v); }
  }
  return out;
}

function suggestFromBudget(budget){
  budget = Number(budget||0);
  const max4=Math.floor(budget/prices.price4);
  const max6=Math.floor(budget/prices.price6);
  const max8=Math.floor(budget/prices.price8);
  let msg = budget<=0?'Ingresa presupuesto para ver sugerencias.':`Con ${formatMoney(budget)} puedes comprar: ${max4} partidas de 4 cartas â€¢ ${max6} partidas de 6 cartas â€¢ ${max8} partidas de 8 cartas.`;
  const calcInfo = document.getElementById('calc-info'); if(calcInfo) calcInfo.textContent=msg;
  ['qty4','qty6','qty8'].forEach(q=>{ const el=document.getElementById(q); if(el) el.parentElement.style.display=budget>=prices[q.slice(-1)+'']==prices['price'+q.slice(-1)]?'block':'none'; });
}

function registerPlayer(){
  const name = (document.getElementById('input-name')?.value||'').trim();
  const cell = (document.getElementById('input-cell')?.value||'').trim();
  const clabe = (document.getElementById('input-clabe')?.value||'').trim();
  const budget = parseFloat(document.getElementById('input-budget')?.value||0);
  const q4=parseInt(document.getElementById('qty4')?.value||0);
  const q6=parseInt(document.getElementById('qty6')?.value||0);
  const q8=parseInt(document.getElementById('qty8')?.value||0);
  if(!name) return alert('Captura el nombre'); if(!cell) return alert('Captura el celular');
  if(q4+q6+q8<=0) return alert('Selecciona al menos una partida');
  const needed = q4*prices.price4 + q6*prices.price6 + q8*prices.price8;
  if(budget < needed) return alert(`El presupuesto no alcanza. Se requiere ${formatMoney(needed)}.`);
  if(budget > needed) return alert(`Hay sobrante de ${formatMoney(budget-needed)}. Ajusta cantidades o presupuesto.`);
  
  [[4,q4,prices.price4],[6,q6,prices.price6],[8,q8,prices.price8]].forEach(([mod,qty,price])=>{
    for(let i=0;i<qty;i++){
      const p={id:uuid(),playerName:name,cell:cell,clabe:clabe,modality:mod,initialGames:1,gamesLeft:1,totalPaid:price,wins:0,state:'JUGANDO',card:[],markedCards:[],selectionUsed:true,createdAt:Date.now()};
      p.card=generateCardForPurchase(mod);
      purchases.push(p);
      tx.push({id:uuid(),type:'purchase',player:name,modality:mod,amount:price,purchaseId:p.id,ts:Date.now()});
    }
  });
  document.querySelectorAll('#input-name,#input-cell,#input-clabe,#input-budget,#qty4,#qty6,#qty8').forEach(el=>el.value='');
  alert('Jugador(s) registrado(s) y cartas asignadas automÃ¡ticamente.');
  renderAll();
}

/************** Tabla de jugadores **************/
function renderPlayersTable(filter){
  const tbody=document.getElementById('players-table');
  if(!tbody) return;
  const list = purchases.slice().filter(p=>!filter||p.modality===filter);
  tbody.innerHTML=list.length?list.map(p=>`<tr>
    <td>${p.id}</td>
    <td>${escapeHtml(p.playerName)}<div class="small-muted">${escapeHtml(p.cell||'â€”')}</div></td>
    <td>${p.modality}</td>
    <td>${p.gamesLeft||0}</td>
    <td>${formatMoney(p.totalPaid)}</td>
    <td>${p.state||'JUGANDO'}</td>
    <td><button class="btn btn-blue" onclick="openPurchaseDetail('${p.id}');event.stopPropagation()">Detalle</button></td>
  </tr>`).join(''):'<tr><td colspan="7" style="text-align:center;color:#888">No hay operaciones.</td></tr>';
}

/************** Modal jugador **************/
function openPurchaseDetail(id){
  const p=purchases.find(x=>x.id===id); if(!p) return alert('No encontrado');
  document.getElementById('modal-player-name').textContent=`${p.playerName} â€¢ ${p.cell||''} â€¢ ${p.id}`;
  const cards=(p.card||[]).map(cid=>`<div style="width:100px;height:150px;background-image:url('${cardImageUrl(cid)}');background-size:cover;border-radius:8px;display:inline-block;margin-right:8px"></div>`).join('');
  const details = `<div><strong>Modalidad:</strong> ${p.modality}</div>
    <div><strong>Partidas restantes:</strong> ${p.gamesLeft||0}</div>
    <div><strong>Total pagado:</strong> ${formatMoney(p.totalPaid)}</div>
    <div style="margin-top:8px"><strong>Cartas asignadas:</strong></div><div>${cards}</div>
    <div style="margin-top:8px"><strong>CLABE / Cuenta:</strong> ${escapeHtml(p.clabe||'')}</div>
    <div style="margin-top:8px"><strong>Estado:</strong> ${p.state||'JUGANDO'}</div>
    <div style="margin-top:8px">
      <button class="btn btn-blue" onclick="printPurchase('${p.id}');">Imprimir</button>
      <button class="btn btn-green" onclick="copyClabe('${p.id}');">Copiar CLABE</button>
      <button class="btn btn-green" onclick="confirmWhatsapp('${p.id}');">Confirmar pago WhatsApp</button>
      <button class="btn btn-green" onclick="markPaidById('${p.id}');">Marcar Pagado</button>
    </div>`;
  document.getElementById('modal-body').innerHTML=details;
  openModal('modal-player');
}

function copyClabe(id){ const p=purchases.find(x=>x.id===id); if(!p) return; const text=p.clabe||''; if(!text) return alert('No hay CLABE'); navigator.clipboard.writeText(text).then(()=>alert('CLABE copiada')); }
function confirmWhatsapp(id){
  const p=purchases.find(x=>x.id===id); if(!p||!p.clabe) return alert('No hay CLABE');
  const msg = `Hola ${p.playerName}, se ha realizado tu pago de ${formatMoney(p.totalPaid)} a la cuenta ${p.clabe} el ${new Date().toLocaleString()}. Â¡Felicidades! ðŸŽ‰`;
  window.open(`https://wa.me/${p.cell}?text=${encodeURIComponent(msg)}`,'_blank');
}
function printPurchase(id){
  const p=purchases.find(x=>x.id===id); if(!p) return;
  const html = `<html><head><title>Compra ${p.id}</title></head><body>
    <h2>Reporte de partidas â€” GANA YA!</h2>
    <div>Jugador: ${escapeHtml(p.playerName)}</div>
    <div>Celular: ${escapeHtml(p.cell||'')}</div>
    <div>Modalidad: ${p.modality} cartas</div>
    <div>Partidas: ${p.gamesLeft||0}</div>
    <div>Total pagado: ${formatMoney(p.totalPaid)}</div>
    <div>Cartas: ${(p.card||[]).map(c=>`<img src="${cardImageUrl(c)}" style="width:120px;height:180px;margin:4px">`).join('')}</div>
    <div><em>${new Date().toLocaleString()}</em></div>
  </body></html>`;
  const w=window.open('','_blank'); w.document.write(html); w.document.close(); setTimeout(()=>w.print(),500);
}

/************** Barajado y dibujo **************/
function shuffle(array){ return array.sort(()=>Math.random()-0.5); }

function shufflePendingToFullScreen(){
  if(animShuffling) return; animShuffling=true;
  const pending = game.deck.filter(id=>!cartasPasadas.includes(id));
  if(!pending.length){ alert('No hay cartas pendientes.'); animShuffling=false; return; }
  const overlay=document.getElementById('shuffle-overlay'); overlay.classList.add('visible'); overlay.style.display='flex'; overlay.innerHTML='';
  const center=document.createElement('div'); center.style.position='relative'; center.style.width='680px'; center.style.height='420px'; overlay.appendChild(center);
  const sample=shuffle(pending).slice(0,12);
  sample.forEach((cid,i)=>{
    const el=document.createElement('div'); el.className='shuffle-card';
    el.style.backgroundImage=`url('${cardImageUrl(cid)}')`;
    el.style.left='50%'; el.style.top='50%';
    el.style.transform=`translate(-50%,-50%) rotate(${(Math.random()*360)-180}deg) scale(${1 - Math.abs(i-6)*0.02})`;
    el.style.zIndex=100+i;
    center.appendChild(el);
  });
  setTimeout(()=>{ overlay.classList.remove('visible'); overlay.style.display='none'; animShuffling=false; renderAll(); },2400);
}

function drawOne(){
  if(isAuto||animShuffling) return;
  let idx = game.deck.findIndex(c=>!cartasPasadas.includes(c));
  if(idx===-1){ alert('No hay cartas pendientes. Barajea'); return; }
  const card = game.deck.splice(idx,1)[0];
  game.drawn.push(card); game.current=card; cartasPasadas.push(card);
  tx.push({id:uuid(),type:'draw',card,ts:Date.now()});
  processCard(card); renderAll();
}

function processCard(cardId){
  const winnersFound=[];
  purchases.forEach((p,i)=>{
    if(!(p.gamesLeft>0 && p.state==='JUGANDO')) return;
    if(p.card?.includes(cardId) && !(p.markedCards||[]).includes(cardId)){
      p.markedCards=[...(p.markedCards||[]),cardId];
    }
    if((p.markedCards||[]).length===p.modality){
      winnersFound.push({idx:i,purchaseId:p.id});
    }
  });
  if(!winnersFound.length) return;
  stopAuto(); disableControls(true);
  const active = purchases.filter(p=>p.state==='JUGANDO' && (p.gamesLeft||0)>0);
  const totalSales = active.reduce((s,p)=>s+(p.totalPaid||0),0);
  const house = active.reduce((s,p)=>s+((p.modality===4?prices.profit4:p.modality===6?prices.profit6:prices.profit8)*(p.initialGames||0)),0);
  const pot = Math.max(0,totalSales-house); const share = pot/winnersFound.length;
  const recs=[];
  winnersFound.forEach(w=>{
    const p=purchases[w.idx]; p.gamesLeft=Math.max(0,(p.gamesLeft||0)-1);
    p.state = p.gamesLeft? 'JUGANDO':'FINALIZADO'; p.markedCards=[];
    const rec={id:uuid(),purchaseId:p.id,playerName:p.playerName,amount:share,timestamp:Date.now(),paid:false,cardId:cardId,clabe:p.clabe||'',cell:p.cell||''};
    winners.push({timestamp:rec.timestamp,playerName:rec.playerName,amount:rec.amount,cardId:rec.cardId,paid:false,purchaseId:p.id});
    tx.push({id:uuid(),type:'winner',player:p.playerName,amount:share,ts:Date.now()});
    recs.push(rec);
  });
  saveAll(); showWinner(recs); renderAll();
}

/************** Auto y controles **************/
function startAuto(){ if(!game.deck.length){ alert('Mazo vacÃ­o'); return; } isAuto=true; document.getElementById('btn-auto').textContent='DETENER AUTOMÃTICO'; autoInterval=setInterval(drawOne,2000); }
function stopAuto(){ isAuto=false; document.getElementById('btn-auto')?.textContent='CARTAS AUTOMÃTICO'; clearInterval(autoInterval); autoInterval=null; }
function toggleAuto(){ isAuto?stopAuto():startAuto(); }
function disableControls(d){ ['btn-shuffle','btn-draw','btn-auto','btn-reset','btn-register','save-prices','btn-export-admin','btn-clear-admin'].forEach(id=>document.getElementById(id)?.disabled=!!d); }

/************** Modal confetti y ganadores **************/
let confettiInterval=null;
function startConfettiFullScreen(){
  const canvas=document.getElementById('confetti-canvas'); canvas.style.display='block';
  const ctx=canvas.getContext('2d'); const w=canvas.width=window.innerWidth; const h=canvas.height=window.innerHeight;
  const colors=['#e63946','#ffd60a','#2a9d8f','#ff9e00','#ff6bcb','#6d9df5'];
  let conf=Array.from({length:220},()=>({x:Math.random()*w,y:Math.random()*-h,r:Math.random()*6+3,c:colors[Math.floor(Math.random()*colors.length)],s:Math.random()*3+2,rrot:Math.random()*6}));
  function draw(){ ctx.clearRect(0,0,w,h); conf.forEach(c=>{ ctx.save(); ctx.translate(c.x,c.y); ctx.rotate(c.rrot); ctx.fillStyle=c.c; ctx.fillRect(-c.r,-c.r,c.r*2,c.r*2); ctx.restore(); c.y+=c.s; c.x+=Math.sin(c.y*0.01)*2; if(c.y>h+30){ c.y=-20; c.x=Math.random()*w; } }); }
  if(confettiInterval) clearInterval(confettiInterval); confettiInterval=setInterval(draw,20);
  setTimeout(()=>stopConfettiFullScreen(),6000);
}
function stopConfettiFullScreen(){ if(confettiInterval) clearInterval(confettiInterval); const canvas=document.getElementById('confetti-canvas'); if(canvas){ const ctx=canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height); canvas.style.display='none'; } }

function showWinner(recs){
  const modal=document.getElementById('modal-winner');
  const body=document.getElementById('winner-body');
  const sub=document.getElementById('winner-sub');
  const total=recs.reduce((s,r)=>s+(r.amount||0),0);
  const names=recs.map(r=>escapeHtml(r.playerName)).join(', ');
  body.innerHTML = `${names} ha ganado ${formatMoney(total)}`;
  sub.innerHTML = `Carta ganadora: ${cardName(recs[0].cardId)}`;
  modal.classList.remove('hidden'); modal.style.display='block';
  playApplause(); startConfettiFullScreen();
}

function openModal(modalId){
  const modal = document.getElementById(modalId); if(!modal) return;
  modal.classList.remove('hidden'); modal.style.display='block';
  const inner = modal.querySelector('.modal'); setTimeout(()=> inner?.classList.add('show'),10);
}
function closeModal(modalId){
  const modal = document.getElementById(modalId); if(!modal) return;
  const inner = modal.querySelector('.modal'); inner?.classList.remove('show');
  setTimeout(()=>{ modal.classList.add('hidden'); modal.style.display='none'; if(modalId==='modal-winner'){ stopConfettiFullScreen(); renderAll(); } },260);
}

/************** Pago y seguimiento **************/
window.markPaidById=function(id){
  const p=purchases.find(x=>x.id===id); if(!p) return alert('No encontrado');
  if(p.state!=='POR PAGAR') return alert('Solo marcar si estÃ¡ POR PAGAR');
  p.state='PAGADO'; p.paidAt=Date.now();
  winners=winners.map(w=>w.purchaseId===id? {...w,paid:true}:w);
  tx.push({id:uuid(),type:'mark_paid',purchaseId:id,ts:Date.now()});
  saveAll(); renderAll(); alert('Marcado como PAGADO');
}

/************** Reset y reinicio **************/
function resetGame(){
  if(!confirm('Iniciar un juego nuevo: se reiniciarÃ¡ el mazo y se quitarÃ¡ 1 partida a todos los jugadores activos. Â¿Continuar?')) return;
  stopAuto();
  purchases.forEach(p=>{ if(p.state==='JUGANDO' && (p.gamesLeft||0)>0){ p.gamesLeft=Math.max(0,(p.gamesLeft||0)-1); if(p.gamesLeft<=0) p.state='FINALIZADO'; } });
  game.deck=Array.from({length:54},(_,i)=>i+1); game.drawn=[]; game.current=0; cartasPasadas=[]; purchases.forEach(p=>p.markedCards=[]);
  document.getElementById('shuffle-overlay').classList.remove('visible');
  document.getElementById('shuffle-overlay').style.display='none';
  tx.push({id:uuid(),type:'reset',ts:Date.now()});
  saveAll(); renderAll();
  alert('Juego reiniciado y partidas descontadas.');
}

function saveAll(){
  localStorage.setItem('purchases',JSON.stringify(purchases));
  localStorage.setItem('winners',JSON.stringify(winners));
  localStorage.setItem('tx',JSON.stringify(tx));
  localStorage.setItem('game',JSON.stringify(game));
  localStorage.setItem('prices',JSON.stringify(prices));
}

/************** Render general **************/
function renderAll(){ renderPlayersTable(currentMode); }

/************** InicializaciÃ³n **************/
document.addEventListener('DOMContentLoaded',()=>{
  renderAll();
  document.addEventListener('keydown',e=>{
    if(e.key==='Escape'){ closeModal('modal-player'); closeModal('modal-winner'); }
    if(e.code==='Space'){ e.preventDefault(); if(!isAuto) drawOne(); }
  });
});
</script>
</body>
</html>
